
<!DOCTYPE html>


<html lang="en" data-theme="light">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pyxu.abc.arithmetic &#8212; Pyxu Documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "light";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../_static/plot_directive.css?v=7f9a90b1" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-codeautolink.css?v=125d5c1c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery.css?v=61a4c737" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css?v=1031a718" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script src="../../../_static/documentation_options.js?v=29481255"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=30646c52"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script src="../../../_static/design-tabs.js?v=36754332"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/pyxu/abc/arithmetic';</script>
    <link rel="icon" href="../../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="light">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  <div class="navbar-header-items__start">
    
      <div class="navbar-item">
  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
    
    
    
    <img src="../../../_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../../../_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
    
  </div>
  
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../intro/index.html">
                        Getting Started
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../guide/index.html">
                        User Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../examples/index.html">
                        Example Gallery
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../api/index.html">
                        API Reference
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../fair/index.html">
                        Extending Pyxu
                      </a>
                    </li>
                
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
        </div>
      
      
        <div class="navbar-item"><strong> v0.0.1 </strong></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/matthieumeo/pyxu" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-github"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/pyxu/" title="PyPI" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-python"></i></span>
            <label class="sr-only">PyPI</label></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="mailto: matthieu.simeoni@gmail.com" title="Contact" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-telegram"></i></span>
            <label class="sr-only">Contact</label></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://imaging.epfl.ch/" title="EPFL Center for Imaging" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="../../../_static/imaging.png" class="icon-link-image" alt="EPFL Center for Imaging"/></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
    </div>
  

  
    <label class="sidebar-toggle secondary-toggle" for="__secondary">
      <span class="fa-solid fa-outdent"></span>
    </label>
  
</div>

    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../intro/index.html">
                        Getting Started
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../guide/index.html">
                        User Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../examples/index.html">
                        Example Gallery
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../api/index.html">
                        API Reference
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../fair/index.html">
                        Extending Pyxu
                      </a>
                    </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item"><strong> v0.0.1 </strong></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/matthieumeo/pyxu" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-github"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/pyxu/" title="PyPI" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-python"></i></span>
            <label class="sr-only">PyPI</label></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="mailto: matthieu.simeoni@gmail.com" title="Contact" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-telegram"></i></span>
            <label class="sr-only">Contact</label></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://imaging.epfl.ch/" title="EPFL Center for Imaging" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="../../../_static/imaging.png" class="icon-link-image" alt="EPFL Center for Imaging"/></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumbs">
  <ul class="bd-breadcrumbs" role="navigation" aria-label="Breadcrumb">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">pyxu.abc.arithmetic</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <h1>Source code for pyxu.abc.arithmetic</h1><div class="highlight"><pre>
<span></span><span class="linenos">   1</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">   2</span><span class="sd">Operator Arithmetic.</span>
<span class="linenos">   3</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">   4</span>
<span class="linenos">   5</span><span class="kn">import</span> <span class="nn">types</span>
<span class="linenos">   6</span><span class="kn">import</span> <span class="nn">typing</span> <span class="k">as</span> <span class="nn">typ</span>
<span class="linenos">   7</span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="linenos">   8</span>
<span class="linenos">   9</span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="linenos">  10</span>
<span class="linenos">  11</span><span class="kn">import</span> <span class="nn">pyxu.abc.operator</span> <span class="k">as</span> <span class="nn">pxo</span>
<span class="linenos">  12</span><span class="kn">import</span> <span class="nn">pyxu.info.deps</span> <span class="k">as</span> <span class="nn">pxd</span>
<span class="linenos">  13</span><span class="kn">import</span> <span class="nn">pyxu.info.ptype</span> <span class="k">as</span> <span class="nn">pxt</span>
<span class="linenos">  14</span><span class="kn">import</span> <span class="nn">pyxu.info.warning</span> <span class="k">as</span> <span class="nn">pxw</span>
<span class="linenos">  15</span><span class="kn">import</span> <span class="nn">pyxu.runtime</span> <span class="k">as</span> <span class="nn">pxrt</span>
<span class="linenos">  16</span><span class="kn">import</span> <span class="nn">pyxu.util</span> <span class="k">as</span> <span class="nn">pxu</span>
<span class="linenos">  17</span>
<span class="linenos">  18</span>
<div class="viewcode-block" id="Rule">
<a class="viewcode-back" href="../../../api/abc.html#pyxu.abc.arithmetic.Rule">[docs]</a>
<span class="linenos">  19</span><span class="k">class</span> <span class="nc">Rule</span><span class="p">:</span>
<div class="viewcode-block" id="Rule.op">
<a class="viewcode-back" href="../../../api/abc.html#pyxu.abc.arithmetic.Rule.op">[docs]</a>
<span class="linenos">  20</span>    <span class="k">def</span> <span class="nf">op</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">:</span>
<span class="linenos">  21</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">  22</span><span class="sd">        Returns</span>
<span class="linenos">  23</span><span class="sd">        -------</span>
<span class="linenos">  24</span><span class="sd">        op: OpT</span>
<span class="linenos">  25</span><span class="sd">            Synthesize operator.</span>
<span class="linenos">  26</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">  27</span>        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<span class="linenos">  28</span>
<span class="linenos">  29</span>    <span class="c1"># Helper Methods ----------------------------------------------------------</span>
<span class="linenos">  30</span>
<span class="linenos">  31</span>    <span class="nd">@staticmethod</span>
<span class="linenos">  32</span>    <span class="k">def</span> <span class="nf">_propagate_constants</span><span class="p">(</span><span class="n">op</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">):</span>
<span class="linenos">  33</span>        <span class="c1"># Propagate (diff-)Lipschitz constants forward via special call to</span>
<span class="linenos">  34</span>        <span class="c1"># Rule()-overridden `estimate_[diff_]lipschitz()` methods.</span>
<span class="linenos">  35</span>
<span class="linenos">  36</span>        <span class="c1"># Important: we write to _[diff_]lipschitz to not overwrite estimate_[diff_]lipschitz() methods.</span>
<span class="linenos">  37</span>        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">CAN_EVAL</span><span class="p">):</span>
<span class="linenos">  38</span>            <span class="n">op</span><span class="o">.</span><span class="n">_lipschitz</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">estimate_lipschitz</span><span class="p">(</span><span class="n">__rule</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">  39</span>        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">DIFFERENTIABLE</span><span class="p">):</span>
<span class="linenos">  40</span>            <span class="n">op</span><span class="o">.</span><span class="n">_diff_lipschitz</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">estimate_diff_lipschitz</span><span class="p">(</span><span class="n">__rule</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">  41</span>
<span class="linenos">  42</span>    <span class="c1"># Default Arithmetic Methods ----------------------------------------------</span>
<span class="linenos">  43</span>    <span class="c1"># Fallback on these when no simple form in terms of Rule.__init__() args is known.</span>
<span class="linenos">  44</span>    <span class="c1"># If a method from Property.arithmetic_methods() is not listed here, then all Rule subclasses</span>
<span class="linenos">  45</span>    <span class="c1"># provide an overloaded implementation.</span>
<span class="linenos">  46</span>
<span class="linenos">  47</span>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos">  48</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="linenos">  49</span>
<span class="linenos">  50</span>    <span class="k">def</span> <span class="nf">svdvals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos">  51</span>        <span class="n">D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">svdvals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos">  52</span>        <span class="k">return</span> <span class="n">D</span>
<span class="linenos">  53</span>
<span class="linenos">  54</span>    <span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;arr&quot;</span><span class="p">,</span> <span class="s2">&quot;damp&quot;</span><span class="p">))</span>
<span class="linenos">  55</span>    <span class="k">def</span> <span class="nf">pinv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">damp</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Real</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos">  56</span>        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="o">=</span><span class="n">arr</span><span class="p">,</span> <span class="n">damp</span><span class="o">=</span><span class="n">damp</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos">  57</span>        <span class="k">return</span> <span class="n">out</span>
<span class="linenos">  58</span>
<span class="linenos">  59</span>    <span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">()</span>
<span class="linenos">  60</span>    <span class="k">def</span> <span class="nf">trace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Real</span><span class="p">:</span>
<span class="linenos">  61</span>        <span class="n">tr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos">  62</span>        <span class="k">return</span> <span class="n">tr</span></div>

<span class="linenos">  63</span>
<span class="linenos">  64</span>
<div class="viewcode-block" id="ScaleRule">
<a class="viewcode-back" href="../../../api/abc.html#pyxu.abc.arithmetic.ScaleRule">[docs]</a>
<span class="linenos">  65</span><span class="k">class</span> <span class="nc">ScaleRule</span><span class="p">(</span><span class="n">Rule</span><span class="p">):</span>
<span class="linenos">  66</span><span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">  67</span><span class="sd">    Special Cases::</span>
<span class="linenos">  68</span>
<span class="linenos">  69</span><span class="sd">        \alpha = 0  =&gt; NullOp/NullFunc</span>
<span class="linenos">  70</span><span class="sd">        \alpha = 1  =&gt; self</span>
<span class="linenos">  71</span>
<span class="linenos">  72</span><span class="sd">    Else::</span>
<span class="linenos">  73</span>
<span class="linenos">  74</span><span class="sd">        |--------------------------|-------------|--------------------------------------------------------------------|</span>
<span class="linenos">  75</span><span class="sd">        |         Property         |  Preserved? |                     Arithmetic Update Rule(s)                      |</span>
<span class="linenos">  76</span><span class="sd">        |--------------------------|-------------|--------------------------------------------------------------------|</span>
<span class="linenos">  77</span><span class="sd">        | CAN_EVAL                 | yes         | op_new.apply(arr) = op_old.apply(arr) * \alpha                     |</span>
<span class="linenos">  78</span><span class="sd">        |                          |             | op_new.lipschitz = op_old.lipschitz * abs(\alpha)                  |</span>
<span class="linenos">  79</span><span class="sd">        |--------------------------|-------------|--------------------------------------------------------------------|</span>
<span class="linenos">  80</span><span class="sd">        | FUNCTIONAL               | yes         | op_new.asloss(\beta) = op_old.asloss(\beta) * \alpha               |</span>
<span class="linenos">  81</span><span class="sd">        |--------------------------|-------------|--------------------------------------------------------------------|</span>
<span class="linenos">  82</span><span class="sd">        | PROXIMABLE               | \alpha &gt; 0  | op_new.prox(arr, tau) = op_old.prox(arr, tau * \alpha)             |</span>
<span class="linenos">  83</span><span class="sd">        |--------------------------|-------------|--------------------------------------------------------------------|</span>
<span class="linenos">  84</span><span class="sd">        | DIFFERENTIABLE           | yes         | op_new.jacobian(arr) = op_old.jacobian(arr) * \alpha               |</span>
<span class="linenos">  85</span><span class="sd">        |                          |             | op_new.diff_lipschitz = op_old.diff_lipschitz * abs(\alpha)        |</span>
<span class="linenos">  86</span><span class="sd">        |--------------------------|-------------|--------------------------------------------------------------------|</span>
<span class="linenos">  87</span><span class="sd">        | DIFFERENTIABLE_FUNCTION  | yes         | op_new.grad(arr) = op_old.grad(arr) * \alpha                       |</span>
<span class="linenos">  88</span><span class="sd">        |--------------------------|-------------|--------------------------------------------------------------------|</span>
<span class="linenos">  89</span><span class="sd">        | QUADRATIC                | \alpha &gt; 0  | Q, c, t = op_old._quad_spec()                                      |</span>
<span class="linenos">  90</span><span class="sd">        |                          |             | op_new._quad_spec() = (\alpha * Q, \alpha * c, \alpha * t)         |</span>
<span class="linenos">  91</span><span class="sd">        |--------------------------|-------------|--------------------------------------------------------------------|</span>
<span class="linenos">  92</span><span class="sd">        | LINEAR                   | yes         | op_new.adjoint(arr) = op_old.adjoint(arr) * \alpha                 |</span>
<span class="linenos">  93</span><span class="sd">        |                          |             | op_new.asarray() = op_old.asarray() * \alpha                       |</span>
<span class="linenos">  94</span><span class="sd">        |                          |             | op_new.svdvals() = op_old.svdvals() * abs(\alpha)                  |</span>
<span class="linenos">  95</span><span class="sd">        |                          |             | op_new.pinv(x, damp) = op_old.pinv(x, damp / (\alpha**2)) / \alpha |</span>
<span class="linenos">  96</span><span class="sd">        |                          |             | op_new.gram() = op_old.gram() * (\alpha**2)                        |</span>
<span class="linenos">  97</span><span class="sd">        |                          |             | op_new.cogram() = op_old.cogram() * (\alpha**2)                    |</span>
<span class="linenos">  98</span><span class="sd">        |--------------------------|-------------|--------------------------------------------------------------------|</span>
<span class="linenos">  99</span><span class="sd">        | LINEAR_SQUARE            | yes         | op_new.trace() = op_old.trace() * \alpha                           |</span>
<span class="linenos"> 100</span><span class="sd">        |--------------------------|-------------|--------------------------------------------------------------------|</span>
<span class="linenos"> 101</span><span class="sd">        | LINEAR_NORMAL            | yes         |                                                                    |</span>
<span class="linenos"> 102</span><span class="sd">        |--------------------------|-------------|--------------------------------------------------------------------|</span>
<span class="linenos"> 103</span><span class="sd">        | LINEAR_UNITARY           | \alpha = -1 |                                                                    |</span>
<span class="linenos"> 104</span><span class="sd">        |--------------------------|-------------|--------------------------------------------------------------------|</span>
<span class="linenos"> 105</span><span class="sd">        | LINEAR_SELF_ADJOINT      | yes         |                                                                    |</span>
<span class="linenos"> 106</span><span class="sd">        |--------------------------|-------------|--------------------------------------------------------------------|</span>
<span class="linenos"> 107</span><span class="sd">        | LINEAR_POSITIVE_DEFINITE | \alpha &gt; 0  |                                                                    |</span>
<span class="linenos"> 108</span><span class="sd">        |--------------------------|-------------|--------------------------------------------------------------------|</span>
<span class="linenos"> 109</span><span class="sd">        | LINEAR_IDEMPOTENT        | no          |                                                                    |</span>
<span class="linenos"> 110</span><span class="sd">        |--------------------------|-------------|--------------------------------------------------------------------|</span>
<span class="linenos"> 111</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 112</span>
<span class="linenos"> 113</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">,</span> <span class="n">cst</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Real</span><span class="p">):</span>
<span class="linenos"> 114</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<span class="linenos"> 115</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_op</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="linenos"> 116</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_cst</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cst</span><span class="p">)</span>
<span class="linenos"> 117</span>
<span class="linenos"> 118</span>    <span class="k">def</span> <span class="nf">op</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">:</span>
<span class="linenos"> 119</span>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cst</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos"> 120</span>            <span class="kn">from</span> <span class="nn">pyxu.operator.linop</span> <span class="kn">import</span> <span class="n">NullOp</span>
<span class="linenos"> 121</span>
<span class="linenos"> 122</span>            <span class="n">op</span> <span class="o">=</span> <span class="n">NullOp</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="linenos"> 123</span>        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cst</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
<span class="linenos"> 124</span>            <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span>
<span class="linenos"> 125</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 126</span>            <span class="n">klass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infer_op_klass</span><span class="p">()</span>
<span class="linenos"> 127</span>            <span class="n">op</span> <span class="o">=</span> <span class="n">klass</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="linenos"> 128</span>            <span class="n">op</span><span class="o">.</span><span class="n">_op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span>  <span class="c1"># embed for introspection</span>
<span class="linenos"> 129</span>            <span class="n">op</span><span class="o">.</span><span class="n">_cst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cst</span>  <span class="c1"># embed for introspection</span>
<span class="linenos"> 130</span>            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">op</span><span class="o">.</span><span class="n">properties</span><span class="p">():</span>
<span class="linenos"> 131</span>                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">arithmetic_methods</span><span class="p">():</span>
<span class="linenos"> 132</span>                    <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
<span class="linenos"> 133</span>                    <span class="nb">setattr</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">op</span><span class="p">))</span>
<span class="linenos"> 134</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_propagate_constants</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<span class="linenos"> 135</span>        <span class="k">return</span> <span class="n">op</span>
<span class="linenos"> 136</span>
<span class="linenos"> 137</span>    <span class="k">def</span> <span class="nf">_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="linenos"> 138</span>        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;scale&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cst</span><span class="p">)</span>
<span class="linenos"> 139</span>
<span class="linenos"> 140</span>    <span class="k">def</span> <span class="nf">_infer_op_klass</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpC</span><span class="p">:</span>
<span class="linenos"> 141</span>        <span class="n">preserved</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos"> 142</span>            <span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">CAN_EVAL</span><span class="p">,</span>
<span class="linenos"> 143</span>            <span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">FUNCTIONAL</span><span class="p">,</span>
<span class="linenos"> 144</span>            <span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">DIFFERENTIABLE</span><span class="p">,</span>
<span class="linenos"> 145</span>            <span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">DIFFERENTIABLE_FUNCTION</span><span class="p">,</span>
<span class="linenos"> 146</span>            <span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">,</span>
<span class="linenos"> 147</span>            <span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">LINEAR_SQUARE</span><span class="p">,</span>
<span class="linenos"> 148</span>            <span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">LINEAR_NORMAL</span><span class="p">,</span>
<span class="linenos"> 149</span>            <span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">LINEAR_SELF_ADJOINT</span><span class="p">,</span>
<span class="linenos"> 150</span>        <span class="p">}</span>
<span class="linenos"> 151</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cst</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos"> 152</span>            <span class="n">preserved</span> <span class="o">|=</span> <span class="p">{</span>
<span class="linenos"> 153</span>                <span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">LINEAR_POSITIVE_DEFINITE</span><span class="p">,</span>
<span class="linenos"> 154</span>                <span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">QUADRATIC</span><span class="p">,</span>
<span class="linenos"> 155</span>                <span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">PROXIMABLE</span><span class="p">,</span>
<span class="linenos"> 156</span>            <span class="p">}</span>
<span class="linenos"> 157</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">):</span>
<span class="linenos"> 158</span>            <span class="n">preserved</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">PROXIMABLE</span><span class="p">)</span>
<span class="linenos"> 159</span>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cst</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
<span class="linenos"> 160</span>            <span class="n">preserved</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">LINEAR_UNITARY</span><span class="p">)</span>
<span class="linenos"> 161</span>
<span class="linenos"> 162</span>        <span class="n">properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">properties</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">preserved</span>
<span class="linenos"> 163</span>        <span class="n">klass</span> <span class="o">=</span> <span class="n">pxo</span><span class="o">.</span><span class="n">Operator</span><span class="o">.</span><span class="n">_infer_operator_type</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span>
<span class="linenos"> 164</span>        <span class="k">return</span> <span class="n">klass</span>
<span class="linenos"> 165</span>
<span class="linenos"> 166</span>    <span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="s2">&quot;arr&quot;</span><span class="p">)</span>
<span class="linenos"> 167</span>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos"> 168</span>        <span class="n">out</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">copy_if_unsafe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">arr</span><span class="p">))</span>
<span class="linenos"> 169</span>        <span class="n">out</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cst</span>
<span class="linenos"> 170</span>        <span class="k">return</span> <span class="n">out</span>
<span class="linenos"> 171</span>
<span class="linenos"> 172</span>    <span class="k">def</span> <span class="nf">estimate_lipschitz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Real</span><span class="p">:</span>
<span class="linenos"> 173</span>        <span class="n">no_eval</span> <span class="o">=</span> <span class="s2">&quot;__rule&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span>
<span class="linenos"> 174</span>        <span class="k">if</span> <span class="n">no_eval</span><span class="p">:</span>
<span class="linenos"> 175</span>            <span class="n">L</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">lipschitz</span><span class="p">)</span>
<span class="linenos"> 176</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 177</span>            <span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">estimate_lipschitz</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos"> 178</span>        <span class="n">L</span> <span class="o">*=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cst</span><span class="p">)</span>
<span class="linenos"> 179</span>        <span class="k">return</span> <span class="n">L</span>
<span class="linenos"> 180</span>
<span class="linenos"> 181</span>    <span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;arr&quot;</span><span class="p">,</span> <span class="s2">&quot;tau&quot;</span><span class="p">))</span>
<span class="linenos"> 182</span>    <span class="k">def</span> <span class="nf">prox</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">tau</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Real</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos"> 183</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">prox</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">tau</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cst</span><span class="p">)</span>
<span class="linenos"> 184</span>
<span class="linenos"> 185</span>    <span class="k">def</span> <span class="nf">_quad_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 186</span>        <span class="n">Q1</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">t1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">_quad_spec</span><span class="p">()</span>
<span class="linenos"> 187</span>        <span class="n">Q2</span> <span class="o">=</span> <span class="n">ScaleRule</span><span class="p">(</span><span class="n">op</span><span class="o">=</span><span class="n">Q1</span><span class="p">,</span> <span class="n">cst</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cst</span><span class="p">)</span><span class="o">.</span><span class="n">op</span><span class="p">()</span>
<span class="linenos"> 188</span>        <span class="n">c2</span> <span class="o">=</span> <span class="n">ScaleRule</span><span class="p">(</span><span class="n">op</span><span class="o">=</span><span class="n">c1</span><span class="p">,</span> <span class="n">cst</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cst</span><span class="p">)</span><span class="o">.</span><span class="n">op</span><span class="p">()</span>
<span class="linenos"> 189</span>        <span class="n">t2</span> <span class="o">=</span> <span class="n">t1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cst</span>
<span class="linenos"> 190</span>        <span class="k">return</span> <span class="p">(</span><span class="n">Q2</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
<span class="linenos"> 191</span>
<span class="linenos"> 192</span>    <span class="k">def</span> <span class="nf">jacobian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">:</span>
<span class="linenos"> 193</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">):</span>
<span class="linenos"> 194</span>            <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span>
<span class="linenos"> 195</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 196</span>            <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cst</span>
<span class="linenos"> 197</span>        <span class="k">return</span> <span class="n">op</span>
<span class="linenos"> 198</span>
<span class="linenos"> 199</span>    <span class="k">def</span> <span class="nf">estimate_diff_lipschitz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Real</span><span class="p">:</span>
<span class="linenos"> 200</span>        <span class="n">no_eval</span> <span class="o">=</span> <span class="s2">&quot;__rule&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span>
<span class="linenos"> 201</span>        <span class="k">if</span> <span class="n">no_eval</span><span class="p">:</span>
<span class="linenos"> 202</span>            <span class="n">dL</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">diff_lipschitz</span><span class="p">)</span>
<span class="linenos"> 203</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 204</span>            <span class="n">dL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">estimate_diff_lipschitz</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos"> 205</span>        <span class="n">dL</span> <span class="o">*=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cst</span><span class="p">)</span>
<span class="linenos"> 206</span>        <span class="k">return</span> <span class="n">dL</span>
<span class="linenos"> 207</span>
<span class="linenos"> 208</span>    <span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="s2">&quot;arr&quot;</span><span class="p">)</span>
<span class="linenos"> 209</span>    <span class="k">def</span> <span class="nf">grad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos"> 210</span>        <span class="n">out</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">copy_if_unsafe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">arr</span><span class="p">))</span>
<span class="linenos"> 211</span>        <span class="n">out</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cst</span>
<span class="linenos"> 212</span>        <span class="k">return</span> <span class="n">out</span>
<span class="linenos"> 213</span>
<span class="linenos"> 214</span>    <span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="s2">&quot;arr&quot;</span><span class="p">)</span>
<span class="linenos"> 215</span>    <span class="k">def</span> <span class="nf">adjoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos"> 216</span>        <span class="n">out</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">copy_if_unsafe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">adjoint</span><span class="p">(</span><span class="n">arr</span><span class="p">))</span>
<span class="linenos"> 217</span>        <span class="n">out</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cst</span>
<span class="linenos"> 218</span>        <span class="k">return</span> <span class="n">out</span>
<span class="linenos"> 219</span>
<span class="linenos"> 220</span>    <span class="k">def</span> <span class="nf">asarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos"> 221</span>        <span class="n">A</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">copy_if_unsafe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
<span class="linenos"> 222</span>        <span class="n">A</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cst</span>
<span class="linenos"> 223</span>        <span class="k">return</span> <span class="n">A</span>
<span class="linenos"> 224</span>
<span class="linenos"> 225</span>    <span class="k">def</span> <span class="nf">svdvals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos"> 226</span>        <span class="n">D</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">copy_if_unsafe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">svdvals</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
<span class="linenos"> 227</span>        <span class="n">D</span> <span class="o">*=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cst</span><span class="p">)</span>
<span class="linenos"> 228</span>        <span class="k">return</span> <span class="n">D</span>
<span class="linenos"> 229</span>
<span class="linenos"> 230</span>    <span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;arr&quot;</span><span class="p">,</span> <span class="s2">&quot;damp&quot;</span><span class="p">))</span>
<span class="linenos"> 231</span>    <span class="k">def</span> <span class="nf">pinv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">damp</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Real</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos"> 232</span>        <span class="n">scale</span> <span class="o">=</span> <span class="n">damp</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cst</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="linenos"> 233</span>        <span class="n">out</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">copy_if_unsafe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">damp</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
<span class="linenos"> 234</span>        <span class="n">out</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cst</span>
<span class="linenos"> 235</span>        <span class="k">return</span> <span class="n">out</span>
<span class="linenos"> 236</span>
<span class="linenos"> 237</span>    <span class="k">def</span> <span class="nf">gram</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">:</span>
<span class="linenos"> 238</span>        <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">gram</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cst</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="linenos"> 239</span>        <span class="k">return</span> <span class="n">op</span>
<span class="linenos"> 240</span>
<span class="linenos"> 241</span>    <span class="k">def</span> <span class="nf">cogram</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">:</span>
<span class="linenos"> 242</span>        <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">cogram</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cst</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="linenos"> 243</span>        <span class="k">return</span> <span class="n">op</span>
<span class="linenos"> 244</span>
<span class="linenos"> 245</span>    <span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">()</span>
<span class="linenos"> 246</span>    <span class="k">def</span> <span class="nf">trace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Real</span><span class="p">:</span>
<span class="linenos"> 247</span>        <span class="n">tr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cst</span>
<span class="linenos"> 248</span>        <span class="k">return</span> <span class="n">tr</span>
<span class="linenos"> 249</span>
<span class="linenos"> 250</span>    <span class="k">def</span> <span class="nf">asloss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">:</span>
<span class="linenos"> 251</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">FUNCTIONAL</span><span class="p">):</span>
<span class="linenos"> 252</span>            <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 253</span>                <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span>
<span class="linenos"> 254</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 255</span>                <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">asloss</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cst</span>
<span class="linenos"> 256</span>            <span class="k">return</span> <span class="n">op</span>
<span class="linenos"> 257</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 258</span>            <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<span class="linenos"> 259</span>
<span class="linenos"> 260</span>
<div class="viewcode-block" id="ArgScaleRule">
<a class="viewcode-back" href="../../../api/abc.html#pyxu.abc.arithmetic.ArgScaleRule">[docs]</a>
<span class="linenos"> 261</span><span class="k">class</span> <span class="nc">ArgScaleRule</span><span class="p">(</span><span class="n">Rule</span><span class="p">):</span>
<span class="linenos"> 262</span><span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 263</span><span class="sd">    Special Cases::</span>
<span class="linenos"> 264</span>
<span class="linenos"> 265</span><span class="sd">        \alpha = 0  =&gt; ConstantValued (w/ potential vector-valued output)</span>
<span class="linenos"> 266</span><span class="sd">        \alpha = 1  =&gt; self</span>
<span class="linenos"> 267</span>
<span class="linenos"> 268</span><span class="sd">    Else::</span>
<span class="linenos"> 269</span>
<span class="linenos"> 270</span><span class="sd">        |--------------------------|-------------|-----------------------------------------------------------------------------|</span>
<span class="linenos"> 271</span><span class="sd">        |         Property         |  Preserved? |                          Arithmetic Update Rule(s)                          |</span>
<span class="linenos"> 272</span><span class="sd">        |--------------------------|-------------|-----------------------------------------------------------------------------|</span>
<span class="linenos"> 273</span><span class="sd">        | CAN_EVAL                 | yes         | op_new.apply(arr) = op_old.apply(arr * \alpha)                              |</span>
<span class="linenos"> 274</span><span class="sd">        |                          |             | op_new.lipschitz = op_old.lipschitz * abs(\alpha)                           |</span>
<span class="linenos"> 275</span><span class="sd">        |--------------------------|-------------|-----------------------------------------------------------------------------|</span>
<span class="linenos"> 276</span><span class="sd">        | FUNCTIONAL               | yes         | op_new.asloss(\beta) = AMBIGUOUS -&gt; DISABLED                                |</span>
<span class="linenos"> 277</span><span class="sd">        |--------------------------|-------------|-----------------------------------------------------------------------------|</span>
<span class="linenos"> 278</span><span class="sd">        | PROXIMABLE               | yes         | op_new.prox(arr, tau) = op_old.prox(\alpha * arr, \alpha**2 * tau) / \alpha |</span>
<span class="linenos"> 279</span><span class="sd">        |--------------------------|-------------|-----------------------------------------------------------------------------|</span>
<span class="linenos"> 280</span><span class="sd">        | DIFFERENTIABLE           | yes         | op_new.diff_lipschitz = op_old.diff_lipschitz * (\alpha**2)                 |</span>
<span class="linenos"> 281</span><span class="sd">        |                          |             | op_new.jacobian(arr) = op_old.jacobian(arr * \alpha) * \alpha               |</span>
<span class="linenos"> 282</span><span class="sd">        |--------------------------|-------------|-----------------------------------------------------------------------------|</span>
<span class="linenos"> 283</span><span class="sd">        | DIFFERENTIABLE_FUNCTION  | yes         | op_new.grad(arr) = op_old.grad(\alpha * arr) * \alpha                       |</span>
<span class="linenos"> 284</span><span class="sd">        |--------------------------|-------------|-----------------------------------------------------------------------------|</span>
<span class="linenos"> 285</span><span class="sd">        | QUADRATIC                | yes         | Q, c, t = op_old._quad_spec()                                               |</span>
<span class="linenos"> 286</span><span class="sd">        |                          |             | op_new._quad_spec() = (\alpha**2 * Q, \alpha * c, t)                        |</span>
<span class="linenos"> 287</span><span class="sd">        |--------------------------|-------------|-----------------------------------------------------------------------------|</span>
<span class="linenos"> 288</span><span class="sd">        | LINEAR                   | yes         | op_new.adjoint(arr) = op_old.adjoint(arr) * \alpha                          |</span>
<span class="linenos"> 289</span><span class="sd">        |                          |             | op_new.asarray() = op_old.asarray() * \alpha                                |</span>
<span class="linenos"> 290</span><span class="sd">        |                          |             | op_new.svdvals() = op_old.svdvals() * abs(\alpha)                           |</span>
<span class="linenos"> 291</span><span class="sd">        |                          |             | op_new.pinv(x, damp) = op_old.pinv(x, damp / (\alpha**2)) / \alpha          |</span>
<span class="linenos"> 292</span><span class="sd">        |                          |             | op_new.gram() = op_old.gram() * (\alpha**2)                                 |</span>
<span class="linenos"> 293</span><span class="sd">        |                          |             | op_new.cogram() = op_old.cogram() * (\alpha**2)                             |</span>
<span class="linenos"> 294</span><span class="sd">        |--------------------------|-------------|-----------------------------------------------------------------------------|</span>
<span class="linenos"> 295</span><span class="sd">        | LINEAR_SQUARE            | yes         | op_new.trace() = op_old.trace() * \alpha                                    |</span>
<span class="linenos"> 296</span><span class="sd">        |--------------------------|-------------|-----------------------------------------------------------------------------|</span>
<span class="linenos"> 297</span><span class="sd">        | LINEAR_NORMAL            | yes         |                                                                             |</span>
<span class="linenos"> 298</span><span class="sd">        |--------------------------|-------------|-----------------------------------------------------------------------------|</span>
<span class="linenos"> 299</span><span class="sd">        | LINEAR_UNITARY           | \alpha = -1 |                                                                             |</span>
<span class="linenos"> 300</span><span class="sd">        |--------------------------|-------------|-----------------------------------------------------------------------------|</span>
<span class="linenos"> 301</span><span class="sd">        | LINEAR_SELF_ADJOINT      | yes         |                                                                             |</span>
<span class="linenos"> 302</span><span class="sd">        |--------------------------|-------------|-----------------------------------------------------------------------------|</span>
<span class="linenos"> 303</span><span class="sd">        | LINEAR_POSITIVE_DEFINITE | \alpha &gt; 0  |                                                                             |</span>
<span class="linenos"> 304</span><span class="sd">        |--------------------------|-------------|-----------------------------------------------------------------------------|</span>
<span class="linenos"> 305</span><span class="sd">        | LINEAR_IDEMPOTENT        | no          |                                                                             |</span>
<span class="linenos"> 306</span><span class="sd">        |--------------------------|-------------|-----------------------------------------------------------------------------|</span>
<span class="linenos"> 307</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 308</span>
<span class="linenos"> 309</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">,</span> <span class="n">cst</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Real</span><span class="p">):</span>
<span class="linenos"> 310</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<span class="linenos"> 311</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_op</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="linenos"> 312</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_cst</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cst</span><span class="p">)</span>
<span class="linenos"> 313</span>
<span class="linenos"> 314</span>    <span class="k">def</span> <span class="nf">op</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">:</span>
<span class="linenos"> 315</span>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cst</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos"> 316</span>            <span class="c1"># ConstantVECTOR output: modify ConstantValued to work.</span>
<span class="linenos"> 317</span>            <span class="kn">from</span> <span class="nn">pyxu.operator.map</span> <span class="kn">import</span> <span class="n">ConstantValued</span>
<span class="linenos"> 318</span>
<span class="linenos"> 319</span>            <span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="s2">&quot;arr&quot;</span><span class="p">)</span>
<span class="linenos"> 320</span>            <span class="k">def</span> <span class="nf">op_apply</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos"> 321</span>                <span class="n">xp</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">get_array_module</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="linenos"> 322</span>                <span class="n">arr</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
<span class="linenos"> 323</span>                    <span class="p">(</span><span class="o">*</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">dim</span><span class="p">),</span>
<span class="linenos"> 324</span>                    <span class="n">dtype</span><span class="o">=</span><span class="n">arr</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
<span class="linenos"> 325</span>                <span class="p">)</span>
<span class="linenos"> 326</span>                <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="linenos"> 327</span>                <span class="k">return</span> <span class="n">out</span>
<span class="linenos"> 328</span>
<span class="linenos"> 329</span>            <span class="n">op</span> <span class="o">=</span> <span class="n">ConstantValued</span><span class="p">(</span>
<span class="linenos"> 330</span>                <span class="n">shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
<span class="linenos"> 331</span>                <span class="n">cst</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cst</span><span class="p">,</span>
<span class="linenos"> 332</span>            <span class="p">)</span>
<span class="linenos"> 333</span>            <span class="n">op</span><span class="o">.</span><span class="n">apply</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">(</span><span class="n">op_apply</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
<span class="linenos"> 334</span>        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cst</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
<span class="linenos"> 335</span>            <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span>
<span class="linenos"> 336</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 337</span>            <span class="n">klass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infer_op_klass</span><span class="p">()</span>
<span class="linenos"> 338</span>            <span class="n">op</span> <span class="o">=</span> <span class="n">klass</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="linenos"> 339</span>            <span class="n">op</span><span class="o">.</span><span class="n">_op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span>  <span class="c1"># embed for introspection</span>
<span class="linenos"> 340</span>            <span class="n">op</span><span class="o">.</span><span class="n">_cst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cst</span>  <span class="c1"># embed for introspection</span>
<span class="linenos"> 341</span>            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">op</span><span class="o">.</span><span class="n">properties</span><span class="p">():</span>
<span class="linenos"> 342</span>                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">arithmetic_methods</span><span class="p">():</span>
<span class="linenos"> 343</span>                    <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
<span class="linenos"> 344</span>                    <span class="nb">setattr</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">op</span><span class="p">))</span>
<span class="linenos"> 345</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_propagate_constants</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<span class="linenos"> 346</span>        <span class="k">return</span> <span class="n">op</span>
<span class="linenos"> 347</span>
<span class="linenos"> 348</span>    <span class="k">def</span> <span class="nf">_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="linenos"> 349</span>        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;argscale&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cst</span><span class="p">)</span>
<span class="linenos"> 350</span>
<span class="linenos"> 351</span>    <span class="k">def</span> <span class="nf">_infer_op_klass</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpC</span><span class="p">:</span>
<span class="linenos"> 352</span>        <span class="n">preserved</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos"> 353</span>            <span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">CAN_EVAL</span><span class="p">,</span>
<span class="linenos"> 354</span>            <span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">FUNCTIONAL</span><span class="p">,</span>
<span class="linenos"> 355</span>            <span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">PROXIMABLE</span><span class="p">,</span>
<span class="linenos"> 356</span>            <span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">DIFFERENTIABLE</span><span class="p">,</span>
<span class="linenos"> 357</span>            <span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">DIFFERENTIABLE_FUNCTION</span><span class="p">,</span>
<span class="linenos"> 358</span>            <span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">,</span>
<span class="linenos"> 359</span>            <span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">LINEAR_SQUARE</span><span class="p">,</span>
<span class="linenos"> 360</span>            <span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">LINEAR_NORMAL</span><span class="p">,</span>
<span class="linenos"> 361</span>            <span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">LINEAR_SELF_ADJOINT</span><span class="p">,</span>
<span class="linenos"> 362</span>            <span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">QUADRATIC</span><span class="p">,</span>
<span class="linenos"> 363</span>        <span class="p">}</span>
<span class="linenos"> 364</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cst</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos"> 365</span>            <span class="n">preserved</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">LINEAR_POSITIVE_DEFINITE</span><span class="p">)</span>
<span class="linenos"> 366</span>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cst</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
<span class="linenos"> 367</span>            <span class="n">preserved</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">LINEAR_UNITARY</span><span class="p">)</span>
<span class="linenos"> 368</span>
<span class="linenos"> 369</span>        <span class="n">properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">properties</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">preserved</span>
<span class="linenos"> 370</span>        <span class="n">klass</span> <span class="o">=</span> <span class="n">pxo</span><span class="o">.</span><span class="n">Operator</span><span class="o">.</span><span class="n">_infer_operator_type</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span>
<span class="linenos"> 371</span>        <span class="k">return</span> <span class="n">klass</span>
<span class="linenos"> 372</span>
<span class="linenos"> 373</span>    <span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="s2">&quot;arr&quot;</span><span class="p">)</span>
<span class="linenos"> 374</span>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos"> 375</span>        <span class="n">x</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="linenos"> 376</span>        <span class="n">x</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cst</span>
<span class="linenos"> 377</span>        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="linenos"> 378</span>        <span class="k">return</span> <span class="n">out</span>
<span class="linenos"> 379</span>
<span class="linenos"> 380</span>    <span class="k">def</span> <span class="nf">estimate_lipschitz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Real</span><span class="p">:</span>
<span class="linenos"> 381</span>        <span class="n">no_eval</span> <span class="o">=</span> <span class="s2">&quot;__rule&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span>
<span class="linenos"> 382</span>        <span class="k">if</span> <span class="n">no_eval</span><span class="p">:</span>
<span class="linenos"> 383</span>            <span class="n">L</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">lipschitz</span><span class="p">)</span>
<span class="linenos"> 384</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 385</span>            <span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">estimate_lipschitz</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos"> 386</span>        <span class="n">L</span> <span class="o">*=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cst</span><span class="p">)</span>
<span class="linenos"> 387</span>        <span class="k">return</span> <span class="n">L</span>
<span class="linenos"> 388</span>
<span class="linenos"> 389</span>    <span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;arr&quot;</span><span class="p">,</span> <span class="s2">&quot;tau&quot;</span><span class="p">))</span>
<span class="linenos"> 390</span>    <span class="k">def</span> <span class="nf">prox</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">tau</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Real</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos"> 391</span>        <span class="n">x</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="linenos"> 392</span>        <span class="n">x</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cst</span>
<span class="linenos"> 393</span>        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">prox</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cst</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">tau</span><span class="p">)</span>
<span class="linenos"> 394</span>        <span class="n">out</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cst</span>
<span class="linenos"> 395</span>        <span class="k">return</span> <span class="n">out</span>
<span class="linenos"> 396</span>
<span class="linenos"> 397</span>    <span class="k">def</span> <span class="nf">_quad_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 398</span>        <span class="n">Q1</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">t1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">_quad_spec</span><span class="p">()</span>
<span class="linenos"> 399</span>        <span class="n">Q2</span> <span class="o">=</span> <span class="n">ScaleRule</span><span class="p">(</span><span class="n">op</span><span class="o">=</span><span class="n">Q1</span><span class="p">,</span> <span class="n">cst</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cst</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">op</span><span class="p">()</span>
<span class="linenos"> 400</span>        <span class="n">c2</span> <span class="o">=</span> <span class="n">ScaleRule</span><span class="p">(</span><span class="n">op</span><span class="o">=</span><span class="n">c1</span><span class="p">,</span> <span class="n">cst</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cst</span><span class="p">)</span><span class="o">.</span><span class="n">op</span><span class="p">()</span>
<span class="linenos"> 401</span>        <span class="n">t2</span> <span class="o">=</span> <span class="n">t1</span>
<span class="linenos"> 402</span>        <span class="k">return</span> <span class="p">(</span><span class="n">Q2</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
<span class="linenos"> 403</span>
<span class="linenos"> 404</span>    <span class="k">def</span> <span class="nf">jacobian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">:</span>
<span class="linenos"> 405</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">):</span>
<span class="linenos"> 406</span>            <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span>
<span class="linenos"> 407</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 408</span>            <span class="n">x</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="linenos"> 409</span>            <span class="n">x</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cst</span>
<span class="linenos"> 410</span>            <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cst</span>
<span class="linenos"> 411</span>        <span class="k">return</span> <span class="n">op</span>
<span class="linenos"> 412</span>
<span class="linenos"> 413</span>    <span class="k">def</span> <span class="nf">estimate_diff_lipschitz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Real</span><span class="p">:</span>
<span class="linenos"> 414</span>        <span class="n">no_eval</span> <span class="o">=</span> <span class="s2">&quot;__rule&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span>
<span class="linenos"> 415</span>        <span class="k">if</span> <span class="n">no_eval</span><span class="p">:</span>
<span class="linenos"> 416</span>            <span class="n">dL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">diff_lipschitz</span>
<span class="linenos"> 417</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 418</span>            <span class="n">dL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">estimate_diff_lipschitz</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos"> 419</span>        <span class="n">dL</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cst</span><span class="o">**</span><span class="mi">2</span>
<span class="linenos"> 420</span>        <span class="k">return</span> <span class="n">dL</span>
<span class="linenos"> 421</span>
<span class="linenos"> 422</span>    <span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="s2">&quot;arr&quot;</span><span class="p">)</span>
<span class="linenos"> 423</span>    <span class="k">def</span> <span class="nf">grad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos"> 424</span>        <span class="n">x</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="linenos"> 425</span>        <span class="n">x</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cst</span>
<span class="linenos"> 426</span>        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="linenos"> 427</span>        <span class="n">out</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cst</span>
<span class="linenos"> 428</span>        <span class="k">return</span> <span class="n">out</span>
<span class="linenos"> 429</span>
<span class="linenos"> 430</span>    <span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="s2">&quot;arr&quot;</span><span class="p">)</span>
<span class="linenos"> 431</span>    <span class="k">def</span> <span class="nf">adjoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos"> 432</span>        <span class="n">out</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">copy_if_unsafe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">adjoint</span><span class="p">(</span><span class="n">arr</span><span class="p">))</span>
<span class="linenos"> 433</span>        <span class="n">out</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cst</span>
<span class="linenos"> 434</span>        <span class="k">return</span> <span class="n">out</span>
<span class="linenos"> 435</span>
<span class="linenos"> 436</span>    <span class="k">def</span> <span class="nf">asarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos"> 437</span>        <span class="n">A</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">copy_if_unsafe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
<span class="linenos"> 438</span>        <span class="n">A</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cst</span>
<span class="linenos"> 439</span>        <span class="k">return</span> <span class="n">A</span>
<span class="linenos"> 440</span>
<span class="linenos"> 441</span>    <span class="k">def</span> <span class="nf">svdvals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos"> 442</span>        <span class="n">D</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">copy_if_unsafe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">svdvals</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
<span class="linenos"> 443</span>        <span class="n">D</span> <span class="o">*=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cst</span><span class="p">)</span>
<span class="linenos"> 444</span>        <span class="k">return</span> <span class="n">D</span>
<span class="linenos"> 445</span>
<span class="linenos"> 446</span>    <span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;arr&quot;</span><span class="p">,</span> <span class="s2">&quot;damp&quot;</span><span class="p">))</span>
<span class="linenos"> 447</span>    <span class="k">def</span> <span class="nf">pinv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">damp</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Real</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos"> 448</span>        <span class="n">scale</span> <span class="o">=</span> <span class="n">damp</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cst</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="linenos"> 449</span>        <span class="n">out</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">copy_if_unsafe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">damp</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
<span class="linenos"> 450</span>        <span class="n">out</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cst</span>
<span class="linenos"> 451</span>        <span class="k">return</span> <span class="n">out</span>
<span class="linenos"> 452</span>
<span class="linenos"> 453</span>    <span class="k">def</span> <span class="nf">gram</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">:</span>
<span class="linenos"> 454</span>        <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">gram</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cst</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="linenos"> 455</span>        <span class="k">return</span> <span class="n">op</span>
<span class="linenos"> 456</span>
<span class="linenos"> 457</span>    <span class="k">def</span> <span class="nf">cogram</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">:</span>
<span class="linenos"> 458</span>        <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">cogram</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cst</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="linenos"> 459</span>        <span class="k">return</span> <span class="n">op</span>
<span class="linenos"> 460</span>
<span class="linenos"> 461</span>    <span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">()</span>
<span class="linenos"> 462</span>    <span class="k">def</span> <span class="nf">trace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Real</span><span class="p">:</span>
<span class="linenos"> 463</span>        <span class="n">tr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cst</span>
<span class="linenos"> 464</span>        <span class="k">return</span> <span class="n">tr</span>
<span class="linenos"> 465</span>
<span class="linenos"> 466</span>    <span class="k">def</span> <span class="nf">asloss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">:</span>
<span class="linenos"> 467</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">FUNCTIONAL</span><span class="p">):</span>
<span class="linenos"> 468</span>            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
<span class="linenos"> 469</span>                <span class="p">[</span>
<span class="linenos"> 470</span>                    <span class="s2">&quot;The meaning of op.argscale().asloss() is ambiguous.&quot;</span><span class="p">,</span>
<span class="linenos"> 471</span>                    <span class="s2">&quot;Rewrite the expression differently to clarify the intent.&quot;</span><span class="p">,</span>
<span class="linenos"> 472</span>                <span class="p">]</span>
<span class="linenos"> 473</span>            <span class="p">)</span>
<span class="linenos"> 474</span>            <span class="k">raise</span> <span class="ne">ArithmeticError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="linenos"> 475</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 476</span>            <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<span class="linenos"> 477</span>
<span class="linenos"> 478</span>
<div class="viewcode-block" id="ArgShiftRule">
<a class="viewcode-back" href="../../../api/abc.html#pyxu.abc.arithmetic.ArgShiftRule">[docs]</a>
<span class="linenos"> 479</span><span class="k">class</span> <span class="nc">ArgShiftRule</span><span class="p">(</span><span class="n">Rule</span><span class="p">):</span>
<span class="linenos"> 480</span><span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 481</span><span class="sd">    Special Cases::</span>
<span class="linenos"> 482</span>
<span class="linenos"> 483</span><span class="sd">        \shift = 0  =&gt; self</span>
<span class="linenos"> 484</span>
<span class="linenos"> 485</span><span class="sd">    Else::</span>
<span class="linenos"> 486</span>
<span class="linenos"> 487</span><span class="sd">        |--------------------------|------------|-----------------------------------------------------------------|</span>
<span class="linenos"> 488</span><span class="sd">        |         Property         | Preserved? |                    Arithmetic Update Rule(s)                    |</span>
<span class="linenos"> 489</span><span class="sd">        |--------------------------|------------|-----------------------------------------------------------------|</span>
<span class="linenos"> 490</span><span class="sd">        | CAN_EVAL                 | yes        | op_new.apply(arr) = op_old.apply(arr + \shift)                  |</span>
<span class="linenos"> 491</span><span class="sd">        |                          |            | op_new.lipschitz = op_old.lipschitz                             |</span>
<span class="linenos"> 492</span><span class="sd">        |--------------------------|------------|-----------------------------------------------------------------|</span>
<span class="linenos"> 493</span><span class="sd">        | FUNCTIONAL               | yes        | op_new.asloss(\beta) = AMBIGUOUS -&gt; DISABLED                    |</span>
<span class="linenos"> 494</span><span class="sd">        |--------------------------|------------|-----------------------------------------------------------------|</span>
<span class="linenos"> 495</span><span class="sd">        | PROXIMABLE               | yes        | op_new.prox(arr, tau) = op_old.prox(arr + \shift, tau) - \shift |</span>
<span class="linenos"> 496</span><span class="sd">        |--------------------------|------------|-----------------------------------------------------------------|</span>
<span class="linenos"> 497</span><span class="sd">        | DIFFERENTIABLE           | yes        | op_new.diff_lipschitz = op_old.diff_lipschitz                   |</span>
<span class="linenos"> 498</span><span class="sd">        |                          |            | op_new.jacobian(arr) = op_old.jacobian(arr + \shift)            |</span>
<span class="linenos"> 499</span><span class="sd">        |--------------------------|------------|-----------------------------------------------------------------|</span>
<span class="linenos"> 500</span><span class="sd">        | DIFFERENTIABLE_FUNCTION  | yes        | op_new.grad(arr) = op_old.grad(arr + \shift)                    |</span>
<span class="linenos"> 501</span><span class="sd">        |--------------------------|------------|-----------------------------------------------------------------|</span>
<span class="linenos"> 502</span><span class="sd">        | QUADRATIC                | yes        | Q, c, t = op_old._quad_spec()                                   |</span>
<span class="linenos"> 503</span><span class="sd">        |                          |            | op_new._quad_spec() = (Q, c + Q @ \shift, op_old.apply(\shift)) |</span>
<span class="linenos"> 504</span><span class="sd">        |--------------------------|------------|-----------------------------------------------------------------|</span>
<span class="linenos"> 505</span><span class="sd">        | LINEAR                   | no         |                                                                 |</span>
<span class="linenos"> 506</span><span class="sd">        |--------------------------|------------|-----------------------------------------------------------------|</span>
<span class="linenos"> 507</span><span class="sd">        | LINEAR_SQUARE            | no         |                                                                 |</span>
<span class="linenos"> 508</span><span class="sd">        |--------------------------|------------|-----------------------------------------------------------------|</span>
<span class="linenos"> 509</span><span class="sd">        | LINEAR_NORMAL            | no         |                                                                 |</span>
<span class="linenos"> 510</span><span class="sd">        |--------------------------|------------|-----------------------------------------------------------------|</span>
<span class="linenos"> 511</span><span class="sd">        | LINEAR_UNITARY           | no         |                                                                 |</span>
<span class="linenos"> 512</span><span class="sd">        |--------------------------|------------|-----------------------------------------------------------------|</span>
<span class="linenos"> 513</span><span class="sd">        | LINEAR_SELF_ADJOINT      | no         |                                                                 |</span>
<span class="linenos"> 514</span><span class="sd">        |--------------------------|------------|-----------------------------------------------------------------|</span>
<span class="linenos"> 515</span><span class="sd">        | LINEAR_POSITIVE_DEFINITE | no         |                                                                 |</span>
<span class="linenos"> 516</span><span class="sd">        |--------------------------|------------|-----------------------------------------------------------------|</span>
<span class="linenos"> 517</span><span class="sd">        | LINEAR_IDEMPOTENT        | no         |                                                                 |</span>
<span class="linenos"> 518</span><span class="sd">        |--------------------------|------------|-----------------------------------------------------------------|</span>
<span class="linenos"> 519</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 520</span>
<span class="linenos"> 521</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">,</span> <span class="n">cst</span><span class="p">:</span> <span class="n">typ</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">pxt</span><span class="o">.</span><span class="n">Real</span><span class="p">,</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">]):</span>
<span class="linenos"> 522</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<span class="linenos"> 523</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_op</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="linenos"> 524</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_scalar</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cst</span><span class="p">,</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Real</span><span class="p">)</span>
<span class="linenos"> 525</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scalar</span><span class="p">:</span>
<span class="linenos"> 526</span>            <span class="n">cst</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cst</span><span class="p">)</span>
<span class="linenos"> 527</span>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># pxt.NDArray</span>
<span class="linenos"> 528</span>            <span class="k">assert</span> <span class="n">cst</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">cst</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;cst: expected 1D array, got </span><span class="si">{</span><span class="n">cst</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">.&quot;</span>
<span class="linenos"> 529</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_cst</span> <span class="o">=</span> <span class="n">cst</span>
<span class="linenos"> 530</span>
<span class="linenos"> 531</span>    <span class="k">def</span> <span class="nf">op</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">:</span>
<span class="linenos"> 532</span>        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fallback</span><span class="o">=</span><span class="n">np</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scalar</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos"> 533</span>        <span class="n">xp</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">get_array_module</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cst</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos"> 534</span>        <span class="n">norm</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">xp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cst</span><span class="p">))</span>
<span class="linenos"> 535</span>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">norm</span><span class="p">),</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos"> 536</span>            <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span>
<span class="linenos"> 537</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 538</span>            <span class="n">klass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infer_op_klass</span><span class="p">()</span>
<span class="linenos"> 539</span>            <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infer_op_shape</span><span class="p">()</span>
<span class="linenos"> 540</span>            <span class="n">op</span> <span class="o">=</span> <span class="n">klass</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">)</span>
<span class="linenos"> 541</span>            <span class="n">op</span><span class="o">.</span><span class="n">_op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span>  <span class="c1"># embed for introspection</span>
<span class="linenos"> 542</span>            <span class="n">op</span><span class="o">.</span><span class="n">_cst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cst</span>  <span class="c1"># embed for introspection</span>
<span class="linenos"> 543</span>            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">op</span><span class="o">.</span><span class="n">properties</span><span class="p">():</span>
<span class="linenos"> 544</span>                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">arithmetic_methods</span><span class="p">():</span>
<span class="linenos"> 545</span>                    <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
<span class="linenos"> 546</span>                    <span class="nb">setattr</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">op</span><span class="p">))</span>
<span class="linenos"> 547</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_propagate_constants</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<span class="linenos"> 548</span>        <span class="k">return</span> <span class="n">op</span>
<span class="linenos"> 549</span>
<span class="linenos"> 550</span>    <span class="k">def</span> <span class="nf">_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="linenos"> 551</span>        <span class="n">sh</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cst</span><span class="p">,</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Real</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cst</span><span class="o">.</span><span class="n">shape</span>
<span class="linenos"> 552</span>        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;argshift&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="p">,</span> <span class="n">sh</span><span class="p">)</span>
<span class="linenos"> 553</span>
<span class="linenos"> 554</span>    <span class="k">def</span> <span class="nf">_infer_op_klass</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpC</span><span class="p">:</span>
<span class="linenos"> 555</span>        <span class="n">preserved</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos"> 556</span>            <span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">CAN_EVAL</span><span class="p">,</span>
<span class="linenos"> 557</span>            <span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">FUNCTIONAL</span><span class="p">,</span>
<span class="linenos"> 558</span>            <span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">PROXIMABLE</span><span class="p">,</span>
<span class="linenos"> 559</span>            <span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">DIFFERENTIABLE</span><span class="p">,</span>
<span class="linenos"> 560</span>            <span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">DIFFERENTIABLE_FUNCTION</span><span class="p">,</span>
<span class="linenos"> 561</span>            <span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">QUADRATIC</span><span class="p">,</span>
<span class="linenos"> 562</span>        <span class="p">}</span>
<span class="linenos"> 563</span>
<span class="linenos"> 564</span>        <span class="n">properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">properties</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">preserved</span>
<span class="linenos"> 565</span>        <span class="n">klass</span> <span class="o">=</span> <span class="n">pxo</span><span class="o">.</span><span class="n">Operator</span><span class="o">.</span><span class="n">_infer_operator_type</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span>
<span class="linenos"> 566</span>        <span class="k">return</span> <span class="n">klass</span>
<span class="linenos"> 567</span>
<span class="linenos"> 568</span>    <span class="k">def</span> <span class="nf">_infer_op_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpShape</span><span class="p">:</span>
<span class="linenos"> 569</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scalar</span><span class="p">:</span>
<span class="linenos"> 570</span>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">shape</span>
<span class="linenos"> 571</span>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># pxt.NDArray</span>
<span class="linenos"> 572</span>            <span class="n">dim_op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">dim</span>
<span class="linenos"> 573</span>            <span class="n">dim_cst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cst</span><span class="o">.</span><span class="n">size</span>
<span class="linenos"> 574</span>            <span class="k">if</span> <span class="p">(</span><span class="n">dim_op</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">dim_op</span> <span class="o">==</span> <span class="n">dim_cst</span><span class="p">):</span>
<span class="linenos"> 575</span>                <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">codim</span><span class="p">,</span> <span class="n">dim_cst</span><span class="p">)</span>
<span class="linenos"> 576</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 577</span>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shifting </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="si">}</span><span class="s2"> by </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_cst</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> forbidden.&quot;</span><span class="p">)</span>
<span class="linenos"> 578</span>
<span class="linenos"> 579</span>    <span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="s2">&quot;arr&quot;</span><span class="p">)</span>
<span class="linenos"> 580</span>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos"> 581</span>        <span class="n">x</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="linenos"> 582</span>        <span class="n">x</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cst</span>
<span class="linenos"> 583</span>        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="linenos"> 584</span>        <span class="k">return</span> <span class="n">out</span>
<span class="linenos"> 585</span>
<span class="linenos"> 586</span>    <span class="k">def</span> <span class="nf">estimate_lipschitz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Real</span><span class="p">:</span>
<span class="linenos"> 587</span>        <span class="n">no_eval</span> <span class="o">=</span> <span class="s2">&quot;__rule&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span>
<span class="linenos"> 588</span>        <span class="k">if</span> <span class="n">no_eval</span><span class="p">:</span>
<span class="linenos"> 589</span>            <span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">lipschitz</span>
<span class="linenos"> 590</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 591</span>            <span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">estimate_lipschitz</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos"> 592</span>        <span class="k">return</span> <span class="n">L</span>
<span class="linenos"> 593</span>
<span class="linenos"> 594</span>    <span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;arr&quot;</span><span class="p">,</span> <span class="s2">&quot;tau&quot;</span><span class="p">))</span>
<span class="linenos"> 595</span>    <span class="k">def</span> <span class="nf">prox</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">tau</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Real</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos"> 596</span>        <span class="n">x</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="linenos"> 597</span>        <span class="n">x</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cst</span>
<span class="linenos"> 598</span>        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">prox</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span>
<span class="linenos"> 599</span>        <span class="n">out</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cst</span>
<span class="linenos"> 600</span>        <span class="k">return</span> <span class="n">out</span>
<span class="linenos"> 601</span>
<span class="linenos"> 602</span>    <span class="k">def</span> <span class="nf">_quad_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 603</span>        <span class="n">Q1</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">t1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">_quad_spec</span><span class="p">()</span>
<span class="linenos"> 604</span>        <span class="n">Q2</span> <span class="o">=</span> <span class="n">Q1</span>
<span class="linenos"> 605</span>
<span class="linenos"> 606</span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cst</span><span class="p">,</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Real</span><span class="p">):</span>
<span class="linenos"> 607</span>            <span class="kn">from</span> <span class="nn">pyxu.operator.linop.reduce</span> <span class="kn">import</span> <span class="n">Sum</span>
<span class="linenos"> 608</span>
<span class="linenos"> 609</span>            <span class="c1"># backend-agnostic `c2`-term</span>
<span class="linenos"> 610</span>            <span class="n">c2</span> <span class="o">=</span> <span class="n">c1</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cst</span> <span class="o">*</span> <span class="p">(</span><span class="n">Sum</span><span class="p">(</span><span class="n">arg_shape</span><span class="o">=</span><span class="p">(</span><span class="n">Q1</span><span class="o">.</span><span class="n">dim</span><span class="p">,))</span> <span class="o">*</span> <span class="n">Q1</span><span class="p">))</span>
<span class="linenos"> 611</span>
<span class="linenos"> 612</span>            <span class="c1"># Try all backends until one lets you compute `t2`.</span>
<span class="linenos"> 613</span>            <span class="c1"># (Reason: We cannot infer the backend of an operator from its public API.)</span>
<span class="linenos"> 614</span>            <span class="n">t2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="linenos"> 615</span>            <span class="k">for</span> <span class="n">xp</span> <span class="ow">in</span> <span class="n">pxd</span><span class="o">.</span><span class="n">supported_array_modules</span><span class="p">():</span>
<span class="linenos"> 616</span>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">t2</span><span class="p">):</span>
<span class="linenos"> 617</span>                    <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 618</span>                        <span class="n">cst</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cst</span><span class="p">,</span> <span class="n">Q1</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>
<span class="linenos"> 619</span>                        <span class="n">t2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">cst</span><span class="p">))</span>
<span class="linenos"> 620</span>                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos"> 621</span>                        <span class="k">pass</span>
<span class="linenos"> 622</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 623</span>            <span class="n">c2</span> <span class="o">=</span> <span class="n">c1</span> <span class="o">+</span> <span class="n">pxo</span><span class="o">.</span><span class="n">LinFunc</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span>
<span class="linenos"> 624</span>                <span class="n">Q1</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cst</span><span class="p">),</span>
<span class="linenos"> 625</span>                <span class="n">enable_warnings</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos"> 626</span>                <span class="c1"># [enable_warnings] API users have no reason to call _quad_spec().</span>
<span class="linenos"> 627</span>                <span class="c1"># If they choose to use `c2`, then we assume they know what they are doing.</span>
<span class="linenos"> 628</span>            <span class="p">)</span>
<span class="linenos"> 629</span>            <span class="n">t2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cst</span><span class="p">))</span>
<span class="linenos"> 630</span>
<span class="linenos"> 631</span>        <span class="k">return</span> <span class="p">(</span><span class="n">Q2</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
<span class="linenos"> 632</span>
<span class="linenos"> 633</span>    <span class="k">def</span> <span class="nf">jacobian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">:</span>
<span class="linenos"> 634</span>        <span class="n">x</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="linenos"> 635</span>        <span class="n">x</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cst</span>
<span class="linenos"> 636</span>        <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="linenos"> 637</span>        <span class="k">return</span> <span class="n">op</span>
<span class="linenos"> 638</span>
<span class="linenos"> 639</span>    <span class="k">def</span> <span class="nf">estimate_diff_lipschitz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Real</span><span class="p">:</span>
<span class="linenos"> 640</span>        <span class="n">no_eval</span> <span class="o">=</span> <span class="s2">&quot;__rule&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span>
<span class="linenos"> 641</span>        <span class="k">if</span> <span class="n">no_eval</span><span class="p">:</span>
<span class="linenos"> 642</span>            <span class="n">dL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">diff_lipschitz</span>
<span class="linenos"> 643</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 644</span>            <span class="n">dL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">estimate_diff_lipschitz</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos"> 645</span>        <span class="k">return</span> <span class="n">dL</span>
<span class="linenos"> 646</span>
<span class="linenos"> 647</span>    <span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="s2">&quot;arr&quot;</span><span class="p">)</span>
<span class="linenos"> 648</span>    <span class="k">def</span> <span class="nf">grad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos"> 649</span>        <span class="n">x</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="linenos"> 650</span>        <span class="n">x</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cst</span>
<span class="linenos"> 651</span>        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="linenos"> 652</span>        <span class="k">return</span> <span class="n">out</span>
<span class="linenos"> 653</span>
<span class="linenos"> 654</span>    <span class="k">def</span> <span class="nf">asloss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">:</span>
<span class="linenos"> 655</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">FUNCTIONAL</span><span class="p">):</span>
<span class="linenos"> 656</span>            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
<span class="linenos"> 657</span>                <span class="p">[</span>
<span class="linenos"> 658</span>                    <span class="s2">&quot;The meaning of op.argshift().asloss() is ambiguous.&quot;</span><span class="p">,</span>
<span class="linenos"> 659</span>                    <span class="s2">&quot;Rewrite the expression differently to clarify the intent.&quot;</span><span class="p">,</span>
<span class="linenos"> 660</span>                <span class="p">]</span>
<span class="linenos"> 661</span>            <span class="p">)</span>
<span class="linenos"> 662</span>            <span class="k">raise</span> <span class="ne">ArithmeticError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="linenos"> 663</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 664</span>            <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<span class="linenos"> 665</span>
<span class="linenos"> 666</span>
<div class="viewcode-block" id="AddRule">
<a class="viewcode-back" href="../../../api/abc.html#pyxu.abc.arithmetic.AddRule">[docs]</a>
<span class="linenos"> 667</span><span class="k">class</span> <span class="nc">AddRule</span><span class="p">(</span><span class="n">Rule</span><span class="p">):</span>
<span class="linenos"> 668</span><span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 669</span><span class="sd">    The output type of ``AddRule(A.squeeze(), B.squeeze())`` is summarized in the table below (LHS/RHS</span>
<span class="linenos"> 670</span><span class="sd">    commute)::</span>
<span class="linenos"> 671</span>
<span class="linenos"> 672</span><span class="sd">        |---------------|-----|------|---------|----------|----------|--------------|-----------|---------|--------------|------------|------------|------------|---------------|---------------|------------|---------------|</span>
<span class="linenos"> 673</span><span class="sd">        |   LHS / RHS   | Map | Func | DiffMap | DiffFunc | ProxFunc | ProxDiffFunc | Quadratic |  LinOp  |   LinFunc    |  SquareOp  |  NormalOp  |   UnitOp   | SelfAdjointOp |    PosDefOp   |   ProjOp   |   OrthProjOp  |</span>
<span class="linenos"> 674</span><span class="sd">        |---------------|-----|------|---------|----------|----------|--------------|-----------|---------|--------------|------------|------------|------------|---------------|---------------|------------|---------------|</span>
<span class="linenos"> 675</span><span class="sd">        | Map           | Map | Map  | Map     | Map      | Map      | Map          | Map       | Map     | Map          | Map        | Map        | Map        | Map           | Map           | Map        | Map           |</span>
<span class="linenos"> 676</span><span class="sd">        | Func          |     | Func | Map     | Func     | Func     | Func         | Func      | Map     | Func         | Map        | Map        | Map        | Map           | Map           | Map        | Map           |</span>
<span class="linenos"> 677</span><span class="sd">        | DiffMap       |     |      | DiffMap | DiffMap  | Map      | DiffMap      | DiffMap   | DiffMap | DiffMap      | DiffMap    | DiffMap    | DiffMap    | DiffMap       | DiffMap       | DiffMap    | DiffMap       |</span>
<span class="linenos"> 678</span><span class="sd">        | DiffFunc      |     |      |         | DiffFunc | Func     | DiffFunc     | DiffFunc  | DiffMap | DiffFunc     | DiffMap    | DiffMap    | DiffMap    | DiffMap       | DiffMap       | DiffMap    | DiffMap       |</span>
<span class="linenos"> 679</span><span class="sd">        | ProxFunc      |     |      |         |          | Func     | Func         | Func      | Map     | ProxFunc     | Map        | Map        | Map        | Map           | Map           | Map        | Map           |</span>
<span class="linenos"> 680</span><span class="sd">        | ProxDiffFunc  |     |      |         |          |          | DiffFunc     | DiffFunc  | DiffMap | ProxDiffFunc | DiffMap    | DiffMap    | DiffMap    | DiffMap       | DiffMap       | DiffMap    | DiffMap       |</span>
<span class="linenos"> 681</span><span class="sd">        | Quadratic     |     |      |         |          |          |              | Quadratic | DiffMap | Quadratic    | DiffMap    | DiffMap    | DiffMap    | DiffMap       | DiffMap       | DiffMap    | DiffMap       |</span>
<span class="linenos"> 682</span><span class="sd">        | LinOp         |     |      |         |          |          |              |           | LinOp   | LinOp        | IMPOSSIBLE | IMPOSSIBLE | IMPOSSIBLE | IMPOSSIBLE    | IMPOSSIBLE    | IMPOSSIBLE | IMPOSSIBLE    |</span>
<span class="linenos"> 683</span><span class="sd">        | LinFunc       |     |      |         |          |          |              |           |         | LinFunc      | SquareOp   | SquareOp   | SquareOp   | SquareOp      | SquareOp      | SquareOp   | SquareOp      |</span>
<span class="linenos"> 684</span><span class="sd">        | SquareOp      |     |      |         |          |          |              |           |         |              | SquareOp   | SquareOp   | SquareOp   | SquareOp      | SquareOp      | SquareOp   | SquareOp      |</span>
<span class="linenos"> 685</span><span class="sd">        | NormalOp      |     |      |         |          |          |              |           |         |              |            | SquareOp   | SquareOp   | SquareOp      | SquareOp      | SquareOp   | SquareOp      |</span>
<span class="linenos"> 686</span><span class="sd">        | UnitOp        |     |      |         |          |          |              |           |         |              |            |            | SquareOp   | SquareOp      | SquareOp      | SquareOp   | SquareOp      |</span>
<span class="linenos"> 687</span><span class="sd">        | SelfAdjointOp |     |      |         |          |          |              |           |         |              |            |            |            | SelfAdjointOp | SelfAdjointOp | SquareOp   | SelfAdjointOp |</span>
<span class="linenos"> 688</span><span class="sd">        | PosDefOp      |     |      |         |          |          |              |           |         |              |            |            |            |               | PosDefOp      | SquareOp   | PosDefOp      |</span>
<span class="linenos"> 689</span><span class="sd">        | ProjOp        |     |      |         |          |          |              |           |         |              |            |            |            |               |               | SquareOp   | SquareOp      |</span>
<span class="linenos"> 690</span><span class="sd">        | OrthProjOp    |     |      |         |          |          |              |           |         |              |            |            |            |               |               |            | SelfAdjointOp |</span>
<span class="linenos"> 691</span><span class="sd">        |---------------|-----|------|---------|----------|----------|--------------|-----------|---------|--------------|------------|------------|------------|---------------|---------------|------------|---------------|</span>
<span class="linenos"> 692</span>
<span class="linenos"> 693</span><span class="sd">    Arithmetic Update Rule(s)::</span>
<span class="linenos"> 694</span>
<span class="linenos"> 695</span><span class="sd">        * CAN_EVAL</span>
<span class="linenos"> 696</span><span class="sd">            op.apply(arr) = _lhs.apply(arr) + _rhs.apply(arr)</span>
<span class="linenos"> 697</span><span class="sd">            op.lipschitz = _lhs.lipschitz + _rhs.lipschitz</span>
<span class="linenos"> 698</span><span class="sd">            IMPORTANT: if range-broadcasting takes place (ex: LHS(1,) + RHS(M,)), then the broadcasted</span>
<span class="linenos"> 699</span><span class="sd">                       operand&#39;s Lipschitz constant must be magnified by \sqrt{M}.</span>
<span class="linenos"> 700</span>
<span class="linenos"> 701</span><span class="sd">        * FUNCTIONAL</span>
<span class="linenos"> 702</span><span class="sd">            op.asloss(\beta) = _lhs.asloss(\beta) + _rhs.asloss(\beta)</span>
<span class="linenos"> 703</span><span class="sd">                               may be ambiguous -&gt; warning</span>
<span class="linenos"> 704</span>
<span class="linenos"> 705</span><span class="sd">        * PROXIMABLE</span>
<span class="linenos"> 706</span><span class="sd">            op.prox(arr, tau) = _lhs.prox(arr - tau * _rhs.grad(arr), tau)</span>
<span class="linenos"> 707</span><span class="sd">                          OR  = _rhs.prox(arr - tau * _lhs.grad(arr), tau)</span>
<span class="linenos"> 708</span><span class="sd">                IMPORTANT: the one calling .grad() should be either (lhs, rhs) which has LINEAR property</span>
<span class="linenos"> 709</span>
<span class="linenos"> 710</span><span class="sd">        * DIFFERENTIABLE</span>
<span class="linenos"> 711</span><span class="sd">            op.jacobian(arr) = _lhs.jacobian(arr) + _rhs.jacobian(arr)</span>
<span class="linenos"> 712</span><span class="sd">            op.diff_lipschitz = _lhs.diff_lipschitz + _rhs.diff_lipschitz</span>
<span class="linenos"> 713</span><span class="sd">            IMPORTANT: if range-broadcasting takes place (ex: LHS(1,) + RHS(M,)), then the broadcasted</span>
<span class="linenos"> 714</span><span class="sd">                       operand&#39;s diff-Lipschitz constant must be magnified by \sqrt{M}.</span>
<span class="linenos"> 715</span>
<span class="linenos"> 716</span><span class="sd">        * DIFFERENTIABLE_FUNCTION</span>
<span class="linenos"> 717</span><span class="sd">            op.grad(arr) = _lhs.grad(arr) + _rhs.grad(arr)</span>
<span class="linenos"> 718</span>
<span class="linenos"> 719</span><span class="sd">        * LINEAR</span>
<span class="linenos"> 720</span><span class="sd">            op.adjoint(arr) = _lhs.adjoint(arr) + _rhs.adjoint(arr)</span>
<span class="linenos"> 721</span><span class="sd">            IMPORTANT: if range-broadcasting takes place (ex: LHS(1,) + RHS(M,)), then the broadcasted</span>
<span class="linenos"> 722</span><span class="sd">                       operand&#39;s adjoint-input must be averaged.</span>
<span class="linenos"> 723</span><span class="sd">            op.asarray() = _lhs.asarray() + _rhs.asarray()</span>
<span class="linenos"> 724</span><span class="sd">            op.gram() = _lhs.gram() + _rhs.gram() + (_lhs.T * _rhs) + (_rhs.T * _lhs)</span>
<span class="linenos"> 725</span><span class="sd">            op.cogram() = _lhs.cogram() + _rhs.cogram() + (_lhs * _rhs.T) + (_rhs * _lhs.T)</span>
<span class="linenos"> 726</span>
<span class="linenos"> 727</span><span class="sd">        * LINEAR_SQUARE</span>
<span class="linenos"> 728</span><span class="sd">            op.trace() = _lhs.trace() + _rhs.trace()</span>
<span class="linenos"> 729</span>
<span class="linenos"> 730</span><span class="sd">        * QUADRATIC</span>
<span class="linenos"> 731</span><span class="sd">            lhs = rhs = quadratic</span>
<span class="linenos"> 732</span><span class="sd">              Q_l, c_l, t_l = lhs._quad_spec()</span>
<span class="linenos"> 733</span><span class="sd">              Q_r, c_r, t_r = rhs._quad_spec()</span>
<span class="linenos"> 734</span><span class="sd">              op._quad_spec() = (Q_l + Q_r, c_l + c_r, t_l + t_r)</span>
<span class="linenos"> 735</span><span class="sd">            lhs, rhs = quadratic, linear</span>
<span class="linenos"> 736</span><span class="sd">              Q, c, t = lhs._quad_spec()</span>
<span class="linenos"> 737</span><span class="sd">              op._quad_spec() = (Q, c + rhs, t)</span>
<span class="linenos"> 738</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 739</span>
<span class="linenos"> 740</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lhs</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">,</span> <span class="n">rhs</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">):</span>
<span class="linenos"> 741</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<span class="linenos"> 742</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span> <span class="o">=</span> <span class="n">lhs</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="linenos"> 743</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span> <span class="o">=</span> <span class="n">rhs</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="linenos"> 744</span>
<span class="linenos"> 745</span>    <span class="k">def</span> <span class="nf">op</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">:</span>
<span class="linenos"> 746</span>        <span class="n">sh_op</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">infer_sum_shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="linenos"> 747</span>        <span class="n">klass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infer_op_klass</span><span class="p">()</span>
<span class="linenos"> 748</span>        <span class="k">if</span> <span class="n">klass</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">QUADRATIC</span><span class="p">):</span>
<span class="linenos"> 749</span>            <span class="c1"># Quadratic additive arithmetic differs substantially from other arithmetic operations.</span>
<span class="linenos"> 750</span>            <span class="c1"># To avoid tedious redefinitions of arithmetic methods to handle QuadraticFunc</span>
<span class="linenos"> 751</span>            <span class="c1"># specifically, the code-path below delegates additive arithmetic directly to</span>
<span class="linenos"> 752</span>            <span class="c1"># QuadraticFunc.</span>
<span class="linenos"> 753</span>            <span class="n">lin</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">_</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">)</span>
<span class="linenos"> 754</span>            <span class="n">quad</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">_</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">QUADRATIC</span><span class="p">)</span>
<span class="linenos"> 755</span>
<span class="linenos"> 756</span>            <span class="k">if</span> <span class="n">quad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="p">)</span> <span class="ow">and</span> <span class="n">quad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="p">):</span>
<span class="linenos"> 757</span>                <span class="n">lQ</span><span class="p">,</span> <span class="n">lc</span><span class="p">,</span> <span class="n">lt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">_quad_spec</span><span class="p">()</span>
<span class="linenos"> 758</span>                <span class="n">rQ</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">rt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">_quad_spec</span><span class="p">()</span>
<span class="linenos"> 759</span>                <span class="n">op</span> <span class="o">=</span> <span class="n">klass</span><span class="p">(</span>
<span class="linenos"> 760</span>                    <span class="n">shape</span><span class="o">=</span><span class="n">sh_op</span><span class="p">,</span>
<span class="linenos"> 761</span>                    <span class="n">Q</span><span class="o">=</span><span class="n">lQ</span> <span class="o">+</span> <span class="n">rQ</span><span class="p">,</span>
<span class="linenos"> 762</span>                    <span class="n">c</span><span class="o">=</span><span class="n">lc</span> <span class="o">+</span> <span class="n">rc</span><span class="p">,</span>
<span class="linenos"> 763</span>                    <span class="n">t</span><span class="o">=</span><span class="n">lt</span> <span class="o">+</span> <span class="n">rt</span><span class="p">,</span>
<span class="linenos"> 764</span>                <span class="p">)</span>
<span class="linenos"> 765</span>            <span class="k">elif</span> <span class="n">quad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="p">)</span> <span class="ow">and</span> <span class="n">lin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="p">):</span>
<span class="linenos"> 766</span>                <span class="n">lQ</span><span class="p">,</span> <span class="n">lc</span><span class="p">,</span> <span class="n">lt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">_quad_spec</span><span class="p">()</span>
<span class="linenos"> 767</span>                <span class="n">op</span> <span class="o">=</span> <span class="n">klass</span><span class="p">(</span>
<span class="linenos"> 768</span>                    <span class="n">shape</span><span class="o">=</span><span class="n">sh_op</span><span class="p">,</span>
<span class="linenos"> 769</span>                    <span class="n">Q</span><span class="o">=</span><span class="n">lQ</span><span class="p">,</span>
<span class="linenos"> 770</span>                    <span class="n">c</span><span class="o">=</span><span class="n">lc</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="p">,</span>
<span class="linenos"> 771</span>                    <span class="n">t</span><span class="o">=</span><span class="n">lt</span><span class="p">,</span>
<span class="linenos"> 772</span>                <span class="p">)</span>
<span class="linenos"> 773</span>            <span class="k">elif</span> <span class="n">lin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="p">)</span> <span class="ow">and</span> <span class="n">quad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="p">):</span>
<span class="linenos"> 774</span>                <span class="n">rQ</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">rt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">_quad_spec</span><span class="p">()</span>
<span class="linenos"> 775</span>                <span class="n">op</span> <span class="o">=</span> <span class="n">klass</span><span class="p">(</span>
<span class="linenos"> 776</span>                    <span class="n">shape</span><span class="o">=</span><span class="n">sh_op</span><span class="p">,</span>
<span class="linenos"> 777</span>                    <span class="n">Q</span><span class="o">=</span><span class="n">rQ</span><span class="p">,</span>
<span class="linenos"> 778</span>                    <span class="n">c</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span> <span class="o">+</span> <span class="n">rc</span><span class="p">,</span>
<span class="linenos"> 779</span>                    <span class="n">t</span><span class="o">=</span><span class="n">rt</span><span class="p">,</span>
<span class="linenos"> 780</span>                <span class="p">)</span>
<span class="linenos"> 781</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 782</span>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Impossible scenario: something went wrong during klass inference.&quot;</span><span class="p">)</span>
<span class="linenos"> 783</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 784</span>            <span class="n">op</span> <span class="o">=</span> <span class="n">klass</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">sh_op</span><span class="p">)</span>
<span class="linenos"> 785</span>            <span class="n">op</span><span class="o">.</span><span class="n">_lhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span>  <span class="c1"># embed for introspection</span>
<span class="linenos"> 786</span>            <span class="n">op</span><span class="o">.</span><span class="n">_rhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span>  <span class="c1"># embed for introspection</span>
<span class="linenos"> 787</span>            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">op</span><span class="o">.</span><span class="n">properties</span><span class="p">():</span>
<span class="linenos"> 788</span>                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">arithmetic_methods</span><span class="p">():</span>
<span class="linenos"> 789</span>                    <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
<span class="linenos"> 790</span>                    <span class="nb">setattr</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">op</span><span class="p">))</span>
<span class="linenos"> 791</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_propagate_constants</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<span class="linenos"> 792</span>        <span class="k">return</span> <span class="n">op</span>
<span class="linenos"> 793</span>
<span class="linenos"> 794</span>    <span class="k">def</span> <span class="nf">_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="linenos"> 795</span>        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;add&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="p">)</span>
<span class="linenos"> 796</span>
<span class="linenos"> 797</span>    <span class="k">def</span> <span class="nf">_infer_op_klass</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpC</span><span class="p">:</span>
<span class="linenos"> 798</span>        <span class="n">P</span> <span class="o">=</span> <span class="n">pxo</span><span class="o">.</span><span class="n">Property</span>
<span class="linenos"> 799</span>        <span class="n">lhs_p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">properties</span><span class="p">()</span>
<span class="linenos"> 800</span>        <span class="n">rhs_p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">properties</span><span class="p">()</span>
<span class="linenos"> 801</span>        <span class="n">base</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">lhs_p</span> <span class="o">&amp;</span> <span class="n">rhs_p</span><span class="p">)</span>
<span class="linenos"> 802</span>        <span class="n">base</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">LINEAR_NORMAL</span><span class="p">)</span>
<span class="linenos"> 803</span>        <span class="n">base</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">LINEAR_UNITARY</span><span class="p">)</span>
<span class="linenos"> 804</span>        <span class="n">base</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">LINEAR_IDEMPOTENT</span><span class="p">)</span>
<span class="linenos"> 805</span>        <span class="n">base</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">PROXIMABLE</span><span class="p">)</span>
<span class="linenos"> 806</span>
<span class="linenos"> 807</span>        <span class="c1"># Exceptions ----------------------------------------------------------</span>
<span class="linenos"> 808</span>        <span class="c1"># normality preserved for self-adjoint addition</span>
<span class="linenos"> 809</span>        <span class="k">if</span> <span class="n">P</span><span class="o">.</span><span class="n">LINEAR_SELF_ADJOINT</span> <span class="ow">in</span> <span class="n">base</span><span class="p">:</span>
<span class="linenos"> 810</span>            <span class="n">base</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">LINEAR_NORMAL</span><span class="p">)</span>
<span class="linenos"> 811</span>
<span class="linenos"> 812</span>        <span class="c1"># orth-proj + pos-def =&gt; pos-def</span>
<span class="linenos"> 813</span>        <span class="k">if</span> <span class="p">(({</span><span class="n">P</span><span class="o">.</span><span class="n">LINEAR_IDEMPOTENT</span><span class="p">,</span> <span class="n">P</span><span class="o">.</span><span class="n">LINEAR_SELF_ADJOINT</span><span class="p">}</span> <span class="o">&lt;</span> <span class="n">lhs_p</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">LINEAR_POSITIVE_DEFINITE</span> <span class="ow">in</span> <span class="n">rhs_p</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span>
<span class="linenos"> 814</span>            <span class="p">({</span><span class="n">P</span><span class="o">.</span><span class="n">LINEAR_IDEMPOTENT</span><span class="p">,</span> <span class="n">P</span><span class="o">.</span><span class="n">LINEAR_SELF_ADJOINT</span><span class="p">}</span> <span class="o">&lt;</span> <span class="n">rhs_p</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">LINEAR_POSITIVE_DEFINITE</span> <span class="ow">in</span> <span class="n">lhs_p</span><span class="p">)</span>
<span class="linenos"> 815</span>        <span class="p">):</span>
<span class="linenos"> 816</span>            <span class="n">base</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">LINEAR_SQUARE</span><span class="p">)</span>
<span class="linenos"> 817</span>            <span class="n">base</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">LINEAR_NORMAL</span><span class="p">)</span>
<span class="linenos"> 818</span>            <span class="n">base</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">LINEAR_SELF_ADJOINT</span><span class="p">)</span>
<span class="linenos"> 819</span>            <span class="n">base</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">LINEAR_POSITIVE_DEFINITE</span><span class="p">)</span>
<span class="linenos"> 820</span>
<span class="linenos"> 821</span>        <span class="c1"># linfunc + (square-shape) =&gt; square</span>
<span class="linenos"> 822</span>        <span class="k">if</span> <span class="n">P</span><span class="o">.</span><span class="n">LINEAR</span> <span class="ow">in</span> <span class="n">base</span><span class="p">:</span>
<span class="linenos"> 823</span>            <span class="n">sh</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">infer_sum_shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="linenos"> 824</span>            <span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">sh</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
<span class="linenos"> 825</span>                <span class="n">base</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">LINEAR_SQUARE</span><span class="p">)</span>
<span class="linenos"> 826</span>
<span class="linenos"> 827</span>        <span class="c1"># quadratic + quadratic =&gt; quadratic</span>
<span class="linenos"> 828</span>        <span class="k">if</span> <span class="n">P</span><span class="o">.</span><span class="n">QUADRATIC</span> <span class="ow">in</span> <span class="n">base</span><span class="p">:</span>
<span class="linenos"> 829</span>            <span class="n">base</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">PROXIMABLE</span><span class="p">)</span>
<span class="linenos"> 830</span>
<span class="linenos"> 831</span>        <span class="c1"># quadratic + linfunc =&gt; quadratic</span>
<span class="linenos"> 832</span>        <span class="k">if</span> <span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">PROXIMABLE</span> <span class="ow">in</span> <span class="p">(</span><span class="n">lhs_p</span> <span class="o">&amp;</span> <span class="n">rhs_p</span><span class="p">))</span> <span class="ow">and</span> <span class="p">({</span><span class="n">P</span><span class="o">.</span><span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">P</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">}</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">lhs_p</span> <span class="o">|</span> <span class="n">rhs_p</span><span class="p">)):</span>
<span class="linenos"> 833</span>            <span class="n">base</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">QUADRATIC</span><span class="p">)</span>
<span class="linenos"> 834</span>
<span class="linenos"> 835</span>        <span class="c1"># prox(-diff) + linfunc =&gt; prox(-diff)</span>
<span class="linenos"> 836</span>        <span class="k">if</span> <span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">PROXIMABLE</span> <span class="ow">in</span> <span class="p">(</span><span class="n">lhs_p</span> <span class="o">&amp;</span> <span class="n">rhs_p</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">LINEAR</span> <span class="ow">in</span> <span class="p">(</span><span class="n">lhs_p</span> <span class="o">|</span> <span class="n">rhs_p</span><span class="p">)):</span>
<span class="linenos"> 837</span>            <span class="n">base</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">PROXIMABLE</span><span class="p">)</span>
<span class="linenos"> 838</span>
<span class="linenos"> 839</span>        <span class="n">klass</span> <span class="o">=</span> <span class="n">pxo</span><span class="o">.</span><span class="n">Operator</span><span class="o">.</span><span class="n">_infer_operator_type</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
<span class="linenos"> 840</span>        <span class="k">return</span> <span class="n">klass</span>
<span class="linenos"> 841</span>
<span class="linenos"> 842</span>    <span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="s2">&quot;arr&quot;</span><span class="p">)</span>
<span class="linenos"> 843</span>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos"> 844</span>        <span class="c1"># ranges may broadcast, so can&#39;t do in-place updates.</span>
<span class="linenos"> 845</span>        <span class="n">out_lhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="linenos"> 846</span>        <span class="n">out_rhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="linenos"> 847</span>        <span class="n">out</span> <span class="o">=</span> <span class="n">out_lhs</span> <span class="o">+</span> <span class="n">out_rhs</span>
<span class="linenos"> 848</span>        <span class="k">return</span> <span class="n">out</span>
<span class="linenos"> 849</span>
<span class="linenos"> 850</span>    <span class="k">def</span> <span class="nf">estimate_lipschitz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Real</span><span class="p">:</span>
<span class="linenos"> 851</span>        <span class="n">no_eval</span> <span class="o">=</span> <span class="s2">&quot;__rule&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span>
<span class="linenos"> 852</span>        <span class="k">if</span> <span class="n">no_eval</span><span class="p">:</span>
<span class="linenos"> 853</span>            <span class="n">L_lhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">lipschitz</span>
<span class="linenos"> 854</span>            <span class="n">L_rhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">lipschitz</span>
<span class="linenos"> 855</span>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">):</span>
<span class="linenos"> 856</span>            <span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">estimate_lipschitz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos"> 857</span>            <span class="k">return</span> <span class="n">L</span>
<span class="linenos"> 858</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 859</span>            <span class="n">L_lhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">estimate_lipschitz</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos"> 860</span>            <span class="n">L_rhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">estimate_lipschitz</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos"> 861</span>
<span class="linenos"> 862</span>        <span class="c1"># Account for broadcasting</span>
<span class="linenos"> 863</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">codim</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">codim</span><span class="p">:</span>
<span class="linenos"> 864</span>            <span class="c1"># LHS broadcasts</span>
<span class="linenos"> 865</span>            <span class="n">L_lhs</span> <span class="o">=</span> <span class="n">L_lhs</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">codim</span><span class="p">)</span>
<span class="linenos"> 866</span>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">codim</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">codim</span><span class="p">:</span>
<span class="linenos"> 867</span>            <span class="c1"># RHS broadcasts</span>
<span class="linenos"> 868</span>            <span class="n">L_rhs</span> <span class="o">=</span> <span class="n">L_rhs</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">codim</span><span class="p">)</span>
<span class="linenos"> 869</span>
<span class="linenos"> 870</span>        <span class="n">L</span> <span class="o">=</span> <span class="n">L_lhs</span> <span class="o">+</span> <span class="n">L_rhs</span>
<span class="linenos"> 871</span>        <span class="k">return</span> <span class="n">L</span>
<span class="linenos"> 872</span>
<span class="linenos"> 873</span>    <span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;arr&quot;</span><span class="p">,</span> <span class="s2">&quot;tau&quot;</span><span class="p">))</span>
<span class="linenos"> 874</span>    <span class="k">def</span> <span class="nf">prox</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">tau</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Real</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos"> 875</span>        <span class="n">P_LHS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">properties</span><span class="p">()</span>
<span class="linenos"> 876</span>        <span class="n">P_RHS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">properties</span><span class="p">()</span>
<span class="linenos"> 877</span>        <span class="k">if</span> <span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">LINEAR</span> <span class="ow">in</span> <span class="p">(</span><span class="n">P_LHS</span> <span class="o">|</span> <span class="n">P_RHS</span><span class="p">):</span>
<span class="linenos"> 878</span>            <span class="c1"># linear + proximable</span>
<span class="linenos"> 879</span>            <span class="k">if</span> <span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">LINEAR</span> <span class="ow">in</span> <span class="n">P_LHS</span><span class="p">:</span>
<span class="linenos"> 880</span>                <span class="n">P</span><span class="p">,</span> <span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span>
<span class="linenos"> 881</span>            <span class="k">elif</span> <span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">LINEAR</span> <span class="ow">in</span> <span class="n">P_RHS</span><span class="p">:</span>
<span class="linenos"> 882</span>                <span class="n">P</span><span class="p">,</span> <span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span>
<span class="linenos"> 883</span>            <span class="n">x</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">copy_if_unsafe</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">arr</span><span class="p">))</span>
<span class="linenos"> 884</span>            <span class="n">x</span> <span class="o">*=</span> <span class="o">-</span><span class="n">tau</span>
<span class="linenos"> 885</span>            <span class="n">x</span> <span class="o">+=</span> <span class="n">arr</span>
<span class="linenos"> 886</span>            <span class="n">out</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">prox</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span>
<span class="linenos"> 887</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 888</span>            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
<span class="linenos"> 889</span>        <span class="k">return</span> <span class="n">out</span>
<span class="linenos"> 890</span>
<span class="linenos"> 891</span>    <span class="k">def</span> <span class="nf">jacobian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">:</span>
<span class="linenos"> 892</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">):</span>
<span class="linenos"> 893</span>            <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span>
<span class="linenos"> 894</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 895</span>            <span class="n">op_lhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="linenos"> 896</span>            <span class="n">op_rhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="linenos"> 897</span>            <span class="n">op</span> <span class="o">=</span> <span class="n">op_lhs</span> <span class="o">+</span> <span class="n">op_rhs</span>
<span class="linenos"> 898</span>        <span class="k">return</span> <span class="n">op</span>
<span class="linenos"> 899</span>
<span class="linenos"> 900</span>    <span class="k">def</span> <span class="nf">estimate_diff_lipschitz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Real</span><span class="p">:</span>
<span class="linenos"> 901</span>        <span class="n">no_eval</span> <span class="o">=</span> <span class="s2">&quot;__rule&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span>
<span class="linenos"> 902</span>        <span class="k">if</span> <span class="n">no_eval</span><span class="p">:</span>
<span class="linenos"> 903</span>            <span class="n">dL_lhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">diff_lipschitz</span>
<span class="linenos"> 904</span>            <span class="n">dL_rhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">diff_lipschitz</span>
<span class="linenos"> 905</span>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">):</span>
<span class="linenos"> 906</span>            <span class="n">dL_lhs</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 907</span>            <span class="n">dL_rhs</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 908</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 909</span>            <span class="n">dL_lhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">estimate_diff_lipschitz</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos"> 910</span>            <span class="n">dL_rhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">estimate_diff_lipschitz</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos"> 911</span>
<span class="linenos"> 912</span>        <span class="c1"># Account for broadcasting</span>
<span class="linenos"> 913</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">codim</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">codim</span><span class="p">:</span>
<span class="linenos"> 914</span>            <span class="c1"># LHS broadcasts</span>
<span class="linenos"> 915</span>            <span class="n">dL_lhs</span> <span class="o">=</span> <span class="n">dL_lhs</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">codim</span><span class="p">)</span>
<span class="linenos"> 916</span>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">codim</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">codim</span><span class="p">:</span>
<span class="linenos"> 917</span>            <span class="c1"># RHS broadcasts</span>
<span class="linenos"> 918</span>            <span class="n">dL_rhs</span> <span class="o">=</span> <span class="n">dL_rhs</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">codim</span><span class="p">)</span>
<span class="linenos"> 919</span>
<span class="linenos"> 920</span>        <span class="n">dL</span> <span class="o">=</span> <span class="n">dL_lhs</span> <span class="o">+</span> <span class="n">dL_rhs</span>
<span class="linenos"> 921</span>        <span class="k">return</span> <span class="n">dL</span>
<span class="linenos"> 922</span>
<span class="linenos"> 923</span>    <span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="s2">&quot;arr&quot;</span><span class="p">)</span>
<span class="linenos"> 924</span>    <span class="k">def</span> <span class="nf">grad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos"> 925</span>        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="linenos"> 926</span>        <span class="n">out</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">copy_if_unsafe</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="linenos"> 927</span>        <span class="n">out</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="linenos"> 928</span>        <span class="k">return</span> <span class="n">out</span>
<span class="linenos"> 929</span>
<span class="linenos"> 930</span>    <span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="s2">&quot;arr&quot;</span><span class="p">)</span>
<span class="linenos"> 931</span>    <span class="k">def</span> <span class="nf">adjoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos"> 932</span>        <span class="n">arr_lhs</span> <span class="o">=</span> <span class="n">arr_rhs</span> <span class="o">=</span> <span class="n">arr</span>
<span class="linenos"> 933</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">codim</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">codim</span><span class="p">:</span>
<span class="linenos"> 934</span>            <span class="c1"># LHS broadcasts</span>
<span class="linenos"> 935</span>            <span class="n">arr_lhs</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 936</span>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">codim</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">codim</span><span class="p">:</span>
<span class="linenos"> 937</span>            <span class="c1"># RHS broadcasts</span>
<span class="linenos"> 938</span>            <span class="n">arr_rhs</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 939</span>
<span class="linenos"> 940</span>        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">adjoint</span><span class="p">(</span><span class="n">arr_lhs</span><span class="p">)</span>
<span class="linenos"> 941</span>        <span class="n">out</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">copy_if_unsafe</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="linenos"> 942</span>        <span class="n">out</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">adjoint</span><span class="p">(</span><span class="n">arr_rhs</span><span class="p">)</span>
<span class="linenos"> 943</span>        <span class="k">return</span> <span class="n">out</span>
<span class="linenos"> 944</span>
<span class="linenos"> 945</span>    <span class="k">def</span> <span class="nf">asarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos"> 946</span>        <span class="c1"># broadcast may be involved, so can&#39;t do in-place updates.</span>
<span class="linenos"> 947</span>        <span class="n">A_lhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos"> 948</span>        <span class="n">A_rhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos"> 949</span>        <span class="n">A</span> <span class="o">=</span> <span class="n">A_lhs</span> <span class="o">+</span> <span class="n">A_rhs</span>
<span class="linenos"> 950</span>        <span class="k">return</span> <span class="n">A</span>
<span class="linenos"> 951</span>
<span class="linenos"> 952</span>    <span class="k">def</span> <span class="nf">gram</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">:</span>
<span class="linenos"> 953</span>        <span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span>
<span class="linenos"> 954</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">codim</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">codim</span><span class="p">:</span>
<span class="linenos"> 955</span>            <span class="c1"># No broadcasting</span>
<span class="linenos"> 956</span>            <span class="n">lhs_F</span> <span class="o">=</span> <span class="n">rhs_F</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos"> 957</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 958</span>            <span class="c1"># Broadcasting</span>
<span class="linenos"> 959</span>            <span class="n">lhs_F</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">FUNCTIONAL</span><span class="p">)</span>
<span class="linenos"> 960</span>            <span class="n">rhs_F</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">FUNCTIONAL</span><span class="p">)</span>
<span class="linenos"> 961</span>            <span class="k">if</span> <span class="n">lhs_F</span><span class="p">:</span>
<span class="linenos"> 962</span>                <span class="n">lhs</span> <span class="o">=</span> <span class="n">_Sum</span><span class="p">(</span><span class="n">M</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">codim</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span>
<span class="linenos"> 963</span>            <span class="k">if</span> <span class="n">rhs_F</span><span class="p">:</span>
<span class="linenos"> 964</span>                <span class="n">rhs</span> <span class="o">=</span> <span class="n">_Sum</span><span class="p">(</span><span class="n">M</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">codim</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span>
<span class="linenos"> 965</span>
<span class="linenos"> 966</span>        <span class="n">op1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">gram</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">codim</span> <span class="k">if</span> <span class="n">lhs_F</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 967</span>        <span class="n">op2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">gram</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">codim</span> <span class="k">if</span> <span class="n">rhs_F</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 968</span>        <span class="n">op3</span> <span class="o">=</span> <span class="n">lhs</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">rhs</span>
<span class="linenos"> 969</span>        <span class="n">op4</span> <span class="o">=</span> <span class="n">rhs</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">lhs</span>
<span class="linenos"> 970</span>        <span class="n">op</span> <span class="o">=</span> <span class="n">op1</span> <span class="o">+</span> <span class="n">op2</span> <span class="o">+</span> <span class="p">(</span><span class="n">op3</span> <span class="o">+</span> <span class="n">op4</span><span class="p">)</span><span class="o">.</span><span class="n">asop</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">SelfAdjointOp</span><span class="p">)</span>
<span class="linenos"> 971</span>        <span class="k">return</span> <span class="n">op</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="linenos"> 972</span>
<span class="linenos"> 973</span>    <span class="k">def</span> <span class="nf">cogram</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">:</span>
<span class="linenos"> 974</span>        <span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span>
<span class="linenos"> 975</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">codim</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">codim</span><span class="p">:</span>
<span class="linenos"> 976</span>            <span class="c1"># No broadcasting</span>
<span class="linenos"> 977</span>            <span class="n">lhs_F</span> <span class="o">=</span> <span class="n">rhs_F</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos"> 978</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 979</span>            <span class="c1"># Broadcasting</span>
<span class="linenos"> 980</span>            <span class="n">lhs_F</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">FUNCTIONAL</span><span class="p">)</span>
<span class="linenos"> 981</span>            <span class="n">rhs_F</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">FUNCTIONAL</span><span class="p">)</span>
<span class="linenos"> 982</span>            <span class="k">if</span> <span class="n">lhs_F</span><span class="p">:</span>
<span class="linenos"> 983</span>                <span class="n">lhs</span> <span class="o">=</span> <span class="n">_Sum</span><span class="p">(</span><span class="n">M</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">codim</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span>
<span class="linenos"> 984</span>            <span class="k">if</span> <span class="n">rhs_F</span><span class="p">:</span>
<span class="linenos"> 985</span>                <span class="n">rhs</span> <span class="o">=</span> <span class="n">_Sum</span><span class="p">(</span><span class="n">M</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">codim</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span>
<span class="linenos"> 986</span>
<span class="linenos"> 987</span>        <span class="k">if</span> <span class="n">lhs_F</span><span class="p">:</span>
<span class="linenos"> 988</span>            <span class="n">scale</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">cogram</span><span class="p">()</span><span class="o">.</span><span class="n">asarray</span><span class="p">())</span>
<span class="linenos"> 989</span>            <span class="n">op1</span> <span class="o">=</span> <span class="n">_Sum</span><span class="p">(</span><span class="n">M</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">codim</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">codim</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span>
<span class="linenos"> 990</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 991</span>            <span class="n">op1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">cogram</span><span class="p">()</span>
<span class="linenos"> 992</span>        <span class="k">if</span> <span class="n">rhs_F</span><span class="p">:</span>
<span class="linenos"> 993</span>            <span class="n">scale</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">cogram</span><span class="p">()</span><span class="o">.</span><span class="n">asarray</span><span class="p">())</span>
<span class="linenos"> 994</span>            <span class="n">op2</span> <span class="o">=</span> <span class="n">_Sum</span><span class="p">(</span><span class="n">M</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">codim</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">codim</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span>
<span class="linenos"> 995</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 996</span>            <span class="n">op2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">cogram</span><span class="p">()</span>
<span class="linenos"> 997</span>        <span class="n">op3</span> <span class="o">=</span> <span class="n">lhs</span> <span class="o">*</span> <span class="n">rhs</span><span class="o">.</span><span class="n">T</span>
<span class="linenos"> 998</span>        <span class="n">op4</span> <span class="o">=</span> <span class="n">rhs</span> <span class="o">*</span> <span class="n">lhs</span><span class="o">.</span><span class="n">T</span>
<span class="linenos"> 999</span>        <span class="n">op</span> <span class="o">=</span> <span class="n">op1</span> <span class="o">+</span> <span class="n">op2</span> <span class="o">+</span> <span class="p">(</span><span class="n">op3</span> <span class="o">+</span> <span class="n">op4</span><span class="p">)</span><span class="o">.</span><span class="n">asop</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">SelfAdjointOp</span><span class="p">)</span>
<span class="linenos">1000</span>        <span class="k">return</span> <span class="n">op</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="linenos">1001</span>
<span class="linenos">1002</span>    <span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">()</span>
<span class="linenos">1003</span>    <span class="k">def</span> <span class="nf">trace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Real</span><span class="p">:</span>
<span class="linenos">1004</span>        <span class="n">tr</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">1005</span>        <span class="k">for</span> <span class="n">side</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="p">):</span>
<span class="linenos">1006</span>            <span class="k">if</span> <span class="n">side</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">FUNCTIONAL</span><span class="p">):</span>
<span class="linenos">1007</span>                <span class="n">tr</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">side</span><span class="o">.</span><span class="n">asarray</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
<span class="linenos">1008</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">1009</span>                <span class="n">tr</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">side</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
<span class="linenos">1010</span>        <span class="k">return</span> <span class="n">tr</span>
<span class="linenos">1011</span>
<span class="linenos">1012</span>    <span class="k">def</span> <span class="nf">asloss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">:</span>
<span class="linenos">1013</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">FUNCTIONAL</span><span class="p">):</span>
<span class="linenos">1014</span>            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
<span class="linenos">1015</span>                <span class="p">[</span>
<span class="linenos">1016</span>                    <span class="s2">&quot;The meaning of (lhs + rhs).asloss() may be ambiguous if the loss-notion differs among functionals involved.&quot;</span><span class="p">,</span>
<span class="linenos">1017</span>                    <span class="s2">&quot;It is recommended to call asloss() prior to adding functionals instead:&quot;</span><span class="p">,</span>
<span class="linenos">1018</span>                    <span class="s2">&quot;    lhs.asloss(data) + rhs.asloss(data)&quot;</span><span class="p">,</span>
<span class="linenos">1019</span>                <span class="p">]</span>
<span class="linenos">1020</span>            <span class="p">)</span>
<span class="linenos">1021</span>            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">pxw</span><span class="o">.</span><span class="n">AutoInferenceWarning</span><span class="p">)</span>
<span class="linenos">1022</span>
<span class="linenos">1023</span>            <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">1024</span>                <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span>
<span class="linenos">1025</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">1026</span>                <span class="n">op_lhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">asloss</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="linenos">1027</span>                <span class="n">op_rhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">asloss</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="linenos">1028</span>                <span class="n">op</span> <span class="o">=</span> <span class="n">op_lhs</span> <span class="o">+</span> <span class="n">op_rhs</span>
<span class="linenos">1029</span>            <span class="k">return</span> <span class="n">op</span>
<span class="linenos">1030</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1031</span>            <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<span class="linenos">1032</span>
<span class="linenos">1033</span>
<div class="viewcode-block" id="ChainRule">
<a class="viewcode-back" href="../../../api/abc.html#pyxu.abc.arithmetic.ChainRule">[docs]</a>
<span class="linenos">1034</span><span class="k">class</span> <span class="nc">ChainRule</span><span class="p">(</span><span class="n">Rule</span><span class="p">):</span>
<span class="linenos">1035</span><span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">1036</span><span class="sd">    The output type of ``ChainRule(A.squeeze(), B.squeeze())`` is summarized in the table below::</span>
<span class="linenos">1037</span>
<span class="linenos">1038</span><span class="sd">        |---------------|------|------------|----------|------------|------------|----------------|----------------------|------------------|------------|-----------|-----------|--------------|---------------|-----------|-----------|------------|</span>
<span class="linenos">1039</span><span class="sd">        |   LHS / RHS   | Map  |    Func    | DiffMap  |  DiffFunc  |  ProxFunc  |  ProxDiffFunc  |      Quadratic       |      LinOp       |  LinFunc   |  SquareOp |  NormalOp |    UnitOp    | SelfAdjointOp |  PosDefOp |   ProjOp  | OrthProjOp |</span>
<span class="linenos">1040</span><span class="sd">        |---------------|------|------------|----------|------------|------------|----------------|----------------------|------------------|------------|-----------|-----------|--------------|---------------|-----------|-----------|------------|</span>
<span class="linenos">1041</span><span class="sd">        | Map           | Map  | Map        | Map      | Map        | Map        | Map            | Map                  | Map              | Map        | Map       | Map       | Map          | Map           | Map       | Map       | Map        |</span>
<span class="linenos">1042</span><span class="sd">        | Func          | Func | Func       | Func     | Func       | Func       | Func           | Func                 | Func             | Func       | Func      | Func      | Func         | Func          | Func      | Func      | Func       |</span>
<span class="linenos">1043</span><span class="sd">        | DiffMap       | Map  | Map        | DiffMap  | DiffMap    | Map        | DiffMap        | DiffMap              | DiffMap          | DiffMap    | DiffMap   | DiffMap   | DiffMap      | DiffMap       | DiffMap   | DiffMap   | DiffMap    |</span>
<span class="linenos">1044</span><span class="sd">        | DiffFunc      | Func | Func       | DiffFunc | DiffFunc   | Func       | DiffFunc       | DiffFunc             | DiffFunc         | DiffFunc   | DiffFunc  | DiffFunc  | DiffFunc     | DiffFunc      | DiffFunc  | DiffFunc  | DiffFunc   |</span>
<span class="linenos">1045</span><span class="sd">        | ProxFunc      | Func | Func       | Func     | Func       | Func       | Func           | Func                 | Func             | Func       | Func      | Func      | ProxFunc     | Func          | Func      | Func      | Func       |</span>
<span class="linenos">1046</span><span class="sd">        | ProxDiffFunc  | Func | Func       | DiffFunc | DiffFunc   | Func       | DiffFunc       | DiffFunc             | DiffFunc         | DiffFunc   | DiffFunc  | DiffFunc  | ProxDiffFunc | DiffFunc      | DiffFunc  | DiffFunc  | DiffFunc   |</span>
<span class="linenos">1047</span><span class="sd">        | Quadratic     | Func | Func       | DiffFunc | DiffFunc   | Func       | DiffFunc       | DiffFunc             | Quadratic        | Quadratic  | Quadratic | Quadratic | Quadratic    | Quadratic     | Quadratic | Quadratic | Quadratic  |</span>
<span class="linenos">1048</span><span class="sd">        | LinOp         | Map  | Func       | DiffMap  | DiffMap    | Map        | DiffMap        | DiffMap              | LinOp / SquareOp | LinOp      | LinOp     | LinOp     | LinOp        | LinOp         | LinOp     | LinOp     | LinOp      |</span>
<span class="linenos">1049</span><span class="sd">        | LinFunc       | Func | Func       | DiffFunc | DiffFunc   | [Prox]Func | [Prox]DiffFunc | DiffFunc / Quadratic | LinFunc          | LinFunc    | LinFunc   | LinFunc   | LinFunc      | LinFunc       | LinFunc   | LinFunc   | LinFunc    |</span>
<span class="linenos">1050</span><span class="sd">        | SquareOp      | Map  | IMPOSSIBLE | DiffMap  | IMPOSSIBLE | IMPOSSIBLE | IMPOSSIBLE     | IMPOSSIBLE           | LinOp            | IMPOSSIBLE | SquareOp  | SquareOp  | SquareOp     | SquareOp      | SquareOp  | SquareOp  | SquareOp   |</span>
<span class="linenos">1051</span><span class="sd">        | NormalOp      | Map  | IMPOSSIBLE | DiffMap  | IMPOSSIBLE | IMPOSSIBLE | IMPOSSIBLE     | IMPOSSIBLE           | LinOp            | IMPOSSIBLE | SquareOp  | SquareOp  | SquareOp     | SquareOp      | SquareOp  | SquareOp  | SquareOp   |</span>
<span class="linenos">1052</span><span class="sd">        | UnitOp        | Map  | IMPOSSIBLE | DiffMap  | IMPOSSIBLE | IMPOSSIBLE | IMPOSSIBLE     | IMPOSSIBLE           | LinOp            | IMPOSSIBLE | SquareOp  | SquareOp  | UnitOp       | SquareOp      | SquareOp  | SquareOp  | SquareOp   |</span>
<span class="linenos">1053</span><span class="sd">        | SelfAdjointOp | Map  | IMPOSSIBLE | DiffMap  | IMPOSSIBLE | IMPOSSIBLE | IMPOSSIBLE     | IMPOSSIBLE           | LinOp            | IMPOSSIBLE | SquareOp  | SquareOp  | SquareOp     | SquareOp      | SquareOp  | SquareOp  | SquareOp   |</span>
<span class="linenos">1054</span><span class="sd">        | PosDefOp      | Map  | IMPOSSIBLE | DiffMap  | IMPOSSIBLE | IMPOSSIBLE | IMPOSSIBLE     | IMPOSSIBLE           | LinOp            | IMPOSSIBLE | SquareOp  | SquareOp  | SquareOp     | SquareOp      | SquareOp  | SquareOp  | SquareOp   |</span>
<span class="linenos">1055</span><span class="sd">        | ProjOp        | Map  | IMPOSSIBLE | DiffMap  | IMPOSSIBLE | IMPOSSIBLE | IMPOSSIBLE     | IMPOSSIBLE           | LinOp            | IMPOSSIBLE | SquareOp  | SquareOp  | SquareOp     | SquareOp      | SquareOp  | SquareOp  | SquareOp   |</span>
<span class="linenos">1056</span><span class="sd">        | OrthProjOp    | Map  | IMPOSSIBLE | DiffMap  | IMPOSSIBLE | IMPOSSIBLE | IMPOSSIBLE     | IMPOSSIBLE           | LinOp            | IMPOSSIBLE | SquareOp  | SquareOp  | SquareOp     | SquareOp      | SquareOp  | SquareOp  | SquareOp   |</span>
<span class="linenos">1057</span><span class="sd">        |---------------|------|------------|----------|------------|------------|----------------|----------------------|------------------|------------|-----------|-----------|--------------|---------------|-----------|-----------|------------|</span>
<span class="linenos">1058</span>
<span class="linenos">1059</span><span class="sd">    Arithmetic Update Rule(s)::</span>
<span class="linenos">1060</span>
<span class="linenos">1061</span><span class="sd">        * CAN_EVAL</span>
<span class="linenos">1062</span><span class="sd">            op.apply(arr) = _lhs.apply(_rhs.apply(arr))</span>
<span class="linenos">1063</span><span class="sd">            op.lipschitz = _lhs.lipschitz * _rhs.lipschitz</span>
<span class="linenos">1064</span>
<span class="linenos">1065</span><span class="sd">        * FUNCTIONAL</span>
<span class="linenos">1066</span><span class="sd">            op.asloss(\beta) = ambiguous -&gt; disabled</span>
<span class="linenos">1067</span>
<span class="linenos">1068</span><span class="sd">        * PROXIMABLE (RHS Unitary only)</span>
<span class="linenos">1069</span><span class="sd">            op.prox(arr, tau) = _rhs.adjoint(_lhs.prox(_rhs.apply(arr), tau))</span>
<span class="linenos">1070</span>
<span class="linenos">1071</span><span class="sd">        * DIFFERENTIABLE</span>
<span class="linenos">1072</span><span class="sd">            op.jacobian(arr) = _lhs.jacobian(_rhs.apply(arr)) * _rhs.jacobian(arr)</span>
<span class="linenos">1073</span><span class="sd">            op.diff_lipschitz =</span>
<span class="linenos">1074</span><span class="sd">                quadratic            =&gt; _quad_spec().Q.lipschitz</span>
<span class="linenos">1075</span><span class="sd">                linear \comp linear  =&gt; 0</span>
<span class="linenos">1076</span><span class="sd">                linear \comp diff    =&gt; _lhs.lipschitz * _rhs.diff_lipschitz</span>
<span class="linenos">1077</span><span class="sd">                diff   \comp linear  =&gt; _lhs.diff_lipschitz * (_rhs.lipschitz ** 2)</span>
<span class="linenos">1078</span><span class="sd">                diff   \comp diff    =&gt; \infty</span>
<span class="linenos">1079</span>
<span class="linenos">1080</span><span class="sd">        * DIFFERENTIABLE_FUNCTION (1D input)</span>
<span class="linenos">1081</span><span class="sd">            op.grad(arr) = _lhs.grad(_rhs.apply(arr)) @ _rhs.jacobian(arr).asarray()</span>
<span class="linenos">1082</span>
<span class="linenos">1083</span><span class="sd">        * LINEAR</span>
<span class="linenos">1084</span><span class="sd">            op.adjoint(arr) = _rhs.adjoint(_lhs.adjoint(arr))</span>
<span class="linenos">1085</span><span class="sd">            op.asarray() = _lhs.asarray() @ _rhs.asarray()</span>
<span class="linenos">1086</span><span class="sd">            op.gram() = _rhs.T @ _lhs.gram() @ _rhs</span>
<span class="linenos">1087</span><span class="sd">            op.cogram() = _lhs @ _rhs.cogram() @ _lhs.T</span>
<span class="linenos">1088</span>
<span class="linenos">1089</span><span class="sd">        * QUADRATIC</span>
<span class="linenos">1090</span><span class="sd">            Q, c, t = _lhs._quad_spec()</span>
<span class="linenos">1091</span><span class="sd">            op._quad_spec() = (_rhs.T * Q * _rhs, _rhs.T * c, t)</span>
<span class="linenos">1092</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">1093</span>
<span class="linenos">1094</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lhs</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">,</span> <span class="n">rhs</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">):</span>
<span class="linenos">1095</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<span class="linenos">1096</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span> <span class="o">=</span> <span class="n">lhs</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="linenos">1097</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span> <span class="o">=</span> <span class="n">rhs</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="linenos">1098</span>
<span class="linenos">1099</span>    <span class="k">def</span> <span class="nf">op</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">:</span>
<span class="linenos">1100</span>        <span class="n">sh_op</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">infer_composition_shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="linenos">1101</span>        <span class="n">klass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infer_op_klass</span><span class="p">()</span>
<span class="linenos">1102</span>        <span class="n">op</span> <span class="o">=</span> <span class="n">klass</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">sh_op</span><span class="p">)</span>
<span class="linenos">1103</span>        <span class="n">op</span><span class="o">.</span><span class="n">_lhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span>  <span class="c1"># embed for introspection</span>
<span class="linenos">1104</span>        <span class="n">op</span><span class="o">.</span><span class="n">_rhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span>  <span class="c1"># embed for introspection</span>
<span class="linenos">1105</span>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">op</span><span class="o">.</span><span class="n">properties</span><span class="p">():</span>
<span class="linenos">1106</span>            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">arithmetic_methods</span><span class="p">():</span>
<span class="linenos">1107</span>                <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
<span class="linenos">1108</span>                <span class="nb">setattr</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">op</span><span class="p">))</span>
<span class="linenos">1109</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_propagate_constants</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<span class="linenos">1110</span>        <span class="k">return</span> <span class="n">op</span>
<span class="linenos">1111</span>
<span class="linenos">1112</span>    <span class="k">def</span> <span class="nf">_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="linenos">1113</span>        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;compose&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="p">)</span>
<span class="linenos">1114</span>
<span class="linenos">1115</span>    <span class="k">def</span> <span class="nf">_infer_op_klass</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpC</span><span class="p">:</span>
<span class="linenos">1116</span>        <span class="c1"># |--------------------------|------------------------------------------------------|</span>
<span class="linenos">1117</span>        <span class="c1"># |         Property         |                      Preserved?                      |</span>
<span class="linenos">1118</span>        <span class="c1"># |--------------------------|------------------------------------------------------|</span>
<span class="linenos">1119</span>        <span class="c1"># | CAN_EVAL                 | (LHS CAN_EVAL) &amp; (RHS CAN_EVAL)                      |</span>
<span class="linenos">1120</span>        <span class="c1"># |--------------------------|------------------------------------------------------|</span>
<span class="linenos">1121</span>        <span class="c1"># | FUNCTIONAL               | LHS FUNCTIONAL                                       |</span>
<span class="linenos">1122</span>        <span class="c1"># |--------------------------|------------------------------------------------------|</span>
<span class="linenos">1123</span>        <span class="c1"># | PROXIMABLE               | * (LHS PROXIMABLE) &amp; (RHS LINEAR_UNITARY)            |</span>
<span class="linenos">1124</span>        <span class="c1"># |                          | * (LHS LINEAR) &amp; (RHS LINEAR)                        |</span>
<span class="linenos">1125</span>        <span class="c1"># |                          | * (LHS LINEAR FUNCTIONAL [&gt; 0]) &amp; (RHS PROXIMABLE)   |</span>
<span class="linenos">1126</span>        <span class="c1"># |--------------------------|------------------------------------------------------|</span>
<span class="linenos">1127</span>        <span class="c1"># | DIFFERENTIABLE           | (LHS DIFFERENTIABLE) &amp; (RHS DIFFERENTIABLE)          |</span>
<span class="linenos">1128</span>        <span class="c1"># |--------------------------|------------------------------------------------------|</span>
<span class="linenos">1129</span>        <span class="c1"># | DIFFERENTIABLE_FUNCTION  | (LHS DIFFERENTIABLE_FUNCTION) &amp; (RHS DIFFERENTIABLE) |</span>
<span class="linenos">1130</span>        <span class="c1"># |--------------------------|------------------------------------------------------|</span>
<span class="linenos">1131</span>        <span class="c1"># | QUADRATIC                | * (LHS QUADRATIC) &amp; (RHS LINEAR)                     |</span>
<span class="linenos">1132</span>        <span class="c1"># |                          | * (LHS LINEAR FUNCTIONAL [&gt; 0]) &amp; (RHS QUADRATIC)    |</span>
<span class="linenos">1133</span>        <span class="c1"># |--------------------------|------------------------------------------------------|</span>
<span class="linenos">1134</span>        <span class="c1"># | LINEAR                   | (LHS LINEAR) &amp; (RHS LINEAR)                          |</span>
<span class="linenos">1135</span>        <span class="c1"># |--------------------------|------------------------------------------------------|</span>
<span class="linenos">1136</span>        <span class="c1"># | LINEAR_SQUARE            | (Shape[LHS * RHS] square) &amp; (LHS.codim &gt; 1)          |</span>
<span class="linenos">1137</span>        <span class="c1"># |--------------------------|------------------------------------------------------|</span>
<span class="linenos">1138</span>        <span class="c1"># | LINEAR_NORMAL            | no                                                   |</span>
<span class="linenos">1139</span>        <span class="c1"># |--------------------------|------------------------------------------------------|</span>
<span class="linenos">1140</span>        <span class="c1"># | LINEAR_UNITARY           | (LHS LINEAR_UNITARY) &amp; (RHS LINEAR_UNITARY)          |</span>
<span class="linenos">1141</span>        <span class="c1"># |--------------------------|------------------------------------------------------|</span>
<span class="linenos">1142</span>        <span class="c1"># | LINEAR_SELF_ADJOINT      | no                                                   |</span>
<span class="linenos">1143</span>        <span class="c1"># |--------------------------|------------------------------------------------------|</span>
<span class="linenos">1144</span>        <span class="c1"># | LINEAR_POSITIVE_DEFINITE | no                                                   |</span>
<span class="linenos">1145</span>        <span class="c1"># |--------------------------|------------------------------------------------------|</span>
<span class="linenos">1146</span>        <span class="c1"># | LINEAR_IDEMPOTENT        | no                                                   |</span>
<span class="linenos">1147</span>        <span class="c1"># |--------------------------|------------------------------------------------------|</span>
<span class="linenos">1148</span>        <span class="n">lhs_p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">properties</span><span class="p">()</span>
<span class="linenos">1149</span>        <span class="n">rhs_p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">properties</span><span class="p">()</span>
<span class="linenos">1150</span>        <span class="n">P</span> <span class="o">=</span> <span class="n">pxo</span><span class="o">.</span><span class="n">Property</span>
<span class="linenos">1151</span>        <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span><span class="n">P</span><span class="o">.</span><span class="n">CAN_EVAL</span><span class="p">}</span>
<span class="linenos">1152</span>        <span class="k">if</span> <span class="n">P</span><span class="o">.</span><span class="n">FUNCTIONAL</span> <span class="ow">in</span> <span class="n">lhs_p</span><span class="p">:</span>
<span class="linenos">1153</span>            <span class="n">properties</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">FUNCTIONAL</span><span class="p">)</span>
<span class="linenos">1154</span>        <span class="c1"># Proximal ------------------------------</span>
<span class="linenos">1155</span>        <span class="k">if</span> <span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">PROXIMABLE</span> <span class="ow">in</span> <span class="n">lhs_p</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">LINEAR_UNITARY</span> <span class="ow">in</span> <span class="n">rhs_p</span><span class="p">):</span>
<span class="linenos">1156</span>            <span class="n">properties</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">PROXIMABLE</span><span class="p">)</span>
<span class="linenos">1157</span>        <span class="k">elif</span> <span class="p">({</span><span class="n">P</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">,</span> <span class="n">P</span><span class="o">.</span><span class="n">FUNCTIONAL</span><span class="p">}</span> <span class="o">&lt;</span> <span class="n">lhs_p</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">PROXIMABLE</span> <span class="ow">in</span> <span class="n">rhs_p</span><span class="p">):</span>
<span class="linenos">1158</span>            <span class="n">cst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">asarray</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<span class="linenos">1159</span>            <span class="k">if</span> <span class="n">cst</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">1160</span>                <span class="n">properties</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">PROXIMABLE</span><span class="p">)</span>
<span class="linenos">1161</span>                <span class="k">if</span> <span class="n">P</span><span class="o">.</span><span class="n">QUADRATIC</span> <span class="ow">in</span> <span class="n">rhs_p</span><span class="p">:</span>
<span class="linenos">1162</span>                    <span class="n">properties</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">QUADRATIC</span><span class="p">)</span>
<span class="linenos">1163</span>        <span class="c1"># ---------------------------------------</span>
<span class="linenos">1164</span>        <span class="k">if</span> <span class="n">P</span><span class="o">.</span><span class="n">DIFFERENTIABLE</span> <span class="ow">in</span> <span class="p">(</span><span class="n">lhs_p</span> <span class="o">&amp;</span> <span class="n">rhs_p</span><span class="p">):</span>
<span class="linenos">1165</span>            <span class="n">properties</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">DIFFERENTIABLE</span><span class="p">)</span>
<span class="linenos">1166</span>        <span class="k">if</span> <span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">DIFFERENTIABLE_FUNCTION</span> <span class="ow">in</span> <span class="n">lhs_p</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">DIFFERENTIABLE</span> <span class="ow">in</span> <span class="n">rhs_p</span><span class="p">):</span>
<span class="linenos">1167</span>            <span class="n">properties</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">DIFFERENTIABLE_FUNCTION</span><span class="p">)</span>
<span class="linenos">1168</span>        <span class="k">if</span> <span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">QUADRATIC</span> <span class="ow">in</span> <span class="n">lhs_p</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">LINEAR</span> <span class="ow">in</span> <span class="n">rhs_p</span><span class="p">):</span>
<span class="linenos">1169</span>            <span class="n">properties</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">PROXIMABLE</span><span class="p">)</span>
<span class="linenos">1170</span>            <span class="n">properties</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">QUADRATIC</span><span class="p">)</span>
<span class="linenos">1171</span>        <span class="k">if</span> <span class="n">P</span><span class="o">.</span><span class="n">LINEAR</span> <span class="ow">in</span> <span class="p">(</span><span class="n">lhs_p</span> <span class="o">&amp;</span> <span class="n">rhs_p</span><span class="p">):</span>
<span class="linenos">1172</span>            <span class="n">properties</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">)</span>
<span class="linenos">1173</span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">codim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">1174</span>                <span class="n">properties</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">PROXIMABLE</span><span class="p">)</span>
<span class="linenos">1175</span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">codim</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">dim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">1176</span>                <span class="n">properties</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">LINEAR_SQUARE</span><span class="p">)</span>
<span class="linenos">1177</span>        <span class="k">if</span> <span class="n">P</span><span class="o">.</span><span class="n">LINEAR_UNITARY</span> <span class="ow">in</span> <span class="p">(</span><span class="n">lhs_p</span> <span class="o">&amp;</span> <span class="n">rhs_p</span><span class="p">):</span>
<span class="linenos">1178</span>            <span class="n">properties</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">LINEAR_NORMAL</span><span class="p">)</span>
<span class="linenos">1179</span>            <span class="n">properties</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">LINEAR_UNITARY</span><span class="p">)</span>
<span class="linenos">1180</span>
<span class="linenos">1181</span>        <span class="n">klass</span> <span class="o">=</span> <span class="n">pxo</span><span class="o">.</span><span class="n">Operator</span><span class="o">.</span><span class="n">_infer_operator_type</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span>
<span class="linenos">1182</span>        <span class="k">return</span> <span class="n">klass</span>
<span class="linenos">1183</span>
<span class="linenos">1184</span>    <span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="s2">&quot;arr&quot;</span><span class="p">)</span>
<span class="linenos">1185</span>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos">1186</span>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="linenos">1187</span>        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="linenos">1188</span>        <span class="k">return</span> <span class="n">out</span>
<span class="linenos">1189</span>
<span class="linenos">1190</span>    <span class="k">def</span> <span class="nf">estimate_lipschitz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Real</span><span class="p">:</span>
<span class="linenos">1191</span>        <span class="n">no_eval</span> <span class="o">=</span> <span class="s2">&quot;__rule&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span>
<span class="linenos">1192</span>        <span class="k">if</span> <span class="n">no_eval</span><span class="p">:</span>
<span class="linenos">1193</span>            <span class="n">L_lhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">lipschitz</span>
<span class="linenos">1194</span>            <span class="n">L_rhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">lipschitz</span>
<span class="linenos">1195</span>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">):</span>
<span class="linenos">1196</span>            <span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">estimate_lipschitz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos">1197</span>            <span class="k">return</span> <span class="n">L</span>
<span class="linenos">1198</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1199</span>            <span class="n">L_lhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">estimate_lipschitz</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos">1200</span>            <span class="n">L_rhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">estimate_lipschitz</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos">1201</span>
<span class="linenos">1202</span>        <span class="n">L</span> <span class="o">=</span> <span class="n">L_lhs</span> <span class="o">*</span> <span class="n">L_rhs</span>
<span class="linenos">1203</span>        <span class="k">return</span> <span class="n">L</span>
<span class="linenos">1204</span>
<span class="linenos">1205</span>    <span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;arr&quot;</span><span class="p">,</span> <span class="s2">&quot;tau&quot;</span><span class="p">))</span>
<span class="linenos">1206</span>    <span class="k">def</span> <span class="nf">prox</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">tau</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Real</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos">1207</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">PROXIMABLE</span><span class="p">):</span>
<span class="linenos">1208</span>            <span class="n">out</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">1209</span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">PROXIMABLE</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">LINEAR_UNITARY</span><span class="p">):</span>
<span class="linenos">1210</span>                <span class="c1"># prox[diff]func() \comp unitop() =&gt; prox[diff]func()</span>
<span class="linenos">1211</span>                <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="linenos">1212</span>                <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">prox</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span>
<span class="linenos">1213</span>                <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">adjoint</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="linenos">1214</span>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">QUADRATIC</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">):</span>
<span class="linenos">1215</span>                <span class="c1"># quadratic \comp linop =&gt; quadratic</span>
<span class="linenos">1216</span>                <span class="n">Q</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quad_spec</span><span class="p">()</span>
<span class="linenos">1217</span>                <span class="n">out</span> <span class="o">=</span> <span class="n">pxo</span><span class="o">.</span><span class="n">QuadraticFunc</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="n">Q</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">prox</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span>
<span class="linenos">1218</span>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">PROXIMABLE</span><span class="p">):</span>
<span class="linenos">1219</span>                <span class="c1"># linfunc() \comp prox[diff]func() =&gt; prox[diff]func()</span>
<span class="linenos">1220</span>                <span class="c1">#                                  = (\alpha * prox[diff]func())</span>
<span class="linenos">1221</span>                <span class="n">op</span> <span class="o">=</span> <span class="n">ScaleRule</span><span class="p">(</span><span class="n">op</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="p">,</span> <span class="n">cst</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">asarray</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">())</span><span class="o">.</span><span class="n">op</span><span class="p">()</span>
<span class="linenos">1222</span>                <span class="n">out</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">prox</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span>
<span class="linenos">1223</span>            <span class="k">elif</span> <span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">LINEAR</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">properties</span><span class="p">()</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">properties</span><span class="p">()):</span>
<span class="linenos">1224</span>                <span class="c1"># linfunc() \comp linop() =&gt; linfunc()</span>
<span class="linenos">1225</span>                <span class="n">out</span> <span class="o">=</span> <span class="n">pxo</span><span class="o">.</span><span class="n">LinFunc</span><span class="o">.</span><span class="n">prox</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span>
<span class="linenos">1226</span>
<span class="linenos">1227</span>            <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">1228</span>                <span class="k">return</span> <span class="n">out</span>
<span class="linenos">1229</span>        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
<span class="linenos">1230</span>
<span class="linenos">1231</span>    <span class="k">def</span> <span class="nf">_quad_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">1232</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">QUADRATIC</span><span class="p">):</span>
<span class="linenos">1233</span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">):</span>
<span class="linenos">1234</span>                <span class="c1"># linfunc (scalar) \comp quadratic</span>
<span class="linenos">1235</span>                <span class="n">op</span> <span class="o">=</span> <span class="n">ScaleRule</span><span class="p">(</span><span class="n">op</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="p">,</span> <span class="n">cst</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">asarray</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">())</span><span class="o">.</span><span class="n">op</span><span class="p">()</span>
<span class="linenos">1236</span>                <span class="n">Q2</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">_quad_spec</span><span class="p">()</span>
<span class="linenos">1237</span>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">):</span>
<span class="linenos">1238</span>                <span class="c1"># quadratic \comp linop</span>
<span class="linenos">1239</span>                <span class="n">Q1</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">t1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">_quad_spec</span><span class="p">()</span>
<span class="linenos">1240</span>                <span class="n">Q2</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">Q1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="p">)</span><span class="o">.</span><span class="n">asop</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">PosDefOp</span><span class="p">)</span>
<span class="linenos">1241</span>                <span class="n">c2</span> <span class="o">=</span> <span class="n">c1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span>
<span class="linenos">1242</span>                <span class="n">t2</span> <span class="o">=</span> <span class="n">t1</span>
<span class="linenos">1243</span>            <span class="k">return</span> <span class="p">(</span><span class="n">Q2</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
<span class="linenos">1244</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1245</span>            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
<span class="linenos">1246</span>
<span class="linenos">1247</span>    <span class="k">def</span> <span class="nf">jacobian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">:</span>
<span class="linenos">1248</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">):</span>
<span class="linenos">1249</span>            <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span>
<span class="linenos">1250</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1251</span>            <span class="n">J_rhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="linenos">1252</span>            <span class="n">J_lhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">arr</span><span class="p">))</span>
<span class="linenos">1253</span>            <span class="n">op</span> <span class="o">=</span> <span class="n">J_lhs</span> <span class="o">*</span> <span class="n">J_rhs</span>
<span class="linenos">1254</span>        <span class="k">return</span> <span class="n">op</span>
<span class="linenos">1255</span>
<span class="linenos">1256</span>    <span class="k">def</span> <span class="nf">estimate_diff_lipschitz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Real</span><span class="p">:</span>
<span class="linenos">1257</span>        <span class="n">no_eval</span> <span class="o">=</span> <span class="s2">&quot;__rule&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span>
<span class="linenos">1258</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">QUADRATIC</span><span class="p">):</span>
<span class="linenos">1259</span>            <span class="n">Q</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quad_spec</span><span class="p">()</span>
<span class="linenos">1260</span>            <span class="n">op</span> <span class="o">=</span> <span class="n">pxo</span><span class="o">.</span><span class="n">QuadraticFunc</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="n">Q</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>
<span class="linenos">1261</span>            <span class="k">if</span> <span class="n">no_eval</span><span class="p">:</span>
<span class="linenos">1262</span>                <span class="n">dL</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">diff_lipschitz</span>
<span class="linenos">1263</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">1264</span>                <span class="n">dL</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">estimate_diff_lipschitz</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos">1265</span>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">):</span>
<span class="linenos">1266</span>            <span class="n">dL</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">1267</span>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">DIFFERENTIABLE</span><span class="p">):</span>
<span class="linenos">1268</span>            <span class="k">if</span> <span class="n">no_eval</span><span class="p">:</span>
<span class="linenos">1269</span>                <span class="n">L_lhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">lipschitz</span>
<span class="linenos">1270</span>                <span class="n">dL_rhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">diff_lipschitz</span>
<span class="linenos">1271</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">1272</span>                <span class="n">L_lhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">estimate_lipschitz</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos">1273</span>                <span class="n">dL_rhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">estimate_diff_lipschitz</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos">1274</span>            <span class="n">dL</span> <span class="o">=</span> <span class="n">L_lhs</span> <span class="o">*</span> <span class="n">dL_rhs</span>
<span class="linenos">1275</span>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">DIFFERENTIABLE</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">):</span>
<span class="linenos">1276</span>            <span class="k">if</span> <span class="n">no_eval</span><span class="p">:</span>
<span class="linenos">1277</span>                <span class="n">dL_lhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">diff_lipschitz</span>
<span class="linenos">1278</span>                <span class="n">L_rhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">lipschitz</span>
<span class="linenos">1279</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">1280</span>                <span class="n">dL_lhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">estimate_diff_lipschitz</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos">1281</span>                <span class="n">L_rhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">estimate_lipschitz</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos">1282</span>            <span class="n">dL</span> <span class="o">=</span> <span class="n">dL_lhs</span> <span class="o">*</span> <span class="p">(</span><span class="n">L_rhs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="linenos">1283</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1284</span>            <span class="n">dL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
<span class="linenos">1285</span>        <span class="k">return</span> <span class="n">dL</span>
<span class="linenos">1286</span>
<span class="linenos">1287</span>    <span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="s2">&quot;arr&quot;</span><span class="p">)</span>
<span class="linenos">1288</span>    <span class="k">def</span> <span class="nf">grad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos">1289</span>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">arr</span><span class="p">))</span>
<span class="linenos">1290</span>        <span class="k">if</span> <span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">):</span>
<span class="linenos">1291</span>            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span><span class="o">.</span><span class="n">adjoint</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="linenos">1292</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1293</span>            <span class="n">xp</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">get_array_module</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="linenos">1294</span>            <span class="n">out</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
<span class="linenos">1295</span>                <span class="p">[</span>
<span class="linenos">1296</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">adjoint</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="linenos">1297</span>                    <span class="k">for</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
<span class="linenos">1298</span>                        <span class="n">arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
<span class="linenos">1299</span>                        <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
<span class="linenos">1300</span>                        <span class="c1"># zip() above safer than</span>
<span class="linenos">1301</span>                        <span class="c1">#       zip(</span>
<span class="linenos">1302</span>                        <span class="c1">#         arr.reshape((-1, self._rhs.dim)),</span>
<span class="linenos">1303</span>                        <span class="c1">#         x.reshape((-1, self._lhs.dim)),</span>
<span class="linenos">1304</span>                        <span class="c1">#       )</span>
<span class="linenos">1305</span>                        <span class="c1"># Due to potential _lhs/_rhs domain-agnosticity, i.e. `[lhs|rhs].dim=None`.</span>
<span class="linenos">1306</span>                    <span class="p">)</span>
<span class="linenos">1307</span>                <span class="p">],</span>
<span class="linenos">1308</span>                <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="linenos">1309</span>            <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="linenos">1310</span>        <span class="k">return</span> <span class="n">out</span>
<span class="linenos">1311</span>
<span class="linenos">1312</span>    <span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="s2">&quot;arr&quot;</span><span class="p">)</span>
<span class="linenos">1313</span>    <span class="k">def</span> <span class="nf">adjoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos">1314</span>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">adjoint</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="linenos">1315</span>        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">adjoint</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="linenos">1316</span>        <span class="k">return</span> <span class="n">out</span>
<span class="linenos">1317</span>
<span class="linenos">1318</span>    <span class="k">def</span> <span class="nf">asarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos">1319</span>        <span class="n">A_lhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos">1320</span>        <span class="n">A_rhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos">1321</span>        <span class="n">A</span> <span class="o">=</span> <span class="n">A_lhs</span> <span class="o">@</span> <span class="n">A_rhs</span>
<span class="linenos">1322</span>        <span class="k">return</span> <span class="n">A</span>
<span class="linenos">1323</span>
<span class="linenos">1324</span>    <span class="k">def</span> <span class="nf">gram</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">:</span>
<span class="linenos">1325</span>        <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">gram</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span>
<span class="linenos">1326</span>        <span class="k">return</span> <span class="n">op</span><span class="o">.</span><span class="n">asop</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">SelfAdjointOp</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="linenos">1327</span>
<span class="linenos">1328</span>    <span class="k">def</span> <span class="nf">cogram</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">:</span>
<span class="linenos">1329</span>        <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhs</span><span class="o">.</span><span class="n">cogram</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lhs</span><span class="o">.</span><span class="n">T</span>
<span class="linenos">1330</span>        <span class="k">return</span> <span class="n">op</span><span class="o">.</span><span class="n">asop</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">SelfAdjointOp</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="linenos">1331</span>
<span class="linenos">1332</span>    <span class="k">def</span> <span class="nf">asloss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">:</span>
<span class="linenos">1333</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">FUNCTIONAL</span><span class="p">):</span>
<span class="linenos">1334</span>            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
<span class="linenos">1335</span>                <span class="p">[</span>
<span class="linenos">1336</span>                    <span class="s2">&quot;The meaning of (lhs * rhs).asloss() is ambiguous:&quot;</span><span class="p">,</span>
<span class="linenos">1337</span>                    <span class="s2">&quot;    (1) (lhs * rhs).asloss(data) ?= lhs.asloss(data) * rhs&quot;</span><span class="p">,</span>
<span class="linenos">1338</span>                    <span class="s2">&quot;    (2) (lhs * rhs).asloss(data) ?= lhs * g.[unknown_transform](data)&quot;</span><span class="p">,</span>
<span class="linenos">1339</span>                    <span class="s2">&quot;Rewrite the expression differently to clarify the intent.&quot;</span><span class="p">,</span>
<span class="linenos">1340</span>                <span class="p">]</span>
<span class="linenos">1341</span>            <span class="p">)</span>
<span class="linenos">1342</span>            <span class="k">raise</span> <span class="ne">ArithmeticError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="linenos">1343</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1344</span>            <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<span class="linenos">1345</span>
<span class="linenos">1346</span>
<div class="viewcode-block" id="PowerRule">
<a class="viewcode-back" href="../../../api/abc.html#pyxu.abc.arithmetic.PowerRule">[docs]</a>
<span class="linenos">1347</span><span class="k">class</span> <span class="nc">PowerRule</span><span class="p">(</span><span class="n">Rule</span><span class="p">):</span>
<span class="linenos">1348</span><span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">1349</span><span class="sd">    Special Cases::</span>
<span class="linenos">1350</span>
<span class="linenos">1351</span><span class="sd">        k = 0  =&gt; IdentityOp</span>
<span class="linenos">1352</span>
<span class="linenos">1353</span><span class="sd">    Else::</span>
<span class="linenos">1354</span>
<span class="linenos">1355</span><span class="sd">        B = A \circ ... \circ A  (k-1 compositions)</span>
<span class="linenos">1356</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">1357</span>
<span class="linenos">1358</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Integer</span><span class="p">):</span>
<span class="linenos">1359</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<span class="linenos">1360</span>        <span class="k">assert</span> <span class="n">op</span><span class="o">.</span><span class="n">codim</span> <span class="o">==</span> <span class="n">op</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;PowerRule: expected endomorphism, got </span><span class="si">{</span><span class="n">op</span><span class="si">}</span><span class="s2">.&quot;</span>
<span class="linenos">1361</span>        <span class="k">assert</span> <span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;PowerRule: only non-negative exponents are supported.&quot;</span>
<span class="linenos">1362</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_op</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="linenos">1363</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_k</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="linenos">1364</span>
<span class="linenos">1365</span>    <span class="k">def</span> <span class="nf">op</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">:</span>
<span class="linenos">1366</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">1367</span>            <span class="kn">from</span> <span class="nn">pyxu.operator.linop</span> <span class="kn">import</span> <span class="n">IdentityOp</span>
<span class="linenos">1368</span>
<span class="linenos">1369</span>            <span class="n">op</span> <span class="o">=</span> <span class="n">IdentityOp</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">codim</span><span class="p">)</span>
<span class="linenos">1370</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1371</span>            <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span>
<span class="linenos">1372</span>            <span class="k">if</span> <span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">LINEAR_IDEMPOTENT</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">properties</span><span class="p">():</span>
<span class="linenos">1373</span>                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
<span class="linenos">1374</span>                    <span class="n">op</span> <span class="o">=</span> <span class="n">ChainRule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span><span class="o">.</span><span class="n">op</span><span class="p">()</span>
<span class="linenos">1375</span>
<span class="linenos">1376</span>                <span class="c1"># Needed due to implicit PowerRule definition in terms of ChainRule.</span>
<span class="linenos">1377</span>                <span class="n">op</span><span class="o">.</span><span class="n">_expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expr</span>
<span class="linenos">1378</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">1379</span>                <span class="c1"># To stop .expr() from recursing indefinitely.</span>
<span class="linenos">1380</span>                <span class="n">op</span><span class="o">.</span><span class="n">_expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">_expr</span>
<span class="linenos">1381</span>        <span class="k">return</span> <span class="n">op</span>
<span class="linenos">1382</span>
<span class="linenos">1383</span>    <span class="k">def</span> <span class="nf">_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="linenos">1384</span>        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;exp&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_k</span><span class="p">)</span></div>

<span class="linenos">1385</span>
<span class="linenos">1386</span>
<div class="viewcode-block" id="TransposeRule">
<a class="viewcode-back" href="../../../api/abc.html#pyxu.abc.arithmetic.TransposeRule">[docs]</a>
<span class="linenos">1387</span><span class="k">class</span> <span class="nc">TransposeRule</span><span class="p">(</span><span class="n">Rule</span><span class="p">):</span>
<span class="linenos">1388</span>    <span class="c1"># Not strictly-speaking an arithmetic method, but the logic behind constructing transposed</span>
<span class="linenos">1389</span>    <span class="c1"># operators is identical to arithmetic methods.</span>
<span class="linenos">1390</span>    <span class="c1"># LinOp.T() rules are hence summarized here.</span>
<span class="linenos">1391</span><span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">1392</span><span class="sd">    Arithmetic Update Rule(s)::</span>
<span class="linenos">1393</span>
<span class="linenos">1394</span><span class="sd">        * CAN_EVAL</span>
<span class="linenos">1395</span><span class="sd">            opT.apply(arr) = op.adjoint(arr)</span>
<span class="linenos">1396</span><span class="sd">            opT.lipschitz = op.lipschitz</span>
<span class="linenos">1397</span>
<span class="linenos">1398</span><span class="sd">        * FUNCTIONAL</span>
<span class="linenos">1399</span><span class="sd">            opT.asloss(\beta) = UNDEFINED</span>
<span class="linenos">1400</span>
<span class="linenos">1401</span><span class="sd">        * PROXIMABLE</span>
<span class="linenos">1402</span><span class="sd">            opT.prox(arr, tau) = LinFunc.prox(arr, tau)</span>
<span class="linenos">1403</span>
<span class="linenos">1404</span><span class="sd">        * DIFFERENTIABLE</span>
<span class="linenos">1405</span><span class="sd">            opT.jacobian(arr) = opT</span>
<span class="linenos">1406</span><span class="sd">            opT.diff_lipschitz = 0</span>
<span class="linenos">1407</span>
<span class="linenos">1408</span><span class="sd">        * DIFFERENTIABLE_FUNCTION</span>
<span class="linenos">1409</span><span class="sd">            opT.grad(arr) = LinFunc.grad(arr)</span>
<span class="linenos">1410</span>
<span class="linenos">1411</span><span class="sd">        * LINEAR</span>
<span class="linenos">1412</span><span class="sd">            opT.adjoint(arr) = op.apply(arr)</span>
<span class="linenos">1413</span><span class="sd">            opT.asarray() = op.asarray().T</span>
<span class="linenos">1414</span><span class="sd">            opT.gram() = op.cogram()</span>
<span class="linenos">1415</span><span class="sd">            opT.cogram() = op.gram()</span>
<span class="linenos">1416</span><span class="sd">            opT.svdvals() = op.svdvals()</span>
<span class="linenos">1417</span>
<span class="linenos">1418</span><span class="sd">        * LINEAR_SQUARE</span>
<span class="linenos">1419</span><span class="sd">            opT.trace() = op.trace()</span>
<span class="linenos">1420</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">1421</span>
<span class="linenos">1422</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">):</span>
<span class="linenos">1423</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<span class="linenos">1424</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_op</span> <span class="o">=</span> <span class="n">op</span>
<span class="linenos">1425</span>
<span class="linenos">1426</span>    <span class="k">def</span> <span class="nf">op</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">:</span>
<span class="linenos">1427</span>        <span class="n">klass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infer_op_klass</span><span class="p">()</span>
<span class="linenos">1428</span>        <span class="n">op</span> <span class="o">=</span> <span class="n">klass</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">codim</span><span class="p">))</span>
<span class="linenos">1429</span>        <span class="n">op</span><span class="o">.</span><span class="n">_op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span>  <span class="c1"># embed for introspection</span>
<span class="linenos">1430</span>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">op</span><span class="o">.</span><span class="n">properties</span><span class="p">():</span>
<span class="linenos">1431</span>            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">arithmetic_methods</span><span class="p">():</span>
<span class="linenos">1432</span>                <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
<span class="linenos">1433</span>                <span class="nb">setattr</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">op</span><span class="p">))</span>
<span class="linenos">1434</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_propagate_constants</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<span class="linenos">1435</span>        <span class="k">return</span> <span class="n">op</span>
<span class="linenos">1436</span>
<span class="linenos">1437</span>    <span class="k">def</span> <span class="nf">_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="linenos">1438</span>        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;transpose&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="p">)</span>
<span class="linenos">1439</span>
<span class="linenos">1440</span>    <span class="k">def</span> <span class="nf">_infer_op_klass</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpC</span><span class="p">:</span>
<span class="linenos">1441</span>        <span class="c1"># |----------------------|-----------------------|</span>
<span class="linenos">1442</span>        <span class="c1"># | op_klass(codim, dim) | opT_klass(codim, dim) |</span>
<span class="linenos">1443</span>        <span class="c1"># |----------------------|-----------------------|</span>
<span class="linenos">1444</span>        <span class="c1"># | LinFunc(1, N)        | LinOp(N, 1)           |</span>
<span class="linenos">1445</span>        <span class="c1"># | LinOp(N, 1)          | LinFunc(1, N)         |</span>
<span class="linenos">1446</span>        <span class="c1"># | SquareOp(N, N)       | SquareOp(N, N)        |</span>
<span class="linenos">1447</span>        <span class="c1"># |----------------------|-----------------------|</span>
<span class="linenos">1448</span>        <span class="n">properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">properties</span><span class="p">()</span>
<span class="linenos">1449</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">codim</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">1450</span>            <span class="n">klass</span> <span class="o">=</span> <span class="n">pxo</span><span class="o">.</span><span class="n">LinFunc</span>
<span class="linenos">1451</span>        <span class="k">elif</span> <span class="n">pxo</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">FUNCTIONAL</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
<span class="linenos">1452</span>            <span class="n">klass</span> <span class="o">=</span> <span class="n">pxo</span><span class="o">.</span><span class="n">LinOp</span>
<span class="linenos">1453</span>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">1454</span>            <span class="n">klass</span> <span class="o">=</span> <span class="n">pxo</span><span class="o">.</span><span class="n">LinFunc</span>
<span class="linenos">1455</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1456</span>            <span class="n">klass</span> <span class="o">=</span> <span class="n">pxo</span><span class="o">.</span><span class="n">Operator</span><span class="o">.</span><span class="n">_infer_operator_type</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span>
<span class="linenos">1457</span>        <span class="k">return</span> <span class="n">klass</span>
<span class="linenos">1458</span>
<span class="linenos">1459</span>    <span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="s2">&quot;arr&quot;</span><span class="p">)</span>
<span class="linenos">1460</span>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos">1461</span>        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">adjoint</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="linenos">1462</span>        <span class="k">return</span> <span class="n">out</span>
<span class="linenos">1463</span>
<span class="linenos">1464</span>    <span class="k">def</span> <span class="nf">estimate_lipschitz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Real</span><span class="p">:</span>
<span class="linenos">1465</span>        <span class="n">no_eval</span> <span class="o">=</span> <span class="s2">&quot;__rule&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span>
<span class="linenos">1466</span>        <span class="k">if</span> <span class="n">no_eval</span><span class="p">:</span>
<span class="linenos">1467</span>            <span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">lipschitz</span>
<span class="linenos">1468</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1469</span>            <span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">estimate_lipschitz</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos">1470</span>        <span class="k">return</span> <span class="n">L</span>
<span class="linenos">1471</span>
<span class="linenos">1472</span>    <span class="k">def</span> <span class="nf">asloss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">:</span>
<span class="linenos">1473</span>        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
<span class="linenos">1474</span>
<span class="linenos">1475</span>    <span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;arr&quot;</span><span class="p">,</span> <span class="s2">&quot;tau&quot;</span><span class="p">))</span>
<span class="linenos">1476</span>    <span class="k">def</span> <span class="nf">prox</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">tau</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Real</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos">1477</span>        <span class="n">out</span> <span class="o">=</span> <span class="n">pxo</span><span class="o">.</span><span class="n">LinFunc</span><span class="o">.</span><span class="n">prox</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span>
<span class="linenos">1478</span>        <span class="k">return</span> <span class="n">out</span>
<span class="linenos">1479</span>
<span class="linenos">1480</span>    <span class="k">def</span> <span class="nf">jacobian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">:</span>
<span class="linenos">1481</span>        <span class="k">return</span> <span class="bp">self</span>
<span class="linenos">1482</span>
<span class="linenos">1483</span>    <span class="k">def</span> <span class="nf">estimate_diff_lipschitz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Real</span><span class="p">:</span>
<span class="linenos">1484</span>        <span class="k">return</span> <span class="mi">0</span>
<span class="linenos">1485</span>
<span class="linenos">1486</span>    <span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="s2">&quot;arr&quot;</span><span class="p">)</span>
<span class="linenos">1487</span>    <span class="k">def</span> <span class="nf">grad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos">1488</span>        <span class="n">out</span> <span class="o">=</span> <span class="n">pxo</span><span class="o">.</span><span class="n">LinFunc</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">)</span>
<span class="linenos">1489</span>        <span class="k">return</span> <span class="n">out</span>
<span class="linenos">1490</span>
<span class="linenos">1491</span>    <span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="s2">&quot;arr&quot;</span><span class="p">)</span>
<span class="linenos">1492</span>    <span class="k">def</span> <span class="nf">adjoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos">1493</span>        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="linenos">1494</span>        <span class="k">return</span> <span class="n">out</span>
<span class="linenos">1495</span>
<span class="linenos">1496</span>    <span class="k">def</span> <span class="nf">asarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos">1497</span>        <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos">1498</span>        <span class="k">return</span> <span class="n">A</span><span class="o">.</span><span class="n">T</span>
<span class="linenos">1499</span>
<span class="linenos">1500</span>    <span class="k">def</span> <span class="nf">gram</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">:</span>
<span class="linenos">1501</span>        <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">cogram</span><span class="p">()</span>
<span class="linenos">1502</span>        <span class="k">return</span> <span class="n">op</span>
<span class="linenos">1503</span>
<span class="linenos">1504</span>    <span class="k">def</span> <span class="nf">cogram</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">:</span>
<span class="linenos">1505</span>        <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">gram</span><span class="p">()</span>
<span class="linenos">1506</span>        <span class="k">return</span> <span class="n">op</span>
<span class="linenos">1507</span>
<span class="linenos">1508</span>    <span class="k">def</span> <span class="nf">svdvals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos">1509</span>        <span class="n">D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">svdvals</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos">1510</span>        <span class="k">return</span> <span class="n">D</span>
<span class="linenos">1511</span>
<span class="linenos">1512</span>    <span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">()</span>
<span class="linenos">1513</span>    <span class="k">def</span> <span class="nf">trace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Real</span><span class="p">:</span>
<span class="linenos">1514</span>        <span class="n">tr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos">1515</span>        <span class="k">return</span> <span class="n">tr</span></div>

<span class="linenos">1516</span>
<span class="linenos">1517</span>
<span class="linenos">1518</span><span class="c1"># Helper Class/Functions ------------------------------------------------------</span>
<span class="linenos">1519</span><span class="k">def</span> <span class="nf">_Sum</span><span class="p">(</span><span class="n">M</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">N</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">:</span>
<span class="linenos">1520</span>    <span class="c1"># f: \bR^{N} -&gt; \bR^{M}</span>
<span class="linenos">1521</span>    <span class="c1">#      x     -&gt; [sum(x), ..., sum(x)]  (M times)</span>
<span class="linenos">1522</span>    <span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="s2">&quot;arr&quot;</span><span class="p">)</span>
<span class="linenos">1523</span>    <span class="k">def</span> <span class="nf">op_apply</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">arr</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos">1524</span>        <span class="n">xp</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">get_array_module</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="linenos">1525</span>        <span class="n">out</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span>
<span class="linenos">1526</span>            <span class="n">arr</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<span class="linenos">1527</span>            <span class="p">(</span><span class="o">*</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">_</span><span class="o">.</span><span class="n">codim</span><span class="p">),</span>
<span class="linenos">1528</span>        <span class="p">)</span>
<span class="linenos">1529</span>        <span class="k">return</span> <span class="n">out</span>
<span class="linenos">1530</span>
<span class="linenos">1531</span>    <span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="s2">&quot;arr&quot;</span><span class="p">)</span>
<span class="linenos">1532</span>    <span class="k">def</span> <span class="nf">op_adjoint</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">arr</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos">1533</span>        <span class="n">xp</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">get_array_module</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="linenos">1534</span>        <span class="n">out</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span>
<span class="linenos">1535</span>            <span class="n">arr</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<span class="linenos">1536</span>            <span class="p">(</span><span class="o">*</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">_</span><span class="o">.</span><span class="n">dim</span><span class="p">),</span>
<span class="linenos">1537</span>        <span class="p">)</span>
<span class="linenos">1538</span>        <span class="k">return</span> <span class="n">out</span>
<span class="linenos">1539</span>
<span class="linenos">1540</span>    <span class="k">def</span> <span class="nf">op_gram</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">:</span>
<span class="linenos">1541</span>        <span class="n">op</span> <span class="o">=</span> <span class="n">_Sum</span><span class="p">(</span><span class="n">M</span><span class="o">=</span><span class="n">_</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="n">_</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span> <span class="o">*</span> <span class="n">_</span><span class="o">.</span><span class="n">codim</span>
<span class="linenos">1542</span>        <span class="k">return</span> <span class="n">op</span>
<span class="linenos">1543</span>
<span class="linenos">1544</span>    <span class="k">def</span> <span class="nf">op_cogram</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">:</span>
<span class="linenos">1545</span>        <span class="n">op</span> <span class="o">=</span> <span class="n">_Sum</span><span class="p">(</span><span class="n">M</span><span class="o">=</span><span class="n">_</span><span class="o">.</span><span class="n">codim</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="n">_</span><span class="o">.</span><span class="n">codim</span><span class="p">)</span> <span class="o">*</span> <span class="n">_</span><span class="o">.</span><span class="n">dim</span>
<span class="linenos">1546</span>        <span class="k">return</span> <span class="n">op</span>
<span class="linenos">1547</span>
<span class="linenos">1548</span>    <span class="k">if</span> <span class="n">M</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">1549</span>        <span class="n">klass</span> <span class="o">=</span> <span class="n">pxo</span><span class="o">.</span><span class="n">LinFunc</span>
<span class="linenos">1550</span>    <span class="k">elif</span> <span class="n">M</span> <span class="o">==</span> <span class="n">N</span><span class="p">:</span>
<span class="linenos">1551</span>        <span class="n">klass</span> <span class="o">=</span> <span class="n">pxo</span><span class="o">.</span><span class="n">SelfAdjointOp</span>
<span class="linenos">1552</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">1553</span>        <span class="n">klass</span> <span class="o">=</span> <span class="n">pxo</span><span class="o">.</span><span class="n">LinOp</span>
<span class="linenos">1554</span>    <span class="n">op</span> <span class="o">=</span> <span class="n">klass</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
<span class="linenos">1555</span>    <span class="n">op</span><span class="o">.</span><span class="n">_lipschitz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">M</span> <span class="o">*</span> <span class="n">N</span><span class="p">)</span>
<span class="linenos">1556</span>    <span class="n">op</span><span class="o">.</span><span class="n">apply</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">(</span><span class="n">op_apply</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
<span class="linenos">1557</span>    <span class="n">op</span><span class="o">.</span><span class="n">adjoint</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">(</span><span class="n">op_adjoint</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
<span class="linenos">1558</span>    <span class="n">op</span><span class="o">.</span><span class="n">gram</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">(</span><span class="n">op_gram</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
<span class="linenos">1559</span>    <span class="n">op</span><span class="o">.</span><span class="n">cogram</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">(</span><span class="n">op_cogram</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
<span class="linenos">1560</span>    <span class="k">return</span> <span class="n">op</span>
</pre></div>

                </article>
              
              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
<div id="searchbox"></div></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">
  <p class="copyright">
    
       Copyright 2023, M. Simeoni, S. Kashani, J. Ru-Queralt &amp; Pyxu Developers.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">
  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.5.
    <br/>
  </p>
</div>
      
        <div class="footer-item"><p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.13.3.
</p></div>
      
    </div>
  
  
    <div class="footer-items__end">
      
        <div class="footer-item"><p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.13.3.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>