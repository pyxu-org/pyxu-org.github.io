
<!DOCTYPE html>


<html lang="en" data-theme="light">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pyxu.operator.linop.fft.nufft &#8212; Pyxu Documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "light";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../../../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../../../../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../../../../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../../../../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/plot_directive.css?v=7f9a90b1" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/sphinx-codeautolink.css?v=125d5c1c" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/sg_gallery.css?v=61a4c737" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/css/custom.css?v=1031a718" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../../../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../../../../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script src="../../../../../_static/documentation_options.js?v=29481255"></script>
    <script src="../../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../../../_static/copybutton.js?v=30646c52"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script src="../../../../../_static/design-tabs.js?v=36754332"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/pyxu/operator/linop/fft/nufft';</script>
    <link rel="icon" href="../../../../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="light">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  <div class="navbar-header-items__start">
    
      <div class="navbar-item">
  

<a class="navbar-brand logo" href="../../../../../index.html">
  
  
  
  
    
    
    
    <img src="../../../../../_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../../../../../_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
    
  </div>
  
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../../intro/index.html">
                        Getting Started
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../../guide/index.html">
                        User Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../../examples/index.html">
                        Example Gallery
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../../api/index.html">
                        API Reference
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../../fair/index.html">
                        Extending Pyxu
                      </a>
                    </li>
                
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
        </div>
      
      
        <div class="navbar-item"><strong> v0.0.1 </strong></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/matthieumeo/pyxu" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-github"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/pyxu/" title="PyPI" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-python"></i></span>
            <label class="sr-only">PyPI</label></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="mailto: matthieu.simeoni@gmail.com" title="Contact" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-telegram"></i></span>
            <label class="sr-only">Contact</label></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://imaging.epfl.ch/" title="EPFL Center for Imaging" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="../../../../../_static/imaging.png" class="icon-link-image" alt="EPFL Center for Imaging"/></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
    </div>
  

  
    <label class="sidebar-toggle secondary-toggle" for="__secondary">
      <span class="fa-solid fa-outdent"></span>
    </label>
  
</div>

    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../../intro/index.html">
                        Getting Started
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../../guide/index.html">
                        User Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../../examples/index.html">
                        Example Gallery
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../../api/index.html">
                        API Reference
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../../fair/index.html">
                        Extending Pyxu
                      </a>
                    </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item"><strong> v0.0.1 </strong></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/matthieumeo/pyxu" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-github"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/pyxu/" title="PyPI" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-python"></i></span>
            <label class="sr-only">PyPI</label></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="mailto: matthieu.simeoni@gmail.com" title="Contact" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-telegram"></i></span>
            <label class="sr-only">Contact</label></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://imaging.epfl.ch/" title="EPFL Center for Imaging" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="../../../../../_static/imaging.png" class="icon-link-image" alt="EPFL Center for Imaging"/></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumbs">
  <ul class="bd-breadcrumbs" role="navigation" aria-label="Breadcrumb">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../../../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">pyxu.operator.linop.fft.nufft</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <h1>Source code for pyxu.operator.linop.fft.nufft</h1><div class="highlight"><pre>
<span></span><span class="linenos">   1</span><span class="kn">import</span> <span class="nn">cmath</span>
<span class="linenos">   2</span><span class="kn">import</span> <span class="nn">collections</span>
<span class="linenos">   3</span><span class="kn">import</span> <span class="nn">collections.abc</span> <span class="k">as</span> <span class="nn">cabc</span>
<span class="linenos">   4</span><span class="kn">import</span> <span class="nn">functools</span>
<span class="linenos">   5</span><span class="kn">import</span> <span class="nn">itertools</span>
<span class="linenos">   6</span><span class="kn">import</span> <span class="nn">math</span>
<span class="linenos">   7</span><span class="kn">import</span> <span class="nn">threading</span>
<span class="linenos">   8</span><span class="kn">import</span> <span class="nn">types</span>
<span class="linenos">   9</span><span class="kn">import</span> <span class="nn">typing</span> <span class="k">as</span> <span class="nn">typ</span>
<span class="linenos">  10</span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="linenos">  11</span>
<span class="linenos">  12</span><span class="kn">import</span> <span class="nn">dask</span>
<span class="linenos">  13</span><span class="kn">import</span> <span class="nn">numba</span>
<span class="linenos">  14</span><span class="kn">import</span> <span class="nn">numba.cuda</span>
<span class="linenos">  15</span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="linenos">  16</span><span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">sopt</span>
<span class="linenos">  17</span><span class="kn">import</span> <span class="nn">scipy.spatial</span> <span class="k">as</span> <span class="nn">spl</span>
<span class="linenos">  18</span>
<span class="linenos">  19</span><span class="kn">import</span> <span class="nn">pyxu.abc</span> <span class="k">as</span> <span class="nn">pxa</span>
<span class="linenos">  20</span><span class="kn">import</span> <span class="nn">pyxu.info.deps</span> <span class="k">as</span> <span class="nn">pxd</span>
<span class="linenos">  21</span><span class="kn">import</span> <span class="nn">pyxu.info.ptype</span> <span class="k">as</span> <span class="nn">pxt</span>
<span class="linenos">  22</span><span class="kn">import</span> <span class="nn">pyxu.info.warning</span> <span class="k">as</span> <span class="nn">pxw</span>
<span class="linenos">  23</span><span class="kn">import</span> <span class="nn">pyxu.operator.linop.select</span> <span class="k">as</span> <span class="nn">pxs</span>
<span class="linenos">  24</span><span class="kn">import</span> <span class="nn">pyxu.runtime</span> <span class="k">as</span> <span class="nn">pxrt</span>
<span class="linenos">  25</span><span class="kn">import</span> <span class="nn">pyxu.util</span> <span class="k">as</span> <span class="nn">pxu</span>
<span class="linenos">  26</span><span class="kn">from</span> <span class="nn">pyxu.util.operator</span> <span class="kn">import</span> <span class="n">_array_ize</span><span class="p">,</span> <span class="n">_dask_zip</span>
<span class="linenos">  27</span>
<span class="linenos">  28</span><span class="n">finufft</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s2">&quot;finufft&quot;</span><span class="p">,</span> <span class="n">fail_on_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos">  29</span><span class="k">if</span> <span class="n">finufft</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">  30</span>    <span class="n">finufft_Plan</span> <span class="o">=</span> <span class="n">typ</span><span class="o">.</span><span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;finufft_Plan&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="s2">&quot;finufft.Plan&quot;</span><span class="p">)</span>
<span class="linenos">  31</span><span class="k">else</span><span class="p">:</span>
<span class="linenos">  32</span>    <span class="n">finufft_Plan</span> <span class="o">=</span> <span class="n">finufft</span><span class="o">.</span><span class="n">Plan</span>
<span class="linenos">  33</span>
<span class="linenos">  34</span>
<span class="linenos">  35</span><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos">  36</span>    <span class="s2">&quot;NUFFT&quot;</span><span class="p">,</span>
<span class="linenos">  37</span><span class="p">]</span>
<span class="linenos">  38</span>
<span class="linenos">  39</span><span class="n">SignT</span> <span class="o">=</span> <span class="n">typ</span><span class="o">.</span><span class="n">Literal</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">  40</span><span class="n">sign_default</span> <span class="o">=</span> <span class="mi">1</span>
<span class="linenos">  41</span><span class="n">eps_default</span> <span class="o">=</span> <span class="mf">1e-4</span>
<span class="linenos">  42</span>
<span class="linenos">  43</span>
<span class="linenos">  44</span><span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;beta&quot;</span><span class="p">))</span>
<span class="linenos">  45</span><span class="k">def</span> <span class="nf">ES_kernel</span><span class="p">(</span><span class="n">z</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">beta</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Real</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos">  46</span><span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">  47</span><span class="sd">    Evaluate the Exponential of Semi-Circle (ES) kernel.</span>
<span class="linenos">  48</span>
<span class="linenos">  49</span><span class="sd">    Parameters</span>
<span class="linenos">  50</span><span class="sd">    ----------</span>
<span class="linenos">  51</span><span class="sd">    z: pxt.NDArray</span>
<span class="linenos">  52</span><span class="sd">        (N,) evaluation points</span>
<span class="linenos">  53</span><span class="sd">    beta: pxt.Real</span>
<span class="linenos">  54</span><span class="sd">        cutoff-frequency</span>
<span class="linenos">  55</span>
<span class="linenos">  56</span><span class="sd">    Returns</span>
<span class="linenos">  57</span><span class="sd">    -------</span>
<span class="linenos">  58</span><span class="sd">    phi: pxt.NDArray</span>
<span class="linenos">  59</span><span class="sd">        (N,) kernel values at evaluation points.</span>
<span class="linenos">  60</span>
<span class="linenos">  61</span><span class="sd">    Notes</span>
<span class="linenos">  62</span><span class="sd">    -----</span>
<span class="linenos">  63</span><span class="sd">    The Exponential of Semi-Circle (ES) kernel is defined as (see [FINUFFT]_ eq. (1.8)):</span>
<span class="linenos">  64</span>
<span class="linenos">  65</span><span class="sd">    .. math::</span>
<span class="linenos">  66</span>
<span class="linenos">  67</span><span class="sd">       \phi_\beta(z)</span>
<span class="linenos">  68</span><span class="sd">       =</span>
<span class="linenos">  69</span><span class="sd">       \begin{cases}</span>
<span class="linenos">  70</span><span class="sd">           e^{\beta(\sqrt{1-z^2}-1)}, &amp; |z|\leq 1,\\</span>
<span class="linenos">  71</span><span class="sd">           0,                         &amp;\text{otherwise.}</span>
<span class="linenos">  72</span><span class="sd">       \end{cases}</span>
<span class="linenos">  73</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">  74</span>    <span class="k">assert</span> <span class="n">beta</span> <span class="o">&gt;</span> <span class="mi">0</span>
<span class="linenos">  75</span>    <span class="n">xp</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">get_array_module</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
<span class="linenos">  76</span>
<span class="linenos">  77</span>    <span class="n">phi</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
<span class="linenos">  78</span>    <span class="n">mask</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span>
<span class="linenos">  79</span>    <span class="n">phi</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">beta</span> <span class="o">*</span> <span class="p">(</span><span class="n">xp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">z</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
<span class="linenos">  80</span>
<span class="linenos">  81</span>    <span class="k">return</span> <span class="n">phi</span>
<span class="linenos">  82</span>
<span class="linenos">  83</span>
<div class="viewcode-block" id="NUFFT">
<a class="viewcode-back" href="../../../../../api/operator/linop.html#pyxu.operator.linop.fft.nufft.NUFFT">[docs]</a>
<span class="linenos">  84</span><span class="k">class</span> <span class="nc">NUFFT</span><span class="p">(</span><span class="n">pxa</span><span class="o">.</span><span class="n">LinOp</span><span class="p">):</span>
<span class="linenos">  85</span><span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">  86</span><span class="sd">    Non-Uniform Fast Fourier Transform (NUFFT) of Type 1/2/3 (for :math:`d=\{1,2,3\}`).</span>
<span class="linenos">  87</span>
<span class="linenos">  88</span><span class="sd">    The *Non-Uniform Fast Fourier Transform (NUFFT)* generalizes the FFT to off-grid data.</span>
<span class="linenos">  89</span><span class="sd">    There are three types of NUFFTs proposed in the literature:</span>
<span class="linenos">  90</span>
<span class="linenos">  91</span><span class="sd">    * Type 1 (*non-uniform to uniform*),</span>
<span class="linenos">  92</span><span class="sd">    * Type 2 (*uniform to non-uniform*),</span>
<span class="linenos">  93</span><span class="sd">    * Type 3 (*non-uniform to non-uniform*).</span>
<span class="linenos">  94</span>
<span class="linenos">  95</span><span class="sd">    See the notes below, including [FINUFFT]_, for definitions of the various transforms and algorithmic details.</span>
<span class="linenos">  96</span>
<span class="linenos">  97</span><span class="sd">    The transforms should be instantiated via</span>
<span class="linenos">  98</span><span class="sd">    :py:meth:`~pyxu.operator.linop.fft.nufft.NUFFT.type1`,</span>
<span class="linenos">  99</span><span class="sd">    :py:meth:`~pyxu.operator.linop.fft.nufft.NUFFT.type2`, and</span>
<span class="linenos"> 100</span><span class="sd">    :py:meth:`~pyxu.operator.linop.fft.nufft.NUFFT.type3` respectively.</span>
<span class="linenos"> 101</span><span class="sd">    (See each method for usage examples.)</span>
<span class="linenos"> 102</span>
<span class="linenos"> 103</span><span class="sd">    The dimension of each transform is inferred from the dimensions of the input arguments, with support for</span>
<span class="linenos"> 104</span><span class="sd">    :math:`d=\{1,2,3\}`.</span>
<span class="linenos"> 105</span>
<span class="linenos"> 106</span><span class="sd">    Notes</span>
<span class="linenos"> 107</span><span class="sd">    -----</span>
<span class="linenos"> 108</span><span class="sd">    We adopt here the same notational conventions as in [FINUFFT]_.</span>
<span class="linenos"> 109</span>
<span class="linenos"> 110</span><span class="sd">    * **Mathematical Definition.**</span>
<span class="linenos"> 111</span><span class="sd">      Let :math:`d\in\{1,2,3\}` and consider the mesh</span>
<span class="linenos"> 112</span>
<span class="linenos"> 113</span><span class="sd">      .. math::</span>
<span class="linenos"> 114</span>
<span class="linenos"> 115</span><span class="sd">         \mathcal{I}_{N_1,\ldots,N_d}</span>
<span class="linenos"> 116</span><span class="sd">         =</span>
<span class="linenos"> 117</span><span class="sd">         \mathcal{I}_{N_1} \times \cdots \times \mathcal{I}_{N_d}</span>
<span class="linenos"> 118</span><span class="sd">         \subset \mathbb{Z}^d,</span>
<span class="linenos"> 119</span>
<span class="linenos"> 120</span><span class="sd">      where the mesh indices :math:`\mathcal{I}_{N_i}\subset\mathbb{Z}` are given for each dimension :math:`i=1,\dots, d`</span>
<span class="linenos"> 121</span><span class="sd">      by:</span>
<span class="linenos"> 122</span>
<span class="linenos"> 123</span><span class="sd">      .. math::</span>
<span class="linenos"> 124</span>
<span class="linenos"> 125</span><span class="sd">         \mathcal{I}_{N_i}</span>
<span class="linenos"> 126</span><span class="sd">         =</span>
<span class="linenos"> 127</span><span class="sd">         \begin{cases}</span>
<span class="linenos"> 128</span><span class="sd">             [[-N_i/2, N_i/2-1]], &amp; N_i\in 2\mathbb{N} \text{ (even)}, \\</span>
<span class="linenos"> 129</span><span class="sd">             [[-(N_i-1)/2, (N_i-1)/2]], &amp; N_i\in 2\mathbb{N}+1 \text{ (odd)}.</span>
<span class="linenos"> 130</span><span class="sd">         \end{cases}</span>
<span class="linenos"> 131</span>
<span class="linenos"> 132</span>
<span class="linenos"> 133</span><span class="sd">      Then the NUFFT operators approximate, up to a requested relative accuracy :math:`\varepsilon \geq 0`, [#]_ the</span>
<span class="linenos"> 134</span><span class="sd">      following exponential sums:</span>
<span class="linenos"> 135</span>
<span class="linenos"> 136</span><span class="sd">      .. math::</span>
<span class="linenos"> 137</span>
<span class="linenos"> 138</span><span class="sd">         \begin{align}</span>
<span class="linenos"> 139</span><span class="sd">             (1)\; &amp;u_{\mathbf{n}} = \sum_{j=1}^{M} w_{j} e^{\sigma i\langle \mathbf{n}, \mathbf{x}_{j} \rangle}, \quad &amp;\mathbf{n}\in \mathcal{I}_{N_1,\ldots, N_d},\qquad &amp;\text{Type 1 (non-uniform to uniform)}\\</span>
<span class="linenos"> 140</span><span class="sd">             (2)\; &amp;w_{j} = \sum_{\mathbf{n}\in\mathcal{I}_{N_1,\ldots, N_d}} u_{\mathbf{n}} e^{\sigma i\langle \mathbf{n}, \mathbf{x}_{j} \rangle }, \quad &amp;j=1,\ldots, M,\qquad  &amp;\text{Type 2 (uniform to non-uniform)}\\</span>
<span class="linenos"> 141</span><span class="sd">             (3)\; &amp;v_{k} = \sum_{j=1}^{M} w_{j} e^{\sigma i\langle \mathbf{z}_k, \mathbf{x}_{j} \rangle }, \quad &amp;k=1,\ldots, N, \qquad &amp;\text{Type 3 (non-uniform to non-uniform)}</span>
<span class="linenos"> 142</span><span class="sd">         \end{align}</span>
<span class="linenos"> 143</span>
<span class="linenos"> 144</span><span class="sd">      where :math:`\sigma \in \{+1, -1\}` defines the sign of the transform and :math:`u_{\mathbf{n}}, v_{k}, w_{j}\in</span>
<span class="linenos"> 145</span><span class="sd">      \mathbb{C}`.</span>
<span class="linenos"> 146</span><span class="sd">      For the type-1 and type-2 NUFFTs, the non-uniform samples :math:`\mathbf{x}_{j}` are assumed to lie in</span>
<span class="linenos"> 147</span><span class="sd">      :math:`[-\pi,\pi)^{d}`.</span>
<span class="linenos"> 148</span><span class="sd">      For the type-3 NUFFT, the non-uniform samples :math:`\mathbf{x}_{j}` and :math:`\mathbf{z}_{k}` are arbitrary points</span>
<span class="linenos"> 149</span><span class="sd">      in :math:`\mathbb{R}^{d}`.</span>
<span class="linenos"> 150</span>
<span class="linenos"> 151</span><span class="sd">    * **Adjoint NUFFTs.**</span>
<span class="linenos"> 152</span><span class="sd">      The type-1 and type-2 NUFFTs with opposite signs form an *adjoint pair*.</span>
<span class="linenos"> 153</span><span class="sd">      The adjoint of the type-3 NUFFT is obtained by flipping the transform&#39;s sign and switching the roles of</span>
<span class="linenos"> 154</span><span class="sd">      :math:`\mathbf{z}_k` and :math:`\mathbf{x}_{j}` in (3).</span>
<span class="linenos"> 155</span>
<span class="linenos"> 156</span><span class="sd">    * **Lipschitz Constants.**</span>
<span class="linenos"> 157</span><span class="sd">      We bound the Lipschitz constant by the Frobenius norm of the operators, which yields :math:`L \leq \sqrt{NM}`.</span>
<span class="linenos"> 158</span><span class="sd">      Note that these Lipschitz constants are cheap to compute but may be pessimistic.</span>
<span class="linenos"> 159</span><span class="sd">      Tighter Lipschitz constants can be computed by calling :py:meth:`~pyxu.abc.operator.Map.estimate_lipschitz`.</span>
<span class="linenos"> 160</span>
<span class="linenos"> 161</span><span class="sd">    * **Error Analysis.**</span>
<span class="linenos"> 162</span><span class="sd">      Let :math:`\tilde{\mathbf{u}}\in\mathbb{C}^{\mathcal{I}_{N_1,\ldots, N_d}}` and</span>
<span class="linenos"> 163</span><span class="sd">      :math:`\tilde{\mathbf{w}}\in\mathbb{C}^{M}` be the outputs of the type-1 and type-2 NUFFT algorithms which</span>
<span class="linenos"> 164</span><span class="sd">      approximate the sequences :math:`{\mathbf{u}}\in\mathbb{C}^{\mathcal{I}_{N_1,\ldots, N_d}}` and</span>
<span class="linenos"> 165</span><span class="sd">      :math:`{\mathbf{w}}\in\mathbb{C}^{M}` defined in (1) and (2) respectively.</span>
<span class="linenos"> 166</span><span class="sd">      Then [FINUFFT]_ shows that the relative errors :math:`\|\tilde{\mathbf{u}}-{\mathbf{u}}\|_2/\|{\mathbf{u}}\|_2` and</span>
<span class="linenos"> 167</span><span class="sd">      :math:`\|\tilde{\mathbf{w}}-{\mathbf{w}}\|_2/\|{\mathbf{w}}\|_2` are *almost always similar to the user-requested</span>
<span class="linenos"> 168</span><span class="sd">      tolerance* :math:`\varepsilon`, except when round-off error dominates (i.e. very small user-requested tolerances).</span>
<span class="linenos"> 169</span><span class="sd">      The same holds approximately for the type-3 NUFFT.</span>
<span class="linenos"> 170</span><span class="sd">      Note however that this is a *typical error analysis*: some degenerate (but rare) worst-case scenarios can result in</span>
<span class="linenos"> 171</span><span class="sd">      higher errors.</span>
<span class="linenos"> 172</span>
<span class="linenos"> 173</span><span class="sd">    * **Complexity.**</span>
<span class="linenos"> 174</span><span class="sd">      Naive evaluation of the exponential sums (1), (2) and (3) above costs :math:`O(NM)`, where :math:`N=N_{1}\ldots</span>
<span class="linenos"> 175</span><span class="sd">      N_{d}` for the type-1 and type-2 NUFFTs.</span>
<span class="linenos"> 176</span><span class="sd">      NUFFT algorithms approximate these sums to a user-specified relative tolerance :math:`\varepsilon` in log-linear</span>
<span class="linenos"> 177</span><span class="sd">      complexity in :math:`N` and :math:`M`.</span>
<span class="linenos"> 178</span><span class="sd">      The complexity of the various NUFFTs are given by (see [FINUFFT]_):</span>
<span class="linenos"> 179</span>
<span class="linenos"> 180</span><span class="sd">      .. math::</span>
<span class="linenos"> 181</span>
<span class="linenos"> 182</span><span class="sd">         &amp;\mathcal{O}\left(N \log(N) + M|\log(\varepsilon)|^d\right)\qquad &amp;\text{(Type 1 and 2)}\\</span>
<span class="linenos"> 183</span><span class="sd">         &amp;\mathcal{O}\left(\Pi_{i=1}^dX_iZ_i\sum_{i=1}^d\log(X_iZ_i) + (M + N)|\log(\varepsilon)|^d\right)\qquad &amp;\text{(Type 3)}</span>
<span class="linenos"> 184</span>
<span class="linenos"> 185</span><span class="sd">      where :math:`X_i = \max_{j=1,\ldots,M}|(\mathbf{x}_{j})_i|` and :math:`Z_i = \max_{k=1,\ldots,N}|(\mathbf{z}_k)_i|`</span>
<span class="linenos"> 186</span><span class="sd">      for :math:`i=1,\ldots,d`.</span>
<span class="linenos"> 187</span><span class="sd">      The terms above correspond to the complexities of the FFT and spreading/interpolation steps respectively.</span>
<span class="linenos"> 188</span>
<span class="linenos"> 189</span><span class="sd">    * **Memory footprint.**</span>
<span class="linenos"> 190</span><span class="sd">      The complexity and memory footprint of the type-3 NUFFT can be arbitrarily large for poorly-centered data, or for</span>
<span class="linenos"> 191</span><span class="sd">      data with a large spread.</span>
<span class="linenos"> 192</span><span class="sd">      An easy fix consists in centering the data before/after the NUFFT via pre/post-phasing operations, as described in</span>
<span class="linenos"> 193</span><span class="sd">      equation (3.24) of [FINUFFT]_.</span>
<span class="linenos"> 194</span><span class="sd">      This optimization is automatically carried out by FINUFFT if the compute/memory gains are non-negligible.</span>
<span class="linenos"> 195</span>
<span class="linenos"> 196</span><span class="sd">      Additionally the type-3 summation (eq. 3) can be evaluated block-wise by partitioning the non-uniform samples</span>
<span class="linenos"> 197</span><span class="sd">      :math:`(x_{j}, z_{k})`:</span>
<span class="linenos"> 198</span>
<span class="linenos"> 199</span><span class="sd">      .. math::</span>
<span class="linenos"> 200</span>
<span class="linenos"> 201</span><span class="sd">         \begin{align}</span>
<span class="linenos"> 202</span><span class="sd">             (4)\;\; &amp;v_{k}</span>
<span class="linenos"> 203</span><span class="sd">             =</span>
<span class="linenos"> 204</span><span class="sd">             \sum_{p=1}^{P}</span>
<span class="linenos"> 205</span><span class="sd">             \sum_{j\in \mathcal{M}_{p}} w_{j}</span>
<span class="linenos"> 206</span><span class="sd">             e^{\sigma i\langle \mathbf{z}_{k}, \mathbf{x}_{j} \rangle },</span>
<span class="linenos"> 207</span><span class="sd">             \quad &amp;</span>
<span class="linenos"> 208</span><span class="sd">             k\in \mathcal{N}_{q}, \quad q=1,\ldots, Q, \quad &amp; \text{Type 3 (chunked)}</span>
<span class="linenos"> 209</span><span class="sd">         \end{align}</span>
<span class="linenos"> 210</span>
<span class="linenos"> 211</span><span class="sd">      where :math:`\{\mathcal{M}_1, \ldots, \mathcal{M}_P\}` and :math:`\{\mathcal{N}_1, \ldots, \mathcal{N}_Q\}` are</span>
<span class="linenos"> 212</span><span class="sd">      *partitions* of the sets :math:`\{1, \ldots, M\}` and  :math:`\{1, \ldots, N\}` respectively.</span>
<span class="linenos"> 213</span><span class="sd">      In the chunked setting, the partial sums in (4)</span>
<span class="linenos"> 214</span>
<span class="linenos"> 215</span><span class="sd">      .. math::</span>
<span class="linenos"> 216</span>
<span class="linenos"> 217</span><span class="sd">         \left\{\sum_{j\in \mathcal{M}_p} w_{j} e^{\sigma i\langle \mathbf{z}_k, \mathbf{x}_{j} \rangle }, \, k\in \mathcal{N}_q\right\}_{p,q}</span>
<span class="linenos"> 218</span>
<span class="linenos"> 219</span><span class="sd">      are each evaluated via a type-3 NUFFT involving a subset of the non-uniform samples.</span>
<span class="linenos"> 220</span><span class="sd">      Sub-problems can be evaluated in parallel.</span>
<span class="linenos"> 221</span><span class="sd">      Moreover, for wisely chosen data partitions, the memory budget of each NUFFT can be explicitly controlled and capped</span>
<span class="linenos"> 222</span><span class="sd">      to a maximal value.</span>
<span class="linenos"> 223</span><span class="sd">      This allows one to perform out-of-core NUFFTs with (theoretically) no complexity overhead w.r.t a single large</span>
<span class="linenos"> 224</span><span class="sd">      NUFFT. (See note below however.)</span>
<span class="linenos"> 225</span>
<span class="linenos"> 226</span><span class="sd">      Chunking of the type-3 NUFFT is activated by passing ``chunked=True`` to</span>
<span class="linenos"> 227</span><span class="sd">      :py:meth:`~pyxu.operator.linop.fft.nufft.NUFFT.type3` (together with ``parallel=True`` for parallel computations).</span>
<span class="linenos"> 228</span><span class="sd">      Finally, :py:meth:`~pyxu.operator.linop.fft.nufft.NUFFT.auto_chunk` can be used to compute a good partition of the</span>
<span class="linenos"> 229</span><span class="sd">      X/Z-domains.</span>
<span class="linenos"> 230</span>
<span class="linenos"> 231</span><span class="sd">      .. admonition:: Hint</span>
<span class="linenos"> 232</span>
<span class="linenos"> 233</span><span class="sd">         The current implementation of the chunked type-3 NUFFT has computational complexity:</span>
<span class="linenos"> 234</span>
<span class="linenos"> 235</span><span class="sd">         .. math::</span>
<span class="linenos"> 236</span>
<span class="linenos"> 237</span><span class="sd">            \mathcal{O}\left(</span>
<span class="linenos"> 238</span><span class="sd">                \sum_{p,q=1}^{P}\Pi_{i=1}^{d} X^{(p)}_{i}Z^{(q)}_{i}</span>
<span class="linenos"> 239</span><span class="sd">                \sum_{i=1}^{d} \log(X^{(p)}_{i} Z^{(q)}_{i})</span>
<span class="linenos"> 240</span><span class="sd">                +</span>
<span class="linenos"> 241</span><span class="sd">                (M_p + N_q)|\log(\varepsilon)|^{d}</span>
<span class="linenos"> 242</span><span class="sd">            \right),</span>
<span class="linenos"> 243</span>
<span class="linenos"> 244</span><span class="sd">         where</span>
<span class="linenos"> 245</span>
<span class="linenos"> 246</span><span class="sd">         .. math::</span>
<span class="linenos"> 247</span>
<span class="linenos"> 248</span><span class="sd">            \begin{align*}</span>
<span class="linenos"> 249</span><span class="sd">                X^{(p)}_{i} &amp; = \max_{j\in \mathcal{M}_{p}}|(\mathbf{x}_{j})_{i}|, \quad i = \{1,\ldots,d\} \\</span>
<span class="linenos"> 250</span><span class="sd">                Z^{(p)}_{i} &amp; = \max_{k\in \mathcal{N}_{q}}|(\mathbf{z}_k)_{i}|, \quad i = \{1,\ldots,d\}</span>
<span class="linenos"> 251</span><span class="sd">            \end{align*}</span>
<span class="linenos"> 252</span>
<span class="linenos"> 253</span>
<span class="linenos"> 254</span><span class="sd">         and :math:`M_{p}, N_{q}` denote the number of elements in the sets :math:`\mathcal{M}_{p},</span>
<span class="linenos"> 255</span><span class="sd">         \mathcal{N}_{q}`, respectively.</span>
<span class="linenos"> 256</span>
<span class="linenos"> 257</span><span class="sd">         For perfectly balanced and uniform chunks (i.e. :math:`M_{p}=M/P`, :math:`N_{q}=N/Q`, :math:`X^{(p)}_{i} =</span>
<span class="linenos"> 258</span><span class="sd">         X_{i}/P`, :math:`Z^{(q)}_{i} = Z_{i}/Q` and :math:`P=Q`) the complexity reduces to</span>
<span class="linenos"> 259</span>
<span class="linenos"> 260</span><span class="sd">         .. math::</span>
<span class="linenos"> 261</span>
<span class="linenos"> 262</span><span class="sd">            \mathcal{O}\left(</span>
<span class="linenos"> 263</span><span class="sd">                \Pi_{i=1}^{d} X_{i}Z_{i}\sum_{i=1}^{d}\log(X_{i}Z_{i})</span>
<span class="linenos"> 264</span><span class="sd">                +</span>
<span class="linenos"> 265</span><span class="sd">                P(M + N)|\log(\varepsilon)|^{d}</span>
<span class="linenos"> 266</span><span class="sd">            \right).</span>
<span class="linenos"> 267</span>
<span class="linenos"> 268</span><span class="sd">         This shows that the spreading/interpolation is :math:`P` times more expensive than in the non-chunked case.</span>
<span class="linenos"> 269</span><span class="sd">         This overhead is usually acceptable if the number of chunks remains small.</span>
<span class="linenos"> 270</span><span class="sd">         With explicit control on the spreading/interpolation steps (which the Python interface to the FINUFFT backend</span>
<span class="linenos"> 271</span><span class="sd">         does not currently offer), the spreading/interpolation overhead can be removed so as to obtain a computational</span>
<span class="linenos"> 272</span><span class="sd">         complexity on par to that of the non-chunked type-3 NUFFT.</span>
<span class="linenos"> 273</span><span class="sd">         This will be implemented in a future release.</span>
<span class="linenos"> 274</span>
<span class="linenos"> 275</span><span class="sd">    * **Backend.**</span>
<span class="linenos"> 276</span><span class="sd">      The NUFFT transforms are computed via Python wrappers to `FINUFFT &lt;https://github.com/flatironinstitute/finufft&gt;`_</span>
<span class="linenos"> 277</span><span class="sd">      and `cuFINUFFT &lt;https://github.com/flatironinstitute/cufinufft&gt;`_.  (See also [FINUFFT]_ and [cuFINUFFT]_.)</span>
<span class="linenos"> 278</span><span class="sd">      These librairies perform the expensive spreading/interpolation between nonuniform points and the fine grid via the</span>
<span class="linenos"> 279</span><span class="sd">      &quot;exponential of semicircle&quot; kernel.</span>
<span class="linenos"> 280</span>
<span class="linenos"> 281</span><span class="sd">    * **Optional Parameters.**</span>
<span class="linenos"> 282</span><span class="sd">      [cu]FINUFFT exposes many optional parameters to adjust the performance of the algorithms, change the output format,</span>
<span class="linenos"> 283</span><span class="sd">      or provide debug/timing information.</span>
<span class="linenos"> 284</span><span class="sd">      While the default options are sensible for most setups, advanced users may overwrite them via the ``kwargs``</span>
<span class="linenos"> 285</span><span class="sd">      parameter of</span>
<span class="linenos"> 286</span><span class="sd">      :py:meth:`~pyxu.operator.linop.fft.nufft.NUFFT.type1`,</span>
<span class="linenos"> 287</span><span class="sd">      :py:meth:`~pyxu.operator.linop.fft.nufft.NUFFT.type2`, and</span>
<span class="linenos"> 288</span><span class="sd">      :py:meth:`~pyxu.operator.linop.fft.nufft.NUFFT.type3`.</span>
<span class="linenos"> 289</span><span class="sd">      See the `guru interface &lt;https://finufft.readthedocs.io/en/latest/python.html#finufft.Plan&gt;`_ from FINUFFT and its</span>
<span class="linenos"> 290</span><span class="sd">      `companion page &lt;https://finufft.readthedocs.io/en/latest/opts.html#options-parameters&gt;`_ for details.</span>
<span class="linenos"> 291</span>
<span class="linenos"> 292</span><span class="sd">      .. admonition:: Hint</span>
<span class="linenos"> 293</span>
<span class="linenos"> 294</span><span class="sd">         FINUFFT exposes a ``dtype`` keyword to control the precision (single or double) at which transforms are</span>
<span class="linenos"> 295</span><span class="sd">         performed.</span>
<span class="linenos"> 296</span><span class="sd">         This parameter is ignored by :py:class:`~pyxu.operator.linop.fft.nufft.NUFFT`: use the context manager</span>
<span class="linenos"> 297</span><span class="sd">         :py:class:`~pyxu.runtime.Precision` to control floating point precision.</span>
<span class="linenos"> 298</span>
<span class="linenos"> 299</span><span class="sd">      .. admonition:: Hint</span>
<span class="linenos"> 300</span>
<span class="linenos"> 301</span><span class="sd">         The NUFFT is performed in **batches of (n_trans,)**, where `n_trans` denotes the number of simultaneous</span>
<span class="linenos"> 302</span><span class="sd">         transforms requested.</span>
<span class="linenos"> 303</span><span class="sd">         (See the ``n_trans`` parameter of `finufft.Plan &lt;https://finufft.readthedocs.io/en/latest/python.html#finufft.Plan&gt;`_.)</span>
<span class="linenos"> 304</span>
<span class="linenos"> 305</span><span class="sd">         Good performance is obtained when each batch fits easily in memory. This recommendation also applies to Dask</span>
<span class="linenos"> 306</span><span class="sd">         inputs which are re-chunked internally to be `n_trans`-compliant.</span>
<span class="linenos"> 307</span>
<span class="linenos"> 308</span><span class="sd">         This parameter also affects performance of the ``eps=0`` case: increasing ``n_trans`` may improve performance</span>
<span class="linenos"> 309</span><span class="sd">         when doing several transforms in parallel.</span>
<span class="linenos"> 310</span>
<span class="linenos"> 311</span><span class="sd">    .. Warning::</span>
<span class="linenos"> 312</span>
<span class="linenos"> 313</span><span class="sd">       Since FINUFFT plans cannot be shared among different processes, this class is **only compatible** with Dask&#39;s</span>
<span class="linenos"> 314</span><span class="sd">       thread-based schedulers, i.e.:</span>
<span class="linenos"> 315</span>
<span class="linenos"> 316</span><span class="sd">       * ``scheduler=&#39;thread&#39;``</span>
<span class="linenos"> 317</span><span class="sd">       * ``scheduler=&#39;synchronous&#39;``</span>
<span class="linenos"> 318</span><span class="sd">       * ``distributed.Client(processes=False)``</span>
<span class="linenos"> 319</span>
<span class="linenos"> 320</span><span class="sd">       Batches are hence processed serially.</span>
<span class="linenos"> 321</span><span class="sd">       (Each batch is multi-threaded however.)</span>
<span class="linenos"> 322</span>
<span class="linenos"> 323</span><span class="sd">    .. [#] :math:`\varepsilon= 0` means that no approximation is performed: the exponential sums</span>
<span class="linenos"> 324</span><span class="sd">           are naively computed by direct evaluation.</span>
<span class="linenos"> 325</span>
<span class="linenos"> 326</span><span class="sd">    See Also</span>
<span class="linenos"> 327</span><span class="sd">    --------</span>
<span class="linenos"> 328</span><span class="sd">    :py:class:`~pyxu.operator.linop.fft.fft.FFT`</span>
<span class="linenos"> 329</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 330</span>    <span class="c1"># The goal of this wrapper class is to sanitize __init__() inputs.</span>
<span class="linenos"> 331</span>
<span class="linenos"> 332</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpShape</span><span class="p">):</span>
<span class="linenos"> 333</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">)</span>
<span class="linenos"> 334</span>
<div class="viewcode-block" id="NUFFT.type1">
<a class="viewcode-back" href="../../../../../api/operator/linop.html#pyxu.operator.linop.fft.nufft.NUFFT.type1">[docs]</a>
<span class="linenos"> 335</span>    <span class="nd">@staticmethod</span>
<span class="linenos"> 336</span>    <span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">o</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">allow_None</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos"> 337</span>    <span class="k">def</span> <span class="nf">type1</span><span class="p">(</span>
<span class="linenos"> 338</span>        <span class="n">x</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">,</span>
<span class="linenos"> 339</span>        <span class="n">N</span><span class="p">:</span> <span class="n">typ</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">pxt</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pxt</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="o">...</span><span class="p">]],</span>
<span class="linenos"> 340</span>        <span class="n">isign</span><span class="p">:</span> <span class="n">SignT</span> <span class="o">=</span> <span class="n">sign_default</span><span class="p">,</span>
<span class="linenos"> 341</span>        <span class="n">eps</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Real</span> <span class="o">=</span> <span class="n">eps_default</span><span class="p">,</span>
<span class="linenos"> 342</span>        <span class="n">real</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="linenos"> 343</span>        <span class="n">plan_fw</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="linenos"> 344</span>        <span class="n">plan_bw</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="linenos"> 345</span>        <span class="n">enable_warnings</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="linenos"> 346</span>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="linenos"> 347</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">:</span>
<span class="linenos"> 348</span><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 349</span><span class="sd">        Type-1 NUFFT (non-uniform to uniform).</span>
<span class="linenos"> 350</span>
<span class="linenos"> 351</span><span class="sd">        Parameters</span>
<span class="linenos"> 352</span><span class="sd">        ----------</span>
<span class="linenos"> 353</span><span class="sd">        x: NDArray</span>
<span class="linenos"> 354</span><span class="sd">            (M, [d]) d-dimensional sample points :math:`\mathbf{x}_{j} \in [-\pi,\pi)^{d}`.</span>
<span class="linenos"> 355</span><span class="sd">        N: Integer, :py:class:`tuple` ( Integer )</span>
<span class="linenos"> 356</span><span class="sd">            ([d],) mesh size in each dimension :math:`(N_1, \ldots, N_d)`.</span>
<span class="linenos"> 357</span>
<span class="linenos"> 358</span><span class="sd">            If `N` is an integer, then the mesh is assumed to have the same size in each dimension.</span>
<span class="linenos"> 359</span><span class="sd">        isign: 1, -1</span>
<span class="linenos"> 360</span><span class="sd">            Sign :math:`\sigma` of the transform.</span>
<span class="linenos"> 361</span><span class="sd">        eps: Real</span>
<span class="linenos"> 362</span><span class="sd">            Requested relative accuracy :math:`\varepsilon \geq 0`.</span>
<span class="linenos"> 363</span>
<span class="linenos"> 364</span><span class="sd">            If ``eps=0``, the transform is computed exactly via direct evaluation of the exponential sum using a Numba</span>
<span class="linenos"> 365</span><span class="sd">            JIT-compiled kernel.</span>
<span class="linenos"> 366</span><span class="sd">        real: bool</span>
<span class="linenos"> 367</span><span class="sd">            If ``True``, assumes :py:func:`~pyxu.operator.linop.fft.nufft.NUFFT.apply` takes (..., M) inputs in</span>
<span class="linenos"> 368</span><span class="sd">            :math:`\mathbb{R}^{M}`.</span>
<span class="linenos"> 369</span>
<span class="linenos"> 370</span><span class="sd">            If ``False``, then :py:func:`~pyxu.operator.linop.fft.nufft.NUFFT.apply` takes (..., 2M) inputs, i.e.</span>
<span class="linenos"> 371</span><span class="sd">            :math:`\mathbb{C}^{M}` vectors viewed as bijections with :math:`\mathbb{R}^{2M}`.</span>
<span class="linenos"> 372</span><span class="sd">        plan_fw/bw: bool</span>
<span class="linenos"> 373</span><span class="sd">            If ``True``, allocate FINUFFT resources to do the forward (fw) and/or backward (bw) transform.</span>
<span class="linenos"> 374</span><span class="sd">            These are advanced options: use them with care.</span>
<span class="linenos"> 375</span><span class="sd">            Some public methods in the :py:class:`~pyxu.abc.operator.LinOp` interface may not work if fw/bw transforms</span>
<span class="linenos"> 376</span><span class="sd">            are disabled.</span>
<span class="linenos"> 377</span><span class="sd">            These options only take effect if ``eps &gt; 0``.</span>
<span class="linenos"> 378</span><span class="sd">        enable_warnings: bool</span>
<span class="linenos"> 379</span><span class="sd">            If ``True``, emit a warning in case of precision mis-match issues.</span>
<span class="linenos"> 380</span><span class="sd">        **kwargs</span>
<span class="linenos"> 381</span><span class="sd">            Extra kwargs to `finufft.Plan &lt;https://finufft.readthedocs.io/en/latest/python.html#finufft.Plan&gt;`_.</span>
<span class="linenos"> 382</span><span class="sd">            (Illegal keywords are dropped silently.) Most useful are ``n_trans``, ``nthreads`` and ``debug``.</span>
<span class="linenos"> 383</span>
<span class="linenos"> 384</span><span class="sd">        Returns</span>
<span class="linenos"> 385</span><span class="sd">        -------</span>
<span class="linenos"> 386</span><span class="sd">        op: OpT</span>
<span class="linenos"> 387</span><span class="sd">            (2N.prod(), M) or (2N.prod(), 2M) type-1 NUFFT.</span>
<span class="linenos"> 388</span>
<span class="linenos"> 389</span><span class="sd">        Examples</span>
<span class="linenos"> 390</span><span class="sd">        --------</span>
<span class="linenos"> 391</span>
<span class="linenos"> 392</span><span class="sd">        .. code-block:: python3</span>
<span class="linenos"> 393</span>
<span class="linenos"> 394</span><span class="sd">           import numpy as np</span>
<span class="linenos"> 395</span><span class="sd">           import pyxu.operator as pxo</span>
<span class="linenos"> 396</span><span class="sd">           import pyxu.runtime as pxrt</span>
<span class="linenos"> 397</span><span class="sd">           import pyxu.util as pxu</span>
<span class="linenos"> 398</span>
<span class="linenos"> 399</span><span class="sd">           rng = np.random.default_rng(0)</span>
<span class="linenos"> 400</span><span class="sd">           D, M, N = 2, 200, 5  # D denotes the dimension of the data</span>
<span class="linenos"> 401</span><span class="sd">           x = np.fmod(rng.normal(size=(M, D)), 2 * np.pi)</span>
<span class="linenos"> 402</span>
<span class="linenos"> 403</span><span class="sd">           with pxrt.Precision(pxrt.Width.SINGLE):</span>
<span class="linenos"> 404</span><span class="sd">               # The NUFFT dimension (1/2/3) is inferred from the trailing dimension of x.</span>
<span class="linenos"> 405</span><span class="sd">               # Its precision is controlled by the context manager.</span>
<span class="linenos"> 406</span><span class="sd">               N_trans = 5</span>
<span class="linenos"> 407</span><span class="sd">               A = pxo.NUFFT.type1(</span>
<span class="linenos"> 408</span><span class="sd">                       x, N,</span>
<span class="linenos"> 409</span><span class="sd">                       n_trans=N_trans,</span>
<span class="linenos"> 410</span><span class="sd">                       isign=-1,</span>
<span class="linenos"> 411</span><span class="sd">                       eps=1e-3,</span>
<span class="linenos"> 412</span><span class="sd">                   )</span>
<span class="linenos"> 413</span>
<span class="linenos"> 414</span><span class="sd">               # Pyxu operators only support real inputs/outputs, so we use the functions</span>
<span class="linenos"> 415</span><span class="sd">               # pxu.view_as_[complex/real] to interpret complex arrays as real arrays (and</span>
<span class="linenos"> 416</span><span class="sd">               # vice-versa).</span>
<span class="linenos"> 417</span><span class="sd">               arr =        rng.normal(size=(3, N_trans, M)) \</span>
<span class="linenos"> 418</span><span class="sd">                     + 1j * rng.normal(size=(3, N_trans, M))</span>
<span class="linenos"> 419</span><span class="sd">               A_out_fw = pxu.view_as_complex(A.apply(pxu.view_as_real(arr)))</span>
<span class="linenos"> 420</span><span class="sd">               A_out_bw = pxu.view_as_complex(A.adjoint(pxu.view_as_real(A_out_fw)))</span>
<span class="linenos"> 421</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 422</span>        <span class="n">init_kwargs</span> <span class="o">=</span> <span class="n">_NUFFT1</span><span class="o">.</span><span class="n">_sanitize_init_kwargs</span><span class="p">(</span>
<span class="linenos"> 423</span>            <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
<span class="linenos"> 424</span>            <span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span>
<span class="linenos"> 425</span>            <span class="n">isign</span><span class="o">=</span><span class="n">isign</span><span class="p">,</span>
<span class="linenos"> 426</span>            <span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span>
<span class="linenos"> 427</span>            <span class="n">real_in</span><span class="o">=</span><span class="n">real</span><span class="p">,</span>
<span class="linenos"> 428</span>            <span class="n">real_out</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos"> 429</span>            <span class="n">plan_fw</span><span class="o">=</span><span class="n">plan_fw</span><span class="p">,</span>
<span class="linenos"> 430</span>            <span class="n">plan_bw</span><span class="o">=</span><span class="n">plan_bw</span><span class="p">,</span>
<span class="linenos"> 431</span>            <span class="n">enable_warnings</span><span class="o">=</span><span class="n">enable_warnings</span><span class="p">,</span>
<span class="linenos"> 432</span>            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="linenos"> 433</span>        <span class="p">)</span>
<span class="linenos"> 434</span>        <span class="k">return</span> <span class="n">_NUFFT1</span><span class="p">(</span><span class="o">**</span><span class="n">init_kwargs</span><span class="p">)</span></div>

<span class="linenos"> 435</span>
<div class="viewcode-block" id="NUFFT.type2">
<a class="viewcode-back" href="../../../../../api/operator/linop.html#pyxu.operator.linop.fft.nufft.NUFFT.type2">[docs]</a>
<span class="linenos"> 436</span>    <span class="nd">@staticmethod</span>
<span class="linenos"> 437</span>    <span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">o</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">allow_None</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos"> 438</span>    <span class="k">def</span> <span class="nf">type2</span><span class="p">(</span>
<span class="linenos"> 439</span>        <span class="n">x</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">,</span>
<span class="linenos"> 440</span>        <span class="n">N</span><span class="p">:</span> <span class="n">typ</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">pxt</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pxt</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="o">...</span><span class="p">]],</span>
<span class="linenos"> 441</span>        <span class="n">isign</span><span class="p">:</span> <span class="n">SignT</span> <span class="o">=</span> <span class="n">sign_default</span><span class="p">,</span>
<span class="linenos"> 442</span>        <span class="n">eps</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Real</span> <span class="o">=</span> <span class="n">eps_default</span><span class="p">,</span>
<span class="linenos"> 443</span>        <span class="n">real</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="linenos"> 444</span>        <span class="n">plan_fw</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="linenos"> 445</span>        <span class="n">plan_bw</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="linenos"> 446</span>        <span class="n">enable_warnings</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="linenos"> 447</span>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="linenos"> 448</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">:</span>
<span class="linenos"> 449</span><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 450</span><span class="sd">        Type-2 NUFFT (uniform to non-uniform).</span>
<span class="linenos"> 451</span>
<span class="linenos"> 452</span><span class="sd">        Parameters</span>
<span class="linenos"> 453</span><span class="sd">        ----------</span>
<span class="linenos"> 454</span><span class="sd">        x: NDArray</span>
<span class="linenos"> 455</span><span class="sd">            (M, [d]) d-dimensional sample points :math:`\mathbf{x}_{j} \in [-\pi,\pi]^{d}`.</span>
<span class="linenos"> 456</span><span class="sd">        N: Integer, :py:class:`tuple` ( Integer )</span>
<span class="linenos"> 457</span><span class="sd">            ([d],) mesh size in each dimension :math:`(N_1, \ldots, N_d)`.</span>
<span class="linenos"> 458</span>
<span class="linenos"> 459</span><span class="sd">            If `N` is an integer, then the mesh is assumed to have the same size in each dimension.</span>
<span class="linenos"> 460</span><span class="sd">        isign: 1, -1</span>
<span class="linenos"> 461</span><span class="sd">            Sign :math:`\sigma` of the transform.</span>
<span class="linenos"> 462</span><span class="sd">        eps: Real</span>
<span class="linenos"> 463</span><span class="sd">            Requested relative accuracy :math:`\varepsilon \geq 0`.</span>
<span class="linenos"> 464</span>
<span class="linenos"> 465</span><span class="sd">            If ``eps=0``, the transform is computed exactly via direct evaluation of the exponential sum using a Numba</span>
<span class="linenos"> 466</span><span class="sd">            JIT-compiled kernel.</span>
<span class="linenos"> 467</span><span class="sd">        real: bool</span>
<span class="linenos"> 468</span><span class="sd">            If ``True``, assumes :py:func:`~pyxu.operator.linop.fft.nufft.NUFFT.apply` takes (..., N.prod()) inputs in</span>
<span class="linenos"> 469</span><span class="sd">            :math:`\mathbb{R}^{N}`.</span>
<span class="linenos"> 470</span>
<span class="linenos"> 471</span><span class="sd">            If ``False``, then :py:func:`~pyxu.operator.linop.fft.nufft.NUFFT.apply` takes (..., 2N.prod()) inputs, i.e.</span>
<span class="linenos"> 472</span><span class="sd">            :math:`\mathbb{C}^{N}` vectors viewed as bijections with :math:`\mathbb{R}^{2N}`.</span>
<span class="linenos"> 473</span><span class="sd">        plan_fw/bw: bool</span>
<span class="linenos"> 474</span><span class="sd">            If ``True``, allocate FINUFFT resources to do the forward (fw) and/or backward (bw) transform.</span>
<span class="linenos"> 475</span><span class="sd">            These are advanced options: use them with care.</span>
<span class="linenos"> 476</span><span class="sd">            Some public methods in the :py:class:`~pyxu.abc.operator.LinOp` interface may not work if fw/bw transforms</span>
<span class="linenos"> 477</span><span class="sd">            are disabled.</span>
<span class="linenos"> 478</span><span class="sd">            These options only take effect if ``eps &gt; 0``.</span>
<span class="linenos"> 479</span><span class="sd">        enable_warnings: bool</span>
<span class="linenos"> 480</span><span class="sd">            If ``True``, emit a warning in case of precision mis-match issues.</span>
<span class="linenos"> 481</span><span class="sd">        **kwargs</span>
<span class="linenos"> 482</span><span class="sd">            Extra kwargs to `finufft.Plan &lt;https://finufft.readthedocs.io/en/latest/python.html#finufft.Plan&gt;`_.</span>
<span class="linenos"> 483</span><span class="sd">            (Illegal keywords are dropped silently.) Most useful are ``n_trans``, ``nthreads`` and ``debug``.</span>
<span class="linenos"> 484</span>
<span class="linenos"> 485</span><span class="sd">        Returns</span>
<span class="linenos"> 486</span><span class="sd">        -------</span>
<span class="linenos"> 487</span><span class="sd">        op: OpT</span>
<span class="linenos"> 488</span><span class="sd">            (2M, N.prod()) or (2M, 2N.prod()) type-2 NUFFT.</span>
<span class="linenos"> 489</span>
<span class="linenos"> 490</span><span class="sd">        Examples</span>
<span class="linenos"> 491</span><span class="sd">        --------</span>
<span class="linenos"> 492</span>
<span class="linenos"> 493</span><span class="sd">        .. code-block:: python3</span>
<span class="linenos"> 494</span>
<span class="linenos"> 495</span><span class="sd">           import numpy as np</span>
<span class="linenos"> 496</span><span class="sd">           import pyxu.operator as pxo</span>
<span class="linenos"> 497</span><span class="sd">           import pyxu.runtime as pxrt</span>
<span class="linenos"> 498</span><span class="sd">           import pyxu.util as pxu</span>
<span class="linenos"> 499</span>
<span class="linenos"> 500</span><span class="sd">           rng = np.random.default_rng(0)</span>
<span class="linenos"> 501</span><span class="sd">           D, M, N = 2, 200, 5  # D denotes the dimension of the data</span>
<span class="linenos"> 502</span><span class="sd">           N_full = (N,) * D</span>
<span class="linenos"> 503</span><span class="sd">           x = np.fmod(rng.normal(size=(M, D)), 2 * np.pi)</span>
<span class="linenos"> 504</span>
<span class="linenos"> 505</span><span class="sd">           with pxrt.Precision(pxrt.Width.SINGLE):</span>
<span class="linenos"> 506</span><span class="sd">               # The NUFFT dimension (1/2/3) is inferred from the trailing dimension of x.</span>
<span class="linenos"> 507</span><span class="sd">               # Its precision is controlled by the context manager.</span>
<span class="linenos"> 508</span><span class="sd">               N_trans = 5</span>
<span class="linenos"> 509</span><span class="sd">               A = pxo.NUFFT.type2(</span>
<span class="linenos"> 510</span><span class="sd">                       x, N,</span>
<span class="linenos"> 511</span><span class="sd">                       n_trans=N_trans,</span>
<span class="linenos"> 512</span><span class="sd">                       isign=-1,</span>
<span class="linenos"> 513</span><span class="sd">                       eps=1e-3,</span>
<span class="linenos"> 514</span><span class="sd">                   )</span>
<span class="linenos"> 515</span>
<span class="linenos"> 516</span><span class="sd">               # Pyxu operators only support real inputs/outputs, so we use the functions</span>
<span class="linenos"> 517</span><span class="sd">               # pxu.view_as_[complex/real] to interpret complex arrays as real arrays (and</span>
<span class="linenos"> 518</span><span class="sd">               # vice-versa).</span>
<span class="linenos"> 519</span><span class="sd">               arr = np.reshape(</span>
<span class="linenos"> 520</span><span class="sd">                          rng.normal(size=(3, N_trans, *N_full))</span>
<span class="linenos"> 521</span><span class="sd">                   + 1j * rng.normal(size=(3, N_trans, *N_full)),</span>
<span class="linenos"> 522</span><span class="sd">                   (3, N_trans, -1),</span>
<span class="linenos"> 523</span><span class="sd">               )</span>
<span class="linenos"> 524</span><span class="sd">               A_out_fw = pxu.view_as_complex(A.apply(pxu.view_as_real(arr)))</span>
<span class="linenos"> 525</span><span class="sd">               A_out_bw = pxu.view_as_complex(A.adjoint(pxu.view_as_real(A_out_fw)))</span>
<span class="linenos"> 526</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 527</span>        <span class="n">init_kwargs</span> <span class="o">=</span> <span class="n">_NUFFT1</span><span class="o">.</span><span class="n">_sanitize_init_kwargs</span><span class="p">(</span>
<span class="linenos"> 528</span>            <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
<span class="linenos"> 529</span>            <span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span>
<span class="linenos"> 530</span>            <span class="n">isign</span><span class="o">=-</span><span class="n">isign</span><span class="p">,</span>
<span class="linenos"> 531</span>            <span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span>
<span class="linenos"> 532</span>            <span class="n">real_in</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos"> 533</span>            <span class="n">real_out</span><span class="o">=</span><span class="n">real</span><span class="p">,</span>
<span class="linenos"> 534</span>            <span class="n">plan_fw</span><span class="o">=</span><span class="n">plan_bw</span><span class="p">,</span>  <span class="c1"># note the reversal</span>
<span class="linenos"> 535</span>            <span class="n">plan_bw</span><span class="o">=</span><span class="n">plan_fw</span><span class="p">,</span>  <span class="c1"># here</span>
<span class="linenos"> 536</span>            <span class="n">enable_warnings</span><span class="o">=</span><span class="n">enable_warnings</span><span class="p">,</span>
<span class="linenos"> 537</span>            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="linenos"> 538</span>        <span class="p">)</span>
<span class="linenos"> 539</span>        <span class="n">op_t1</span> <span class="o">=</span> <span class="n">_NUFFT1</span><span class="p">(</span><span class="o">**</span><span class="n">init_kwargs</span><span class="p">)</span>
<span class="linenos"> 540</span>        <span class="n">op_t2</span> <span class="o">=</span> <span class="n">op_t1</span><span class="o">.</span><span class="n">T</span>
<span class="linenos"> 541</span>        <span class="n">op_t2</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="s2">&quot;_NUFFT2&quot;</span>
<span class="linenos"> 542</span>
<span class="linenos"> 543</span>        <span class="c1"># not strictly necessary, but users will probably want to access it.</span>
<span class="linenos"> 544</span>        <span class="n">op_t2</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">(</span><span class="n">_NUFFT1</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">op_t1</span><span class="p">)</span>
<span class="linenos"> 545</span>        <span class="n">op_t2</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">(</span><span class="n">_NUFFT1</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">op_t1</span><span class="p">)</span>
<span class="linenos"> 546</span>        <span class="k">return</span> <span class="n">op_t2</span></div>

<span class="linenos"> 547</span>
<div class="viewcode-block" id="NUFFT.type3">
<a class="viewcode-back" href="../../../../../api/operator/linop.html#pyxu.operator.linop.fft.nufft.NUFFT.type3">[docs]</a>
<span class="linenos"> 548</span>    <span class="nd">@staticmethod</span>
<span class="linenos"> 549</span>    <span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">),</span> <span class="n">o</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">allow_None</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos"> 550</span>    <span class="k">def</span> <span class="nf">type3</span><span class="p">(</span>
<span class="linenos"> 551</span>        <span class="n">x</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">,</span>
<span class="linenos"> 552</span>        <span class="n">z</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">,</span>
<span class="linenos"> 553</span>        <span class="n">isign</span><span class="p">:</span> <span class="n">SignT</span> <span class="o">=</span> <span class="n">sign_default</span><span class="p">,</span>
<span class="linenos"> 554</span>        <span class="n">eps</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Real</span> <span class="o">=</span> <span class="n">eps_default</span><span class="p">,</span>
<span class="linenos"> 555</span>        <span class="n">real</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="linenos"> 556</span>        <span class="n">plan_fw</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="linenos"> 557</span>        <span class="n">plan_bw</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="linenos"> 558</span>        <span class="n">enable_warnings</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="linenos"> 559</span>        <span class="n">chunked</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="linenos"> 560</span>        <span class="n">parallel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="linenos"> 561</span>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="linenos"> 562</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">OpT</span><span class="p">:</span>
<span class="linenos"> 563</span><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 564</span><span class="sd">        Type-3 NUFFT (non-uniform to non-uniform).</span>
<span class="linenos"> 565</span>
<span class="linenos"> 566</span><span class="sd">        Parameters</span>
<span class="linenos"> 567</span><span class="sd">        ----------</span>
<span class="linenos"> 568</span><span class="sd">        x: NDArray</span>
<span class="linenos"> 569</span><span class="sd">            (M, [d]) d-dimensional sample points :math:`\mathbf{x}_{j} \in \mathbb{R}^{d}`.</span>
<span class="linenos"> 570</span><span class="sd">        z: NDArray</span>
<span class="linenos"> 571</span><span class="sd">            (N, [d]) d-dimensional query points :math:`\mathbf{z}_{k} \in \mathbb{R}^{d}`.</span>
<span class="linenos"> 572</span><span class="sd">        isign: 1, -1</span>
<span class="linenos"> 573</span><span class="sd">            Sign :math:`\sigma` of the transform.</span>
<span class="linenos"> 574</span><span class="sd">        eps: Real</span>
<span class="linenos"> 575</span><span class="sd">            Requested relative accuracy :math:`\varepsilon \geq 0`.</span>
<span class="linenos"> 576</span>
<span class="linenos"> 577</span><span class="sd">            If ``eps=0``, the transform is computed exactly via direct evaluation of the exponential</span>
<span class="linenos"> 578</span><span class="sd">            sum using a Numba JIT-compiled kernel.</span>
<span class="linenos"> 579</span><span class="sd">        real: bool</span>
<span class="linenos"> 580</span><span class="sd">            If ``True``, assumes :py:func:`~pyxu.operator.linop.fft.nufft.NUFFT.apply` takes (..., M) inputs in</span>
<span class="linenos"> 581</span><span class="sd">            :math:`\mathbb{R}^{M}`.</span>
<span class="linenos"> 582</span>
<span class="linenos"> 583</span><span class="sd">            If ``False``, then :py:func:`~pyxu.operator.linop.fft.nufft.NUFFT.apply` takes (..., 2M) inputs, i.e.</span>
<span class="linenos"> 584</span><span class="sd">            :math:`\mathbb{C}^{M}` vectors viewed as bijections with :math:`\mathbb{R}^{2M}`.</span>
<span class="linenos"> 585</span><span class="sd">        plan_fw/bw: bool</span>
<span class="linenos"> 586</span><span class="sd">            If ``True``, allocate FINUFFT resources to do the forward (fw) and/or backward (bw) transform.</span>
<span class="linenos"> 587</span><span class="sd">            These are advanced options: use them with care.</span>
<span class="linenos"> 588</span><span class="sd">            Some public methods in the :py:class:`~pyxu.abc.operator.LinOp` interface may not work if fw/bw transforms</span>
<span class="linenos"> 589</span><span class="sd">            are disabled.</span>
<span class="linenos"> 590</span><span class="sd">            These options only take effect if ``eps &gt; 0``.</span>
<span class="linenos"> 591</span><span class="sd">        enable_warnings: bool</span>
<span class="linenos"> 592</span><span class="sd">            If ``True``, emit a warning in case of precision mis-match issues.</span>
<span class="linenos"> 593</span><span class="sd">        chunked: bool</span>
<span class="linenos"> 594</span><span class="sd">            If ``True``, the transform is performed in small chunks. (See Notes for details.)</span>
<span class="linenos"> 595</span><span class="sd">        parallel: bool</span>
<span class="linenos"> 596</span><span class="sd">            This option only applies to chunked transforms.</span>
<span class="linenos"> 597</span><span class="sd">            If ``True``, evaluate chunks in parallel.</span>
<span class="linenos"> 598</span><span class="sd">        **kwargs</span>
<span class="linenos"> 599</span><span class="sd">            Extra kwargs to `finufft.Plan &lt;https://finufft.readthedocs.io/en/latest/python.html#finufft.Plan&gt;`_.</span>
<span class="linenos"> 600</span><span class="sd">            (Illegal keywords are dropped silently.) Most useful are ``n_trans``, ``nthreads`` and ``debug``.</span>
<span class="linenos"> 601</span>
<span class="linenos"> 602</span><span class="sd">        Returns</span>
<span class="linenos"> 603</span><span class="sd">        -------</span>
<span class="linenos"> 604</span><span class="sd">        op: OpT</span>
<span class="linenos"> 605</span><span class="sd">            (2N, M) or (2N, 2M) type-3 NUFFT.</span>
<span class="linenos"> 606</span>
<span class="linenos"> 607</span><span class="sd">        Examples</span>
<span class="linenos"> 608</span><span class="sd">        --------</span>
<span class="linenos"> 609</span>
<span class="linenos"> 610</span><span class="sd">        .. code-block:: python3</span>
<span class="linenos"> 611</span>
<span class="linenos"> 612</span><span class="sd">           import numpy as np</span>
<span class="linenos"> 613</span><span class="sd">           import pyxu.operator as pxo</span>
<span class="linenos"> 614</span><span class="sd">           import pyxu.runtime as pxrt</span>
<span class="linenos"> 615</span><span class="sd">           import pyxu.util as pxu</span>
<span class="linenos"> 616</span>
<span class="linenos"> 617</span><span class="sd">           rng = np.random.default_rng(0)</span>
<span class="linenos"> 618</span><span class="sd">           D, M, N = 3, 200, 5  # D denotes the dimension of the data</span>
<span class="linenos"> 619</span><span class="sd">           x = rng.normal(size=(M, D)) + 2000  # Poorly-centered data</span>
<span class="linenos"> 620</span><span class="sd">           z = rng.normal(size=(N, D))</span>
<span class="linenos"> 621</span><span class="sd">           with pxrt.Precision(pxrt.Width.SINGLE):</span>
<span class="linenos"> 622</span><span class="sd">               # The NUFFT dimension (1/2/3) is inferred from the trailing dimension of x/z.</span>
<span class="linenos"> 623</span><span class="sd">               # Its precision is controlled by the context manager.</span>
<span class="linenos"> 624</span><span class="sd">               N_trans = 20</span>
<span class="linenos"> 625</span><span class="sd">               A = pxo.NUFFT.type3(</span>
<span class="linenos"> 626</span><span class="sd">                       x, z,</span>
<span class="linenos"> 627</span><span class="sd">                       n_trans=N_trans,</span>
<span class="linenos"> 628</span><span class="sd">                       isign=-1,</span>
<span class="linenos"> 629</span><span class="sd">                       eps=1e-6,</span>
<span class="linenos"> 630</span><span class="sd">                    )</span>
<span class="linenos"> 631</span>
<span class="linenos"> 632</span><span class="sd">               # Pyxu operators only support real inputs/outputs, so we use the functions</span>
<span class="linenos"> 633</span><span class="sd">               # pxu.view_as_[complex/real] to interpret complex arrays as real arrays (and</span>
<span class="linenos"> 634</span><span class="sd">               # vice-versa).</span>
<span class="linenos"> 635</span><span class="sd">               arr =        rng.normal(size=(3, N_trans, M)) \</span>
<span class="linenos"> 636</span><span class="sd">                     + 1j * rng.normal(size=(3, N_trans, M))</span>
<span class="linenos"> 637</span><span class="sd">               A_out_fw = pxu.view_as_complex(A.apply(pxu.view_as_real(arr)))</span>
<span class="linenos"> 638</span><span class="sd">               A_out_bw = pxu.view_as_complex(A.adjoint(pxu.view_as_real(A_out_fw)))</span>
<span class="linenos"> 639</span>
<span class="linenos"> 640</span><span class="sd">        .. rubric:: Notes (chunked-transform)</span>
<span class="linenos"> 641</span>
<span class="linenos"> 642</span><span class="sd">        * An extra initialization step is required before using a chunked-transform:</span>
<span class="linenos"> 643</span>
<span class="linenos"> 644</span><span class="sd">          .. code-block:: python3</span>
<span class="linenos"> 645</span>
<span class="linenos"> 646</span><span class="sd">             A = pxl.NUFFT.type3(</span>
<span class="linenos"> 647</span><span class="sd">                     x, z</span>
<span class="linenos"> 648</span><span class="sd">                     isign</span>
<span class="linenos"> 649</span><span class="sd">                     chunked=True,   # with chunk specified</span>
<span class="linenos"> 650</span><span class="sd">                     parallel=True,  # for extra speed (chunked-only)</span>
<span class="linenos"> 651</span><span class="sd">                     **finufft_kwargs,</span>
<span class="linenos"> 652</span><span class="sd">                  )</span>
<span class="linenos"> 653</span><span class="sd">             x_chunks, z_chunks = A.auto_chunk()  # auto-determine a good x/z chunking strategy</span>
<span class="linenos"> 654</span><span class="sd">             A.allocate(x_chunks, z_chunks)  # apply the chunking strategy.</span>
<span class="linenos"> 655</span>
<span class="linenos"> 656</span><span class="sd">          :py:meth:`~pyxu.operator.linop.fft.nufft.NUFFT.auto_chunk` is a helper method to auto-determine a good</span>
<span class="linenos"> 657</span><span class="sd">          chunking strategy.</span>
<span class="linenos"> 658</span>
<span class="linenos"> 659</span><span class="sd">          Its runtime is significant when the number of sub-problems grows large. (1000+)</span>
<span class="linenos"> 660</span><span class="sd">          In these contexts, assuming a good-enough x/z-split is known in advance, users can directly supply them to</span>
<span class="linenos"> 661</span><span class="sd">          :py:meth:`~pyxu.operator.linop.fft.nufft.NUFFT.allocate`.</span>
<span class="linenos"> 662</span>
<span class="linenos"> 663</span><span class="sd">        * :py:func:`~pyxu.operator.linop.fft.nufft.NUFFT.apply` /</span>
<span class="linenos"> 664</span><span class="sd">          :py:func:`~pyxu.operator.linop.fft.nufft.NUFFT.adjoint` runtime is minimized when x/z are well-ordered, i.e.</span>
<span class="linenos"> 665</span><span class="sd">          when sub-problems can sub-sample inputs to :py:func:`~pyxu.operator.linop.fft.nufft.NUFFT.apply` /</span>
<span class="linenos"> 666</span><span class="sd">          :py:func:`~pyxu.operator.linop.fft.nufft.NUFFT.adjoint` via slice operators.</span>
<span class="linenos"> 667</span>
<span class="linenos"> 668</span><span class="sd">          To reduce runtime of chunked transforms, :py:meth:`~pyxu.operator.linop.fft.nufft.NUFFT.allocate`</span>
<span class="linenos"> 669</span><span class="sd">          automatically re-orders x/z when appropriate.</span>
<span class="linenos"> 670</span>
<span class="linenos"> 671</span><span class="sd">          The side-effect is the cost of a permutation before/after calls to</span>
<span class="linenos"> 672</span><span class="sd">          :py:func:`~pyxu.operator.linop.fft.nufft.NUFFT.apply` /</span>
<span class="linenos"> 673</span><span class="sd">          :py:func:`~pyxu.operator.linop.fft.nufft.NUFFT.adjoint`.</span>
<span class="linenos"> 674</span><span class="sd">          This cost becomes significant when the number of non-uniform points x/z is large. (&gt; 1e6)</span>
<span class="linenos"> 675</span>
<span class="linenos"> 676</span><span class="sd">          To avoid paying the re-ordering cost at each transform, it is recommended to supply x/z and apply/adjoint</span>
<span class="linenos"> 677</span><span class="sd">          inputs in the &quot;correct&quot; order from the start.</span>
<span class="linenos"> 678</span>
<span class="linenos"> 679</span><span class="sd">          A good re-ordering is computed automatically by :py:meth:`~pyxu.operator.linop.fft.nufft.NUFFT.allocate` and</span>
<span class="linenos"> 680</span><span class="sd">          can be used to initialize a new chunked-transform with better runtime properties as such:</span>
<span class="linenos"> 681</span>
<span class="linenos"> 682</span><span class="sd">          .. code-block:: python3</span>
<span class="linenos"> 683</span>
<span class="linenos"> 684</span><span class="sd">             ### Initialize a chunked transform (1st try; as above)</span>
<span class="linenos"> 685</span><span class="sd">             A = pxl.NUFFT.type3(</span>
<span class="linenos"> 686</span><span class="sd">                     x, z</span>
<span class="linenos"> 687</span><span class="sd">                     isign</span>
<span class="linenos"> 688</span><span class="sd">                     chunked=True,</span>
<span class="linenos"> 689</span><span class="sd">                     parallel=True,</span>
<span class="linenos"> 690</span><span class="sd">                     **finufft_kwargs,</span>
<span class="linenos"> 691</span><span class="sd">                  )</span>
<span class="linenos"> 692</span><span class="sd">             x_chunks, z_chunks = A.auto_chunk()  # auto-determine a good x/z chunking strategy</span>
<span class="linenos"> 693</span><span class="sd">             A.allocate(x_chunks, z_chunks)  # will raise warning if bad x/z-order detected</span>
<span class="linenos"> 694</span>
<span class="linenos"> 695</span>
<span class="linenos"> 696</span><span class="sd">             ### Now initialize a better transform (2nd try)</span>
<span class="linenos"> 697</span><span class="sd">             x_idx, x_chunks = A.order(&quot;x&quot;)  # get a good x-ordering</span>
<span class="linenos"> 698</span><span class="sd">             z_idx, z_chunks = A.order(&quot;z&quot;)  # get a good z-ordering</span>
<span class="linenos"> 699</span><span class="sd">             A = pxl.NUFFT.type3(</span>
<span class="linenos"> 700</span><span class="sd">                     x[x_idx], z[z_idx]  # re-order x/z accordingly</span>
<span class="linenos"> 701</span><span class="sd">                     ...                 # same as before</span>
<span class="linenos"> 702</span><span class="sd">                  )</span>
<span class="linenos"> 703</span><span class="sd">             A.allocate(x_chunks, z_chunks)  # skip auto-chunking and apply</span>
<span class="linenos"> 704</span><span class="sd">                                             # optimal x/z_chunks provided.</span>
<span class="linenos"> 705</span>
<span class="linenos"> 706</span><span class="sd">        See Also</span>
<span class="linenos"> 707</span><span class="sd">        --------</span>
<span class="linenos"> 708</span><span class="sd">        :py:meth:`~pyxu.operator.linop.fft.nufft.NUFFT.auto_chunk`,</span>
<span class="linenos"> 709</span><span class="sd">        :py:meth:`~pyxu.operator.linop.fft.nufft.NUFFT.allocate`,</span>
<span class="linenos"> 710</span><span class="sd">        :py:meth:`~pyxu.operator.linop.fft.nufft.NUFFT.diagnostic_plot`,</span>
<span class="linenos"> 711</span><span class="sd">        :py:meth:`~pyxu.operator.linop.fft.nufft.NUFFT.stats`</span>
<span class="linenos"> 712</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 713</span>        <span class="n">init_kwargs</span> <span class="o">=</span> <span class="n">_NUFFT3</span><span class="o">.</span><span class="n">_sanitize_init_kwargs</span><span class="p">(</span>
<span class="linenos"> 714</span>            <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
<span class="linenos"> 715</span>            <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span>
<span class="linenos"> 716</span>            <span class="n">isign</span><span class="o">=</span><span class="n">isign</span><span class="p">,</span>
<span class="linenos"> 717</span>            <span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span>
<span class="linenos"> 718</span>            <span class="n">real</span><span class="o">=</span><span class="n">real</span><span class="p">,</span>
<span class="linenos"> 719</span>            <span class="n">plan_fw</span><span class="o">=</span><span class="n">plan_fw</span><span class="p">,</span>
<span class="linenos"> 720</span>            <span class="n">plan_bw</span><span class="o">=</span><span class="n">plan_bw</span><span class="p">,</span>
<span class="linenos"> 721</span>            <span class="n">enable_warnings</span><span class="o">=</span><span class="n">enable_warnings</span><span class="p">,</span>
<span class="linenos"> 722</span>            <span class="n">chunked</span><span class="o">=</span><span class="n">chunked</span><span class="p">,</span>
<span class="linenos"> 723</span>            <span class="n">parallel</span><span class="o">=</span><span class="n">parallel</span><span class="p">,</span>
<span class="linenos"> 724</span>            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="linenos"> 725</span>        <span class="p">)</span>
<span class="linenos"> 726</span>
<span class="linenos"> 727</span>        <span class="k">if</span> <span class="n">chunked</span> <span class="o">:=</span> <span class="n">init_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;chunked&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
<span class="linenos"> 728</span>            <span class="n">klass</span> <span class="o">=</span> <span class="n">_NUFFT3_chunked</span>
<span class="linenos"> 729</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 730</span>            <span class="n">klass</span> <span class="o">=</span> <span class="n">_NUFFT3</span>
<span class="linenos"> 731</span>            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span>  <span class="c1"># kwargs only valid for chunked-transforms</span>
<span class="linenos"> 732</span>                <span class="s2">&quot;parallel&quot;</span><span class="p">,</span>
<span class="linenos"> 733</span>            <span class="p">]:</span>
<span class="linenos"> 734</span>                <span class="n">init_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos"> 735</span>
<span class="linenos"> 736</span>        <span class="n">op</span> <span class="o">=</span> <span class="n">klass</span><span class="p">(</span><span class="o">**</span><span class="n">init_kwargs</span><span class="p">)</span>
<span class="linenos"> 737</span>        <span class="k">return</span> <span class="n">op</span></div>

<span class="linenos"> 738</span>
<div class="viewcode-block" id="NUFFT.apply">
<a class="viewcode-back" href="../../../../../api/operator/linop.html#pyxu.operator.linop.fft.nufft.NUFFT.apply">[docs]</a>
<span class="linenos"> 739</span>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos"> 740</span><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 741</span><span class="sd">        Parameters</span>
<span class="linenos"> 742</span><span class="sd">        ----------</span>
<span class="linenos"> 743</span><span class="sd">        arr: NDArray</span>
<span class="linenos"> 744</span><span class="sd">            - **Type 1 and 3:**</span>
<span class="linenos"> 745</span><span class="sd">                * (...,  M) input weights :math:`\mathbf{w} \in \mathbb{R}^{M}` (real transform).</span>
<span class="linenos"> 746</span><span class="sd">                * (..., 2M) input weights :math:`\mathbf{w} \in \mathbb{C}^{M}` viewed as a real array.</span>
<span class="linenos"> 747</span><span class="sd">                  (See :py:func:`~pyxu.util.complex.view_as_real`.)</span>
<span class="linenos"> 748</span><span class="sd">            - **Type 2:**</span>
<span class="linenos"> 749</span><span class="sd">                * (...,  N.prod()) input weights :math:`\mathbf{u} \in</span>
<span class="linenos"> 750</span><span class="sd">                  \mathbb{R}^{\mathcal{I}_{N_1, \ldots, N_d}}` (real transform).</span>
<span class="linenos"> 751</span><span class="sd">                * (..., 2N.prod()) input weights :math:`\mathbf{u} \in</span>
<span class="linenos"> 752</span><span class="sd">                  \mathbb{C}^{\mathcal{I}_{N_1, \ldots, N_d}}` viewed as a real array.</span>
<span class="linenos"> 753</span><span class="sd">                  (See :py:func:`~pyxu.util.complex.view_as_real`.)</span>
<span class="linenos"> 754</span>
<span class="linenos"> 755</span><span class="sd">        Returns</span>
<span class="linenos"> 756</span><span class="sd">        -------</span>
<span class="linenos"> 757</span><span class="sd">        out: NDArray</span>
<span class="linenos"> 758</span><span class="sd">            - **Type 1:**</span>
<span class="linenos"> 759</span><span class="sd">                (..., 2N.prod()) output weights :math:`\mathbf{u} \in</span>
<span class="linenos"> 760</span><span class="sd">                \mathbb{C}^{\mathcal{I}_{N_1, \ldots, N_d}}` viewed as a real array.</span>
<span class="linenos"> 761</span><span class="sd">                (See :py:func:`~pyxu.util.complex.view_as_real`.)</span>
<span class="linenos"> 762</span><span class="sd">            - **Type 2:**</span>
<span class="linenos"> 763</span><span class="sd">                (..., 2M) output weights :math:`\mathbf{w} \in \mathbb{C}^{M}` viewed as a real array.</span>
<span class="linenos"> 764</span><span class="sd">                (See :py:func:`~pyxu.util.complex.view_as_real`.)</span>
<span class="linenos"> 765</span><span class="sd">            - **Type 3:**</span>
<span class="linenos"> 766</span><span class="sd">                (..., 2N) output weights :math:`\mathbf{v} \in \mathbb{C}^{N}` viewed as a real array.</span>
<span class="linenos"> 767</span><span class="sd">                (See :py:func:`~pyxu.util.complex.view_as_real`.)</span>
<span class="linenos"> 768</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 769</span>        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<span class="linenos"> 770</span>
<div class="viewcode-block" id="NUFFT.adjoint">
<a class="viewcode-back" href="../../../../../api/operator/linop.html#pyxu.operator.linop.fft.nufft.NUFFT.adjoint">[docs]</a>
<span class="linenos"> 771</span>    <span class="k">def</span> <span class="nf">adjoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos"> 772</span><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 773</span><span class="sd">        Parameters</span>
<span class="linenos"> 774</span><span class="sd">        ----------</span>
<span class="linenos"> 775</span><span class="sd">        arr: NDArray</span>
<span class="linenos"> 776</span><span class="sd">            - **Type 1:**</span>
<span class="linenos"> 777</span><span class="sd">                (..., 2N.prod()) output weights :math:`\mathbf{u} \in</span>
<span class="linenos"> 778</span><span class="sd">                \mathbb{C}^{\mathcal{I}_{N_1, \ldots, N_d}}` viewed as a real array.</span>
<span class="linenos"> 779</span><span class="sd">                (See :py:func:`~pyxu.util.complex.view_as_real`.)</span>
<span class="linenos"> 780</span><span class="sd">            - **Type 2:**</span>
<span class="linenos"> 781</span><span class="sd">                (..., 2M) output weights :math:`\mathbf{w} \in \mathbb{C}^{M}` viewed as a real array.</span>
<span class="linenos"> 782</span><span class="sd">                (See :py:func:`~pyxu.util.complex.view_as_real`.)</span>
<span class="linenos"> 783</span><span class="sd">            - **Type 3:**</span>
<span class="linenos"> 784</span><span class="sd">                (..., 2N) output weights :math:`\mathbf{v} \in \mathbb{C}^{N}` viewed as a real array.</span>
<span class="linenos"> 785</span><span class="sd">                (See :py:func:`~pyxu.util.complex.view_as_real`.)</span>
<span class="linenos"> 786</span>
<span class="linenos"> 787</span><span class="sd">        Returns</span>
<span class="linenos"> 788</span><span class="sd">        -------</span>
<span class="linenos"> 789</span><span class="sd">        out: NDArray</span>
<span class="linenos"> 790</span><span class="sd">            - **Type 1 and 3:**</span>
<span class="linenos"> 791</span><span class="sd">                * (...,  M) input weights :math:`\mathbf{w} \in \mathbb{R}^{M}` (real transform).</span>
<span class="linenos"> 792</span><span class="sd">                * (..., 2M) input weights :math:`\mathbf{w} \in \mathbb{C}^{M}` viewed as a real array.</span>
<span class="linenos"> 793</span><span class="sd">                  (See :py:func:`~pyxu.util.complex.view_as_real`.)</span>
<span class="linenos"> 794</span><span class="sd">            - **Type 2:**</span>
<span class="linenos"> 795</span><span class="sd">                * (...,  N.prod()) input weights :math:`\mathbf{u} \in</span>
<span class="linenos"> 796</span><span class="sd">                  \mathbb{R}^{\mathcal{I}_{N_1, \ldots, N_d}}` (real transform).</span>
<span class="linenos"> 797</span><span class="sd">                * (..., 2N.prod()) input weights :math:`\mathbf{u} \in</span>
<span class="linenos"> 798</span><span class="sd">                  \mathbb{C}^{\mathcal{I}_{N_1, \ldots, N_d}}` viewed as a real array.</span>
<span class="linenos"> 799</span><span class="sd">                  (See :py:func:`~pyxu.util.complex.view_as_real`.)</span>
<span class="linenos"> 800</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 801</span>        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<span class="linenos"> 802</span>
<span class="linenos"> 803</span>    <span class="nd">@staticmethod</span>
<span class="linenos"> 804</span>    <span class="k">def</span> <span class="nf">_as_canonical_coordinate</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos"> 805</span>        <span class="k">if</span> <span class="p">(</span><span class="n">N_dim</span> <span class="o">:=</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos"> 806</span>            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="linenos"> 807</span>        <span class="k">elif</span> <span class="n">N_dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
<span class="linenos"> 808</span>            <span class="k">assert</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;Only (1,2,3)-D transforms supported.&quot;</span>
<span class="linenos"> 809</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 810</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected 1D/2D array, got </span><span class="si">{</span><span class="n">N_dim</span><span class="si">}</span><span class="s2">-D array.&quot;</span><span class="p">)</span>
<span class="linenos"> 811</span>        <span class="k">return</span> <span class="n">x</span>
<span class="linenos"> 812</span>
<span class="linenos"> 813</span>    <span class="nd">@staticmethod</span>
<span class="linenos"> 814</span>    <span class="k">def</span> <span class="nf">_as_canonical_mode</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArrayShape</span><span class="p">:</span>
<span class="linenos"> 815</span>        <span class="n">N</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">as_canonical_shape</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
<span class="linenos"> 816</span>        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">_</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">N</span><span class="p">)</span>
<span class="linenos"> 817</span>        <span class="k">assert</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;Only (1,2,3)-D transforms supported.&quot;</span>
<span class="linenos"> 818</span>        <span class="k">return</span> <span class="n">N</span>
<span class="linenos"> 819</span>
<span class="linenos"> 820</span>    <span class="nd">@classmethod</span>
<span class="linenos"> 821</span>    <span class="k">def</span> <span class="nf">_sanitize_init_kwargs</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="linenos"> 822</span>        <span class="c1"># check init() params + put in standardized form</span>
<span class="linenos"> 823</span>        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
<span class="linenos"> 824</span>
<span class="linenos"> 825</span>    <span class="nd">@staticmethod</span>
<span class="linenos"> 826</span>    <span class="k">def</span> <span class="nf">_plan_fw</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">finufft_Plan</span><span class="p">:</span>
<span class="linenos"> 827</span>        <span class="c1"># create plan and set points</span>
<span class="linenos"> 828</span>        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
<span class="linenos"> 829</span>
<span class="linenos"> 830</span>    <span class="k">def</span> <span class="nf">_fw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos"> 831</span>        <span class="c1"># apply forward operator.</span>
<span class="linenos"> 832</span>        <span class="c1"># input: (n_trans, Q1) complex-valued</span>
<span class="linenos"> 833</span>        <span class="c1"># output: (n_trans, Q2) complex-valued</span>
<span class="linenos"> 834</span>        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
<span class="linenos"> 835</span>
<span class="linenos"> 836</span>    <span class="nd">@staticmethod</span>
<span class="linenos"> 837</span>    <span class="k">def</span> <span class="nf">_plan_bw</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">finufft_Plan</span><span class="p">:</span>
<span class="linenos"> 838</span>        <span class="c1"># create plan and set points</span>
<span class="linenos"> 839</span>        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
<span class="linenos"> 840</span>
<span class="linenos"> 841</span>    <span class="k">def</span> <span class="nf">_bw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos"> 842</span>        <span class="c1"># apply backward operator.</span>
<span class="linenos"> 843</span>        <span class="c1"># input: (n_trans, Q2) complex-valued</span>
<span class="linenos"> 844</span>        <span class="c1"># output: (n_trans, Q1) complex-valued</span>
<span class="linenos"> 845</span>        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
<span class="linenos"> 846</span>
<span class="linenos"> 847</span>    <span class="k">def</span> <span class="nf">_warn_cast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos"> 848</span>        <span class="n">W</span> <span class="o">=</span> <span class="n">pxrt</span><span class="o">.</span><span class="n">Width</span>  <span class="c1"># shorthand</span>
<span class="linenos"> 849</span>        <span class="n">x_width</span> <span class="o">=</span> <span class="n">W</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
<span class="linenos"> 850</span>        <span class="k">if</span> <span class="p">(</span><span class="n">a_width</span> <span class="o">:=</span> <span class="n">W</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span> <span class="o">!=</span> <span class="n">x_width</span><span class="p">:</span>
<span class="linenos"> 851</span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enable_warnings</span><span class="p">:</span>
<span class="linenos"> 852</span>                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;NUFFT was configured to run with </span><span class="si">{</span><span class="n">x_width</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> inputs, but provided </span><span class="si">{</span><span class="n">a_width</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> inputs.&quot;</span>
<span class="linenos"> 853</span>                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">pxw</span><span class="o">.</span><span class="n">PrecisionWarning</span><span class="p">)</span>
<span class="linenos"> 854</span>            <span class="n">out</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">x_width</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<span class="linenos"> 855</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 856</span>            <span class="n">out</span> <span class="o">=</span> <span class="n">arr</span>
<span class="linenos"> 857</span>        <span class="k">return</span> <span class="n">out</span>
<span class="linenos"> 858</span>
<span class="linenos"> 859</span>    <span class="nd">@staticmethod</span>
<span class="linenos"> 860</span>    <span class="k">def</span> <span class="nf">_preprocess</span><span class="p">(</span>
<span class="linenos"> 861</span>        <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">,</span>
<span class="linenos"> 862</span>        <span class="n">n_trans</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
<span class="linenos"> 863</span>        <span class="n">dim_out</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
<span class="linenos"> 864</span>    <span class="p">):</span>
<span class="linenos"> 865</span>        <span class="c1"># Internal method for apply/adjoint.</span>
<span class="linenos"> 866</span>        <span class="c1">#</span>
<span class="linenos"> 867</span>        <span class="c1"># Parameters</span>
<span class="linenos"> 868</span>        <span class="c1"># ----------</span>
<span class="linenos"> 869</span>        <span class="c1"># arr: pxt.NDArray</span>
<span class="linenos"> 870</span>        <span class="c1">#     (..., N1) complex-valued input of [apply|adjoint]().</span>
<span class="linenos"> 871</span>        <span class="c1"># n_trans: pxt.Integer</span>
<span class="linenos"> 872</span>        <span class="c1">#     n_trans parameter given to finufft.Plan()</span>
<span class="linenos"> 873</span>        <span class="c1"># dim_out: pxt.Integer</span>
<span class="linenos"> 874</span>        <span class="c1">#     Trailing dimension [apply|adjoint](arr) should have.</span>
<span class="linenos"> 875</span>        <span class="c1">#</span>
<span class="linenos"> 876</span>        <span class="c1"># Returns</span>
<span class="linenos"> 877</span>        <span class="c1"># -------</span>
<span class="linenos"> 878</span>        <span class="c1"># x: pxt.NDArray</span>
<span class="linenos"> 879</span>        <span class="c1">#     (N_blk, n_trans, N1) complex-valued blocks to input to [_fw|_bw](), suitably augmented</span>
<span class="linenos"> 880</span>        <span class="c1">#     as needed.</span>
<span class="linenos"> 881</span>        <span class="c1"># N: pxt.Integer</span>
<span class="linenos"> 882</span>        <span class="c1">#     Amount of &quot;valid&quot; data to extract from [_fw|_bw](). {For _postprocess()}</span>
<span class="linenos"> 883</span>        <span class="c1"># sh_out: pxt.NDArrayShape</span>
<span class="linenos"> 884</span>        <span class="c1">#     Shape [apply|adjoint](arr) should have. {For _postprocess()}</span>
<span class="linenos"> 885</span>        <span class="n">sh_out</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">dim_out</span><span class="p">,)</span>
<span class="linenos"> 886</span>        <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos"> 887</span>            <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="linenos"> 888</span>        <span class="n">N</span><span class="p">,</span> <span class="n">dim_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos"> 889</span>
<span class="linenos"> 890</span>        <span class="n">N_blk</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">n_trans</span><span class="p">)</span>
<span class="linenos"> 891</span>        <span class="n">N_blk</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
<span class="linenos"> 892</span>        <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos"> 893</span>            <span class="n">x</span> <span class="o">=</span> <span class="n">arr</span>
<span class="linenos"> 894</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 895</span>            <span class="n">xp</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">get_array_module</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="linenos"> 896</span>            <span class="n">x</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
<span class="linenos"> 897</span>                <span class="p">[</span>
<span class="linenos"> 898</span>                    <span class="n">arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">dim_in</span><span class="p">)),</span>
<span class="linenos"> 899</span>                    <span class="n">xp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_trans</span> <span class="o">-</span> <span class="n">r</span><span class="p">,</span> <span class="n">dim_in</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">arr</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
<span class="linenos"> 900</span>                <span class="p">],</span>
<span class="linenos"> 901</span>                <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="linenos"> 902</span>            <span class="p">)</span>
<span class="linenos"> 903</span>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">N_blk</span><span class="p">,</span> <span class="n">n_trans</span><span class="p">,</span> <span class="n">dim_in</span><span class="p">))</span>
<span class="linenos"> 904</span>        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">sh_out</span>
<span class="linenos"> 905</span>
<span class="linenos"> 906</span>    <span class="nd">@staticmethod</span>
<span class="linenos"> 907</span>    <span class="k">def</span> <span class="nf">_postprocess</span><span class="p">(</span>
<span class="linenos"> 908</span>        <span class="n">blks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">],</span>
<span class="linenos"> 909</span>        <span class="n">N</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
<span class="linenos"> 910</span>        <span class="n">sh_out</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArrayShape</span><span class="p">,</span>
<span class="linenos"> 911</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos"> 912</span>        <span class="c1"># Internal method for apply/adjoint.</span>
<span class="linenos"> 913</span>        <span class="c1">#</span>
<span class="linenos"> 914</span>        <span class="c1"># Parameters</span>
<span class="linenos"> 915</span>        <span class="c1"># ----------</span>
<span class="linenos"> 916</span>        <span class="c1"># blks: list[pxt.NDArray]</span>
<span class="linenos"> 917</span>        <span class="c1">#     (N_blk,) complex-valued outputs of [_fw|_bw]().</span>
<span class="linenos"> 918</span>        <span class="c1"># N: pxt.Integer</span>
<span class="linenos"> 919</span>        <span class="c1">#     Amount of &quot;valid&quot; data to extract from [_fw|_bw]()</span>
<span class="linenos"> 920</span>        <span class="c1"># sh_out: pxt.NDArrayShape</span>
<span class="linenos"> 921</span>        <span class="c1">#     Shape [apply|adjoint](arr) should have.</span>
<span class="linenos"> 922</span>        <span class="n">xp</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">get_array_module</span><span class="p">(</span><span class="n">blks</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="linenos"> 923</span>        <span class="k">return</span> <span class="n">xp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">blks</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[:</span><span class="n">N</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">sh_out</span><span class="p">)</span>
<span class="linenos"> 924</span>
<div class="viewcode-block" id="NUFFT.ascomplexarray">
<a class="viewcode-back" href="../../../../../api/operator/linop.html#pyxu.operator.linop.fft.nufft.NUFFT.ascomplexarray">[docs]</a>
<span class="linenos"> 925</span>    <span class="k">def</span> <span class="nf">ascomplexarray</span><span class="p">(</span>
<span class="linenos"> 926</span>        <span class="bp">self</span><span class="p">,</span>
<span class="linenos"> 927</span>        <span class="n">xp</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">ArrayModule</span> <span class="o">=</span> <span class="n">pxd</span><span class="o">.</span><span class="n">NDArrayInfo</span><span class="o">.</span><span class="n">NUMPY</span><span class="o">.</span><span class="n">module</span><span class="p">(),</span>
<span class="linenos"> 928</span>        <span class="n">dtype</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">DType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 929</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos"> 930</span><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 931</span><span class="sd">        Matrix representation (complex-valued) of the linear operator.</span>
<span class="linenos"> 932</span>
<span class="linenos"> 933</span><span class="sd">        Parameters</span>
<span class="linenos"> 934</span><span class="sd">        ----------</span>
<span class="linenos"> 935</span><span class="sd">        xp: ArrayModule</span>
<span class="linenos"> 936</span><span class="sd">            Which array module to use to represent the output.</span>
<span class="linenos"> 937</span><span class="sd">        dtype: DType</span>
<span class="linenos"> 938</span><span class="sd">            Optional (complex-valued) type of the array.</span>
<span class="linenos"> 939</span>
<span class="linenos"> 940</span><span class="sd">        Returns</span>
<span class="linenos"> 941</span><span class="sd">        -------</span>
<span class="linenos"> 942</span><span class="sd">        A: NDArray</span>
<span class="linenos"> 943</span><span class="sd">            Array representation of the operator (NUFFT type-dependant).</span>
<span class="linenos"> 944</span>
<span class="linenos"> 945</span><span class="sd">            - **Type 1:** (N.prod(), M)</span>
<span class="linenos"> 946</span><span class="sd">            - **Type 2:** (M, N.prod())</span>
<span class="linenos"> 947</span><span class="sd">            - **Type 3:** (N, M)</span>
<span class="linenos"> 948</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 949</span>        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<span class="linenos"> 950</span>
<div class="viewcode-block" id="NUFFT.mesh">
<a class="viewcode-back" href="../../../../../api/operator/linop.html#pyxu.operator.linop.fft.nufft.NUFFT.mesh">[docs]</a>
<span class="linenos"> 951</span>    <span class="k">def</span> <span class="nf">mesh</span><span class="p">(</span>
<span class="linenos"> 952</span>        <span class="bp">self</span><span class="p">,</span>
<span class="linenos"> 953</span>        <span class="n">xp</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">ArrayModule</span> <span class="o">=</span> <span class="n">pxd</span><span class="o">.</span><span class="n">NDArrayInfo</span><span class="o">.</span><span class="n">NUMPY</span><span class="o">.</span><span class="n">module</span><span class="p">(),</span>
<span class="linenos"> 954</span>        <span class="n">dtype</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">DType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 955</span>        <span class="n">scale</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;unit&quot;</span><span class="p">,</span>
<span class="linenos"> 956</span>        <span class="n">upsampled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="linenos"> 957</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos"> 958</span><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 959</span><span class="sd">        For type-1/2 NUFFT: compute the transform&#39;s meshgrid :math:`\mathcal{I}_{N_{1} \times \cdots \times N_{d}} =</span>
<span class="linenos"> 960</span><span class="sd">        \mathcal{I}_{N_{1}} \times \cdots \times \mathcal{I}_{N_{d}}`.</span>
<span class="linenos"> 961</span>
<span class="linenos"> 962</span><span class="sd">        For type-3 NUFFT: compute the (shifted) meshgrid used for internal FFT computations.</span>
<span class="linenos"> 963</span>
<span class="linenos"> 964</span><span class="sd">        Parameters</span>
<span class="linenos"> 965</span><span class="sd">        ----------</span>
<span class="linenos"> 966</span><span class="sd">        xp: ArrayModule</span>
<span class="linenos"> 967</span><span class="sd">            Which array module to use to represent the output.</span>
<span class="linenos"> 968</span><span class="sd">        dtype: DType</span>
<span class="linenos"> 969</span><span class="sd">            Optional type of the array.</span>
<span class="linenos"> 970</span><span class="sd">        scale: str</span>
<span class="linenos"> 971</span><span class="sd">            Grid scale. Options are:</span>
<span class="linenos"> 972</span>
<span class="linenos"> 973</span><span class="sd">            - **Type1 and 2:**</span>
<span class="linenos"> 974</span><span class="sd">                * ``unit``, i.e. :math:`\mathcal{I} = [[-N_{d}//2, \ldots, (N_{d}-1)//2 + 1))^{d}`</span>
<span class="linenos"> 975</span><span class="sd">                * ``source``, i.e. :math:`\mathcal{I} \subset [-\pi, \pi)^{d}`</span>
<span class="linenos"> 976</span><span class="sd">            - **Type 3:**</span>
<span class="linenos"> 977</span><span class="sd">                * ``unit``, i.e. :math:`\mathcal{I} = [[-N_{d}//2, \ldots, (N_{d}-1)//2 + 1))^{d}`</span>
<span class="linenos"> 978</span>
<span class="linenos"> 979</span><span class="sd">                * ``source``, i.e. :math:`\mathcal{I}_{\text{source}} \subset x^{c} + [-X_{d}, X_{d})^{d}`</span>
<span class="linenos"> 980</span>
<span class="linenos"> 981</span><span class="sd">                * ``target``, i.e. :math:`\mathcal{I}_{\text{target}} \subset z^{c} + [-Z_{d}, Z_{d})^{d}`,</span>
<span class="linenos"> 982</span>
<span class="linenos"> 983</span><span class="sd">              where :math:`x^{c}`, :math:`z^{c}` denote the source/target centroids, and :math:`X`,</span>
<span class="linenos"> 984</span><span class="sd">              :math:`Z` the source/target half-widths.</span>
<span class="linenos"> 985</span>
<span class="linenos"> 986</span><span class="sd">        upsampled: bool</span>
<span class="linenos"> 987</span><span class="sd">            Use the upsampled meshgrid.  (See [FINUFFT]_ for details.)</span>
<span class="linenos"> 988</span>
<span class="linenos"> 989</span><span class="sd">        Returns</span>
<span class="linenos"> 990</span><span class="sd">        -------</span>
<span class="linenos"> 991</span><span class="sd">        grid: NDArray</span>
<span class="linenos"> 992</span><span class="sd">            (N1, ..., Nd, d) grid.</span>
<span class="linenos"> 993</span>
<span class="linenos"> 994</span><span class="sd">        Examples</span>
<span class="linenos"> 995</span><span class="sd">        --------</span>
<span class="linenos"> 996</span><span class="sd">        .. code-block:: python3</span>
<span class="linenos"> 997</span>
<span class="linenos"> 998</span><span class="sd">           import numpy as np</span>
<span class="linenos"> 999</span><span class="sd">           import pyxu.operator as pxo</span>
<span class="linenos">1000</span>
<span class="linenos">1001</span><span class="sd">           rng = np.random.default_rng(0)</span>
<span class="linenos">1002</span><span class="sd">           D, M, N = 1, 2, 3  # D denotes the dimension of the data</span>
<span class="linenos">1003</span><span class="sd">           x = np.fmod(rng.normal(size=(M, D)), 2 * np.pi)</span>
<span class="linenos">1004</span><span class="sd">           A = pxo.NUFFT.type1(</span>
<span class="linenos">1005</span><span class="sd">               x, N,</span>
<span class="linenos">1006</span><span class="sd">               isign=-1,</span>
<span class="linenos">1007</span><span class="sd">               eps=1e-3</span>
<span class="linenos">1008</span><span class="sd">           )</span>
<span class="linenos">1009</span><span class="sd">           A.mesh()  # array([[-1.],</span>
<span class="linenos">1010</span><span class="sd">                     #        [ 0.],</span>
<span class="linenos">1011</span><span class="sd">                     #        [ 1.]])</span>
<span class="linenos">1012</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">1013</span>        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<span class="linenos">1014</span>
<div class="viewcode-block" id="NUFFT.plot_kernel">
<a class="viewcode-back" href="../../../../../api/operator/linop.html#pyxu.operator.linop.fft.nufft.NUFFT.plot_kernel">[docs]</a>
<span class="linenos">1015</span>    <span class="k">def</span> <span class="nf">plot_kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="linenos">1016</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">1017</span><span class="sd">        Plot the spreading/interpolation kernel (along each dimension) on its support.</span>
<span class="linenos">1018</span>
<span class="linenos">1019</span><span class="sd">        Parameters</span>
<span class="linenos">1020</span><span class="sd">        ----------</span>
<span class="linenos">1021</span><span class="sd">        ax: :py:class:`~matplotlib.axes.Axes`</span>
<span class="linenos">1022</span><span class="sd">            Axes to draw on.</span>
<span class="linenos">1023</span><span class="sd">            If :py:obj:`None`, a new axes is used.</span>
<span class="linenos">1024</span><span class="sd">        **kwargs</span>
<span class="linenos">1025</span><span class="sd">            Keyword arguments forwarded to :py:meth:`matplotlib.axes.Axes.plot`.</span>
<span class="linenos">1026</span>
<span class="linenos">1027</span><span class="sd">        Returns</span>
<span class="linenos">1028</span><span class="sd">        -------</span>
<span class="linenos">1029</span><span class="sd">        ax : :py:class:`~matplotlib.axes.Axes`</span>
<span class="linenos">1030</span>
<span class="linenos">1031</span><span class="sd">        Examples</span>
<span class="linenos">1032</span><span class="sd">        --------</span>
<span class="linenos">1033</span>
<span class="linenos">1034</span><span class="sd">        .. plot::</span>
<span class="linenos">1035</span>
<span class="linenos">1036</span><span class="sd">           import numpy as np</span>
<span class="linenos">1037</span><span class="sd">           import pyxu.operator as pxo</span>
<span class="linenos">1038</span><span class="sd">           import matplotlib.pyplot as plt</span>
<span class="linenos">1039</span>
<span class="linenos">1040</span><span class="sd">           rng = np.random.default_rng(0)</span>
<span class="linenos">1041</span><span class="sd">           D, M, N = 1, 2, 3  # D denotes the dimension of the data</span>
<span class="linenos">1042</span><span class="sd">           x = np.fmod(rng.normal(size=(M, D)), 2 * np.pi)</span>
<span class="linenos">1043</span><span class="sd">           A = pxo.NUFFT.type1(</span>
<span class="linenos">1044</span><span class="sd">               x, N,</span>
<span class="linenos">1045</span><span class="sd">               isign=-1,</span>
<span class="linenos">1046</span><span class="sd">               eps=1e-9</span>
<span class="linenos">1047</span><span class="sd">           )</span>
<span class="linenos">1048</span><span class="sd">           A.plot_kernel()</span>
<span class="linenos">1049</span><span class="sd">           plt.show()</span>
<span class="linenos">1050</span>
<span class="linenos">1051</span><span class="sd">        Notes</span>
<span class="linenos">1052</span><span class="sd">        -----</span>
<span class="linenos">1053</span><span class="sd">        Requires `Matplotlib &lt;https://matplotlib.org/&gt;`_ to be installed.</span>
<span class="linenos">1054</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">1055</span>        <span class="n">plt</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s2">&quot;matplotlib.pyplot&quot;</span><span class="p">)</span>
<span class="linenos">1056</span>        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">1057</span>            <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="linenos">1058</span>
<span class="linenos">1059</span>        <span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kernel_width</span><span class="p">()</span>
<span class="linenos">1060</span>        <span class="n">beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kernel_beta</span><span class="p">()</span>
<span class="linenos">1061</span>        <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fft_shape</span><span class="p">()</span>
<span class="linenos">1062</span>
<span class="linenos">1063</span>        <span class="n">N_sample</span> <span class="o">=</span> <span class="mi">100</span>
<span class="linenos">1064</span>        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N_sample</span><span class="p">)</span>
<span class="linenos">1065</span>        <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_D</span><span class="p">),</span> <span class="n">N</span><span class="p">):</span>
<span class="linenos">1066</span>            <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">width</span> <span class="o">/</span> <span class="n">n</span>
<span class="linenos">1067</span>            <span class="n">x</span> <span class="o">=</span> <span class="n">z</span> <span class="o">/</span> <span class="n">alpha</span>
<span class="linenos">1068</span>            <span class="n">phi</span> <span class="o">=</span> <span class="n">ES_kernel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span>
<span class="linenos">1069</span>            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">rf</span><span class="s2">&quot;$\phi_</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos">1070</span>
<span class="linenos">1071</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_D</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">1072</span>            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="linenos">1073</span>        <span class="k">return</span> <span class="n">ax</span></div>

<span class="linenos">1074</span>
<div class="viewcode-block" id="NUFFT.params">
<a class="viewcode-back" href="../../../../../api/operator/linop.html#pyxu.operator.linop.fft.nufft.NUFFT.params">[docs]</a>
<span class="linenos">1075</span>    <span class="k">def</span> <span class="nf">params</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">:</span>
<span class="linenos">1076</span><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">1077</span><span class="sd">        Compute internal parameters of the [FINUFFT]_ implementation.</span>
<span class="linenos">1078</span>
<span class="linenos">1079</span><span class="sd">        Returns</span>
<span class="linenos">1080</span><span class="sd">        -------</span>
<span class="linenos">1081</span><span class="sd">        p: :py:func:`~collections.namedtuple`</span>
<span class="linenos">1082</span><span class="sd">            Internal parameters of the FINUFFT implementation, with fields:</span>
<span class="linenos">1083</span>
<span class="linenos">1084</span><span class="sd">            * upsample_factor: :py:attr:`~pyxu.info.ptype.Real`</span>
<span class="linenos">1085</span><span class="sd">                FFT upsampling factor &gt; 1</span>
<span class="linenos">1086</span><span class="sd">            * kernel_width: :py:attr:`~pyxu.info.ptype.Integer`</span>
<span class="linenos">1087</span><span class="sd">                Width of the spreading/interpolation kernels (in number of samples).</span>
<span class="linenos">1088</span><span class="sd">            * kernel_beta: :py:attr:`~pyxu.info.ptype.Real`</span>
<span class="linenos">1089</span><span class="sd">                Kernel decay parameter :math:`\beta &gt; 0`.</span>
<span class="linenos">1090</span><span class="sd">            * fft_shape: (d,) [:py:attr:`~pyxu.info.ptype.Integer`]</span>
<span class="linenos">1091</span><span class="sd">                Size of the D-dimensional FFT(s) performed internally.</span>
<span class="linenos">1092</span><span class="sd">            * dilation_factor: (d,) [:py:attr:`~pyxu.info.ptype.Real`]</span>
<span class="linenos">1093</span><span class="sd">                Dilation factor(s) :math:`\gamma_{d}`. (Type-3 only)</span>
<span class="linenos">1094</span>
<span class="linenos">1095</span><span class="sd">        Notes</span>
<span class="linenos">1096</span><span class="sd">        -----</span>
<span class="linenos">1097</span><span class="sd">        When called from a chunked type-3 transform, :py:meth:`~pyxu.operator.linop.fft.nufft.NUFFT.params` returns</span>
<span class="linenos">1098</span><span class="sd">        parameters of the equivalent monolithic type-3 transform.</span>
<span class="linenos">1099</span><span class="sd">        The monolithic transform is seldom instantiable due to its large memory requirements.</span>
<span class="linenos">1100</span><span class="sd">        This method can hence be used to estimate the memory savings induced by chunking.</span>
<span class="linenos">1101</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">1102</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direct_eval</span><span class="p">:</span>
<span class="linenos">1103</span>            <span class="n">p</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">1104</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1105</span>            <span class="n">FINUFFT_PARAMS</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span>
<span class="linenos">1106</span>                <span class="s2">&quot;finufft_params&quot;</span><span class="p">,</span>
<span class="linenos">1107</span>                <span class="p">[</span>
<span class="linenos">1108</span>                    <span class="s2">&quot;upsample_factor&quot;</span><span class="p">,</span>
<span class="linenos">1109</span>                    <span class="s2">&quot;kernel_width&quot;</span><span class="p">,</span>
<span class="linenos">1110</span>                    <span class="s2">&quot;kernel_beta&quot;</span><span class="p">,</span>
<span class="linenos">1111</span>                    <span class="s2">&quot;fft_shape&quot;</span><span class="p">,</span>
<span class="linenos">1112</span>                    <span class="s2">&quot;dilation_factor&quot;</span><span class="p">,</span>
<span class="linenos">1113</span>                <span class="p">],</span>
<span class="linenos">1114</span>            <span class="p">)</span>
<span class="linenos">1115</span>            <span class="n">p</span> <span class="o">=</span> <span class="n">FINUFFT_PARAMS</span><span class="p">(</span>
<span class="linenos">1116</span>                <span class="n">upsample_factor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_upsample_factor</span><span class="p">(),</span>
<span class="linenos">1117</span>                <span class="n">kernel_width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_kernel_width</span><span class="p">(),</span>
<span class="linenos">1118</span>                <span class="n">kernel_beta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_kernel_beta</span><span class="p">(),</span>
<span class="linenos">1119</span>                <span class="n">fft_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fft_shape</span><span class="p">(),</span>
<span class="linenos">1120</span>                <span class="n">dilation_factor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dilation_factor</span><span class="p">(),</span>
<span class="linenos">1121</span>            <span class="p">)</span>
<span class="linenos">1122</span>        <span class="k">return</span> <span class="n">p</span></div>

<span class="linenos">1123</span>
<div class="viewcode-block" id="NUFFT.auto_chunk">
<a class="viewcode-back" href="../../../../../api/operator/linop.html#pyxu.operator.linop.fft.nufft.NUFFT.auto_chunk">[docs]</a>
<span class="linenos">1124</span>    <span class="k">def</span> <span class="nf">auto_chunk</span><span class="p">(</span>
<span class="linenos">1125</span>        <span class="bp">self</span><span class="p">,</span>
<span class="linenos">1126</span>        <span class="n">max_mem</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Real</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
<span class="linenos">1127</span>        <span class="n">max_anisotropy</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Real</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
<span class="linenos">1128</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">]]:</span>
<span class="linenos">1129</span><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">1130</span><span class="sd">        (Only applies to chunked type-3 transforms.)</span>
<span class="linenos">1131</span>
<span class="linenos">1132</span><span class="sd">        Auto-determine chunk indices per domain.</span>
<span class="linenos">1133</span>
<span class="linenos">1134</span><span class="sd">        Use this function if you don&#39;t know how to optimally &#39;cut&#39; x/z manually.</span>
<span class="linenos">1135</span>
<span class="linenos">1136</span><span class="sd">        Parameters</span>
<span class="linenos">1137</span><span class="sd">        ----------</span>
<span class="linenos">1138</span><span class="sd">        max_mem: Real</span>
<span class="linenos">1139</span><span class="sd">            Max FFT memory (MiB) allowed per sub-block. (Default = 10 MiB)</span>
<span class="linenos">1140</span><span class="sd">        max_anisotropy: Real</span>
<span class="linenos">1141</span><span class="sd">            Max tolerated (normalized) anisotropy ratio &gt;= 1.</span>
<span class="linenos">1142</span>
<span class="linenos">1143</span><span class="sd">            * Setting close to 1 favors cubeoid-shaped partitions of x/z space.</span>
<span class="linenos">1144</span><span class="sd">            * Setting large allows x/z-partitions to be highly-rectangular.</span>
<span class="linenos">1145</span>
<span class="linenos">1146</span><span class="sd">        Returns</span>
<span class="linenos">1147</span><span class="sd">        -------</span>
<span class="linenos">1148</span><span class="sd">        x_chunks: list[NDArray[int]]</span>
<span class="linenos">1149</span><span class="sd">            (x_idx[0], ..., x_idx[A-1]) x-coordinate chunk specifier.</span>
<span class="linenos">1150</span><span class="sd">            `x_idx[k]` contains indices of `x` which participate in the k-th NUFFT sub-problem.</span>
<span class="linenos">1151</span><span class="sd">        z_chunks: list[NDArray[int]]</span>
<span class="linenos">1152</span><span class="sd">            (z_idx[0], ..., z_idx[B-1]) z-coordinate chunk specifier.</span>
<span class="linenos">1153</span><span class="sd">            `z_idx[k]` contains indices of `z` which participate in the k-th NUFFT sub-problem.</span>
<span class="linenos">1154</span>
<span class="linenos">1155</span><span class="sd">        Notes</span>
<span class="linenos">1156</span><span class="sd">        -----</span>
<span class="linenos">1157</span><span class="sd">        Chunks are identified by a custom hierarchical clustering method, with main steps:</span>
<span class="linenos">1158</span>
<span class="linenos">1159</span><span class="sd">        1. **Partition the NUFFT domains.**</span>
<span class="linenos">1160</span><span class="sd">           Given a maximum FFT memory budget :math:`B&gt;0` and chunk anisotropy :math:`\alpha\geq 1`, partition the</span>
<span class="linenos">1161</span><span class="sd">           source/target domains into uniform rectangular cells.</span>
<span class="linenos">1162</span><span class="sd">           The (half) widths of the source/target cells :math:`h_{k}&gt;0` and :math:`\eta_{k}&gt;0` in each dimension</span>
<span class="linenos">1163</span><span class="sd">           :math:`k=\{1,\ldots d\}` are chosen so as to:</span>
<span class="linenos">1164</span>
<span class="linenos">1165</span><span class="sd">           Minimize the total number of partitions:</span>
<span class="linenos">1166</span>
<span class="linenos">1167</span><span class="sd">           .. math::</span>
<span class="linenos">1168</span>
<span class="linenos">1169</span><span class="sd">              N_{c}</span>
<span class="linenos">1170</span><span class="sd">              =</span>
<span class="linenos">1171</span><span class="sd">              \underbrace{\prod_{k=1}^{d} \frac{X_k}{h_k}}_{\text{Source partition count}}</span>
<span class="linenos">1172</span><span class="sd">              \times</span>
<span class="linenos">1173</span><span class="sd">              \underbrace{\prod_{k=1}^{d} \frac{Z_k}{\eta_k}}_{\text{Target partition count}}</span>
<span class="linenos">1174</span>
<span class="linenos">1175</span><span class="sd">           subject to:</span>
<span class="linenos">1176</span>
<span class="linenos">1177</span><span class="sd">             (a) .. math::</span>
<span class="linenos">1178</span>
<span class="linenos">1179</span><span class="sd">                    \prod_{k=1}^{d} \eta_k h_k</span>
<span class="linenos">1180</span><span class="sd">                    \leq</span>
<span class="linenos">1181</span><span class="sd">                    (\pi/2\upsilon)^{d} \frac{B}{\delta \; \texttt{n_trans}},</span>
<span class="linenos">1182</span>
<span class="linenos">1183</span><span class="sd">                 where</span>
<span class="linenos">1184</span>
<span class="linenos">1185</span><span class="sd">                   * :math:`\upsilon` denotes the NUFFT&#39;s grid upsampling factor,</span>
<span class="linenos">1186</span><span class="sd">                   * :math:`\delta` the number of bytes occupied by a complex number,</span>
<span class="linenos">1187</span><span class="sd">                   * :math:`\texttt{n_trans}` the number of simultaneous transforms performed.</span>
<span class="linenos">1188</span><span class="sd">             (b) .. math::</span>
<span class="linenos">1189</span>
<span class="linenos">1190</span><span class="sd">                    \begin{align*}</span>
<span class="linenos">1191</span><span class="sd">                        h_{k} &amp; \leq X_{k}, \quad k=\{1,\ldots,d\} \\</span>
<span class="linenos">1192</span><span class="sd">                        \eta_{k} &amp; \leq Z_{k}, \quad k=\{1,\ldots,d\}</span>
<span class="linenos">1193</span><span class="sd">                    \end{align*}</span>
<span class="linenos">1194</span><span class="sd">             (c) .. math::</span>
<span class="linenos">1195</span>
<span class="linenos">1196</span><span class="sd">                    N_{c} \ge 1.</span>
<span class="linenos">1197</span><span class="sd">             (d) .. math::</span>
<span class="linenos">1198</span>
<span class="linenos">1199</span><span class="sd">                    \begin{align*}</span>
<span class="linenos">1200</span><span class="sd">                        \frac{1}{\alpha} &amp; \leq \frac{h_{k}}{h_{j}} \frac{X_{j}}{X_{k}} \leq \alpha, \quad k \ne j, \\</span>
<span class="linenos">1201</span><span class="sd">                        \frac{1}{\alpha} &amp; \leq \frac{\eta_{k}}{\eta_{j}} \frac{Z_{j}}{Z_{k}} \leq \alpha, \quad k \ne j.</span>
<span class="linenos">1202</span><span class="sd">                    \end{align*}</span>
<span class="linenos">1203</span><span class="sd">             (e) .. math::</span>
<span class="linenos">1204</span>
<span class="linenos">1205</span><span class="sd">                    \begin{align*}</span>
<span class="linenos">1206</span><span class="sd">                        \frac{1}{\alpha} &amp; \leq \frac{h_{k}}{\eta_{j}} \frac{Z_{j}}{X_{k}} \leq \alpha, \quad (j, k) = \{1,\ldots,d\}^{2}.</span>
<span class="linenos">1207</span><span class="sd">                    \end{align*}</span>
<span class="linenos">1208</span>
<span class="linenos">1209</span><span class="sd">           Constraint (a) ensures type-3 NUFFTs performed in each sub-problem do not exceed the FFT memory budget.</span>
<span class="linenos">1210</span><span class="sd">           Constraints (b-c) ensure that partitions are non-degenerate/non-trivial respectively.</span>
<span class="linenos">1211</span><span class="sd">           Constraints (d-e) limit the anisotropy of the partitioning cells in each domain and across domains.</span>
<span class="linenos">1212</span><span class="sd">        2. **Data-independent Chunking.**</span>
<span class="linenos">1213</span><span class="sd">           Chunk the data by assigning non-uniform samples to their enclosing cell in the partition.</span>
<span class="linenos">1214</span><span class="sd">           Empty partitions are dropped.</span>
<span class="linenos">1215</span><span class="sd">        3. **Data-dependent Chunk Fusion.**</span>
<span class="linenos">1216</span><span class="sd">           Since (1) is data-independent, data chunks obtained in (2) may split clusters among adjacent chunks, which is</span>
<span class="linenos">1217</span><span class="sd">           undesirable.</span>
<span class="linenos">1218</span><span class="sd">           Clusters whose joint-spread is small enough are hence fused hierarchically.</span>
<span class="linenos">1219</span>
<span class="linenos">1220</span><span class="sd">        .. Warning::</span>
<span class="linenos">1221</span>
<span class="linenos">1222</span><span class="sd">           This procedure yields a small number of memory-capped and well-separated data chunks in source/target</span>
<span class="linenos">1223</span><span class="sd">           domains.</span>
<span class="linenos">1224</span><span class="sd">           However, it may result in unbalanced chunks, with some chunks containing significantly more data-points than</span>
<span class="linenos">1225</span><span class="sd">           others.</span>
<span class="linenos">1226</span><span class="sd">           FINUFFT mitigates the unbalanced-chunk problem by spawning multiple threads to process dense clusters.</span>
<span class="linenos">1227</span>
<span class="linenos">1228</span><span class="sd">        See Also</span>
<span class="linenos">1229</span><span class="sd">        --------</span>
<span class="linenos">1230</span><span class="sd">        :py:meth:`~pyxu.operator.linop.fft.nufft.NUFFT.allocate`,</span>
<span class="linenos">1231</span><span class="sd">        :py:meth:`~pyxu.operator.linop.fft.nufft.NUFFT.diagnostic_plot`,</span>
<span class="linenos">1232</span><span class="sd">        :py:meth:`~pyxu.operator.linop.fft.nufft.NUFFT.stats`</span>
<span class="linenos">1233</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">1234</span>        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<span class="linenos">1235</span>
<div class="viewcode-block" id="NUFFT.allocate">
<a class="viewcode-back" href="../../../../../api/operator/linop.html#pyxu.operator.linop.fft.nufft.NUFFT.allocate">[docs]</a>
<span class="linenos">1236</span>    <span class="k">def</span> <span class="nf">allocate</span><span class="p">(</span>
<span class="linenos">1237</span>        <span class="bp">self</span><span class="p">,</span>
<span class="linenos">1238</span>        <span class="n">x_chunks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">typ</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">,</span> <span class="nb">slice</span><span class="p">]],</span>
<span class="linenos">1239</span>        <span class="n">z_chunks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">typ</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">,</span> <span class="nb">slice</span><span class="p">]],</span>
<span class="linenos">1240</span>        <span class="n">direct_eval_threshold</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Integer</span> <span class="o">=</span> <span class="mi">10_000</span><span class="p">,</span>
<span class="linenos">1241</span>    <span class="p">):</span>
<span class="linenos">1242</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">1243</span><span class="sd">        (Only applies to chunked type-3 transforms.)</span>
<span class="linenos">1244</span>
<span class="linenos">1245</span><span class="sd">        Allocate NUFFT sub-problems based on chunk specification.</span>
<span class="linenos">1246</span>
<span class="linenos">1247</span><span class="sd">        Parameters</span>
<span class="linenos">1248</span><span class="sd">        ----------</span>
<span class="linenos">1249</span><span class="sd">        x_chunks: list[NDArray[int] | slice]</span>
<span class="linenos">1250</span><span class="sd">            (x_idx[0], ..., x_idx[A-1]) x-coordinate chunk specifier.</span>
<span class="linenos">1251</span><span class="sd">            `x_idx[k]` contains indices of `x` which participate in the k-th NUFFT sub-problem.</span>
<span class="linenos">1252</span><span class="sd">        z_chunks: list[NDArray[int] | slice]</span>
<span class="linenos">1253</span><span class="sd">            (z_idx[0], ..., z_idx[B-1]) z-coordinate chunk specifier.</span>
<span class="linenos">1254</span><span class="sd">            `z_idx[k]` contains indices of `z` which participate in the k-th NUFFT sub-problem.</span>
<span class="linenos">1255</span><span class="sd">        direct_eval_threshold: Integer</span>
<span class="linenos">1256</span><span class="sd">            If provided: lower bound on ``len(x) * len(z)`` below which an NUFFT sub-problem is</span>
<span class="linenos">1257</span><span class="sd">            replaced with direct-evaluation (eps=0) for performance reasons.</span>
<span class="linenos">1258</span>
<span class="linenos">1259</span><span class="sd">            (Defaults to 10k as per the `FINUFFT guidelines</span>
<span class="linenos">1260</span><span class="sd">            &lt;https://finufft.readthedocs.io/en/latest/#do-i-even-need-a-nufft&gt;`_.)</span>
<span class="linenos">1261</span>
<span class="linenos">1262</span><span class="sd">        See Also</span>
<span class="linenos">1263</span><span class="sd">        --------</span>
<span class="linenos">1264</span><span class="sd">        :py:meth:`~pyxu.operator.linop.fft.nufft.NUFFT.auto_chunk`,</span>
<span class="linenos">1265</span><span class="sd">        :py:meth:`~pyxu.operator.linop.fft.nufft.NUFFT.diagnostic_plot`,</span>
<span class="linenos">1266</span><span class="sd">        :py:meth:`~pyxu.operator.linop.fft.nufft.NUFFT.stats`</span>
<span class="linenos">1267</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">1268</span>        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<span class="linenos">1269</span>
<div class="viewcode-block" id="NUFFT.diagnostic_plot">
<a class="viewcode-back" href="../../../../../api/operator/linop.html#pyxu.operator.linop.fft.nufft.NUFFT.diagnostic_plot">[docs]</a>
<span class="linenos">1270</span>    <span class="k">def</span> <span class="nf">diagnostic_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="linenos">1271</span><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">1272</span><span class="sd">        (Only applies to chunked type-3 transforms.)</span>
<span class="linenos">1273</span>
<span class="linenos">1274</span><span class="sd">        Plot data + tesselation structure for diagnostic purposes.</span>
<span class="linenos">1275</span>
<span class="linenos">1276</span><span class="sd">        Parameters</span>
<span class="linenos">1277</span><span class="sd">        ----------</span>
<span class="linenos">1278</span><span class="sd">        domain: &#39;x&#39;, &#39;z&#39;</span>
<span class="linenos">1279</span><span class="sd">            Plot x-domain or z-domain data.</span>
<span class="linenos">1280</span>
<span class="linenos">1281</span><span class="sd">        Returns</span>
<span class="linenos">1282</span><span class="sd">        -------</span>
<span class="linenos">1283</span><span class="sd">        fig: :py:class:`~matplotlib.figure.Figure`</span>
<span class="linenos">1284</span><span class="sd">            Diagnostic plot.</span>
<span class="linenos">1285</span>
<span class="linenos">1286</span><span class="sd">        Notes</span>
<span class="linenos">1287</span><span class="sd">        -----</span>
<span class="linenos">1288</span><span class="sd">        * This method can only be called after :py:meth:`~pyxu.operator.linop.fft.nufft.NUFFT.allocate`.</span>
<span class="linenos">1289</span><span class="sd">        * This method only works for 2D/3D domains.</span>
<span class="linenos">1290</span>
<span class="linenos">1291</span><span class="sd">        Examples</span>
<span class="linenos">1292</span><span class="sd">        --------</span>
<span class="linenos">1293</span>
<span class="linenos">1294</span><span class="sd">        .. plot::</span>
<span class="linenos">1295</span>
<span class="linenos">1296</span><span class="sd">           import numpy as np</span>
<span class="linenos">1297</span><span class="sd">           import pyxu.operator as pxo</span>
<span class="linenos">1298</span>
<span class="linenos">1299</span><span class="sd">           rng = np.random.default_rng(2)</span>
<span class="linenos">1300</span><span class="sd">           D, M, N = 2, 500, 200</span>
<span class="linenos">1301</span><span class="sd">           rnd_points = lambda _: rng.normal(scale=rng.uniform(0.25, 0.5, size=(D,)), size=(_, D))</span>
<span class="linenos">1302</span><span class="sd">           rnd_offset = lambda: rng.uniform(-1, 1, size=(D,))</span>
<span class="linenos">1303</span><span class="sd">           scale = 20</span>
<span class="linenos">1304</span><span class="sd">           x = np.concatenate(</span>
<span class="linenos">1305</span><span class="sd">               [</span>
<span class="linenos">1306</span><span class="sd">                   rnd_points(M) + rnd_offset() * scale,</span>
<span class="linenos">1307</span><span class="sd">                   rnd_points(M) + rnd_offset() * scale,</span>
<span class="linenos">1308</span><span class="sd">                   rnd_points(M) + rnd_offset() * scale,</span>
<span class="linenos">1309</span><span class="sd">                   rnd_points(M) + rnd_offset() * scale,</span>
<span class="linenos">1310</span><span class="sd">                   rnd_points(M) + rnd_offset() * scale,</span>
<span class="linenos">1311</span><span class="sd">               ],</span>
<span class="linenos">1312</span><span class="sd">               axis=0,</span>
<span class="linenos">1313</span><span class="sd">           )</span>
<span class="linenos">1314</span><span class="sd">           z = np.concatenate(</span>
<span class="linenos">1315</span><span class="sd">               [</span>
<span class="linenos">1316</span><span class="sd">                   rnd_points(N) + rnd_offset() * scale,</span>
<span class="linenos">1317</span><span class="sd">                   rnd_points(N) + rnd_offset() * scale,</span>
<span class="linenos">1318</span><span class="sd">                   rnd_points(N) + rnd_offset() * scale,</span>
<span class="linenos">1319</span><span class="sd">                   rnd_points(N) + rnd_offset() * scale,</span>
<span class="linenos">1320</span><span class="sd">                   rnd_points(N) + rnd_offset() * scale,</span>
<span class="linenos">1321</span><span class="sd">               ],</span>
<span class="linenos">1322</span><span class="sd">               axis=0,</span>
<span class="linenos">1323</span><span class="sd">           )</span>
<span class="linenos">1324</span>
<span class="linenos">1325</span><span class="sd">           kwargs = dict(</span>
<span class="linenos">1326</span><span class="sd">               x=x,</span>
<span class="linenos">1327</span><span class="sd">               z=z,</span>
<span class="linenos">1328</span><span class="sd">               isign=-1,</span>
<span class="linenos">1329</span><span class="sd">               eps=1e-3,</span>
<span class="linenos">1330</span><span class="sd">           )</span>
<span class="linenos">1331</span><span class="sd">           A = pxo.NUFFT.type3(**kwargs, chunked=True)</span>
<span class="linenos">1332</span><span class="sd">           x_chunks, z_chunks = A.auto_chunk(</span>
<span class="linenos">1333</span><span class="sd">               max_mem=.1,</span>
<span class="linenos">1334</span><span class="sd">               max_anisotropy=1,</span>
<span class="linenos">1335</span><span class="sd">           )</span>
<span class="linenos">1336</span><span class="sd">           A.allocate(x_chunks, z_chunks)</span>
<span class="linenos">1337</span><span class="sd">           fig = A.diagnostic_plot(&#39;x&#39;)</span>
<span class="linenos">1338</span><span class="sd">           fig.show()</span>
<span class="linenos">1339</span>
<span class="linenos">1340</span><span class="sd">        Notes</span>
<span class="linenos">1341</span><span class="sd">        -----</span>
<span class="linenos">1342</span><span class="sd">        Requires `Matplotlib &lt;https://matplotlib.org/&gt;`_ to be installed.</span>
<span class="linenos">1343</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">1344</span>        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<span class="linenos">1345</span>
<div class="viewcode-block" id="NUFFT.stats">
<a class="viewcode-back" href="../../../../../api/operator/linop.html#pyxu.operator.linop.fft.nufft.NUFFT.stats">[docs]</a>
<span class="linenos">1346</span>    <span class="k">def</span> <span class="nf">stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">1347</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">1348</span><span class="sd">        (Only applies to chunked type-3 transforms.)</span>
<span class="linenos">1349</span>
<span class="linenos">1350</span><span class="sd">        Gather internal statistics about a chunked type-3 NUFFT.</span>
<span class="linenos">1351</span>
<span class="linenos">1352</span><span class="sd">        Returns</span>
<span class="linenos">1353</span><span class="sd">        -------</span>
<span class="linenos">1354</span><span class="sd">        p: :py:func:`~collections.namedtuple`</span>
<span class="linenos">1355</span><span class="sd">            Statistics on the NUFFT chunks, with fields:</span>
<span class="linenos">1356</span>
<span class="linenos">1357</span><span class="sd">            * blk_count: :py:attr:`~pyxu.info.ptype.Integer`</span>
<span class="linenos">1358</span><span class="sd">                Number of NUFFT chunks.</span>
<span class="linenos">1359</span><span class="sd">            * dEval_count: :py:attr:`~pyxu.info.ptype.Integer`</span>
<span class="linenos">1360</span><span class="sd">                Number of chunks directly evaluated via the NUDFT.</span>
<span class="linenos">1361</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">1362</span>        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<span class="linenos">1363</span>
<span class="linenos">1364</span>    <span class="k">def</span> <span class="nf">_upsample_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Real</span><span class="p">:</span>
<span class="linenos">1365</span>        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
<span class="linenos">1366</span>
<span class="linenos">1367</span>    <span class="k">def</span> <span class="nf">_kernel_width</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Integer</span><span class="p">:</span>
<span class="linenos">1368</span>        <span class="c1"># https://github.com/flatironinstitute/finufft/</span>
<span class="linenos">1369</span>        <span class="c1">#     ./src/spreadinterp.cpp::setup_spreader()</span>
<span class="linenos">1370</span>        <span class="c1"># [FINUFFT]_</span>
<span class="linenos">1371</span>        <span class="c1">#     eq   3.2</span>
<span class="linenos">1372</span>        <span class="c1">#     sect 4.2</span>
<span class="linenos">1373</span>        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_upsample_factor</span><span class="p">()</span>
<span class="linenos">1374</span>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
<span class="linenos">1375</span>            <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_eps</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">1376</span>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># 1.25 Consistent with setup_spreader() but not sect 4.2 (safety factor gamma=1 instead of 0.976)</span>
<span class="linenos">1377</span>            <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">u</span><span class="p">))</span>
<span class="linenos">1378</span>            <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_eps</span><span class="p">)</span> <span class="o">/</span> <span class="n">scale</span><span class="p">)</span>
<span class="linenos">1379</span>        <span class="n">w</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
<span class="linenos">1380</span>        <span class="k">return</span> <span class="n">w</span>
<span class="linenos">1381</span>
<span class="linenos">1382</span>    <span class="k">def</span> <span class="nf">_kernel_beta</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Real</span><span class="p">:</span>
<span class="linenos">1383</span>        <span class="c1"># https://github.com/flatironinstitute/finufft/</span>
<span class="linenos">1384</span>        <span class="c1">#     ./src/spreadinterp.cpp::setup_spreader()</span>
<span class="linenos">1385</span>        <span class="c1"># [FINUFFT]_</span>
<span class="linenos">1386</span>        <span class="c1">#     eq   3.2</span>
<span class="linenos">1387</span>        <span class="c1">#     sect 4.2</span>
<span class="linenos">1388</span>        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_upsample_factor</span><span class="p">()</span>
<span class="linenos">1389</span>        <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kernel_width</span><span class="p">()</span>
<span class="linenos">1390</span>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
<span class="linenos">1391</span>            <span class="n">scale</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos">1392</span>                <span class="mi">2</span><span class="p">:</span> <span class="mf">2.20</span><span class="p">,</span>
<span class="linenos">1393</span>                <span class="mi">3</span><span class="p">:</span> <span class="mf">2.26</span><span class="p">,</span>
<span class="linenos">1394</span>                <span class="mi">4</span><span class="p">:</span> <span class="mf">2.38</span><span class="p">,</span>
<span class="linenos">1395</span>            <span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="mf">2.30</span><span class="p">)</span>
<span class="linenos">1396</span>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># 1.25</span>
<span class="linenos">1397</span>            <span class="n">gamma</span> <span class="o">=</span> <span class="mf">0.97</span>  <span class="c1"># 0.976 in paper</span>
<span class="linenos">1398</span>            <span class="n">scale</span> <span class="o">=</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">/</span> <span class="n">u</span><span class="p">))</span>
<span class="linenos">1399</span>        <span class="n">beta</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">scale</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span>
<span class="linenos">1400</span>        <span class="k">return</span> <span class="n">beta</span>
<span class="linenos">1401</span>
<span class="linenos">1402</span>    <span class="k">def</span> <span class="nf">_fft_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArrayShape</span><span class="p">:</span>
<span class="linenos">1403</span>        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
<span class="linenos">1404</span>
<span class="linenos">1405</span>    <span class="k">def</span> <span class="nf">_dilation_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cabc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">pxt</span><span class="o">.</span><span class="n">Integer</span><span class="p">]:</span>
<span class="linenos">1406</span>        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<span class="linenos">1407</span>
<span class="linenos">1408</span>
<span class="linenos">1409</span><span class="k">class</span> <span class="nc">_NUFFT1</span><span class="p">(</span><span class="n">NUFFT</span><span class="p">):</span>
<span class="linenos">1410</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="linenos">1411</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_M</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_D</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>  <span class="c1"># Useful constants</span>
<span class="linenos">1412</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_N</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;N&quot;</span><span class="p">]</span>
<span class="linenos">1413</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_x</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span>
<span class="linenos">1414</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_isign</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;isign&quot;</span><span class="p">]</span>
<span class="linenos">1415</span>
<span class="linenos">1416</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_eps</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;eps&quot;</span><span class="p">)</span>
<span class="linenos">1417</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_direct_eval</span> <span class="o">=</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_eps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">1418</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_enable_warnings</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;enable_warnings&quot;</span><span class="p">)</span>
<span class="linenos">1419</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_real_in</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;real_in&quot;</span><span class="p">)</span>
<span class="linenos">1420</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_real_out</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;real_out&quot;</span><span class="p">)</span>
<span class="linenos">1421</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_upsampfac</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;upsampfac&quot;</span><span class="p">)</span>
<span class="linenos">1422</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_n</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;n_trans&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">1423</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_modeord</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;modeord&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">1424</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direct_eval</span><span class="p">:</span>
<span class="linenos">1425</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_plan</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">1426</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1427</span>            <span class="n">_pfw</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;plan_fw&quot;</span><span class="p">)</span>
<span class="linenos">1428</span>            <span class="n">_pbw</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;plan_bw&quot;</span><span class="p">)</span>
<span class="linenos">1429</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_plan</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
<span class="linenos">1430</span>                <span class="n">fw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_plan_fw</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">if</span> <span class="n">_pfw</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos">1431</span>                <span class="n">bw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_plan_bw</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">if</span> <span class="n">_pbw</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos">1432</span>            <span class="p">)</span>
<span class="linenos">1433</span>
<span class="linenos">1434</span>        <span class="n">sh_op</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_M</span><span class="p">]</span>
<span class="linenos">1435</span>        <span class="n">sh_op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//=</span> <span class="mi">2</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_real_out</span> <span class="k">else</span> <span class="mi">1</span>
<span class="linenos">1436</span>        <span class="n">sh_op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//=</span> <span class="mi">2</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_real_in</span> <span class="k">else</span> <span class="mi">1</span>
<span class="linenos">1437</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">sh_op</span><span class="p">)</span>
<span class="linenos">1438</span>        <span class="bp">self</span><span class="o">.</span><span class="n">lipschitz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_M</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">))</span>  <span class="c1"># analytical upper bound</span>
<span class="linenos">1439</span>
<span class="linenos">1440</span>    <span class="nd">@classmethod</span>
<span class="linenos">1441</span>    <span class="k">def</span> <span class="nf">_sanitize_init_kwargs</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="linenos">1442</span>        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="linenos">1443</span>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;nufft_type&quot;</span><span class="p">,</span> <span class="s2">&quot;n_modes_or_dim&quot;</span><span class="p">,</span> <span class="s2">&quot;dtype&quot;</span><span class="p">):</span>
<span class="linenos">1444</span>            <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">1445</span>        <span class="n">x</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_as_canonical_coordinate</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]))</span>
<span class="linenos">1446</span>        <span class="n">N</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;N&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_as_canonical_mode</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;N&quot;</span><span class="p">])</span>
<span class="linenos">1447</span>        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;isign&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;isign&quot;</span><span class="p">]))</span>
<span class="linenos">1448</span>        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;eps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;eps&quot;</span><span class="p">])</span>
<span class="linenos">1449</span>        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;real_in&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;real_in&quot;</span><span class="p">])</span>
<span class="linenos">1450</span>        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;real_out&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;real_out&quot;</span><span class="p">])</span>
<span class="linenos">1451</span>        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;plan_fw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;plan_fw&quot;</span><span class="p">])</span>
<span class="linenos">1452</span>        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;plan_bw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;plan_bw&quot;</span><span class="p">])</span>
<span class="linenos">1453</span>        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;enable_warnings&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;enable_warnings&quot;</span><span class="p">])</span>
<span class="linenos">1454</span>        <span class="k">if</span> <span class="p">(</span><span class="n">D</span> <span class="o">:=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
<span class="linenos">1455</span>            <span class="k">pass</span>
<span class="linenos">1456</span>        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">1457</span>            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;N&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span> <span class="o">*</span> <span class="n">D</span>
<span class="linenos">1458</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1459</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;x vs. N: dimensionality mis-match.&quot;</span><span class="p">)</span>
<span class="linenos">1460</span>        <span class="k">return</span> <span class="n">kwargs</span>
<span class="linenos">1461</span>
<span class="linenos">1462</span>    <span class="nd">@staticmethod</span>
<span class="linenos">1463</span>    <span class="k">def</span> <span class="nf">_plan_fw</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">finufft_Plan</span><span class="p">:</span>
<span class="linenos">1464</span>        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="linenos">1465</span>        <span class="n">x</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="p">[</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">)]</span>
<span class="linenos">1466</span>        <span class="n">_</span><span class="p">,</span> <span class="n">N_dim</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
<span class="linenos">1467</span>
<span class="linenos">1468</span>        <span class="n">plan</span> <span class="o">=</span> <span class="n">finufft</span><span class="o">.</span><span class="n">Plan</span><span class="p">(</span>
<span class="linenos">1469</span>            <span class="n">nufft_type</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="linenos">1470</span>            <span class="n">n_modes_or_dim</span><span class="o">=</span><span class="n">N</span><span class="p">,</span>
<span class="linenos">1471</span>            <span class="n">dtype</span><span class="o">=</span><span class="n">pxrt</span><span class="o">.</span><span class="n">getPrecision</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<span class="linenos">1472</span>            <span class="n">eps</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;eps&quot;</span><span class="p">),</span>
<span class="linenos">1473</span>            <span class="n">n_trans</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;n_trans&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="linenos">1474</span>            <span class="n">isign</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;isign&quot;</span><span class="p">),</span>
<span class="linenos">1475</span>            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="linenos">1476</span>        <span class="p">)</span>
<span class="linenos">1477</span>        <span class="n">plan</span><span class="o">.</span><span class="n">setpts</span><span class="p">(</span><span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="s2">&quot;xyz&quot;</span><span class="p">[:</span><span class="n">N_dim</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="p">[:</span><span class="n">N_dim</span><span class="p">])))</span>
<span class="linenos">1478</span>        <span class="k">return</span> <span class="n">plan</span>
<span class="linenos">1479</span>
<span class="linenos">1480</span>    <span class="k">def</span> <span class="nf">_fw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos">1481</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direct_eval</span><span class="p">:</span>
<span class="linenos">1482</span>            <span class="c1"># Computing the target each time is wasteful (in comparison to the type-3 case where it</span>
<span class="linenos">1483</span>            <span class="c1"># is implicit.) We are ok with this since relying on NUDFT is a failsafe.</span>
<span class="linenos">1484</span>            <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">(</span>
<span class="linenos">1485</span>                <span class="n">xp</span><span class="o">=</span><span class="n">pxd</span><span class="o">.</span><span class="n">NDArrayInfo</span><span class="o">.</span><span class="n">from_obj</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span><span class="o">.</span><span class="n">module</span><span class="p">(),</span>
<span class="linenos">1486</span>                <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
<span class="linenos">1487</span>                <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;unit&quot;</span><span class="p">,</span>
<span class="linenos">1488</span>                <span class="n">upsampled</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos">1489</span>            <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_D</span><span class="p">))</span>
<span class="linenos">1490</span>
<span class="linenos">1491</span>            <span class="n">out</span> <span class="o">=</span> <span class="n">_nudft</span><span class="p">(</span>
<span class="linenos">1492</span>                <span class="n">weight</span><span class="o">=</span><span class="n">arr</span><span class="p">,</span>
<span class="linenos">1493</span>                <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">,</span>
<span class="linenos">1494</span>                <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
<span class="linenos">1495</span>                <span class="n">isign</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_isign</span><span class="p">,</span>
<span class="linenos">1496</span>                <span class="n">dtype</span><span class="o">=</span><span class="n">arr</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
<span class="linenos">1497</span>            <span class="p">)</span>
<span class="linenos">1498</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1499</span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># finufft limitation: insists on having no</span>
<span class="linenos">1500</span>                <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># leading-dim if n_trans==1.</span>
<span class="linenos">1501</span>            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plan</span><span class="p">[</span><span class="s2">&quot;fw&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>  <span class="c1"># ([n_trans], M) -&gt; ([n_trans], N1,..., Nd)</span>
<span class="linenos">1502</span>        <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_n</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">)))</span>
<span class="linenos">1503</span>
<span class="linenos">1504</span>    <span class="nd">@staticmethod</span>
<span class="linenos">1505</span>    <span class="k">def</span> <span class="nf">_plan_bw</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">finufft_Plan</span><span class="p">:</span>
<span class="linenos">1506</span>        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="linenos">1507</span>        <span class="n">x</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="p">[</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">)]</span>
<span class="linenos">1508</span>        <span class="n">_</span><span class="p">,</span> <span class="n">N_dim</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
<span class="linenos">1509</span>
<span class="linenos">1510</span>        <span class="n">plan</span> <span class="o">=</span> <span class="n">finufft</span><span class="o">.</span><span class="n">Plan</span><span class="p">(</span>
<span class="linenos">1511</span>            <span class="n">nufft_type</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="linenos">1512</span>            <span class="n">n_modes_or_dim</span><span class="o">=</span><span class="n">N</span><span class="p">,</span>
<span class="linenos">1513</span>            <span class="n">dtype</span><span class="o">=</span><span class="n">pxrt</span><span class="o">.</span><span class="n">getPrecision</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<span class="linenos">1514</span>            <span class="n">eps</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;eps&quot;</span><span class="p">),</span>
<span class="linenos">1515</span>            <span class="n">n_trans</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;n_trans&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="linenos">1516</span>            <span class="n">isign</span><span class="o">=-</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;isign&quot;</span><span class="p">),</span>
<span class="linenos">1517</span>            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="linenos">1518</span>        <span class="p">)</span>
<span class="linenos">1519</span>        <span class="n">plan</span><span class="o">.</span><span class="n">setpts</span><span class="p">(</span><span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="s2">&quot;xyz&quot;</span><span class="p">[:</span><span class="n">N_dim</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="p">[:</span><span class="n">N_dim</span><span class="p">])))</span>
<span class="linenos">1520</span>        <span class="k">return</span> <span class="n">plan</span>
<span class="linenos">1521</span>
<span class="linenos">1522</span>    <span class="k">def</span> <span class="nf">_bw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos">1523</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direct_eval</span><span class="p">:</span>
<span class="linenos">1524</span>            <span class="c1"># Computing the target each time is wasteful (in comparison to the type-3 case where it</span>
<span class="linenos">1525</span>            <span class="c1"># is implicit.) We are ok with this since relying on NUDFT is a failsafe.</span>
<span class="linenos">1526</span>            <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">(</span>
<span class="linenos">1527</span>                <span class="n">xp</span><span class="o">=</span><span class="n">pxd</span><span class="o">.</span><span class="n">NDArrayInfo</span><span class="o">.</span><span class="n">from_obj</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span><span class="o">.</span><span class="n">module</span><span class="p">(),</span>
<span class="linenos">1528</span>                <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
<span class="linenos">1529</span>                <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;unit&quot;</span><span class="p">,</span>
<span class="linenos">1530</span>                <span class="n">upsampled</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos">1531</span>            <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_D</span><span class="p">))</span>
<span class="linenos">1532</span>
<span class="linenos">1533</span>            <span class="n">out</span> <span class="o">=</span> <span class="n">_nudft</span><span class="p">(</span>
<span class="linenos">1534</span>                <span class="n">weight</span><span class="o">=</span><span class="n">arr</span><span class="p">,</span>
<span class="linenos">1535</span>                <span class="n">source</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
<span class="linenos">1536</span>                <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">,</span>
<span class="linenos">1537</span>                <span class="n">isign</span><span class="o">=-</span><span class="bp">self</span><span class="o">.</span><span class="n">_isign</span><span class="p">,</span>
<span class="linenos">1538</span>                <span class="n">dtype</span><span class="o">=</span><span class="n">arr</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
<span class="linenos">1539</span>            <span class="p">)</span>
<span class="linenos">1540</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1541</span>            <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_n</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">))</span>
<span class="linenos">1542</span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># finufft limitation: insists on having no</span>
<span class="linenos">1543</span>                <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># leading-dim if n_trans==1.</span>
<span class="linenos">1544</span>            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plan</span><span class="p">[</span><span class="s2">&quot;bw&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>  <span class="c1"># ([n_trans], N1, ..., Nd) -&gt; ([n_trans], M)</span>
<span class="linenos">1545</span>        <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_M</span><span class="p">))</span>
<span class="linenos">1546</span>
<span class="linenos">1547</span>    <span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">(</span><span class="s2">&quot;arr&quot;</span><span class="p">)</span>
<span class="linenos">1548</span>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos">1549</span>        <span class="n">arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_warn_cast</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="linenos">1550</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_real_in</span><span class="p">:</span>
<span class="linenos">1551</span>            <span class="n">r_width</span> <span class="o">=</span> <span class="n">pxrt</span><span class="o">.</span><span class="n">Width</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
<span class="linenos">1552</span>            <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">r_width</span><span class="o">.</span><span class="n">complex</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<span class="linenos">1553</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1554</span>            <span class="n">arr</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">view_as_complex</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="linenos">1555</span>
<span class="linenos">1556</span>        <span class="n">data</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">sh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">))</span>
<span class="linenos">1557</span>        <span class="n">blks</span> <span class="o">=</span> <span class="n">_dask_zip</span><span class="p">(</span>
<span class="linenos">1558</span>            <span class="n">func</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fw</span><span class="p">,)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
<span class="linenos">1559</span>            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
<span class="linenos">1560</span>            <span class="n">out_shape</span><span class="o">=</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_n</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">)),)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
<span class="linenos">1561</span>            <span class="n">out_dtype</span><span class="o">=</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">,)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
<span class="linenos">1562</span>            <span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos">1563</span>        <span class="p">)</span>
<span class="linenos">1564</span>        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_postprocess</span><span class="p">(</span><span class="n">blks</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">sh</span><span class="p">)</span>
<span class="linenos">1565</span>
<span class="linenos">1566</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_real_out</span><span class="p">:</span>
<span class="linenos">1567</span>            <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">real</span>
<span class="linenos">1568</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1569</span>            <span class="k">return</span> <span class="n">pxu</span><span class="o">.</span><span class="n">view_as_real</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="linenos">1570</span>
<span class="linenos">1571</span>    <span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">(</span><span class="s2">&quot;arr&quot;</span><span class="p">)</span>
<span class="linenos">1572</span>    <span class="k">def</span> <span class="nf">adjoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos">1573</span>        <span class="n">arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_warn_cast</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="linenos">1574</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_real_out</span><span class="p">:</span>
<span class="linenos">1575</span>            <span class="n">r_width</span> <span class="o">=</span> <span class="n">pxrt</span><span class="o">.</span><span class="n">Width</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
<span class="linenos">1576</span>            <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">r_width</span><span class="o">.</span><span class="n">complex</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<span class="linenos">1577</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1578</span>            <span class="n">arr</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">view_as_complex</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="linenos">1579</span>
<span class="linenos">1580</span>        <span class="n">data</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">sh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_M</span><span class="p">)</span>
<span class="linenos">1581</span>        <span class="n">blks</span> <span class="o">=</span> <span class="n">_dask_zip</span><span class="p">(</span>
<span class="linenos">1582</span>            <span class="n">func</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bw</span><span class="p">,)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
<span class="linenos">1583</span>            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
<span class="linenos">1584</span>            <span class="n">out_shape</span><span class="o">=</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_M</span><span class="p">),)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
<span class="linenos">1585</span>            <span class="n">out_dtype</span><span class="o">=</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">,)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
<span class="linenos">1586</span>            <span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos">1587</span>        <span class="p">)</span>
<span class="linenos">1588</span>        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_postprocess</span><span class="p">(</span><span class="n">blks</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">sh</span><span class="p">)</span>
<span class="linenos">1589</span>
<span class="linenos">1590</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_real_in</span><span class="p">:</span>
<span class="linenos">1591</span>            <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">real</span>
<span class="linenos">1592</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1593</span>            <span class="k">return</span> <span class="n">pxu</span><span class="o">.</span><span class="n">view_as_real</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="linenos">1594</span>
<span class="linenos">1595</span>    <span class="k">def</span> <span class="nf">ascomplexarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos">1596</span>        <span class="c1"># compute exact operator (using supported precision/backend)</span>
<span class="linenos">1597</span>        <span class="n">xp</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">get_array_module</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">)</span>
<span class="linenos">1598</span>        <span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">(</span>
<span class="linenos">1599</span>            <span class="n">xp</span><span class="o">=</span><span class="n">xp</span><span class="p">,</span>
<span class="linenos">1600</span>            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
<span class="linenos">1601</span>            <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;unit&quot;</span><span class="p">,</span>
<span class="linenos">1602</span>            <span class="n">upsampled</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos">1603</span>        <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_D</span><span class="p">))</span>
<span class="linenos">1604</span>        <span class="n">_A</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isign</span> <span class="o">*</span> <span class="n">mesh</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="linenos">1605</span>
<span class="linenos">1606</span>        <span class="c1"># then comply with **kwargs()</span>
<span class="linenos">1607</span>        <span class="n">xp</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;xp&quot;</span><span class="p">,</span> <span class="n">pxd</span><span class="o">.</span><span class="n">NDArrayInfo</span><span class="o">.</span><span class="n">NUMPY</span><span class="o">.</span><span class="n">module</span><span class="p">())</span>
<span class="linenos">1608</span>        <span class="n">c_dtype</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dtype&quot;</span><span class="p">,</span> <span class="n">pxrt</span><span class="o">.</span><span class="n">getPrecision</span><span class="p">()</span><span class="o">.</span><span class="n">complex</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<span class="linenos">1609</span>        <span class="n">A</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pxu</span><span class="o">.</span><span class="n">to_NUMPY</span><span class="p">(</span><span class="n">_A</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">c_dtype</span><span class="p">)</span>
<span class="linenos">1610</span>        <span class="k">return</span> <span class="n">A</span>
<span class="linenos">1611</span>
<span class="linenos">1612</span>    <span class="k">def</span> <span class="nf">mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos">1613</span>        <span class="n">xp</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;xp&quot;</span><span class="p">,</span> <span class="n">pxd</span><span class="o">.</span><span class="n">NDArrayInfo</span><span class="o">.</span><span class="n">NUMPY</span><span class="o">.</span><span class="n">module</span><span class="p">())</span>
<span class="linenos">1614</span>        <span class="n">dtype</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dtype&quot;</span><span class="p">,</span> <span class="n">pxrt</span><span class="o">.</span><span class="n">getPrecision</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<span class="linenos">1615</span>        <span class="n">scale</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scale&quot;</span><span class="p">,</span> <span class="s2">&quot;unit&quot;</span><span class="p">)</span>
<span class="linenos">1616</span>        <span class="n">upsampled</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;upsampled&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="linenos">1617</span>
<span class="linenos">1618</span>        <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fft_shape</span><span class="p">()</span> <span class="k">if</span> <span class="n">upsampled</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_N</span>
<span class="linenos">1619</span>        <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="s2">&quot;unit&quot;</span><span class="p">:</span>
<span class="linenos">1620</span>            <span class="n">grid</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>  <span class="c1"># (N1, ..., Nd, D)</span>
<span class="linenos">1621</span>                <span class="n">xp</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span>
<span class="linenos">1622</span>                    <span class="o">*</span><span class="p">[</span><span class="n">xp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">n</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">N</span><span class="p">],</span>
<span class="linenos">1623</span>                    <span class="n">indexing</span><span class="o">=</span><span class="s2">&quot;ij&quot;</span><span class="p">,</span>
<span class="linenos">1624</span>                <span class="p">),</span>
<span class="linenos">1625</span>                <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
<span class="linenos">1626</span>            <span class="p">)</span>
<span class="linenos">1627</span>        <span class="k">elif</span> <span class="n">scale</span> <span class="o">==</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span>
<span class="linenos">1628</span>            <span class="c1"># As per eq. 3.12, the source grid is of the form: 2*pi*l/n, l=0,...,n-1, that is n</span>
<span class="linenos">1629</span>            <span class="c1"># points over [0, 2* pi[ (or [-pi, pi[ if shifted by pi).</span>
<span class="linenos">1630</span>            <span class="n">grid</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>  <span class="c1"># (N1, ..., Nd, D)</span>
<span class="linenos">1631</span>                <span class="n">xp</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span>
<span class="linenos">1632</span>                    <span class="o">*</span><span class="p">[</span><span class="n">xp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">N</span><span class="p">],</span>
<span class="linenos">1633</span>                    <span class="n">indexing</span><span class="o">=</span><span class="s2">&quot;ij&quot;</span><span class="p">,</span>
<span class="linenos">1634</span>                <span class="p">),</span>
<span class="linenos">1635</span>                <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
<span class="linenos">1636</span>            <span class="p">)</span>
<span class="linenos">1637</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1638</span>            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
<span class="linenos">1639</span>
<span class="linenos">1640</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modeord</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># FFT-order</span>
<span class="linenos">1641</span>            <span class="n">grid</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftshift</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">N</span><span class="p">)))</span>
<span class="linenos">1642</span>        <span class="k">return</span> <span class="n">grid</span>
<span class="linenos">1643</span>
<span class="linenos">1644</span>    <span class="k">def</span> <span class="nf">asarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos">1645</span>        <span class="n">xp</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;xp&quot;</span><span class="p">,</span> <span class="n">pxd</span><span class="o">.</span><span class="n">NDArrayInfo</span><span class="o">.</span><span class="n">NUMPY</span><span class="o">.</span><span class="n">module</span><span class="p">())</span>
<span class="linenos">1646</span>        <span class="k">if</span> <span class="p">(</span><span class="n">r_dtype</span> <span class="o">:=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dtype&quot;</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">1647</span>            <span class="n">c_dtype</span> <span class="o">=</span> <span class="n">pxrt</span><span class="o">.</span><span class="n">getPrecision</span><span class="p">()</span><span class="o">.</span><span class="n">complex</span><span class="o">.</span><span class="n">value</span>
<span class="linenos">1648</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1649</span>            <span class="n">r_width</span> <span class="o">=</span> <span class="n">pxrt</span><span class="o">.</span><span class="n">Width</span><span class="p">(</span><span class="n">r_dtype</span><span class="p">)</span>
<span class="linenos">1650</span>            <span class="n">c_dtype</span> <span class="o">=</span> <span class="n">r_width</span><span class="o">.</span><span class="n">complex</span><span class="o">.</span><span class="n">value</span>
<span class="linenos">1651</span>        <span class="n">_A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ascomplexarray</span><span class="p">(</span><span class="n">xp</span><span class="o">=</span><span class="n">xp</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">c_dtype</span><span class="p">)</span>
<span class="linenos">1652</span>
<span class="linenos">1653</span>        <span class="n">A</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">view_as_real_mat</span><span class="p">(</span>
<span class="linenos">1654</span>            <span class="n">cmat</span><span class="o">=</span><span class="n">_A</span><span class="p">,</span>
<span class="linenos">1655</span>            <span class="n">real_input</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_real_in</span><span class="p">,</span>
<span class="linenos">1656</span>            <span class="n">real_output</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_real_out</span><span class="p">,</span>
<span class="linenos">1657</span>        <span class="p">)</span>
<span class="linenos">1658</span>        <span class="k">return</span> <span class="n">A</span>
<span class="linenos">1659</span>
<span class="linenos">1660</span>    <span class="k">def</span> <span class="nf">_upsample_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Real</span><span class="p">:</span>
<span class="linenos">1661</span>        <span class="c1"># https://github.com/flatironinstitute/finufft/</span>
<span class="linenos">1662</span>        <span class="c1">#     ./src/finufft.cpp::FINUFFT_MAKEPLAN()</span>
<span class="linenos">1663</span>        <span class="k">if</span> <span class="p">(</span><span class="n">u</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_upsampfac</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">1664</span>            <span class="n">precQ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eps</span> <span class="o">&gt;=</span> <span class="mf">1e-9</span>
<span class="linenos">1665</span>            <span class="n">dimQ</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_D</span> <span class="o">==</span> <span class="n">d</span>
<span class="linenos">1666</span>            <span class="n">cutoffQ</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">cutoff</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">cutoff</span><span class="p">)</span>
<span class="linenos">1667</span>            <span class="k">if</span> <span class="n">precQ</span> <span class="ow">and</span> <span class="n">dimQ</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cutoffQ</span><span class="p">(</span><span class="mf">1e7</span><span class="p">):</span>
<span class="linenos">1668</span>                <span class="n">u</span> <span class="o">=</span> <span class="mf">1.25</span>
<span class="linenos">1669</span>            <span class="k">elif</span> <span class="n">precQ</span> <span class="ow">and</span> <span class="n">dimQ</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cutoffQ</span><span class="p">(</span><span class="mf">3e5</span><span class="p">):</span>
<span class="linenos">1670</span>                <span class="n">u</span> <span class="o">=</span> <span class="mf">1.25</span>
<span class="linenos">1671</span>            <span class="k">elif</span> <span class="n">precQ</span> <span class="ow">and</span> <span class="n">dimQ</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cutoffQ</span><span class="p">(</span><span class="mf">3e6</span><span class="p">):</span>
<span class="linenos">1672</span>                <span class="n">u</span> <span class="o">=</span> <span class="mf">1.25</span>
<span class="linenos">1673</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">1674</span>                <span class="n">u</span> <span class="o">=</span> <span class="mi">2</span>
<span class="linenos">1675</span>        <span class="k">return</span> <span class="n">u</span>
<span class="linenos">1676</span>
<span class="linenos">1677</span>    <span class="k">def</span> <span class="nf">_fft_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArrayShape</span><span class="p">:</span>
<span class="linenos">1678</span>        <span class="c1"># https://github.com/flatironinstitute/finufft/</span>
<span class="linenos">1679</span>        <span class="c1">#     ./src/finufft.cpp::SET_NF_TYPE12()</span>
<span class="linenos">1680</span>        <span class="c1"># [FINUFFT]_</span>
<span class="linenos">1681</span>        <span class="c1">#     sect 3.1.1</span>
<span class="linenos">1682</span>        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_upsample_factor</span><span class="p">()</span>
<span class="linenos">1683</span>        <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kernel_width</span><span class="p">()</span>
<span class="linenos">1684</span>        <span class="n">shape</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">1685</span>        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">:</span>
<span class="linenos">1686</span>            <span class="n">target</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">n</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span>
<span class="linenos">1687</span>            <span class="n">n_opt</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">next_fast_len</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">even</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">1688</span>            <span class="n">shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n_opt</span><span class="p">)</span>
<span class="linenos">1689</span>        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
<span class="linenos">1690</span>
<span class="linenos">1691</span>    <span class="k">def</span> <span class="nf">_dilation_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cabc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">pxt</span><span class="o">.</span><span class="n">Integer</span><span class="p">]:</span>
<span class="linenos">1692</span>        <span class="c1"># Undefined for type-1</span>
<span class="linenos">1693</span>        <span class="k">return</span> <span class="kc">None</span>
<span class="linenos">1694</span>
<span class="linenos">1695</span>
<span class="linenos">1696</span><span class="k">class</span> <span class="nc">_NUFFT3</span><span class="p">(</span><span class="n">NUFFT</span><span class="p">):</span>
<span class="linenos">1697</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="linenos">1698</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_M</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_D</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>  <span class="c1"># Useful constants</span>
<span class="linenos">1699</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
<span class="linenos">1700</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_x</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span>
<span class="linenos">1701</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_z</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span>
<span class="linenos">1702</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_isign</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;isign&quot;</span><span class="p">]</span>
<span class="linenos">1703</span>
<span class="linenos">1704</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_eps</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;eps&quot;</span><span class="p">)</span>
<span class="linenos">1705</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_direct_eval</span> <span class="o">=</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_eps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">1706</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_enable_warnings</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;enable_warnings&quot;</span><span class="p">)</span>
<span class="linenos">1707</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_real</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;real&quot;</span><span class="p">)</span>
<span class="linenos">1708</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_upsampfac</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;upsampfac&quot;</span><span class="p">)</span>
<span class="linenos">1709</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_n</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;n_trans&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">1710</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_modeord</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># in case _NUFFT1 methods are called</span>
<span class="linenos">1711</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direct_eval</span><span class="p">:</span>
<span class="linenos">1712</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_plan</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">1713</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1714</span>            <span class="n">_pfw</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;plan_fw&quot;</span><span class="p">)</span>
<span class="linenos">1715</span>            <span class="n">_pbw</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;plan_bw&quot;</span><span class="p">)</span>
<span class="linenos">1716</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_plan</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
<span class="linenos">1717</span>                <span class="n">fw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_plan_fw</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">if</span> <span class="n">_pfw</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos">1718</span>                <span class="n">bw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_plan_bw</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">if</span> <span class="n">_pbw</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos">1719</span>            <span class="p">)</span>
<span class="linenos">1720</span>        <span class="n">sh_op</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_M</span><span class="p">]</span>
<span class="linenos">1721</span>        <span class="n">sh_op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//=</span> <span class="mi">2</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_real</span> <span class="k">else</span> <span class="mi">1</span>
<span class="linenos">1722</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">sh_op</span><span class="p">)</span>
<span class="linenos">1723</span>        <span class="bp">self</span><span class="o">.</span><span class="n">lipschitz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_M</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">))</span>  <span class="c1"># analytical upper bound</span>
<span class="linenos">1724</span>
<span class="linenos">1725</span>    <span class="nd">@classmethod</span>
<span class="linenos">1726</span>    <span class="k">def</span> <span class="nf">_sanitize_init_kwargs</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="linenos">1727</span>        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="linenos">1728</span>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;nufft_type&quot;</span><span class="p">,</span> <span class="s2">&quot;n_modes_or_dim&quot;</span><span class="p">,</span> <span class="s2">&quot;dtype&quot;</span><span class="p">,</span> <span class="s2">&quot;modeord&quot;</span><span class="p">):</span>
<span class="linenos">1729</span>            <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">1730</span>
<span class="linenos">1731</span>        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;isign&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;isign&quot;</span><span class="p">]))</span>
<span class="linenos">1732</span>        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;eps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;eps&quot;</span><span class="p">])</span>
<span class="linenos">1733</span>        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;real&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;real&quot;</span><span class="p">])</span>
<span class="linenos">1734</span>        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;plan_fw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;plan_fw&quot;</span><span class="p">])</span>
<span class="linenos">1735</span>        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;plan_bw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;plan_bw&quot;</span><span class="p">])</span>
<span class="linenos">1736</span>        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;enable_warnings&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;enable_warnings&quot;</span><span class="p">])</span>
<span class="linenos">1737</span>        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;parallel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;parallel&quot;</span><span class="p">])</span>
<span class="linenos">1738</span>        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;chunked&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;chunked&quot;</span><span class="p">])</span>
<span class="linenos">1739</span>
<span class="linenos">1740</span>        <span class="n">x</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_as_canonical_coordinate</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">])</span>
<span class="linenos">1741</span>        <span class="n">z</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_as_canonical_coordinate</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">])</span>
<span class="linenos">1742</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;chunked&quot;</span><span class="p">]:</span>
<span class="linenos">1743</span>            <span class="n">x</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">])</span>
<span class="linenos">1744</span>            <span class="n">z</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">])</span>
<span class="linenos">1745</span>        <span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;x vs. z: dimensionality mis-match.&quot;</span>
<span class="linenos">1746</span>        <span class="k">assert</span> <span class="n">pxu</span><span class="o">.</span><span class="n">get_array_module</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="n">pxu</span><span class="o">.</span><span class="n">get_array_module</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
<span class="linenos">1747</span>
<span class="linenos">1748</span>        <span class="k">return</span> <span class="n">kwargs</span>
<span class="linenos">1749</span>
<span class="linenos">1750</span>    <span class="nd">@staticmethod</span>
<span class="linenos">1751</span>    <span class="k">def</span> <span class="nf">_plan_fw</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">finufft_Plan</span><span class="p">:</span>
<span class="linenos">1752</span>        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="linenos">1753</span>        <span class="n">x</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="p">[</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">)]</span>
<span class="linenos">1754</span>        <span class="n">_</span><span class="p">,</span> <span class="n">N_dim</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
<span class="linenos">1755</span>
<span class="linenos">1756</span>        <span class="n">plan</span> <span class="o">=</span> <span class="n">finufft</span><span class="o">.</span><span class="n">Plan</span><span class="p">(</span>
<span class="linenos">1757</span>            <span class="n">nufft_type</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
<span class="linenos">1758</span>            <span class="n">n_modes_or_dim</span><span class="o">=</span><span class="n">N_dim</span><span class="p">,</span>
<span class="linenos">1759</span>            <span class="n">dtype</span><span class="o">=</span><span class="n">pxrt</span><span class="o">.</span><span class="n">getPrecision</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<span class="linenos">1760</span>            <span class="n">eps</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;eps&quot;</span><span class="p">),</span>
<span class="linenos">1761</span>            <span class="n">n_trans</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;n_trans&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="linenos">1762</span>            <span class="n">isign</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;isign&quot;</span><span class="p">),</span>
<span class="linenos">1763</span>            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="linenos">1764</span>        <span class="p">)</span>
<span class="linenos">1765</span>        <span class="n">plan</span><span class="o">.</span><span class="n">setpts</span><span class="p">(</span>
<span class="linenos">1766</span>            <span class="o">**</span><span class="nb">dict</span><span class="p">(</span>
<span class="linenos">1767</span>                <span class="nb">zip</span><span class="p">(</span>
<span class="linenos">1768</span>                    <span class="s2">&quot;xyz&quot;</span><span class="p">[:</span><span class="n">N_dim</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;stu&quot;</span><span class="p">[:</span><span class="n">N_dim</span><span class="p">],</span>
<span class="linenos">1769</span>                    <span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="p">[:</span><span class="n">N_dim</span><span class="p">],</span> <span class="o">*</span><span class="n">z</span><span class="o">.</span><span class="n">T</span><span class="p">[:</span><span class="n">N_dim</span><span class="p">]),</span>
<span class="linenos">1770</span>                <span class="p">)</span>
<span class="linenos">1771</span>            <span class="p">),</span>
<span class="linenos">1772</span>        <span class="p">)</span>
<span class="linenos">1773</span>        <span class="k">return</span> <span class="n">plan</span>
<span class="linenos">1774</span>
<span class="linenos">1775</span>    <span class="k">def</span> <span class="nf">_fw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos">1776</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direct_eval</span><span class="p">:</span>
<span class="linenos">1777</span>            <span class="n">out</span> <span class="o">=</span> <span class="n">_nudft</span><span class="p">(</span>
<span class="linenos">1778</span>                <span class="n">weight</span><span class="o">=</span><span class="n">arr</span><span class="p">,</span>
<span class="linenos">1779</span>                <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">,</span>
<span class="linenos">1780</span>                <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">,</span>
<span class="linenos">1781</span>                <span class="n">isign</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_isign</span><span class="p">,</span>
<span class="linenos">1782</span>                <span class="n">dtype</span><span class="o">=</span><span class="n">arr</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
<span class="linenos">1783</span>            <span class="p">)</span>
<span class="linenos">1784</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1785</span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># finufft limitation: insists on having no</span>
<span class="linenos">1786</span>                <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># leading-dim if n_trans==1.</span>
<span class="linenos">1787</span>            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plan</span><span class="p">[</span><span class="s2">&quot;fw&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>  <span class="c1"># ([n_trans], M) -&gt; ([n_trans], N)</span>
<span class="linenos">1788</span>        <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">))</span>
<span class="linenos">1789</span>
<span class="linenos">1790</span>    <span class="nd">@staticmethod</span>
<span class="linenos">1791</span>    <span class="k">def</span> <span class="nf">_plan_bw</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">finufft_Plan</span><span class="p">:</span>
<span class="linenos">1792</span>        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="linenos">1793</span>        <span class="n">x</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="p">[</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">)]</span>
<span class="linenos">1794</span>        <span class="n">_</span><span class="p">,</span> <span class="n">N_dim</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
<span class="linenos">1795</span>
<span class="linenos">1796</span>        <span class="n">plan</span> <span class="o">=</span> <span class="n">finufft</span><span class="o">.</span><span class="n">Plan</span><span class="p">(</span>
<span class="linenos">1797</span>            <span class="n">nufft_type</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
<span class="linenos">1798</span>            <span class="n">n_modes_or_dim</span><span class="o">=</span><span class="n">N_dim</span><span class="p">,</span>
<span class="linenos">1799</span>            <span class="n">dtype</span><span class="o">=</span><span class="n">pxrt</span><span class="o">.</span><span class="n">getPrecision</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<span class="linenos">1800</span>            <span class="n">eps</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;eps&quot;</span><span class="p">),</span>
<span class="linenos">1801</span>            <span class="n">n_trans</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;n_trans&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="linenos">1802</span>            <span class="n">isign</span><span class="o">=-</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;isign&quot;</span><span class="p">),</span>
<span class="linenos">1803</span>            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="linenos">1804</span>        <span class="p">)</span>
<span class="linenos">1805</span>        <span class="n">plan</span><span class="o">.</span><span class="n">setpts</span><span class="p">(</span>
<span class="linenos">1806</span>            <span class="o">**</span><span class="nb">dict</span><span class="p">(</span>
<span class="linenos">1807</span>                <span class="nb">zip</span><span class="p">(</span>
<span class="linenos">1808</span>                    <span class="s2">&quot;xyz&quot;</span><span class="p">[:</span><span class="n">N_dim</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;stu&quot;</span><span class="p">[:</span><span class="n">N_dim</span><span class="p">],</span>
<span class="linenos">1809</span>                    <span class="p">(</span><span class="o">*</span><span class="n">z</span><span class="o">.</span><span class="n">T</span><span class="p">[:</span><span class="n">N_dim</span><span class="p">],</span> <span class="o">*</span><span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="p">[:</span><span class="n">N_dim</span><span class="p">]),</span>
<span class="linenos">1810</span>                <span class="p">)</span>
<span class="linenos">1811</span>            <span class="p">),</span>
<span class="linenos">1812</span>        <span class="p">)</span>
<span class="linenos">1813</span>        <span class="k">return</span> <span class="n">plan</span>
<span class="linenos">1814</span>
<span class="linenos">1815</span>    <span class="k">def</span> <span class="nf">_bw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos">1816</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direct_eval</span><span class="p">:</span>
<span class="linenos">1817</span>            <span class="n">out</span> <span class="o">=</span> <span class="n">_nudft</span><span class="p">(</span>
<span class="linenos">1818</span>                <span class="n">weight</span><span class="o">=</span><span class="n">arr</span><span class="p">,</span>
<span class="linenos">1819</span>                <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">,</span>
<span class="linenos">1820</span>                <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">,</span>
<span class="linenos">1821</span>                <span class="n">isign</span><span class="o">=-</span><span class="bp">self</span><span class="o">.</span><span class="n">_isign</span><span class="p">,</span>
<span class="linenos">1822</span>                <span class="n">dtype</span><span class="o">=</span><span class="n">arr</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
<span class="linenos">1823</span>            <span class="p">)</span>
<span class="linenos">1824</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1825</span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># finufft limitation: insists on having no</span>
<span class="linenos">1826</span>                <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># leading-dim if n_trans==1.</span>
<span class="linenos">1827</span>            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plan</span><span class="p">[</span><span class="s2">&quot;bw&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>  <span class="c1"># ([n_trans], N) -&gt; ([n_trans], M)</span>
<span class="linenos">1828</span>        <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_M</span><span class="p">))</span>
<span class="linenos">1829</span>
<span class="linenos">1830</span>    <span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">(</span><span class="s2">&quot;arr&quot;</span><span class="p">)</span>
<span class="linenos">1831</span>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos">1832</span>        <span class="n">arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_warn_cast</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="linenos">1833</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_real</span><span class="p">:</span>
<span class="linenos">1834</span>            <span class="n">r_width</span> <span class="o">=</span> <span class="n">pxrt</span><span class="o">.</span><span class="n">Width</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
<span class="linenos">1835</span>            <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">r_width</span><span class="o">.</span><span class="n">complex</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<span class="linenos">1836</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1837</span>            <span class="n">arr</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">view_as_complex</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="linenos">1838</span>
<span class="linenos">1839</span>        <span class="n">data</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">sh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">)</span>
<span class="linenos">1840</span>        <span class="n">blks</span> <span class="o">=</span> <span class="n">_dask_zip</span><span class="p">(</span>
<span class="linenos">1841</span>            <span class="n">func</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fw</span><span class="p">,)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
<span class="linenos">1842</span>            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
<span class="linenos">1843</span>            <span class="n">out_shape</span><span class="o">=</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">),)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
<span class="linenos">1844</span>            <span class="n">out_dtype</span><span class="o">=</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">,)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
<span class="linenos">1845</span>            <span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos">1846</span>        <span class="p">)</span>
<span class="linenos">1847</span>        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_postprocess</span><span class="p">(</span><span class="n">blks</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">sh</span><span class="p">)</span>
<span class="linenos">1848</span>
<span class="linenos">1849</span>        <span class="k">return</span> <span class="n">pxu</span><span class="o">.</span><span class="n">view_as_real</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="linenos">1850</span>
<span class="linenos">1851</span>    <span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">(</span><span class="s2">&quot;arr&quot;</span><span class="p">)</span>
<span class="linenos">1852</span>    <span class="k">def</span> <span class="nf">adjoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos">1853</span>        <span class="n">arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_warn_cast</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="linenos">1854</span>        <span class="n">arr</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">view_as_complex</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="linenos">1855</span>
<span class="linenos">1856</span>        <span class="n">data</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">sh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_M</span><span class="p">)</span>
<span class="linenos">1857</span>        <span class="n">blks</span> <span class="o">=</span> <span class="n">_dask_zip</span><span class="p">(</span>
<span class="linenos">1858</span>            <span class="n">func</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bw</span><span class="p">,)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
<span class="linenos">1859</span>            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
<span class="linenos">1860</span>            <span class="n">out_shape</span><span class="o">=</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_M</span><span class="p">),)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
<span class="linenos">1861</span>            <span class="n">out_dtype</span><span class="o">=</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">,)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
<span class="linenos">1862</span>            <span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos">1863</span>        <span class="p">)</span>
<span class="linenos">1864</span>        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_postprocess</span><span class="p">(</span><span class="n">blks</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">sh</span><span class="p">)</span>
<span class="linenos">1865</span>
<span class="linenos">1866</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_real</span><span class="p">:</span>
<span class="linenos">1867</span>            <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">real</span>
<span class="linenos">1868</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1869</span>            <span class="k">return</span> <span class="n">pxu</span><span class="o">.</span><span class="n">view_as_real</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="linenos">1870</span>
<span class="linenos">1871</span>    <span class="k">def</span> <span class="nf">ascomplexarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos">1872</span>        <span class="c1"># compute exact operator (using supported precision/backend)</span>
<span class="linenos">1873</span>        <span class="n">xp</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">get_array_module</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">)</span>
<span class="linenos">1874</span>        <span class="n">_A</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isign</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="linenos">1875</span>
<span class="linenos">1876</span>        <span class="c1"># then comply with **kwargs()</span>
<span class="linenos">1877</span>        <span class="n">xp</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;xp&quot;</span><span class="p">,</span> <span class="n">pxd</span><span class="o">.</span><span class="n">NDArrayInfo</span><span class="o">.</span><span class="n">NUMPY</span><span class="o">.</span><span class="n">module</span><span class="p">())</span>
<span class="linenos">1878</span>        <span class="n">c_dtype</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dtype&quot;</span><span class="p">,</span> <span class="n">pxrt</span><span class="o">.</span><span class="n">getPrecision</span><span class="p">()</span><span class="o">.</span><span class="n">complex</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<span class="linenos">1879</span>        <span class="n">A</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pxu</span><span class="o">.</span><span class="n">to_NUMPY</span><span class="p">(</span><span class="n">_A</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">c_dtype</span><span class="p">)</span>
<span class="linenos">1880</span>        <span class="k">return</span> <span class="n">A</span>
<span class="linenos">1881</span>
<span class="linenos">1882</span>    <span class="k">def</span> <span class="nf">mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos">1883</span>        <span class="n">xp</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;xp&quot;</span><span class="p">,</span> <span class="n">pxd</span><span class="o">.</span><span class="n">NDArrayInfo</span><span class="o">.</span><span class="n">NUMPY</span><span class="o">.</span><span class="n">module</span><span class="p">())</span>
<span class="linenos">1884</span>        <span class="n">dtype</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dtype&quot;</span><span class="p">,</span> <span class="n">pxrt</span><span class="o">.</span><span class="n">getPrecision</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<span class="linenos">1885</span>        <span class="n">scale</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scale&quot;</span><span class="p">,</span> <span class="s2">&quot;unit&quot;</span><span class="p">)</span>
<span class="linenos">1886</span>        <span class="n">upsampled</span> <span class="o">=</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;upsampled&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>  <span class="c1"># upsampled unsupported for type-3</span>
<span class="linenos">1887</span>        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
<span class="linenos">1888</span>            <span class="n">xp</span><span class="o">=</span><span class="n">xp</span><span class="p">,</span>
<span class="linenos">1889</span>            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
<span class="linenos">1890</span>            <span class="n">upsampled</span><span class="o">=</span><span class="n">upsampled</span><span class="p">,</span>
<span class="linenos">1891</span>        <span class="p">)</span>
<span class="linenos">1892</span>
<span class="linenos">1893</span>        <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="s2">&quot;unit&quot;</span><span class="p">:</span>
<span class="linenos">1894</span>            <span class="n">grid</span> <span class="o">=</span> <span class="n">_NUFFT1</span><span class="o">.</span><span class="n">mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;unit&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos">1895</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1896</span>            <span class="n">grid</span> <span class="o">=</span> <span class="n">_NUFFT1</span><span class="o">.</span><span class="n">mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos">1897</span>            <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">xp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
<span class="linenos">1898</span>            <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span>  <span class="c1"># Sect 3.3 Eq 3.18.</span>
<span class="linenos">1899</span>                <span class="n">s</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dilation_factor</span><span class="p">())</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kernel_width</span><span class="p">()</span> <span class="o">/</span> <span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fft_shape</span><span class="p">()))</span>
<span class="linenos">1900</span>                <span class="n">grid</span> <span class="o">*=</span> <span class="n">s</span>
<span class="linenos">1901</span>                <span class="n">_</span><span class="p">,</span> <span class="n">center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shift_coords</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">)</span>
<span class="linenos">1902</span>            <span class="k">else</span><span class="p">:</span>  <span class="c1"># target, Sect 3.3 Eq 3.22.</span>
<span class="linenos">1903</span>                <span class="n">s</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dilation_factor</span><span class="p">())</span> <span class="o">/</span> <span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fft_shape</span><span class="p">())</span>
<span class="linenos">1904</span>                <span class="n">s</span> <span class="o">*=</span> <span class="n">f</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_upsample_factor</span><span class="p">())</span>
<span class="linenos">1905</span>                <span class="n">grid</span> <span class="o">/=</span> <span class="n">s</span>
<span class="linenos">1906</span>                <span class="n">_</span><span class="p">,</span> <span class="n">center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shift_coords</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">)</span>
<span class="linenos">1907</span>            <span class="n">grid</span> <span class="o">+=</span> <span class="n">f</span><span class="p">(</span><span class="n">center</span><span class="p">)</span>
<span class="linenos">1908</span>        <span class="k">return</span> <span class="n">grid</span>
<span class="linenos">1909</span>
<span class="linenos">1910</span>    <span class="k">def</span> <span class="nf">asarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos">1911</span>        <span class="n">xp</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;xp&quot;</span><span class="p">,</span> <span class="n">pxd</span><span class="o">.</span><span class="n">NDArrayInfo</span><span class="o">.</span><span class="n">NUMPY</span><span class="o">.</span><span class="n">module</span><span class="p">())</span>
<span class="linenos">1912</span>        <span class="k">if</span> <span class="p">(</span><span class="n">r_dtype</span> <span class="o">:=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dtype&quot;</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">1913</span>            <span class="n">c_dtype</span> <span class="o">=</span> <span class="n">pxrt</span><span class="o">.</span><span class="n">getPrecision</span><span class="p">()</span><span class="o">.</span><span class="n">complex</span><span class="o">.</span><span class="n">value</span>
<span class="linenos">1914</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1915</span>            <span class="n">r_width</span> <span class="o">=</span> <span class="n">pxrt</span><span class="o">.</span><span class="n">Width</span><span class="p">(</span><span class="n">r_dtype</span><span class="p">)</span>
<span class="linenos">1916</span>            <span class="n">c_dtype</span> <span class="o">=</span> <span class="n">r_width</span><span class="o">.</span><span class="n">complex</span><span class="o">.</span><span class="n">value</span>
<span class="linenos">1917</span>        <span class="n">_A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ascomplexarray</span><span class="p">(</span><span class="n">xp</span><span class="o">=</span><span class="n">xp</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">c_dtype</span><span class="p">)</span>
<span class="linenos">1918</span>
<span class="linenos">1919</span>        <span class="n">A</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">view_as_real_mat</span><span class="p">(</span><span class="n">cmat</span><span class="o">=</span><span class="n">_A</span><span class="p">,</span> <span class="n">real_input</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_real</span><span class="p">)</span>
<span class="linenos">1920</span>        <span class="k">return</span> <span class="n">A</span>
<span class="linenos">1921</span>
<span class="linenos">1922</span>    <span class="k">def</span> <span class="nf">_upsample_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Real</span><span class="p">:</span>
<span class="linenos">1923</span>        <span class="c1"># https://github.com/flatironinstitute/finufft/</span>
<span class="linenos">1924</span>        <span class="c1">#     ./src/finufft.cpp::FINUFFT_MAKEPLAN()</span>
<span class="linenos">1925</span>        <span class="k">if</span> <span class="p">(</span><span class="n">u</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_upsampfac</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">1926</span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eps</span> <span class="o">&gt;=</span> <span class="mf">1e-9</span><span class="p">:</span>
<span class="linenos">1927</span>                <span class="n">u</span> <span class="o">=</span> <span class="mf">1.25</span>
<span class="linenos">1928</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">1929</span>                <span class="n">u</span> <span class="o">=</span> <span class="mi">2</span>
<span class="linenos">1930</span>        <span class="k">return</span> <span class="n">u</span>
<span class="linenos">1931</span>
<span class="linenos">1932</span>    <span class="k">def</span> <span class="nf">_fft_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArrayShape</span><span class="p">:</span>
<span class="linenos">1933</span>        <span class="c1"># https://github.com/flatironinstitute/finufft/</span>
<span class="linenos">1934</span>        <span class="c1">#     ./src/finufft.cpp::set_nhg_type3()</span>
<span class="linenos">1935</span>        <span class="c1"># [FINUFFT]_</span>
<span class="linenos">1936</span>        <span class="c1">#     eq 3.23</span>
<span class="linenos">1937</span>        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_upsample_factor</span><span class="p">()</span>
<span class="linenos">1938</span>        <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kernel_width</span><span class="p">()</span>
<span class="linenos">1939</span>        <span class="n">X</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shift_coords</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">)</span>  <span class="c1"># (D,)</span>
<span class="linenos">1940</span>        <span class="n">Z</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shift_coords</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">)</span>  <span class="c1"># (D,)</span>
<span class="linenos">1941</span>        <span class="n">shape</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">1942</span>        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_D</span><span class="p">):</span>
<span class="linenos">1943</span>            <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">X</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">*</span> <span class="n">Z</span><span class="p">[</span><span class="n">d</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">w</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">1944</span>            <span class="n">target</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span>
<span class="linenos">1945</span>            <span class="n">n_opt</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">next_fast_len</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">even</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">1946</span>            <span class="n">shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n_opt</span><span class="p">)</span>
<span class="linenos">1947</span>        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
<span class="linenos">1948</span>
<span class="linenos">1949</span>    <span class="k">def</span> <span class="nf">_dilation_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cabc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">pxt</span><span class="o">.</span><span class="n">Integer</span><span class="p">]:</span>
<span class="linenos">1950</span>        <span class="c1"># https://github.com/flatironinstitute/finufft/</span>
<span class="linenos">1951</span>        <span class="c1">#     ./src/finufft.cpp::set_nhg_type3()</span>
<span class="linenos">1952</span>        <span class="c1"># [FINUFFT]_</span>
<span class="linenos">1953</span>        <span class="c1">#     eq 3.23</span>
<span class="linenos">1954</span>        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_upsample_factor</span><span class="p">()</span>
<span class="linenos">1955</span>        <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fft_shape</span><span class="p">()</span>
<span class="linenos">1956</span>        <span class="n">Z</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shift_coords</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">)</span>  <span class="c1"># (D,)</span>
<span class="linenos">1957</span>        <span class="n">gamma</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">Z</span><span class="p">)]</span>
<span class="linenos">1958</span>        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>
<span class="linenos">1959</span>
<span class="linenos">1960</span>    <span class="nd">@staticmethod</span>
<span class="linenos">1961</span>    <span class="k">def</span> <span class="nf">_shift_coords</span><span class="p">(</span><span class="n">pts</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos">1962</span>        <span class="c1"># https://github.com/flatironinstitute/finufft/</span>
<span class="linenos">1963</span>        <span class="c1">#     ./src/utils.cpp::arraywidcen()</span>
<span class="linenos">1964</span>        <span class="c1">#     ./include/finufft/defs.h</span>
<span class="linenos">1965</span>        <span class="c1">#</span>
<span class="linenos">1966</span>        <span class="c1"># Parameters</span>
<span class="linenos">1967</span>        <span class="c1"># ----------</span>
<span class="linenos">1968</span>        <span class="c1"># pts: pxt.NDArray</span>
<span class="linenos">1969</span>        <span class="c1">#     (Q, D) coordinates.</span>
<span class="linenos">1970</span>        <span class="c1">#</span>
<span class="linenos">1971</span>        <span class="c1"># Returns</span>
<span class="linenos">1972</span>        <span class="c1"># -------</span>
<span class="linenos">1973</span>        <span class="c1"># h_width: np.ndarray</span>
<span class="linenos">1974</span>        <span class="c1">#     (D,) shifted half_width</span>
<span class="linenos">1975</span>        <span class="c1"># center: np.ndarray</span>
<span class="linenos">1976</span>        <span class="c1">#     (D,) shifted centroid</span>
<span class="linenos">1977</span>        <span class="n">low</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">to_NUMPY</span><span class="p">(</span><span class="n">pts</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="linenos">1978</span>        <span class="n">high</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">to_NUMPY</span><span class="p">(</span><span class="n">pts</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="linenos">1979</span>        <span class="n">h_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">low</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
<span class="linenos">1980</span>        <span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="n">high</span> <span class="o">+</span> <span class="n">low</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
<span class="linenos">1981</span>        <span class="n">grow_frac</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="linenos">1982</span>
<span class="linenos">1983</span>        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">center</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">h_width</span> <span class="o">*</span> <span class="n">grow_frac</span>
<span class="linenos">1984</span>        <span class="n">h_width</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
<span class="linenos">1985</span>        <span class="n">center</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">1986</span>        <span class="k">return</span> <span class="n">h_width</span><span class="p">,</span> <span class="n">center</span>
<span class="linenos">1987</span>
<span class="linenos">1988</span>
<span class="linenos">1989</span><span class="k">def</span> <span class="nf">_parallelize</span><span class="p">(</span><span class="n">func</span><span class="p">:</span> <span class="n">cabc</span><span class="o">.</span><span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cabc</span><span class="o">.</span><span class="n">Callable</span><span class="p">:</span>
<span class="linenos">1990</span>    <span class="c1"># Parallelize execution of func() under conditions.</span>
<span class="linenos">1991</span>    <span class="c1">#</span>
<span class="linenos">1992</span>    <span class="c1"># * func() must be one of the arithmetic methods [apply,prox,grad,adjoint,pinv]()</span>
<span class="linenos">1993</span>    <span class="c1"># * the `_parallel` attribute must be attached to the instance for it to parallelize execution</span>
<span class="linenos">1994</span>    <span class="c1">#   over NUMPY inputs.</span>
<span class="linenos">1995</span>
<span class="linenos">1996</span>    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
<span class="linenos">1997</span>    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">ARGS</span><span class="p">,</span> <span class="o">**</span><span class="n">KWARGS</span><span class="p">):</span>
<span class="linenos">1998</span>        <span class="n">func_args</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">parse_params</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">ARGS</span><span class="p">,</span> <span class="o">**</span><span class="n">KWARGS</span><span class="p">)</span>
<span class="linenos">1999</span>
<span class="linenos">2000</span>        <span class="n">arr</span> <span class="o">=</span> <span class="n">func_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;arr&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">2001</span>        <span class="n">N</span> <span class="o">=</span> <span class="n">pxd</span><span class="o">.</span><span class="n">NDArrayInfo</span>
<span class="linenos">2002</span>        <span class="n">parallelize</span> <span class="o">=</span> <span class="n">ARGS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_parallel</span> <span class="ow">and</span> <span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">from_obj</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="o">==</span> <span class="n">N</span><span class="o">.</span><span class="n">NUMPY</span><span class="p">)</span>
<span class="linenos">2003</span>
<span class="linenos">2004</span>        <span class="c1"># [2022.09.26] Sepand Kashani</span>
<span class="linenos">2005</span>        <span class="c1"># Q: Why do we parallelize only for NUMPY inputs and not CUPY?</span>
<span class="linenos">2006</span>        <span class="c1"># A: Given an arithmetic method `f`, there is no obligation (for DASK inputs) to satisfy the</span>
<span class="linenos">2007</span>        <span class="c1">#    relation `f(arr).chunk_type == arr.chunk_type`.</span>
<span class="linenos">2008</span>        <span class="c1">#    In particular the relationship does not hold for LinFunc.[grad, adjoint]() unless the</span>
<span class="linenos">2009</span>        <span class="c1">#    user provides a special implementation for DASK inputs.</span>
<span class="linenos">2010</span>        <span class="c1">#    Consequence: the sum() / xp.concatenate() instructions in _COOBlock() may:</span>
<span class="linenos">2011</span>        <span class="c1">#    * fail due to array-type mismatch; or</span>
<span class="linenos">2012</span>        <span class="c1">#    * induce unnecessary CPU&lt;&gt;GPU transfers.</span>
<span class="linenos">2013</span>
<span class="linenos">2014</span>        <span class="k">if</span> <span class="n">parallelize</span><span class="p">:</span>
<span class="linenos">2015</span>            <span class="n">xp</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">DASK</span><span class="o">.</span><span class="n">module</span><span class="p">()</span>
<span class="linenos">2016</span>            <span class="n">func_args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">arr</span><span class="o">=</span><span class="n">xp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">arr</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
<span class="linenos">2017</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">2018</span>            <span class="k">pass</span>
<span class="linenos">2019</span>
<span class="linenos">2020</span>        <span class="n">out</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">**</span><span class="n">func_args</span><span class="p">)</span>
<span class="linenos">2021</span>        <span class="n">f</span> <span class="o">=</span> <span class="p">{</span><span class="kc">True</span><span class="p">:</span> <span class="n">pxu</span><span class="o">.</span><span class="n">compute</span><span class="p">,</span> <span class="kc">False</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">_</span><span class="p">}[</span><span class="n">parallelize</span><span class="p">]</span>
<span class="linenos">2022</span>        <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="linenos">2023</span>
<span class="linenos">2024</span>    <span class="k">return</span> <span class="n">wrapper</span>
<span class="linenos">2025</span>
<span class="linenos">2026</span>
<span class="linenos">2027</span><span class="k">class</span> <span class="nc">_NUFFT3_chunked</span><span class="p">(</span><span class="n">_NUFFT3</span><span class="p">):</span>
<span class="linenos">2028</span>    <span class="c1"># Note:</span>
<span class="linenos">2029</span>    <span class="c1"># * params() in chunked-context returns equivalent parameters of one single huge NUFFT3 block.</span>
<span class="linenos">2030</span>    <span class="c1">#</span>
<span class="linenos">2031</span>    <span class="c1"># TODO:</span>
<span class="linenos">2032</span>    <span class="c1">#   What needs to be changed:</span>
<span class="linenos">2033</span>    <span class="c1">#   * _tesselate() assumes x/z are in memory to find optimal chunks.</span>
<span class="linenos">2034</span>    <span class="c1">#     Do we want to support Dask arrays here so that users can auto-chunk disk-sized data?</span>
<span class="linenos">2035</span>
<span class="linenos">2036</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="linenos">2037</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_disable_unsupported_methods</span><span class="p">()</span>
<span class="linenos">2038</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_parallel</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;parallel&quot;</span><span class="p">)</span>  <span class="c1"># for _parallelize()</span>
<span class="linenos">2039</span>
<span class="linenos">2040</span>        <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">plan_fw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plan_bw</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># don&#39;t plan a huge NUFFT</span>
<span class="linenos">2041</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos">2042</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_fail_on_small_problems</span><span class="p">()</span>
<span class="linenos">2043</span>
<span class="linenos">2044</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># extra FINUFFT planning args</span>
<span class="linenos">2045</span>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]:</span>
<span class="linenos">2046</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">2047</span>
<span class="linenos">2048</span>        <span class="c1"># variables set by allocate()</span>
<span class="linenos">2049</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos">2050</span>        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span>
<span class="linenos">2051</span>            <span class="s2">&quot;_plan_lock&quot;</span><span class="p">,</span>  <span class="c1"># FFTW planner lock; see _transform() for details</span>
<span class="linenos">2052</span>            <span class="s2">&quot;_up&quot;</span><span class="p">,</span>  <span class="c1"># up-sample ops</span>
<span class="linenos">2053</span>            <span class="s2">&quot;_down&quot;</span><span class="p">,</span>  <span class="c1"># down-sample ops</span>
<span class="linenos">2054</span>            <span class="s2">&quot;_dEval_threshold&quot;</span><span class="p">,</span>  <span class="c1"># direct-evaluation threshold</span>
<span class="linenos">2055</span>            <span class="s2">&quot;_x_reorder&quot;</span><span class="p">,</span>  <span class="c1"># .apply() input re-order op</span>
<span class="linenos">2056</span>            <span class="s2">&quot;_x_chunk&quot;</span><span class="p">,</span>  <span class="c1"># X-domain chunk slice-selectors</span>
<span class="linenos">2057</span>            <span class="s2">&quot;_z_reorder&quot;</span><span class="p">,</span>  <span class="c1"># .adjoint() input re-order op</span>
<span class="linenos">2058</span>            <span class="s2">&quot;_z_chunk&quot;</span><span class="p">,</span>  <span class="c1"># Z-domain chunk slice-selectors</span>
<span class="linenos">2059</span>        <span class="p">]:</span>
<span class="linenos">2060</span>            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos">2061</span>
<span class="linenos">2062</span>    <span class="nd">@_parallelize</span>
<span class="linenos">2063</span>    <span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">(</span><span class="s2">&quot;arr&quot;</span><span class="p">)</span>
<span class="linenos">2064</span>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos">2065</span>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span>
<span class="linenos">2066</span>        <span class="n">arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_reorder</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="linenos">2067</span>
<span class="linenos">2068</span>        <span class="n">outer</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">2069</span>        <span class="n">nufft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_transform</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="linenos">2070</span>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">up</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_up</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="linenos">2071</span>            <span class="n">inner</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">2072</span>            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">down</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_down</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="linenos">2073</span>                <span class="n">x</span> <span class="o">=</span> <span class="n">down</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="linenos">2074</span>                <span class="n">y</span> <span class="o">=</span> <span class="n">_array_ize</span><span class="p">(</span>
<span class="linenos">2075</span>                    <span class="n">data</span><span class="o">=</span><span class="n">nufft</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="s2">&quot;fw&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span>
<span class="linenos">2076</span>                    <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="o">*</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">up</span><span class="o">.</span><span class="n">dim</span><span class="p">),</span>
<span class="linenos">2077</span>                    <span class="n">dtype</span><span class="o">=</span><span class="n">arr</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
<span class="linenos">2078</span>                <span class="p">)</span>
<span class="linenos">2079</span>                <span class="n">inner</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="linenos">2080</span>            <span class="n">inner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tree_sum</span><span class="p">(</span><span class="n">inner</span><span class="p">)</span>
<span class="linenos">2081</span>            <span class="n">z</span> <span class="o">=</span> <span class="n">up</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">inner</span><span class="p">)</span>
<span class="linenos">2082</span>            <span class="n">outer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
<span class="linenos">2083</span>        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tree_sum</span><span class="p">(</span><span class="n">outer</span><span class="p">)</span>
<span class="linenos">2084</span>
<span class="linenos">2085</span>        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_reorder</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="linenos">2086</span>        <span class="k">return</span> <span class="n">out</span>
<span class="linenos">2087</span>
<span class="linenos">2088</span>    <span class="nd">@_parallelize</span>
<span class="linenos">2089</span>    <span class="nd">@pxrt</span><span class="o">.</span><span class="n">enforce_precision</span><span class="p">(</span><span class="s2">&quot;arr&quot;</span><span class="p">)</span>
<span class="linenos">2090</span>    <span class="k">def</span> <span class="nf">adjoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos">2091</span>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span>
<span class="linenos">2092</span>        <span class="n">arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_reorder</span><span class="o">.</span><span class="n">adjoint</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="linenos">2093</span>
<span class="linenos">2094</span>        <span class="n">outer</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">2095</span>        <span class="n">nufft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_transform</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="linenos">2096</span>        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">down</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_down</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="linenos">2097</span>            <span class="n">inner</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">2098</span>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">up</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_up</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="linenos">2099</span>                <span class="n">z</span> <span class="o">=</span> <span class="n">up</span><span class="o">.</span><span class="n">adjoint</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="linenos">2100</span>                <span class="n">y</span> <span class="o">=</span> <span class="n">_array_ize</span><span class="p">(</span>
<span class="linenos">2101</span>                    <span class="n">data</span><span class="o">=</span><span class="n">nufft</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="s2">&quot;bw&quot;</span><span class="p">,</span> <span class="n">z</span><span class="p">),</span>
<span class="linenos">2102</span>                    <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="o">*</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">down</span><span class="o">.</span><span class="n">codim</span><span class="p">),</span>
<span class="linenos">2103</span>                    <span class="n">dtype</span><span class="o">=</span><span class="n">arr</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
<span class="linenos">2104</span>                <span class="p">)</span>
<span class="linenos">2105</span>                <span class="n">inner</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="linenos">2106</span>            <span class="n">inner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tree_sum</span><span class="p">(</span><span class="n">inner</span><span class="p">)</span>
<span class="linenos">2107</span>            <span class="n">x</span> <span class="o">=</span> <span class="n">down</span><span class="o">.</span><span class="n">adjoint</span><span class="p">(</span><span class="n">inner</span><span class="p">)</span>
<span class="linenos">2108</span>            <span class="n">outer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="linenos">2109</span>        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tree_sum</span><span class="p">(</span><span class="n">outer</span><span class="p">)</span>
<span class="linenos">2110</span>
<span class="linenos">2111</span>        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_reorder</span><span class="o">.</span><span class="n">adjoint</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="linenos">2112</span>        <span class="k">return</span> <span class="n">out</span>
<span class="linenos">2113</span>
<span class="linenos">2114</span>    <span class="k">def</span> <span class="nf">_get_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cabc</span><span class="o">.</span><span class="n">Callable</span><span class="p">:</span>
<span class="linenos">2115</span>        <span class="n">NDI</span> <span class="o">=</span> <span class="n">pxd</span><span class="o">.</span><span class="n">NDArrayInfo</span>
<span class="linenos">2116</span>        <span class="n">dask_input</span> <span class="o">=</span> <span class="n">NDI</span><span class="o">.</span><span class="n">from_obj</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="o">==</span> <span class="n">NDI</span><span class="o">.</span><span class="n">DASK</span>
<span class="linenos">2117</span>
<span class="linenos">2118</span>        <span class="k">if</span> <span class="n">dask_input</span><span class="p">:</span>
<span class="linenos">2119</span>            <span class="n">func</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span>
<span class="linenos">2120</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_transform</span><span class="p">,</span>
<span class="linenos">2121</span>                <span class="n">pure</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="linenos">2122</span>                <span class="n">traverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos">2123</span>            <span class="p">)</span>
<span class="linenos">2124</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">2125</span>            <span class="n">func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform</span>
<span class="linenos">2126</span>        <span class="k">return</span> <span class="n">func</span>
<span class="linenos">2127</span>
<span class="linenos">2128</span>    <span class="k">def</span> <span class="nf">_transform</span><span class="p">(</span>
<span class="linenos">2129</span>        <span class="bp">self</span><span class="p">,</span>
<span class="linenos">2130</span>        <span class="n">x_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<span class="linenos">2131</span>        <span class="n">z_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<span class="linenos">2132</span>        <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="linenos">2133</span>        <span class="n">arr</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">,</span>
<span class="linenos">2134</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos">2135</span>        <span class="c1"># Internal method for apply/adjoint.</span>
<span class="linenos">2136</span>        <span class="c1">#</span>
<span class="linenos">2137</span>        <span class="c1"># Parameters</span>
<span class="linenos">2138</span>        <span class="c1"># ----------</span>
<span class="linenos">2139</span>        <span class="c1"># x_idx: int</span>
<span class="linenos">2140</span>        <span class="c1">#     Index into _x_chunk.</span>
<span class="linenos">2141</span>        <span class="c1">#     Identifies the X-region participating in the transform.</span>
<span class="linenos">2142</span>        <span class="c1"># z_idx: int</span>
<span class="linenos">2143</span>        <span class="c1">#     Index into _z_chunk.</span>
<span class="linenos">2144</span>        <span class="c1">#     Identifies the Z-region participating in the transform.</span>
<span class="linenos">2145</span>        <span class="c1"># mode: str</span>
<span class="linenos">2146</span>        <span class="c1">#     Transform direction:</span>
<span class="linenos">2147</span>        <span class="c1">#</span>
<span class="linenos">2148</span>        <span class="c1">#     * &#39;fw&#39;: _NUFFT3.apply</span>
<span class="linenos">2149</span>        <span class="c1">#     * &#39;bw&#39;: _NUFFT3.adjoint</span>
<span class="linenos">2150</span>        <span class="c1"># arr: pxt.NDArray</span>
<span class="linenos">2151</span>        <span class="c1">#     (...,) array fed to apply/adjoint().</span>
<span class="linenos">2152</span>        <span class="c1">#</span>
<span class="linenos">2153</span>        <span class="c1"># Returns</span>
<span class="linenos">2154</span>        <span class="c1"># -------</span>
<span class="linenos">2155</span>        <span class="c1"># out: pxt.NDArray</span>
<span class="linenos">2156</span>        <span class="c1">#     (...,) output of _NUFFT3.[apply|adjoint](arr)</span>
<span class="linenos">2157</span>        <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="linenos">2158</span>
<span class="linenos">2159</span>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_x_chunk</span><span class="p">[</span><span class="n">x_idx</span><span class="p">]]</span>
<span class="linenos">2160</span>        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_z_chunk</span><span class="p">[</span><span class="n">z_idx</span><span class="p">]]</span>
<span class="linenos">2161</span>        <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">)</span>
<span class="linenos">2162</span>
<span class="linenos">2163</span>        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;fw&quot;</span><span class="p">:</span>
<span class="linenos">2164</span>            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">plan_fw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plan_bw</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos">2165</span>            <span class="n">func</span> <span class="o">=</span> <span class="s2">&quot;apply&quot;</span>
<span class="linenos">2166</span>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># bw</span>
<span class="linenos">2167</span>            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">plan_fw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plan_bw</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">2168</span>            <span class="n">func</span> <span class="o">=</span> <span class="s2">&quot;adjoint&quot;</span>
<span class="linenos">2169</span>
<span class="linenos">2170</span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dEval_threshold</span><span class="p">:</span>
<span class="linenos">2171</span>            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">eps</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">2172</span>
<span class="linenos">2173</span>        <span class="c1"># NUFFT.apply/adjoint() requires inputs to be C-contiguous.</span>
<span class="linenos">2174</span>        <span class="c1"># This is not guaranteed in chunked context given chain of operations preceding</span>
<span class="linenos">2175</span>        <span class="c1"># apply/adjoint().</span>
<span class="linenos">2176</span>        <span class="c1"># Chunks are small however, so the overhead is minimal.</span>
<span class="linenos">2177</span>        <span class="n">xp</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">get_array_module</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="linenos">2178</span>        <span class="n">arr</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">requirements</span><span class="o">=</span><span class="s2">&quot;C&quot;</span><span class="p">)</span>
<span class="linenos">2179</span>
<span class="linenos">2180</span>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plan_lock</span><span class="p">:</span>
<span class="linenos">2181</span>            <span class="c1"># FINUFFT uses FFTW to compute FFTs.</span>
<span class="linenos">2182</span>            <span class="c1"># FFTW&#39;s planner is not thread-safe. [http://www.fftw.org/fftw3_doc/Thread-safety.html]</span>
<span class="linenos">2183</span>            <span class="c1"># Not coordinating the planning stage with other workers/tasks leads to segmentation faults.</span>
<span class="linenos">2184</span>            <span class="n">op</span> <span class="o">=</span> <span class="n">NUFFT</span><span class="o">.</span><span class="n">type3</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos">2185</span>
<span class="linenos">2186</span>        <span class="c1"># The complexity of _NUFFT3.[apply|adjoint]() is</span>
<span class="linenos">2187</span>        <span class="c1">#     N_F \ln N_F   +   (N_x + N_z) w^d</span>
<span class="linenos">2188</span>        <span class="c1">#        N_F = FFT size</span>
<span class="linenos">2189</span>        <span class="c1">#        N_x = # x-domain points</span>
<span class="linenos">2190</span>        <span class="c1">#        N_z = # z-domain points</span>
<span class="linenos">2191</span>        <span class="c1">#        w = spread/interpolation kernel size</span>
<span class="linenos">2192</span>        <span class="c1">#</span>
<span class="linenos">2193</span>        <span class="c1">#</span>
<span class="linenos">2194</span>        <span class="c1"># The complexity of _NUFFT3_chunked.[apply|adjoint]() is</span>
<span class="linenos">2195</span>        <span class="c1"># (1) \sum_{i,j} N_F_ij \ln N_F_ij   +   N_z_blk N_x w^d   +   N_x_blk N_z w^d,</span>
<span class="linenos">2196</span>        <span class="c1">#         N_F_ij = FFT size in (i,j)-th sub-problem</span>
<span class="linenos">2197</span>        <span class="c1">#         N_x_blk = # x-domain chunks</span>
<span class="linenos">2198</span>        <span class="c1">#         N_z_blk = # z-domain chunks</span>
<span class="linenos">2199</span>        <span class="c1"># Assuming N_x_blk ~= N_z_blk, the term above simplifies to</span>
<span class="linenos">2200</span>        <span class="c1">#     \sum_{i,j} N_F_ij \ln N_F_ij   +   (N_x w^d + N_z w^d) \sqrt(N_x_blk * N_z_blk),</span>
<span class="linenos">2201</span>        <span class="c1"># i.e. the spread/interpolation cost grows proportional to \sqrt{# sub-problems}</span>
<span class="linenos">2202</span>        <span class="c1">#</span>
<span class="linenos">2203</span>        <span class="c1">#</span>
<span class="linenos">2204</span>        <span class="c1"># It is possible to share the spread/interpolation costs amongst sub-problems so as to bring</span>
<span class="linenos">2205</span>        <span class="c1"># the complexity of _NUFFT3_chunked.[apply|adjoint]() down to</span>
<span class="linenos">2206</span>        <span class="c1"># (2) (N_x_blk * N_z_blk) * N_F \ln N_F   +   (N_x + N_z) w^d.</span>
<span class="linenos">2207</span>        <span class="c1">#</span>
<span class="linenos">2208</span>        <span class="c1"># The philosophies of computing via (1) and (2) differ:</span>
<span class="linenos">2209</span>        <span class="c1">#   (1) optimal FFT-size per sub-problem + \sqrt{N_xz_blk} spread/interpolation overhead</span>
<span class="linenos">2210</span>        <span class="c1">#   (2) largest FFT-size per sub-problem + no spread/interpolation overhead w.r.t. _NUFFT3.[apply|adjoint]()</span>
<span class="linenos">2211</span>        <span class="n">out</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">func</span><span class="p">)(</span><span class="n">arr</span><span class="p">)</span>
<span class="linenos">2212</span>        <span class="k">return</span> <span class="n">out</span>
<span class="linenos">2213</span>
<span class="linenos">2214</span>    <span class="k">def</span> <span class="nf">auto_chunk</span><span class="p">(</span>
<span class="linenos">2215</span>        <span class="bp">self</span><span class="p">,</span>
<span class="linenos">2216</span>        <span class="n">max_mem</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Real</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
<span class="linenos">2217</span>        <span class="n">max_anisotropy</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Real</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
<span class="linenos">2218</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">]]:</span>
<span class="linenos">2219</span>        <span class="n">max_mem</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">max_mem</span><span class="p">)</span>
<span class="linenos">2220</span>        <span class="k">assert</span> <span class="n">max_mem</span> <span class="o">&gt;</span> <span class="mi">0</span>
<span class="linenos">2221</span>        <span class="n">max_mem</span> <span class="o">*=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">20</span>  <span class="c1"># MiB -&gt; B</span>
<span class="linenos">2222</span>
<span class="linenos">2223</span>        <span class="n">max_anisotropy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">max_anisotropy</span><span class="p">)</span>
<span class="linenos">2224</span>        <span class="k">assert</span> <span class="n">max_anisotropy</span> <span class="o">&gt;=</span> <span class="mi">1</span>
<span class="linenos">2225</span>
<span class="linenos">2226</span>        <span class="n">T</span><span class="p">,</span> <span class="n">B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_box_dimensions</span><span class="p">(</span><span class="n">max_mem</span><span class="p">,</span> <span class="n">max_anisotropy</span><span class="p">)</span>
<span class="linenos">2227</span>        <span class="n">x_chunks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tesselate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
<span class="linenos">2228</span>        <span class="n">z_chunks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tesselate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span>
<span class="linenos">2229</span>        <span class="k">return</span> <span class="n">x_chunks</span><span class="p">,</span> <span class="n">z_chunks</span>
<span class="linenos">2230</span>
<span class="linenos">2231</span>    <span class="k">def</span> <span class="nf">allocate</span><span class="p">(</span>
<span class="linenos">2232</span>        <span class="bp">self</span><span class="p">,</span>
<span class="linenos">2233</span>        <span class="n">x_chunks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">typ</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">,</span> <span class="nb">slice</span><span class="p">]],</span>
<span class="linenos">2234</span>        <span class="n">z_chunks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">typ</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">,</span> <span class="nb">slice</span><span class="p">]],</span>
<span class="linenos">2235</span>        <span class="n">direct_eval_threshold</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">Integer</span> <span class="o">=</span> <span class="mi">10_000</span><span class="p">,</span>
<span class="linenos">2236</span>    <span class="p">):</span>
<span class="linenos">2237</span>        <span class="k">def</span> <span class="nf">_to_slice</span><span class="p">(</span><span class="n">idx_spec</span><span class="p">):</span>
<span class="linenos">2238</span>            <span class="n">out</span> <span class="o">=</span> <span class="n">idx_spec</span>
<span class="linenos">2239</span>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">idx_spec</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
<span class="linenos">2240</span>                <span class="n">lb</span> <span class="o">=</span> <span class="n">idx_spec</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
<span class="linenos">2241</span>                <span class="n">ub</span> <span class="o">=</span> <span class="n">idx_spec</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="linenos">2242</span>                <span class="k">if</span> <span class="n">ub</span> <span class="o">-</span> <span class="n">lb</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx_spec</span><span class="p">):</span>
<span class="linenos">2243</span>                    <span class="n">out</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">ub</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">2244</span>            <span class="k">return</span> <span class="n">out</span>
<span class="linenos">2245</span>
<span class="linenos">2246</span>        <span class="k">def</span> <span class="nf">_preprocess</span><span class="p">(</span><span class="n">chunks</span><span class="p">,</span> <span class="n">var</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="linenos">2247</span>            <span class="c1"># Analyze chunk specifiers and return:</span>
<span class="linenos">2248</span>            <span class="c1">#   * input re-ordering coordinates (if applicable)</span>
<span class="linenos">2249</span>            <span class="c1">#   * slice() objects identifying each sub-chunk data</span>
<span class="linenos">2250</span>            <span class="n">chunks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">_to_slice</span><span class="p">,</span> <span class="n">chunks</span><span class="p">))</span>
<span class="linenos">2251</span>            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">chk</span><span class="p">,</span> <span class="nb">slice</span><span class="p">)</span> <span class="k">for</span> <span class="n">chk</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">):</span>
<span class="linenos">2252</span>                <span class="c1"># No re-ordering required: up/sub-sampling operators can slice-select themselves.</span>
<span class="linenos">2253</span>                <span class="n">reorder_spec</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">chk</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="n">chk</span><span class="o">.</span><span class="n">start</span> <span class="k">for</span> <span class="n">chk</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">))</span>
<span class="linenos">2254</span>                <span class="n">chunk_spec</span> <span class="o">=</span> <span class="n">chunks</span>
<span class="linenos">2255</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">2256</span>                <span class="c1"># Some chunks cannot be slice-indexed. To avoid expensive x/z copies when</span>
<span class="linenos">2257</span>                <span class="c1"># initializing NUFFT sub-problems, x/z will be re-ordered before/after</span>
<span class="linenos">2258</span>                <span class="c1"># down/up-sampling operators.</span>
<span class="linenos">2259</span>                <span class="n">reorder_spec</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">2260</span>                <span class="k">for</span> <span class="n">chk</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">:</span>
<span class="linenos">2261</span>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chk</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
<span class="linenos">2262</span>                        <span class="n">_chk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">chk</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">chk</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
<span class="linenos">2263</span>                    <span class="k">else</span><span class="p">:</span>
<span class="linenos">2264</span>                        <span class="n">_chk</span> <span class="o">=</span> <span class="n">chk</span>
<span class="linenos">2265</span>                    <span class="n">reorder_spec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_chk</span><span class="p">)</span>
<span class="linenos">2266</span>                <span class="n">reorder_spec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">reorder_spec</span><span class="p">)</span>
<span class="linenos">2267</span>
<span class="linenos">2268</span>                <span class="n">chunk_spec</span><span class="p">,</span> <span class="n">start</span> <span class="o">=</span> <span class="p">[],</span> <span class="mi">0</span>
<span class="linenos">2269</span>                <span class="k">for</span> <span class="n">chk</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">:</span>
<span class="linenos">2270</span>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chk</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
<span class="linenos">2271</span>                        <span class="n">_len</span> <span class="o">=</span> <span class="n">chk</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="n">chk</span><span class="o">.</span><span class="n">start</span>
<span class="linenos">2272</span>                    <span class="k">else</span><span class="p">:</span>
<span class="linenos">2273</span>                        <span class="n">_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chk</span><span class="p">)</span>
<span class="linenos">2274</span>                    <span class="n">s</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">_len</span><span class="p">)</span>
<span class="linenos">2275</span>                    <span class="n">start</span> <span class="o">+=</span> <span class="n">_len</span>
<span class="linenos">2276</span>                    <span class="n">chunk_spec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="linenos">2277</span>
<span class="linenos">2278</span>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enable_warnings</span><span class="p">:</span>
<span class="linenos">2279</span>                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
<span class="linenos">2280</span>                        <span class="p">[</span>
<span class="linenos">2281</span>                            <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">&#39; order is sub-optimal given provided chunk specifiers.&quot;</span><span class="p">,</span>
<span class="linenos">2282</span>                            <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">&#39; will be re-ordered internally to improve NUFFT performance.&quot;</span><span class="p">,</span>
<span class="linenos">2283</span>                            <span class="s2">&quot;The cost of re-ordering apply/adjoint inputs is significant when the number of non-uniform points x/z is large.&quot;</span><span class="p">,</span>
<span class="linenos">2284</span>                            <span class="sa">f</span><span class="s2">&quot;It is recommended to re-initialize </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="si">}</span><span class="s2"> where x/z [and apply/adjoint() inputs] are re-ordered.&quot;</span><span class="p">,</span>
<span class="linenos">2285</span>                            <span class="sa">f</span><span class="s2">&quot;See notes/examples provided in docstring of </span><span class="si">{</span><span class="n">NUFFT</span><span class="o">.</span><span class="n">type3</span><span class="o">.</span><span class="vm">__qualname__</span><span class="si">}</span><span class="s2">() for how to achieve this.&quot;</span><span class="p">,</span>
<span class="linenos">2286</span>                        <span class="p">]</span>
<span class="linenos">2287</span>                    <span class="p">)</span>
<span class="linenos">2288</span>                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">pxw</span><span class="o">.</span><span class="n">PerformanceWarning</span><span class="p">)</span>
<span class="linenos">2289</span>            <span class="k">return</span> <span class="n">reorder_spec</span><span class="p">,</span> <span class="n">chunk_spec</span>
<span class="linenos">2290</span>
<span class="linenos">2291</span>        <span class="k">def</span> <span class="nf">_r2c</span><span class="p">(</span><span class="n">idx_spec</span><span class="p">):</span>
<span class="linenos">2292</span>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">idx_spec</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
<span class="linenos">2293</span>                <span class="n">idx</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">idx_spec</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">idx_spec</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
<span class="linenos">2294</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">2295</span>                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="mi">2</span> <span class="o">*</span> <span class="n">idx_spec</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">idx_spec</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">2296</span>            <span class="k">return</span> <span class="n">idx</span>
<span class="linenos">2297</span>
<span class="linenos">2298</span>        <span class="n">x_idx</span><span class="p">,</span> <span class="n">x_chunks</span> <span class="o">=</span> <span class="n">_preprocess</span><span class="p">(</span><span class="n">x_chunks</span><span class="p">,</span> <span class="n">var</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
<span class="linenos">2299</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">[</span><span class="n">x_idx</span><span class="p">]</span>
<span class="linenos">2300</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_x_reorder</span> <span class="o">=</span> <span class="n">pxs</span><span class="o">.</span><span class="n">SubSample</span><span class="p">(</span>  <span class="c1"># Permutation</span>
<span class="linenos">2301</span>            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">,),</span>
<span class="linenos">2302</span>            <span class="n">x_idx</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_real</span> <span class="k">else</span> <span class="n">_r2c</span><span class="p">(</span><span class="n">x_idx</span><span class="p">),</span>
<span class="linenos">2303</span>        <span class="p">)</span>
<span class="linenos">2304</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_x_chunk</span> <span class="o">=</span> <span class="n">x_chunks</span>
<span class="linenos">2305</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_down</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos">2306</span>            <span class="n">j</span><span class="p">:</span> <span class="n">pxs</span><span class="o">.</span><span class="n">SubSample</span><span class="p">(</span>
<span class="linenos">2307</span>                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">,),</span>
<span class="linenos">2308</span>                <span class="n">x_idx</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_real</span> <span class="k">else</span> <span class="n">_r2c</span><span class="p">(</span><span class="n">x_idx</span><span class="p">),</span>
<span class="linenos">2309</span>            <span class="p">)</span>
<span class="linenos">2310</span>            <span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">x_idx</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x_chunks</span><span class="p">)</span>
<span class="linenos">2311</span>        <span class="p">}</span>
<span class="linenos">2312</span>
<span class="linenos">2313</span>        <span class="n">z_idx</span><span class="p">,</span> <span class="n">z_chunks</span> <span class="o">=</span> <span class="n">_preprocess</span><span class="p">(</span><span class="n">z_chunks</span><span class="p">,</span> <span class="n">var</span><span class="o">=</span><span class="s2">&quot;z&quot;</span><span class="p">)</span>
<span class="linenos">2314</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">[</span><span class="n">z_idx</span><span class="p">]</span>
<span class="linenos">2315</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_z_reorder</span> <span class="o">=</span> <span class="n">pxs</span><span class="o">.</span><span class="n">SubSample</span><span class="p">(</span>
<span class="linenos">2316</span>            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">codim</span><span class="p">,),</span>
<span class="linenos">2317</span>            <span class="n">_r2c</span><span class="p">(</span><span class="n">z_idx</span><span class="p">),</span>
<span class="linenos">2318</span>        <span class="p">)</span><span class="o">.</span><span class="n">T</span>
<span class="linenos">2319</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_z_chunk</span> <span class="o">=</span> <span class="n">z_chunks</span>
<span class="linenos">2320</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_up</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos">2321</span>            <span class="n">i</span><span class="p">:</span> <span class="n">pxs</span><span class="o">.</span><span class="n">SubSample</span><span class="p">(</span>
<span class="linenos">2322</span>                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">codim</span><span class="p">,),</span>
<span class="linenos">2323</span>                <span class="n">_r2c</span><span class="p">(</span><span class="n">z_idx</span><span class="p">),</span>
<span class="linenos">2324</span>            <span class="p">)</span><span class="o">.</span><span class="n">T</span>
<span class="linenos">2325</span>            <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">z_idx</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">z_chunks</span><span class="p">)</span>
<span class="linenos">2326</span>        <span class="p">}</span>
<span class="linenos">2327</span>
<span class="linenos">2328</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_plan_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
<span class="linenos">2329</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_dEval_threshold</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">direct_eval_threshold</span><span class="p">)</span>
<span class="linenos">2330</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">2331</span>
<span class="linenos">2332</span>    <span class="k">def</span> <span class="nf">stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">:</span>
<span class="linenos">2333</span>        <span class="n">BLOCK_STATS</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span>
<span class="linenos">2334</span>            <span class="s2">&quot;block_stats&quot;</span><span class="p">,</span>
<span class="linenos">2335</span>            <span class="p">[</span>
<span class="linenos">2336</span>                <span class="s2">&quot;blk_count&quot;</span><span class="p">,</span>
<span class="linenos">2337</span>                <span class="s2">&quot;dEval_count&quot;</span><span class="p">,</span>
<span class="linenos">2338</span>            <span class="p">],</span>
<span class="linenos">2339</span>        <span class="p">)</span>
<span class="linenos">2340</span>
<span class="linenos">2341</span>        <span class="n">N_up</span> <span class="o">=</span> <span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">dim</span> <span class="o">//</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_up</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
<span class="linenos">2342</span>        <span class="n">N_down</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">codim</span> <span class="o">//</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_real</span> <span class="k">else</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_down</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
<span class="linenos">2343</span>        <span class="n">blk_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">N_up</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">N_down</span><span class="p">)</span>
<span class="linenos">2344</span>        <span class="n">dEval</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">N_up</span><span class="p">,</span> <span class="n">N_down</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">d</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dEval_threshold</span><span class="p">)</span>
<span class="linenos">2345</span>
<span class="linenos">2346</span>        <span class="n">p</span> <span class="o">=</span> <span class="n">BLOCK_STATS</span><span class="p">(</span><span class="n">blk_count</span><span class="o">=</span><span class="n">blk_count</span><span class="p">,</span> <span class="n">dEval_count</span><span class="o">=</span><span class="n">dEval</span><span class="p">)</span>
<span class="linenos">2347</span>        <span class="k">return</span> <span class="n">p</span>
<span class="linenos">2348</span>
<span class="linenos">2349</span>    <span class="k">def</span> <span class="nf">ascomplexarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="linenos">2350</span>        <span class="n">cA</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">ascomplexarray</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos">2351</span>        <span class="n">rA</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">view_as_real_mat</span><span class="p">(</span><span class="n">cA</span><span class="p">,</span> <span class="n">real_input</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_real</span><span class="p">)</span>
<span class="linenos">2352</span>        <span class="k">with</span> <span class="n">pxrt</span><span class="o">.</span><span class="n">Precision</span><span class="p">(</span><span class="n">pxrt</span><span class="o">.</span><span class="n">Width</span><span class="p">(</span><span class="n">rA</span><span class="o">.</span><span class="n">dtype</span><span class="p">)):</span>
<span class="linenos">2353</span>            <span class="n">rA</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_reorder</span><span class="o">.</span><span class="n">adjoint</span><span class="p">(</span><span class="n">rA</span><span class="p">)</span>  <span class="c1"># re-order rows</span>
<span class="linenos">2354</span>            <span class="n">rA</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_reorder</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">rA</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># re-order columns</span>
<span class="linenos">2355</span>        <span class="n">cA</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">view_as_complex_mat</span><span class="p">(</span><span class="n">rA</span><span class="p">,</span> <span class="n">real_input</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_real</span><span class="p">)</span>
<span class="linenos">2356</span>        <span class="k">return</span> <span class="n">cA</span>
<span class="linenos">2357</span>
<span class="linenos">2358</span>    <span class="k">def</span> <span class="nf">order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="linenos">2359</span>        <span class="n">var</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<span class="linenos">2360</span>        <span class="k">assert</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">)</span>
<span class="linenos">2361</span>
<span class="linenos">2362</span>        <span class="k">def</span> <span class="nf">_c2r</span><span class="p">(</span><span class="n">idx_spec</span><span class="p">):</span>
<span class="linenos">2363</span>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">idx_spec</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
<span class="linenos">2364</span>                <span class="n">idx</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">idx_spec</span><span class="o">.</span><span class="n">start</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">idx_spec</span><span class="o">.</span><span class="n">stop</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">2365</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">2366</span>                <span class="n">idx</span> <span class="o">=</span> <span class="n">idx_spec</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
<span class="linenos">2367</span>            <span class="k">return</span> <span class="n">idx</span>
<span class="linenos">2368</span>
<span class="linenos">2369</span>        <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span>
<span class="linenos">2370</span>            <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_reorder</span><span class="o">.</span><span class="n">_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">2371</span>            <span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_real</span> <span class="k">else</span> <span class="n">_c2r</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
<span class="linenos">2372</span>            <span class="n">chunks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_chunk</span>
<span class="linenos">2373</span>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># &quot;z&quot;</span>
<span class="linenos">2374</span>            <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_reorder</span><span class="o">.</span><span class="n">_op</span><span class="o">.</span><span class="n">_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># _z_reorder = SubSampleOp.T</span>
<span class="linenos">2375</span>            <span class="n">idx</span> <span class="o">=</span> <span class="n">_c2r</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
<span class="linenos">2376</span>            <span class="n">chunks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_chunk</span>
<span class="linenos">2377</span>
<span class="linenos">2378</span>        <span class="k">return</span> <span class="n">idx</span><span class="p">,</span> <span class="n">chunks</span>
<span class="linenos">2379</span>
<span class="linenos">2380</span>    <span class="k">def</span> <span class="nf">_disable_unsupported_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">2381</span>        <span class="c1"># Despite being a child-class of _NUFFT3, some methods are not supported because they don&#39;t</span>
<span class="linenos">2382</span>        <span class="c1"># make sense in the chunked context.</span>
<span class="linenos">2383</span>        <span class="c1"># This method overrides problematic methods to avoid erroneous use.</span>
<span class="linenos">2384</span>        <span class="k">def</span> <span class="nf">unsupported</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="linenos">2385</span>            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
<span class="linenos">2386</span>
<span class="linenos">2387</span>        <span class="n">unsupported_fields</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos">2388</span>            <span class="s2">&quot;mesh&quot;</span><span class="p">,</span>
<span class="linenos">2389</span>            <span class="s2">&quot;plot_kernel&quot;</span><span class="p">,</span>
<span class="linenos">2390</span>        <span class="p">]</span>
<span class="linenos">2391</span>        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">unsupported_fields</span><span class="p">:</span>
<span class="linenos">2392</span>            <span class="n">override</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">(</span><span class="n">unsupported</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
<span class="linenos">2393</span>            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">override</span><span class="p">)</span>
<span class="linenos">2394</span>
<span class="linenos">2395</span>    <span class="k">def</span> <span class="nf">_fail_on_small_problems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">2396</span>        <span class="n">cst</span> <span class="o">=</span> <span class="mi">10</span>
<span class="linenos">2397</span>        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">cst</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">cst</span><span class="p">):</span>
<span class="linenos">2398</span>            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
<span class="linenos">2399</span>                <span class="p">[</span>
<span class="linenos">2400</span>                    <span class="s2">&quot;A chunked-NUFFT3 is sub-optimal for very small problems:&quot;</span><span class="p">,</span>
<span class="linenos">2401</span>                    <span class="s2">&quot;instantiate instead via `NUFFT.type3(x,z,eps=0)`.&quot;</span><span class="p">,</span>
<span class="linenos">2402</span>                <span class="p">]</span>
<span class="linenos">2403</span>            <span class="p">)</span>
<span class="linenos">2404</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="linenos">2405</span>
<span class="linenos">2406</span>    <span class="nd">@classmethod</span>
<span class="linenos">2407</span>    <span class="k">def</span> <span class="nf">_tree_sum</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">cabc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">):</span>
<span class="linenos">2408</span>        <span class="c1"># computes (data[0] + ... + data[N-1]) via a binary tree reduction.</span>
<span class="linenos">2409</span>        <span class="k">if</span> <span class="p">(</span><span class="n">N</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">2410</span>            <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">2411</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">2412</span>            <span class="n">compressed</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)]</span>
<span class="linenos">2413</span>            <span class="k">if</span> <span class="n">N</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">2414</span>                <span class="n">compressed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="linenos">2415</span>            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_tree_sum</span><span class="p">(</span><span class="n">compressed</span><span class="p">)</span>
<span class="linenos">2416</span>
<span class="linenos">2417</span>    <span class="k">def</span> <span class="nf">_box_dimensions</span><span class="p">(</span>
<span class="linenos">2418</span>        <span class="bp">self</span><span class="p">,</span>
<span class="linenos">2419</span>        <span class="n">fft_bytes</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<span class="linenos">2420</span>        <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<span class="linenos">2421</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">pxt</span><span class="o">.</span><span class="n">Real</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pxt</span><span class="o">.</span><span class="n">Real</span><span class="p">]]:</span>
<span class="linenos">2422</span><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">2423</span><span class="sd">        Find X box dimensions (T_1,...,T_D) and Z box dimensions (B_1,...,B_D) such that:</span>
<span class="linenos">2424</span>
<span class="linenos">2425</span><span class="sd">        * number of NUFFT sub-problems is minimized;</span>
<span class="linenos">2426</span><span class="sd">        * NUFFT sub-problems limited to user-specified memory budget;</span>
<span class="linenos">2427</span><span class="sd">        * box dimensions are not too rectangular, i.e. anisotropic.</span>
<span class="linenos">2428</span>
<span class="linenos">2429</span><span class="sd">        Parameters</span>
<span class="linenos">2430</span><span class="sd">        ----------</span>
<span class="linenos">2431</span><span class="sd">        fft_bytes: pxt.Real</span>
<span class="linenos">2432</span><span class="sd">            Max FFT memory (B) allowed per sub-block.</span>
<span class="linenos">2433</span><span class="sd">        alpha: pxt.Real</span>
<span class="linenos">2434</span><span class="sd">            Max tolerated (normalized) anisotropy ratio &gt;= 1.</span>
<span class="linenos">2435</span>
<span class="linenos">2436</span><span class="sd">        Returns</span>
<span class="linenos">2437</span><span class="sd">        -------</span>
<span class="linenos">2438</span><span class="sd">        T: tuple[float]</span>
<span class="linenos">2439</span><span class="sd">            X-box dimensions.</span>
<span class="linenos">2440</span><span class="sd">        B: tuple[float]</span>
<span class="linenos">2441</span><span class="sd">            Z-box dimensions.</span>
<span class="linenos">2442</span>
<span class="linenos">2443</span><span class="sd">        Notes</span>
<span class="linenos">2444</span><span class="sd">        -----</span>
<span class="linenos">2445</span><span class="sd">        Given that</span>
<span class="linenos">2446</span>
<span class="linenos">2447</span><span class="sd">            FFT_memory / (element_itemsize * N_transform)</span>
<span class="linenos">2448</span><span class="sd">            \approx</span>
<span class="linenos">2449</span><span class="sd">            \prod_{k=1..D} (\sigma_k T_k B_k) / (2 \pi),</span>
<span class="linenos">2450</span>
<span class="linenos">2451</span><span class="sd">        we can solve an optimization problem to find the optimal (T_k, B_k) values.</span>
<span class="linenos">2452</span>
<span class="linenos">2453</span>
<span class="linenos">2454</span><span class="sd">        Mathematical Formulation</span>
<span class="linenos">2455</span><span class="sd">        ------------------------</span>
<span class="linenos">2456</span>
<span class="linenos">2457</span><span class="sd">        User input:</span>
<span class="linenos">2458</span><span class="sd">            1. FFT_memory: max memory budget per sub-problem</span>
<span class="linenos">2459</span><span class="sd">            2. alpha: max anisotropy &gt;= 1</span>
<span class="linenos">2460</span>
<span class="linenos">2461</span><span class="sd">        minimize (objective_func)</span>
<span class="linenos">2462</span><span class="sd">            \prod_{k=1..D} T_k^{tot} / T_k                                                    # X-domain box-count</span>
<span class="linenos">2463</span><span class="sd">            *                                                                                 #       \times</span>
<span class="linenos">2464</span><span class="sd">            \prod_{k=1..D} B_k^{tot} / B_k                                                    # Z-domain box-count</span>
<span class="linenos">2465</span><span class="sd">        subject to</span>
<span class="linenos">2466</span><span class="sd">            1. \prod_{k=1..D} s_k T_k B_k &lt;= FFT_mem / (elem_size * N_trans) * (2 \pi)^{D}    # sub-problem memory limit</span>
<span class="linenos">2467</span><span class="sd">            2. T_k &lt;= T_k^{tot}                                                               # X-domain box size limited to X_k&#39;s spread</span>
<span class="linenos">2468</span><span class="sd">            3. B_k &lt;= B_k^{tot}                                                               # Z-domain box size limited to Z_k&#39;s spread</span>
<span class="linenos">2469</span><span class="sd">            4. objective_func &gt;= 1                                                            # at least 1 NUFFT sub-problem necessary</span>
<span class="linenos">2470</span><span class="sd">            5. 1/alpha &lt;= (T_k / T_k^{tot}) / (T_q / T_q^{tot}) &lt;= alpha                      # X-domain box size anisotropy limited</span>
<span class="linenos">2471</span><span class="sd">            6. 1/alpha &lt;= (B_k / B_k^{tot}) / (B_q / B_q^{tot}) &lt;= alpha                      # Z-domain box size anisotropy limited</span>
<span class="linenos">2472</span><span class="sd">            7. 1/alpha &lt;= (T_l / T_l^{tot}) / (B_m / B_m^{tot}) &lt;= alpha                      # XZ-domain box size cross-anisotropy limited</span>
<span class="linenos">2473</span>
<span class="linenos">2474</span><span class="sd">        Constraint (7) ensures (T_k, B_k) partitions the X/Z-domains uniformly. (Not including this</span>
<span class="linenos">2475</span><span class="sd">        term may give rise to solutions where X/Z-domains are partitioned finely/coarsely, or not at</span>
<span class="linenos">2476</span><span class="sd">        all.)</span>
<span class="linenos">2477</span>
<span class="linenos">2478</span><span class="sd">        The problem above can be recast as a small LP and easily solved.</span>
<span class="linenos">2479</span>
<span class="linenos">2480</span>
<span class="linenos">2481</span><span class="sd">        Mathematical Formulation (LinProg)</span>
<span class="linenos">2482</span><span class="sd">        ----------------------------------</span>
<span class="linenos">2483</span>
<span class="linenos">2484</span><span class="sd">        minimize</span>
<span class="linenos">2485</span><span class="sd">            c^{T} x</span>
<span class="linenos">2486</span><span class="sd">        subject to</span>
<span class="linenos">2487</span><span class="sd">            A x &lt;= b</span>
<span class="linenos">2488</span><span class="sd">              x &lt;= u</span>
<span class="linenos">2489</span><span class="sd">        where</span>
<span class="linenos">2490</span><span class="sd">            x = [ln(T_1) ... ln(T_D), ln(B_1) ... ln(B_D)] \in \bR^{2D}</span>
<span class="linenos">2491</span><span class="sd">            c = [-1 ... -1]</span>
<span class="linenos">2492</span><span class="sd">            u = [ln(T_1^{tot}) ... ln(T_D^{tot}), ln(B_1^{tot}) ... ln(B_D^{tot})]</span>
<span class="linenos">2493</span><span class="sd">            [A | b] = [</span>
<span class="linenos">2494</span><span class="sd">                    [  -c   | ln(FFT_mem / (elem_size * N_trans)) + \sum_{k=1..D} ln(2 \pi / s_k) ],  # sub-problem memory limit</span>
<span class="linenos">2495</span><span class="sd">                    [  -c   | \sum_{k=1..D} ln(T_k^{tot}) + \sum_{k=1..D} ln(B_k^{tot})           ],  # at least 1 NUFFT sub-problem necessary</span>
<span class="linenos">2496</span><span class="sd">               (L1) [ M1, Z | ln(alpha) + ln(T_k^{tot}) - ln(T_q^{tot})                           ],  # X-domain box size anisotropy limited (upper limit, vector form)</span>
<span class="linenos">2497</span><span class="sd">               (L2) [-M1, Z | ln(alpha) - ln(T_k^{tot}) + ln(T_q^{tot})                           ],  # X-domain box size anisotropy limited (lower limit, vector form)</span>
<span class="linenos">2498</span><span class="sd">               (L3) [ Z, M1 | ln(alpha) + ln(B_k^{tot}) - ln(B_q^{tot})                           ],  # Z-domain box size anisotropy limited (upper limit, vector form)</span>
<span class="linenos">2499</span><span class="sd">               (L4) [ Z,-M1 | ln(alpha) - ln(B_k^{tot}) + ln(B_q^{tot})                           ],  # Z-domain box size anisotropy limited (lower limit, vector form)</span>
<span class="linenos">2500</span><span class="sd">               (L5) [  M2   | ln(alpha) + ln(T_l^{tot}) - ln(B_m^{tot})                           ],  # XZ-domain box size cross-anisotropy limited (upper limit, vector form)</span>
<span class="linenos">2501</span><span class="sd">               (L6) [ -M2   | ln(alpha) - ln(T_l^{tot}) + ln(B_m^{tot})                           ],  # XZ-domain box size cross-anisotropy limited (lower limit, vector form)</span>
<span class="linenos">2502</span><span class="sd">            ]</span>
<span class="linenos">2503</span><span class="sd">            Z = zeros(D_choose_2, D)</span>
<span class="linenos">2504</span><span class="sd">            M1 = (D_choose_2, D) (M)ask containing:</span>
<span class="linenos">2505</span><span class="sd">                D = 1 =&gt; drop L1..4 in [A | b]</span>
<span class="linenos">2506</span><span class="sd">                D = 2 =&gt; [[ 1 -1]</span>
<span class="linenos">2507</span><span class="sd">                          [-1  1]]</span>
<span class="linenos">2508</span><span class="sd">                D = 3 =&gt; [[ 1 -1  0]</span>
<span class="linenos">2509</span><span class="sd">                          [ 1  0 -1]</span>
<span class="linenos">2510</span><span class="sd">                          [ 0  1 -1]]</span>
<span class="linenos">2511</span><span class="sd">            M2 = (D^{2}, 2 D) (M)ask containing:</span>
<span class="linenos">2512</span><span class="sd">                D = 1 =&gt; [1 -1]</span>
<span class="linenos">2513</span><span class="sd">                D = 2 =&gt; [[ 1  0 -1  0]</span>
<span class="linenos">2514</span><span class="sd">                          [ 1  0  0 -1]</span>
<span class="linenos">2515</span><span class="sd">                          [ 0  1 -1  0]</span>
<span class="linenos">2516</span><span class="sd">                          [ 0  1  0 -1]]</span>
<span class="linenos">2517</span><span class="sd">                D = 3 =&gt; [[ 1  0  0 -1  0  0]</span>
<span class="linenos">2518</span><span class="sd">                          [ 1  0  0  0 -1  0]</span>
<span class="linenos">2519</span><span class="sd">                          [ 1  0  0  0  0 -1]</span>
<span class="linenos">2520</span><span class="sd">                          [ 0  1  0 -1  0  0]</span>
<span class="linenos">2521</span><span class="sd">                          [ 0  1  0  0 -1  0]</span>
<span class="linenos">2522</span><span class="sd">                          [ 0  1  0  0  0 -1]</span>
<span class="linenos">2523</span><span class="sd">                          [ 0  0  1 -1  0  0]</span>
<span class="linenos">2524</span><span class="sd">                          [ 0  0  1  0 -1  0]</span>
<span class="linenos">2525</span><span class="sd">                          [ 0  0  1  0  0 -1]]</span>
<span class="linenos">2526</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">2527</span>        <span class="c1"># NUFFT parameters</span>
<span class="linenos">2528</span>        <span class="n">D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_D</span>
<span class="linenos">2529</span>        <span class="n">xp</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">get_array_module</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">)</span>
<span class="linenos">2530</span>        <span class="n">T_tot</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">to_NUMPY</span><span class="p">(</span><span class="n">xp</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="linenos">2531</span>        <span class="n">B_tot</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">to_NUMPY</span><span class="p">(</span><span class="n">xp</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_z</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="linenos">2532</span>        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_upsample_factor</span><span class="p">(),)</span> <span class="o">*</span> <span class="n">D</span><span class="p">)</span>
<span class="linenos">2533</span>        <span class="n">c_width</span> <span class="o">=</span> <span class="n">pxrt</span><span class="o">.</span><span class="n">Width</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">complex</span>
<span class="linenos">2534</span>        <span class="n">c_itemsize</span> <span class="o">=</span> <span class="n">c_width</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">itemsize</span>
<span class="linenos">2535</span>        <span class="n">n_trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n</span>
<span class="linenos">2536</span>
<span class="linenos">2537</span>        <span class="c1"># (M)ask, (Z)ero and (R)ange arrays to simplify LinProg spec</span>
<span class="linenos">2538</span>        <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
<span class="linenos">2539</span>        <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">math</span><span class="o">.</span><span class="n">comb</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">D</span><span class="p">))</span>
<span class="linenos">2540</span>        <span class="n">M1</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="linenos">2541</span>        <span class="n">_k</span><span class="p">,</span> <span class="n">_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">D</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">2542</span>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">__k</span><span class="p">,</span> <span class="n">__q</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">_k</span><span class="p">,</span> <span class="n">_q</span><span class="p">)):</span>
<span class="linenos">2543</span>            <span class="n">M1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">__k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="linenos">2544</span>            <span class="n">M1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">__q</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="linenos">2545</span>        <span class="n">_l</span><span class="p">,</span> <span class="n">_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
<span class="linenos">2546</span>        <span class="n">M2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">D</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">D</span><span class="p">))</span>
<span class="linenos">2547</span>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">__l</span><span class="p">,</span> <span class="n">__m</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">_l</span><span class="p">,</span> <span class="n">_m</span><span class="p">)):</span>
<span class="linenos">2548</span>            <span class="n">M2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">__l</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="linenos">2549</span>            <span class="n">M2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">D</span> <span class="o">+</span> <span class="n">__m</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="linenos">2550</span>
<span class="linenos">2551</span>        <span class="c1"># LinProg parameters</span>
<span class="linenos">2552</span>        <span class="n">c</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">D</span><span class="p">)</span>  <span class="c1"># maximize box volumes / minimize #sub-problems</span>
<span class="linenos">2553</span>        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">block</span><span class="p">(</span>
<span class="linenos">2554</span>            <span class="p">[</span>
<span class="linenos">2555</span>                <span class="p">[</span><span class="o">-</span><span class="n">c</span><span class="p">],</span>  <span class="c1"># memory limit</span>
<span class="linenos">2556</span>                <span class="p">[</span><span class="o">-</span><span class="n">c</span><span class="p">],</span>  <span class="c1"># at least 1 box</span>
<span class="linenos">2557</span>                <span class="p">[</span><span class="n">M1</span><span class="p">,</span> <span class="n">Z</span><span class="p">],</span>  <span class="c1"># T_k anisotropy upper-bound</span>
<span class="linenos">2558</span>                <span class="p">[</span><span class="o">-</span><span class="n">M1</span><span class="p">,</span> <span class="n">Z</span><span class="p">],</span>  <span class="c1"># T_k anisotropy lower-bound</span>
<span class="linenos">2559</span>                <span class="p">[</span><span class="n">Z</span><span class="p">,</span> <span class="n">M1</span><span class="p">],</span>  <span class="c1"># B_k anisotropy upper-bound</span>
<span class="linenos">2560</span>                <span class="p">[</span><span class="n">Z</span><span class="p">,</span> <span class="o">-</span><span class="n">M1</span><span class="p">],</span>  <span class="c1"># B_k anisotropy lower-bound</span>
<span class="linenos">2561</span>                <span class="p">[</span><span class="n">M2</span><span class="p">],</span>  <span class="c1"># T_k/B_k cross-anisotropy upper-bound</span>
<span class="linenos">2562</span>                <span class="p">[</span><span class="o">-</span><span class="n">M2</span><span class="p">],</span>  <span class="c1"># T_k/B_k cross-anisotropy lower-bound</span>
<span class="linenos">2563</span>            <span class="p">]</span>
<span class="linenos">2564</span>        <span class="p">)</span>
<span class="linenos">2565</span>        <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span>
<span class="linenos">2566</span>            <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">fft_bytes</span> <span class="o">/</span> <span class="p">(</span><span class="n">c_itemsize</span> <span class="o">*</span> <span class="n">n_trans</span><span class="p">))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">sigma</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>  <span class="c1"># memory limit</span>
<span class="linenos">2567</span>            <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">T_tot</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">B_tot</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>  <span class="c1"># at least 1 box</span>
<span class="linenos">2568</span>            <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">T_tot</span><span class="p">)[</span><span class="n">_k</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">T_tot</span><span class="p">)[</span><span class="n">_q</span><span class="p">],</span>  <span class="c1"># T_k anisotropy upper-bound</span>
<span class="linenos">2569</span>            <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">T_tot</span><span class="p">)[</span><span class="n">_k</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">T_tot</span><span class="p">)[</span><span class="n">_q</span><span class="p">],</span>  <span class="c1"># T_k anisotropy lower-bound</span>
<span class="linenos">2570</span>            <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">B_tot</span><span class="p">)[</span><span class="n">_k</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">B_tot</span><span class="p">)[</span><span class="n">_q</span><span class="p">],</span>  <span class="c1"># B_k anisotropy upper-bound</span>
<span class="linenos">2571</span>            <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">B_tot</span><span class="p">)[</span><span class="n">_k</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">B_tot</span><span class="p">)[</span><span class="n">_q</span><span class="p">],</span>  <span class="c1"># B_k anisotropy lower-bound</span>
<span class="linenos">2572</span>            <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">T_tot</span><span class="p">)[</span><span class="n">_l</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">B_tot</span><span class="p">)[</span><span class="n">_m</span><span class="p">],</span>  <span class="c1"># T_k/B_k cross-anisotropy upper-bound</span>
<span class="linenos">2573</span>            <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">T_tot</span><span class="p">)[</span><span class="n">_l</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">B_tot</span><span class="p">)[</span><span class="n">_m</span><span class="p">],</span>  <span class="c1"># T_k/B_k cross-anisotropy lower-bound</span>
<span class="linenos">2574</span>        <span class="p">]</span>
<span class="linenos">2575</span>        <span class="n">lb</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">D</span><span class="p">)</span>  <span class="c1"># T_k, B_k lower limit (None)</span>
<span class="linenos">2576</span>        <span class="n">ub</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">T_tot</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">B_tot</span><span class="p">)]</span>  <span class="c1"># T_k, B_k upper limit</span>
<span class="linenos">2577</span>
<span class="linenos">2578</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">sopt</span><span class="o">.</span><span class="n">linprog</span><span class="p">(</span>
<span class="linenos">2579</span>            <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
<span class="linenos">2580</span>            <span class="n">A_ub</span><span class="o">=</span><span class="n">A</span><span class="p">,</span>
<span class="linenos">2581</span>            <span class="n">b_ub</span><span class="o">=</span><span class="n">b</span><span class="p">,</span>
<span class="linenos">2582</span>            <span class="n">bounds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">lb</span><span class="p">,</span> <span class="n">ub</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
<span class="linenos">2583</span>            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;highs&quot;</span><span class="p">,</span>
<span class="linenos">2584</span>        <span class="p">)</span>
<span class="linenos">2585</span>        <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
<span class="linenos">2586</span>            <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[:</span><span class="n">D</span><span class="p">])</span>
<span class="linenos">2587</span>            <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">D</span><span class="p">:])</span>
<span class="linenos">2588</span>            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">T</span><span class="p">),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
<span class="linenos">2589</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">2590</span>            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Auto-chunking failed given memory/anisotropy constraints.&quot;</span>
<span class="linenos">2591</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="linenos">2592</span>
<span class="linenos">2593</span>    <span class="nd">@staticmethod</span>
<span class="linenos">2594</span>    <span class="k">def</span> <span class="nf">_tesselate</span><span class="p">(</span>
<span class="linenos">2595</span>        <span class="n">data</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">,</span>
<span class="linenos">2596</span>        <span class="n">box_dim</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pxt</span><span class="o">.</span><span class="n">Real</span><span class="p">],</span>
<span class="linenos">2597</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">]:</span>
<span class="linenos">2598</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">2599</span><span class="sd">        Split point-cloud into disjoint rectangular regions.</span>
<span class="linenos">2600</span>
<span class="linenos">2601</span><span class="sd">        Parameters</span>
<span class="linenos">2602</span><span class="sd">        ----------</span>
<span class="linenos">2603</span><span class="sd">        data: pxt.NDArray</span>
<span class="linenos">2604</span><span class="sd">            (M, D) point cloud.</span>
<span class="linenos">2605</span><span class="sd">        box_dim: tuple[float]</span>
<span class="linenos">2606</span><span class="sd">            (D,) box dimensions.</span>
<span class="linenos">2607</span>
<span class="linenos">2608</span><span class="sd">        Returns</span>
<span class="linenos">2609</span><span class="sd">        -------</span>
<span class="linenos">2610</span><span class="sd">        chunks: list[NDArray[int]]</span>
<span class="linenos">2611</span><span class="sd">            (idx[0], ..., idx[C-1]) chunk specifiers.</span>
<span class="linenos">2612</span><span class="sd">            `idx[k]` contains indices of `data` which lie in the same box.</span>
<span class="linenos">2613</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">2614</span>        <span class="n">M</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
<span class="linenos">2615</span>
<span class="linenos">2616</span>        <span class="c1"># Center data-points around origin</span>
<span class="linenos">2617</span>        <span class="n">data</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">to_NUMPY</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
<span class="linenos">2618</span>        <span class="n">data_min</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">2619</span>        <span class="n">data_max</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">2620</span>        <span class="n">data</span> <span class="o">-=</span> <span class="p">(</span><span class="n">data_min</span> <span class="o">+</span> <span class="n">data_max</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
<span class="linenos">2621</span>
<span class="linenos">2622</span>        <span class="c1"># Compute optimal box_[dim, count]</span>
<span class="linenos">2623</span>        <span class="n">data_spread</span> <span class="o">=</span> <span class="n">data_max</span> <span class="o">-</span> <span class="n">data_min</span>
<span class="linenos">2624</span>        <span class="n">box_dim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">box_dim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
<span class="linenos">2625</span>        <span class="n">N_box</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">data_spread</span> <span class="o">/</span> <span class="n">box_dim</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="linenos">2626</span>        <span class="n">box_dim</span> <span class="o">=</span> <span class="n">data_spread</span> <span class="o">/</span> <span class="n">N_box</span>
<span class="linenos">2627</span>
<span class="linenos">2628</span>        <span class="c1"># Rescale data to have equal spread in each dimension.</span>
<span class="linenos">2629</span>        <span class="c1"># Reason: KDTree only accepts scalar-valued radii.</span>
<span class="linenos">2630</span>        <span class="n">scale</span> <span class="o">=</span> <span class="n">box_dim</span>
<span class="linenos">2631</span>        <span class="n">data</span> <span class="o">/=</span> <span class="n">scale</span>
<span class="linenos">2632</span>        <span class="n">data_min</span> <span class="o">/=</span> <span class="n">scale</span>
<span class="linenos">2633</span>        <span class="n">data_max</span> <span class="o">/=</span> <span class="n">scale</span>
<span class="linenos">2634</span>        <span class="n">data_spread</span> <span class="o">/=</span> <span class="n">scale</span>
<span class="linenos">2635</span>        <span class="n">box_dim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">box_dim</span><span class="p">)</span>
<span class="linenos">2636</span>
<span class="linenos">2637</span>        <span class="c1"># Compute gridded centroids</span>
<span class="linenos">2638</span>        <span class="n">range_spec</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">2639</span>        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">N_box</span><span class="p">:</span>
<span class="linenos">2640</span>            <span class="n">is_odd</span> <span class="o">=</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span>
<span class="linenos">2641</span>            <span class="n">lb</span><span class="p">,</span> <span class="n">ub</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">n</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span> <span class="n">n</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">is_odd</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">2642</span>            <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">is_odd</span> <span class="k">else</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span>
<span class="linenos">2643</span>            <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">ub</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span>
<span class="linenos">2644</span>            <span class="n">range_spec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="linenos">2645</span>        <span class="n">centroid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="o">*</span><span class="n">range_spec</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s2">&quot;ij&quot;</span><span class="p">)</span>
<span class="linenos">2646</span>        <span class="n">centroid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">centroid</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
<span class="linenos">2647</span>
<span class="linenos">2648</span>        <span class="c1"># Allocate data points to gridded centroids</span>
<span class="linenos">2649</span>        <span class="n">c_tree</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">KDTree</span><span class="p">(</span><span class="n">centroid</span><span class="p">)</span>  <span class="c1"># centroid_tree</span>
<span class="linenos">2650</span>        <span class="n">dist</span><span class="p">,</span> <span class="n">c_idx</span> <span class="o">=</span> <span class="n">c_tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
<span class="linenos">2651</span>            <span class="n">data</span><span class="p">,</span>
<span class="linenos">2652</span>            <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="linenos">2653</span>            <span class="n">eps</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span>  <span class="c1"># approximate NN-search for speed</span>
<span class="linenos">2654</span>            <span class="n">p</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>  <span class="c1"># L-infinity norm</span>
<span class="linenos">2655</span>        <span class="p">)</span>
<span class="linenos">2656</span>        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">c_idx</span><span class="p">)</span>
<span class="linenos">2657</span>        <span class="n">count</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">(</span><span class="n">c_idx</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>  <span class="c1"># sort + count occurence</span>
<span class="linenos">2658</span>        <span class="n">chunks</span><span class="p">,</span> <span class="n">start</span> <span class="o">=</span> <span class="p">[],</span> <span class="mi">0</span>
<span class="linenos">2659</span>        <span class="k">for</span> <span class="n">c_idx</span><span class="p">,</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">count</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
<span class="linenos">2660</span>            <span class="n">chk</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="n">start</span> <span class="p">:</span> <span class="n">start</span> <span class="o">+</span> <span class="n">step</span><span class="p">]</span>
<span class="linenos">2661</span>            <span class="n">chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chk</span><span class="p">)</span>
<span class="linenos">2662</span>            <span class="n">start</span> <span class="o">+=</span> <span class="n">step</span>
<span class="linenos">2663</span>        <span class="n">centroid</span> <span class="o">=</span> <span class="n">centroid</span><span class="p">[</span><span class="nb">sorted</span><span class="p">(</span><span class="n">count</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span>  <span class="c1"># drop boxes with no data-points</span>
<span class="linenos">2664</span>
<span class="linenos">2665</span>        <span class="c1"># Compute true centroids + tight box boundaries seen by FINUFFT</span>
<span class="linenos">2666</span>        <span class="n">tbox_dim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">centroid</span><span class="p">),</span> <span class="n">D</span><span class="p">))</span>  <span class="c1"># tight box_dim(s)</span>
<span class="linenos">2667</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">centroid</span><span class="p">)):</span>
<span class="linenos">2668</span>            <span class="n">_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">chunks</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
<span class="linenos">2669</span>            <span class="n">_data_min</span> <span class="o">=</span> <span class="n">_data</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">2670</span>            <span class="n">_data_max</span> <span class="o">=</span> <span class="n">_data</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">2671</span>            <span class="n">centroid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">_data_min</span> <span class="o">+</span> <span class="n">_data_max</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
<span class="linenos">2672</span>            <span class="n">tbox_dim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_data_max</span> <span class="o">-</span> <span class="n">_data_min</span>
<span class="linenos">2673</span>
<span class="linenos">2674</span>        <span class="c1"># Fuse chunks which are closely-spaced &amp; small-enough</span>
<span class="linenos">2675</span>        <span class="n">fuse_chunks</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">2676</span>        <span class="k">while</span> <span class="n">fuse_chunks</span><span class="p">:</span>
<span class="linenos">2677</span>            <span class="c1"># Find fuseable centroid pairs</span>
<span class="linenos">2678</span>            <span class="n">c_tree</span> <span class="o">=</span> <span class="n">spl</span><span class="o">.</span><span class="n">KDTree</span><span class="p">(</span><span class="n">centroid</span><span class="p">)</span>  <span class="c1"># centroid_tree</span>
<span class="linenos">2679</span>            <span class="n">candidates</span> <span class="o">=</span> <span class="n">c_tree</span><span class="o">.</span><span class="n">query_pairs</span><span class="p">(</span>
<span class="linenos">2680</span>                <span class="n">r</span><span class="o">=</span><span class="n">box_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
<span class="linenos">2681</span>                <span class="n">p</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
<span class="linenos">2682</span>                <span class="n">output_type</span><span class="o">=</span><span class="s2">&quot;ndarray&quot;</span><span class="p">,</span>
<span class="linenos">2683</span>            <span class="p">)</span>
<span class="linenos">2684</span>            <span class="n">_i</span><span class="p">,</span> <span class="n">_j</span> <span class="o">=</span> <span class="n">candidates</span><span class="o">.</span><span class="n">T</span>
<span class="linenos">2685</span>            <span class="n">c_spacing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">centroid</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span> <span class="o">-</span> <span class="n">centroid</span><span class="p">[</span><span class="n">_j</span><span class="p">])</span>
<span class="linenos">2686</span>            <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">tbox_dim</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span> <span class="o">+</span> <span class="n">tbox_dim</span><span class="p">[</span><span class="n">_j</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
<span class="linenos">2687</span>            <span class="n">fuseable</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">c_spacing</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">box_dim</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">2688</span>            <span class="n">candidates</span> <span class="o">=</span> <span class="n">candidates</span><span class="p">[</span><span class="n">fuseable</span><span class="p">]</span>
<span class="linenos">2689</span>
<span class="linenos">2690</span>            <span class="c1"># If a centroid can be fused with multiple others, restrict choice to single pair</span>
<span class="linenos">2691</span>            <span class="n">seen</span><span class="p">,</span> <span class="n">fuse</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(),</span> <span class="nb">set</span><span class="p">()</span>
<span class="linenos">2692</span>            <span class="k">for</span> <span class="n">_i</span><span class="p">,</span> <span class="n">_j</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
<span class="linenos">2693</span>                <span class="k">if</span> <span class="p">(</span><span class="n">_i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">_j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">):</span>
<span class="linenos">2694</span>                    <span class="n">seen</span> <span class="o">|=</span> <span class="p">{</span><span class="n">_i</span><span class="p">,</span> <span class="n">_j</span><span class="p">}</span>
<span class="linenos">2695</span>                    <span class="n">fuse</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">_i</span><span class="p">,</span> <span class="n">_j</span><span class="p">))</span>
<span class="linenos">2696</span>
<span class="linenos">2697</span>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fuse</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">2698</span>                <span class="k">for</span> <span class="n">_i</span><span class="p">,</span> <span class="n">_j</span> <span class="ow">in</span> <span class="n">fuse</span><span class="p">:</span>
<span class="linenos">2699</span>                    <span class="n">chunks</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">chunks</span><span class="p">[</span><span class="n">_i</span><span class="p">],</span> <span class="n">chunks</span><span class="p">[</span><span class="n">_j</span><span class="p">]]</span>
<span class="linenos">2700</span>                    <span class="n">_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">chunks</span><span class="p">[</span><span class="n">_i</span><span class="p">]]</span>
<span class="linenos">2701</span>                    <span class="n">_data_min</span> <span class="o">=</span> <span class="n">_data</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">2702</span>                    <span class="n">_data_max</span> <span class="o">=</span> <span class="n">_data</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">2703</span>                    <span class="n">centroid</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">_data_min</span> <span class="o">+</span> <span class="n">_data_max</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
<span class="linenos">2704</span>                    <span class="n">tbox_dim</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_data_max</span> <span class="o">-</span> <span class="n">_data_min</span>
<span class="linenos">2705</span>
<span class="linenos">2706</span>                <span class="c1"># Fuse cleanup: drop _j entries</span>
<span class="linenos">2707</span>                <span class="n">c_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span>  <span class="c1"># indices to keep</span>
<span class="linenos">2708</span>                    <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">centroid</span><span class="p">)),</span>
<span class="linenos">2709</span>                    <span class="p">[</span><span class="n">_j</span> <span class="k">for</span> <span class="p">(</span><span class="n">_i</span><span class="p">,</span> <span class="n">_j</span><span class="p">)</span> <span class="ow">in</span> <span class="n">fuse</span><span class="p">],</span>  <span class="c1"># indices to drop</span>
<span class="linenos">2710</span>                <span class="p">)</span>
<span class="linenos">2711</span>                <span class="n">centroid</span> <span class="o">=</span> <span class="n">centroid</span><span class="p">[</span><span class="n">c_idx</span><span class="p">]</span>
<span class="linenos">2712</span>                <span class="n">tbox_dim</span> <span class="o">=</span> <span class="n">tbox_dim</span><span class="p">[</span><span class="n">c_idx</span><span class="p">]</span>
<span class="linenos">2713</span>                <span class="n">chunks</span> <span class="o">=</span> <span class="p">[</span><span class="n">chk</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">chk</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="n">c_idx</span><span class="p">)]</span>
<span class="linenos">2714</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">2715</span>                <span class="n">fuse_chunks</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos">2716</span>
<span class="linenos">2717</span>        <span class="k">return</span> <span class="n">chunks</span>
<span class="linenos">2718</span>
<span class="linenos">2719</span>    <span class="k">def</span> <span class="nf">diagnostic_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="linenos">2720</span>        <span class="n">plt</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s2">&quot;matplotlib.pyplot&quot;</span><span class="p">)</span>
<span class="linenos">2721</span>        <span class="n">mpl_p</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s2">&quot;matplotlib.patches&quot;</span><span class="p">)</span>
<span class="linenos">2722</span>
<span class="linenos">2723</span>        <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span>
<span class="linenos">2724</span>            <span class="n">points</span><span class="p">,</span>  <span class="c1"># (N, 2) data points</span>
<span class="linenos">2725</span>            <span class="n">chunks</span><span class="p">,</span>  <span class="c1"># (N_c,) chunk specifiers</span>
<span class="linenos">2726</span>            <span class="n">ax</span><span class="p">,</span>
<span class="linenos">2727</span>        <span class="p">):</span>
<span class="linenos">2728</span>            <span class="c1"># Compute chunk centroids, tight-box_dims, cvx hulls</span>
<span class="linenos">2729</span>            <span class="n">N_chk</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>
<span class="linenos">2730</span>            <span class="n">centroid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N_chk</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="linenos">2731</span>            <span class="n">tbox_dim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N_chk</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="linenos">2732</span>            <span class="n">hull</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># (N_c,) hulls</span>
<span class="linenos">2733</span>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">chk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">chunks</span><span class="p">):</span>
<span class="linenos">2734</span>                <span class="n">_pts</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">chk</span><span class="p">]</span>
<span class="linenos">2735</span>                <span class="n">_pts_min</span> <span class="o">=</span> <span class="n">_pts</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">2736</span>                <span class="n">_pts_max</span> <span class="o">=</span> <span class="n">_pts</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">2737</span>                <span class="n">centroid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">_pts_min</span> <span class="o">+</span> <span class="n">_pts_max</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
<span class="linenos">2738</span>                <span class="n">tbox_dim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_pts_max</span> <span class="o">-</span> <span class="n">_pts_min</span>
<span class="linenos">2739</span>                <span class="n">_hull</span> <span class="o">=</span> <span class="n">_pts</span><span class="p">[</span><span class="n">spl</span><span class="o">.</span><span class="n">ConvexHull</span><span class="p">(</span><span class="n">_pts</span><span class="p">)</span><span class="o">.</span><span class="n">vertices</span><span class="p">]</span>
<span class="linenos">2740</span>                <span class="n">hull</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_hull</span><span class="p">)</span>
<span class="linenos">2741</span>
<span class="linenos">2742</span>            <span class="k">for</span> <span class="n">_tbox</span><span class="p">,</span> <span class="n">_c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tbox_dim</span><span class="p">,</span> <span class="n">centroid</span><span class="p">):</span>
<span class="linenos">2743</span>                <span class="n">data_rect</span> <span class="o">=</span> <span class="n">mpl_p</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>  <span class="c1"># sub-problem bounding-box</span>
<span class="linenos">2744</span>                    <span class="n">xy</span><span class="o">=</span><span class="n">_c</span> <span class="o">-</span> <span class="n">_tbox</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
<span class="linenos">2745</span>                    <span class="n">width</span><span class="o">=</span><span class="n">_tbox</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
<span class="linenos">2746</span>                    <span class="n">height</span><span class="o">=</span><span class="n">_tbox</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
<span class="linenos">2747</span>                    <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="linenos">2748</span>                    <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span>
<span class="linenos">2749</span>                    <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span>
<span class="linenos">2750</span>                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
<span class="linenos">2751</span>                    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;data box&quot;</span><span class="p">,</span>
<span class="linenos">2752</span>                <span class="p">)</span>
<span class="linenos">2753</span>                <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">data_rect</span><span class="p">)</span>
<span class="linenos">2754</span>            <span class="k">for</span> <span class="n">_hull</span> <span class="ow">in</span> <span class="n">hull</span><span class="p">:</span>
<span class="linenos">2755</span>                <span class="n">data_poly</span> <span class="o">=</span> <span class="n">mpl_p</span><span class="o">.</span><span class="n">Polygon</span><span class="p">(</span>  <span class="c1"># sub-problem data support</span>
<span class="linenos">2756</span>                    <span class="n">xy</span><span class="o">=</span><span class="n">_hull</span><span class="p">,</span>
<span class="linenos">2757</span>                    <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="linenos">2758</span>                    <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span>
<span class="linenos">2759</span>                    <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span>
<span class="linenos">2760</span>                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
<span class="linenos">2761</span>                    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;data cvx hull&quot;</span><span class="p">,</span>
<span class="linenos">2762</span>                <span class="p">)</span>
<span class="linenos">2763</span>                <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">data_poly</span><span class="p">)</span>
<span class="linenos">2764</span>            <span class="n">centroid_pts</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>  <span class="c1"># sub-problem bounding-box centers</span>
<span class="linenos">2765</span>                <span class="n">centroid</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
<span class="linenos">2766</span>                <span class="n">centroid</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
<span class="linenos">2767</span>                <span class="s2">&quot;x&quot;</span><span class="p">,</span>  <span class="c1"># cross</span>
<span class="linenos">2768</span>                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
<span class="linenos">2769</span>                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;chunk centroid&quot;</span><span class="p">,</span>
<span class="linenos">2770</span>            <span class="p">)</span>
<span class="linenos">2771</span>            <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
<span class="linenos">2772</span>            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
<span class="linenos">2773</span>                <span class="n">handles</span><span class="o">=</span><span class="p">[</span>
<span class="linenos">2774</span>                    <span class="o">*</span><span class="n">centroid_pts</span><span class="p">,</span>
<span class="linenos">2775</span>                    <span class="n">data_poly</span><span class="p">,</span>
<span class="linenos">2776</span>                    <span class="n">data_rect</span><span class="p">,</span>
<span class="linenos">2777</span>                <span class="p">],</span>
<span class="linenos">2778</span>                <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">,</span>
<span class="linenos">2779</span>            <span class="p">)</span>
<span class="linenos">2780</span>
<span class="linenos">2781</span>        <span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<span class="linenos">2782</span>        <span class="k">if</span> <span class="n">domain</span> <span class="o">==</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span>
<span class="linenos">2783</span>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span>
<span class="linenos">2784</span>            <span class="n">chunks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_chunk</span>
<span class="linenos">2785</span>        <span class="k">elif</span> <span class="n">domain</span> <span class="o">==</span> <span class="s2">&quot;z&quot;</span><span class="p">:</span>
<span class="linenos">2786</span>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span>
<span class="linenos">2787</span>            <span class="n">chunks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z_chunk</span>
<span class="linenos">2788</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">2789</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown domain &#39;</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
<span class="linenos">2790</span>
<span class="linenos">2791</span>        <span class="n">_</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
<span class="linenos">2792</span>        <span class="k">if</span> <span class="n">D</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">2793</span>            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
<span class="linenos">2794</span>
<span class="linenos">2795</span>        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="linenos">2796</span>        <span class="k">if</span> <span class="n">D</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
<span class="linenos">2797</span>            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">2798</span>            <span class="n">_plot</span><span class="p">(</span>
<span class="linenos">2799</span>                <span class="n">points</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
<span class="linenos">2800</span>                <span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">,</span>
<span class="linenos">2801</span>                <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
<span class="linenos">2802</span>            <span class="p">)</span>
<span class="linenos">2803</span>            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;data/chunk distribution (XY-plane)&quot;</span><span class="p">)</span>
<span class="linenos">2804</span>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># D == 3</span>
<span class="linenos">2805</span>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="p">[</span>
<span class="linenos">2806</span>                <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;data/chunk distribution (XY-plane)&quot;</span><span class="p">),</span>
<span class="linenos">2807</span>                <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;data/chunk distribution (XZ-plane)&quot;</span><span class="p">),</span>
<span class="linenos">2808</span>                <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;data/chunk distribution (YZ-plane)&quot;</span><span class="p">),</span>
<span class="linenos">2809</span>            <span class="p">]:</span>
<span class="linenos">2810</span>                <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">2811</span>                <span class="n">_plot</span><span class="p">(</span>
<span class="linenos">2812</span>                    <span class="n">points</span><span class="o">=</span><span class="n">data</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">],</span>
<span class="linenos">2813</span>                    <span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">,</span>
<span class="linenos">2814</span>                    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
<span class="linenos">2815</span>                <span class="p">)</span>
<span class="linenos">2816</span>                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
<span class="linenos">2817</span>        <span class="k">return</span> <span class="n">fig</span>
<span class="linenos">2818</span>
<span class="linenos">2819</span>
<span class="linenos">2820</span><span class="nd">@numba</span><span class="o">.</span><span class="n">njit</span><span class="p">(</span><span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nogil</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">2821</span><span class="k">def</span> <span class="nf">_nudft_NUMPY</span><span class="p">(</span>
<span class="linenos">2822</span>    <span class="n">weight</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">,</span>  <span class="c1"># (Q, M) weights (n_trans=Q) [complex64/128]</span>
<span class="linenos">2823</span>    <span class="n">source</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">,</span>  <span class="c1"># (M, D) sample points [float32/64]</span>
<span class="linenos">2824</span>    <span class="n">target</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">,</span>  <span class="c1"># (N, D) query points [float32/64]</span>
<span class="linenos">2825</span>    <span class="o">*</span><span class="p">,</span>
<span class="linenos">2826</span>    <span class="n">isign</span><span class="p">:</span> <span class="n">SignT</span><span class="p">,</span>
<span class="linenos">2827</span>    <span class="n">dtype</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">DType</span><span class="p">,</span>  <span class="c1"># complex64/128</span>
<span class="linenos">2828</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>  <span class="c1"># (Q, N) complex64/128</span>
<span class="linenos">2829</span>    <span class="n">Q</span> <span class="o">=</span> <span class="n">weight</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">2830</span>    <span class="n">M</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">2831</span>    <span class="n">N</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">2832</span>    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
<span class="linenos">2833</span>    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">numba</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
<span class="linenos">2834</span>        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
<span class="linenos">2835</span>            <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">isign</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="p">:],</span> <span class="n">target</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="p">:]))</span>
<span class="linenos">2836</span>            <span class="n">out</span><span class="p">[:,</span> <span class="n">n</span><span class="p">]</span> <span class="o">+=</span> <span class="n">weight</span><span class="p">[:,</span> <span class="n">m</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale</span>
<span class="linenos">2837</span>    <span class="k">return</span> <span class="n">out</span>
<span class="linenos">2838</span>
<span class="linenos">2839</span>
<span class="linenos">2840</span><span class="k">def</span> <span class="nf">_nudft_CUPY</span><span class="p">(</span>
<span class="linenos">2841</span>    <span class="n">weight</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">,</span>  <span class="c1"># (Q, M) weights (n_trans=Q) [complex64/128]</span>
<span class="linenos">2842</span>    <span class="n">source</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">,</span>  <span class="c1"># (M, D) sample points [float32/64]</span>
<span class="linenos">2843</span>    <span class="n">target</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">,</span>  <span class="c1"># (N, D) query points [float32/64]</span>
<span class="linenos">2844</span>    <span class="o">*</span><span class="p">,</span>
<span class="linenos">2845</span>    <span class="n">isign</span><span class="p">:</span> <span class="n">SignT</span><span class="p">,</span>
<span class="linenos">2846</span>    <span class="n">dtype</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">DType</span><span class="p">,</span>  <span class="c1"># complex64/128</span>
<span class="linenos">2847</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>  <span class="c1"># (Q, N) complex64/128</span>
<span class="linenos">2848</span>    <span class="nd">@numba</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">2849</span>    <span class="k">def</span> <span class="nf">_cexp</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>  <span class="c1"># [(1,), (D,), (D,)] -&gt; (1,)</span>
<span class="linenos">2850</span>        <span class="c1"># np.exp(1j * s * (a @ b))</span>
<span class="linenos">2851</span>        <span class="n">D</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="mi">0</span>
<span class="linenos">2852</span>        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">D</span><span class="p">):</span>
<span class="linenos">2853</span>            <span class="n">c</span> <span class="o">+=</span> <span class="n">a</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">*</span> <span class="n">b</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>
<span class="linenos">2854</span>        <span class="n">out</span> <span class="o">=</span> <span class="n">cmath</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">s</span> <span class="o">*</span> <span class="n">c</span><span class="p">)</span>
<span class="linenos">2855</span>        <span class="k">return</span> <span class="n">out</span>
<span class="linenos">2856</span>
<span class="linenos">2857</span>    <span class="nd">@numba</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">2858</span>    <span class="k">def</span> <span class="nf">_kernel</span><span class="p">(</span><span class="n">weight</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">isign</span><span class="p">,</span> <span class="n">out</span><span class="p">):</span>
<span class="linenos">2859</span>        <span class="n">Q</span><span class="p">,</span> <span class="n">M</span> <span class="o">=</span> <span class="n">weight</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">2860</span>        <span class="n">N</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">2861</span>        <span class="n">q</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">numba</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="linenos">2862</span>        <span class="k">if</span> <span class="p">(</span><span class="n">q</span> <span class="o">&lt;</span> <span class="n">Q</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">):</span>
<span class="linenos">2863</span>            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
<span class="linenos">2864</span>                <span class="n">scale</span> <span class="o">=</span> <span class="n">_cexp</span><span class="p">(</span><span class="n">isign</span><span class="p">,</span> <span class="n">source</span><span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="p">:],</span> <span class="n">target</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="p">:])</span>
<span class="linenos">2865</span>                <span class="n">out</span><span class="p">[</span><span class="n">q</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span> <span class="o">+=</span> <span class="n">weight</span><span class="p">[</span><span class="n">q</span><span class="p">,</span> <span class="n">m</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale</span>
<span class="linenos">2866</span>
<span class="linenos">2867</span>    <span class="n">Q</span> <span class="o">=</span> <span class="n">weight</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">2868</span>    <span class="n">N</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">2869</span>    <span class="n">xp</span> <span class="o">=</span> <span class="n">pxu</span><span class="o">.</span><span class="n">get_array_module</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
<span class="linenos">2870</span>    <span class="n">out</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Q</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
<span class="linenos">2871</span>
<span class="linenos">2872</span>    <span class="n">ceil</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">_</span><span class="p">))</span>
<span class="linenos">2873</span>    <span class="n">t_max</span> <span class="o">=</span> <span class="n">weight</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;MaxThreadsPerBlock&quot;</span><span class="p">]</span>
<span class="linenos">2874</span>    <span class="n">tpb</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">t_max</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span> <span class="kc">None</span><span class="p">]</span>  <span class="c1"># thread_per_block</span>
<span class="linenos">2875</span>    <span class="n">tpb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_max</span> <span class="o">//</span> <span class="n">tpb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">2876</span>    <span class="n">bpg</span> <span class="o">=</span> <span class="p">[</span><span class="n">ceil</span><span class="p">(</span><span class="n">Q</span> <span class="o">/</span> <span class="n">tpb</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">ceil</span><span class="p">(</span><span class="n">N</span> <span class="o">/</span> <span class="n">tpb</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>  <span class="c1"># block_per_grid</span>
<span class="linenos">2877</span>
<span class="linenos">2878</span>    <span class="n">config</span> <span class="o">=</span> <span class="n">_kernel</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">bpg</span><span class="p">),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">tpb</span><span class="p">)]</span>
<span class="linenos">2879</span>    <span class="n">config</span><span class="p">(</span><span class="n">weight</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">isign</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
<span class="linenos">2880</span>    <span class="k">return</span> <span class="n">out</span>
<span class="linenos">2881</span>
<span class="linenos">2882</span>
<span class="linenos">2883</span><span class="nd">@pxu</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="s2">&quot;weight&quot;</span><span class="p">,</span> <span class="n">NUMPY</span><span class="o">=</span><span class="n">_nudft_NUMPY</span><span class="p">,</span> <span class="n">CUPY</span><span class="o">=</span><span class="n">_nudft_CUPY</span><span class="p">)</span>
<span class="linenos">2884</span><span class="k">def</span> <span class="nf">_nudft</span><span class="p">(</span>
<span class="linenos">2885</span>    <span class="n">weight</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">,</span>  <span class="c1"># (Q, M) weights (n_trans=Q) [complex64/128]</span>
<span class="linenos">2886</span>    <span class="n">source</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">,</span>  <span class="c1"># (M, D) sample points [float32/64]</span>
<span class="linenos">2887</span>    <span class="n">target</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">,</span>  <span class="c1"># (N, D) query points [float32/64]</span>
<span class="linenos">2888</span>    <span class="o">*</span><span class="p">,</span>
<span class="linenos">2889</span>    <span class="n">isign</span><span class="p">:</span> <span class="n">SignT</span><span class="p">,</span>
<span class="linenos">2890</span>    <span class="n">dtype</span><span class="p">:</span> <span class="n">pxt</span><span class="o">.</span><span class="n">DType</span><span class="p">,</span>  <span class="c1"># complex64/128</span>
<span class="linenos">2891</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pxt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>  <span class="c1"># (Q, N) complex64/128</span>
<span class="linenos">2892</span>    <span class="k">pass</span>
</pre></div>

                </article>
              
              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
<div id="searchbox"></div></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../../../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../../../../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">
  <p class="copyright">
    
       Copyright 2023, M. Simeoni, S. Kashani, J. Ru-Queralt &amp; Pyxu Developers.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">
  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.5.
    <br/>
  </p>
</div>
      
        <div class="footer-item"><p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.13.3.
</p></div>
      
    </div>
  
  
    <div class="footer-items__end">
      
        <div class="footer-item"><p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.13.3.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>