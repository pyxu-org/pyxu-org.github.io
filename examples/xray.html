
<!DOCTYPE html>

<html data-theme="light" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/><meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Advanced Computerized Tomography with Pyxu — Pyxu Documentation</title>
<script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "light";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
<!-- Loaded before other Sphinx assets -->
<link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet"/>
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet"/>
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet"/>
<link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet"/>
<link as="font" crossorigin="" href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" rel="preload" type="font/woff2"/>
<link href="../_static/pygments.css?v=fa44fd50" rel="stylesheet" type="text/css"/>
<link href="../_static/plot_directive.css?v=7f9a90b1" rel="stylesheet" type="text/css"/>
<link href="../_static/sphinx-codeautolink.css?v=125d5c1c" rel="stylesheet" type="text/css"/>
<link href="../_static/copybutton.css?v=76b2166b" rel="stylesheet" type="text/css"/>
<link href="../_static/togglebutton.css?v=13237357" rel="stylesheet" type="text/css"/>
<link href="../_static/sg_gallery.css?v=61a4c737" rel="stylesheet" type="text/css"/>
<link href="../_static/sg_gallery-binder.css?v=f4aeca0c" rel="stylesheet" type="text/css"/>
<link href="../_static/sg_gallery-dataframe.css?v=2082cf3c" rel="stylesheet" type="text/css"/>
<link href="../_static/sg_gallery-rendered-html.css?v=1277b6f3" rel="stylesheet" type="text/css"/>
<link href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" rel="stylesheet" type="text/css"/>
<link href="../_static/nbsphinx-code-cells.css?v=2aa19091" rel="stylesheet" type="text/css"/>
<link href="../_static/css/custom.css?v=14df3d68" rel="stylesheet" type="text/css"/>
<!-- Pre-loaded scripts that we'll load fully later -->
<link as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" rel="preload"/>
<link as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" rel="preload"/>
<script src="../_static/documentation_options.js?v=0b294dfe"></script>
<script src="../_static/doctools.js?v=888ff710"></script>
<script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
<script src="../_static/clipboard.min.js?v=a7894cd8"></script>
<script src="../_static/copybutton.js?v=30646c52"></script>
<script>let toggleHintShow = 'Click to show';</script>
<script>let toggleHintHide = 'Click to hide';</script>
<script>let toggleOpenOnPrint = 'true';</script>
<script src="../_static/togglebutton.js?v=4a39c7ea"></script>
<script src="../_static/design-tabs.js?v=36754332"></script>
<script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
<script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
<script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
<script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
<script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script>DOCUMENTATION_OPTIONS.pagename = 'examples/xray';</script>
<link href="../_static/favicon.png" rel="icon"/>
<link href="../genindex.html" rel="index" title="Index"/>
<link href="../search.html" rel="search" title="Search"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="en" name="docsearch:language"/>
</head>
<body data-bs-root-margin="0px 0px -60%" data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-default-mode="light" data-offset="180">
<a class="skip-link" href="#main-content">Skip to main content</a>
<input class="sidebar-toggle" id="__primary" name="__primary" type="checkbox"/>
<label class="overlay overlay-primary" for="__primary"></label>
<input class="sidebar-toggle" id="__secondary" name="__secondary" type="checkbox"/>
<label class="overlay overlay-secondary" for="__secondary"></label>
<div class="search-button__wrapper">
<div class="search-button__overlay"></div>
<div class="search-button__search-container">
<form action="../search.html" class="bd-search d-flex align-items-center" method="get">
<i class="fa-solid fa-magnifying-glass"></i>
<input aria-label="Search the docs ..." autocapitalize="off" autocomplete="off" autocorrect="off" class="form-control" id="search-input" name="q" placeholder="Search the docs ..." spellcheck="false" type="search"/>
<span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
</div>
<nav class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
<label class="sidebar-toggle primary-toggle" for="__primary">
<span class="fa-solid fa-bars"></span>
</label>
<div class="navbar-header-items__start">
<div class="navbar-item">
<a class="navbar-brand logo" href="../index.html">
<img alt="Logo image" class="logo__image only-light" src="../_static/logo.png"/>
<script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
</a></div>
</div>
<div class="col-lg-9 navbar-header-items">
<div class="me-auto navbar-header-items__center">
<div class="navbar-item"><nav class="navbar-nav">
<p aria-label="Site Navigation" aria-level="1" class="sidebar-header-items__title" role="heading">
    Site Navigation
  </p>
<ul class="bd-navbar-elements navbar-nav">
<li class="nav-item">
<a class="nav-link nav-internal" href="../intro/index.html">
                        Getting Started
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../guide/index.html">
                        User Guide
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="index.html">
                        Example Gallery
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../api/index.html">
                        API Reference
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../fair/index.html">
                        Extending Pyxu
                      </a>
</li>
</ul>
</nav></div>
</div>
<div class="navbar-header-items__end">
<div class="navbar-item navbar-persistent--container">
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
</div>
<div class="navbar-item"><strong> Pyxu v1.1.0 </strong></div>
<div class="navbar-item"><ul aria-label="Icon Links" class="navbar-icon-links navbar-nav">
<li class="nav-item">
<a class="nav-link" data-bs-placement="bottom" data-bs-toggle="tooltip" href="https://github.com/matthieumeo/pyxu" rel="noopener" target="_blank" title="GitHub"><span><i class="fa-brands fa-github"></i></span>
<label class="sr-only">GitHub</label></a>
</li>
<li class="nav-item">
<a class="nav-link" data-bs-placement="bottom" data-bs-toggle="tooltip" href="https://pypi.org/project/pyxu/" rel="noopener" target="_blank" title="PyPI"><span><i class="fa-brands fa-python"></i></span>
<label class="sr-only">PyPI</label></a>
</li>
<li class="nav-item">
<a class="nav-link" data-bs-placement="bottom" data-bs-toggle="tooltip" href="mailto: contact@pyxu.org" rel="noopener" target="_blank" title="Contact"><span><i class="fa-brands fa-telegram"></i></span>
<label class="sr-only">Contact</label></a>
</li>
<li class="nav-item">
<a class="nav-link" data-bs-placement="bottom" data-bs-toggle="tooltip" href="https://imaging.epfl.ch/" rel="noopener" target="_blank" title="EPFL Center for Imaging"><img alt="EPFL Center for Imaging" class="icon-link-image" src="../_static/imaging.png"/></a>
</li>
</ul></div>
</div>
</div>
<div class="navbar-persistent--mobile">
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
</div>
<label class="sidebar-toggle secondary-toggle" for="__secondary">
<span class="fa-solid fa-outdent"></span>
</label>
</div>
</nav>
<div class="bd-container">
<div class="bd-container__inner bd-page-width">
<div class="bd-sidebar-primary bd-sidebar hide-on-wide">
<div class="sidebar-header-items sidebar-primary__section">
<div class="sidebar-header-items__center">
<div class="navbar-item"><nav class="navbar-nav">
<p aria-label="Site Navigation" aria-level="1" class="sidebar-header-items__title" role="heading">
    Site Navigation
  </p>
<ul class="bd-navbar-elements navbar-nav">
<li class="nav-item">
<a class="nav-link nav-internal" href="../intro/index.html">
                        Getting Started
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../guide/index.html">
                        User Guide
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="index.html">
                        Example Gallery
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../api/index.html">
                        API Reference
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../fair/index.html">
                        Extending Pyxu
                      </a>
</li>
</ul>
</nav></div>
</div>
<div class="sidebar-header-items__end">
<div class="navbar-item"><strong> Pyxu v1.1.0 </strong></div>
<div class="navbar-item"><ul aria-label="Icon Links" class="navbar-icon-links navbar-nav">
<li class="nav-item">
<a class="nav-link" data-bs-placement="bottom" data-bs-toggle="tooltip" href="https://github.com/matthieumeo/pyxu" rel="noopener" target="_blank" title="GitHub"><span><i class="fa-brands fa-github"></i></span>
<label class="sr-only">GitHub</label></a>
</li>
<li class="nav-item">
<a class="nav-link" data-bs-placement="bottom" data-bs-toggle="tooltip" href="https://pypi.org/project/pyxu/" rel="noopener" target="_blank" title="PyPI"><span><i class="fa-brands fa-python"></i></span>
<label class="sr-only">PyPI</label></a>
</li>
<li class="nav-item">
<a class="nav-link" data-bs-placement="bottom" data-bs-toggle="tooltip" href="mailto: contact@pyxu.org" rel="noopener" target="_blank" title="Contact"><span><i class="fa-brands fa-telegram"></i></span>
<label class="sr-only">Contact</label></a>
</li>
<li class="nav-item">
<a class="nav-link" data-bs-placement="bottom" data-bs-toggle="tooltip" href="https://imaging.epfl.ch/" rel="noopener" target="_blank" title="EPFL Center for Imaging"><img alt="EPFL Center for Imaging" class="icon-link-image" src="../_static/imaging.png"/></a>
</li>
</ul></div>
</div>
</div>
<div class="sidebar-primary-items__end sidebar-primary__section">
</div>
<div id="rtd-footer-container"></div>
</div>
<main class="bd-main" id="main-content">
<div class="bd-content">
<div class="bd-article-container">
<div class="bd-header-article">
<div class="header-article-items header-article__inner">
<div class="header-article-items__start">
<div class="header-article-item">
<nav aria-label="Breadcrumbs">
<ul aria-label="Breadcrumb" class="bd-breadcrumbs" role="navigation">
<li class="breadcrumb-item breadcrumb-home">
<a aria-label="Home" class="nav-link" href="../index.html">
<i class="fa-solid fa-home"></i>
</a>
</li>
<li aria-current="page" class="breadcrumb-item active">Advanced Computerized Tomography with Pyxu</li>
</ul>
</nav>
</div>
</div>
</div>
</div>
<div id="searchbox"></div>
<article class="bd-article" role="main">
<section id="Advanced-Computerized-Tomography-with-Pyxu">
<h1>Advanced Computerized Tomography with Pyxu<a class="headerlink" href="#Advanced-Computerized-Tomography-with-Pyxu" title="Link to this heading">#</a></h1>
<p>The <a class="reference external" href="../intro/tomo.html">introductory tutorial</a> on tomography showed how to simulate a tomographic setup using Pyxu, where we piggy-backed on the <code class="docutils literal notranslate"><span class="pre">radon()</span></code><a class="reference external" href="https://scikit-image.org/docs/stable/api/skimage.transform.html#skimage.transform.radon">🔗</a> and <code class="docutils literal notranslate"><span class="pre">iradon()</span></code><a class="reference external" href="https://scikit-image.org/docs/stable/api/skimage.transform.html#skimage.transform.iradon">🔗</a> functions from <code class="docutils literal notranslate"><span class="pre">scikit-image</span></code> to define the <code class="docutils literal notranslate"><span class="pre">apply</span></code> and <code class="docutils literal notranslate"><span class="pre">adjoint</span></code> methods of the Radon operator.</p>
<p>While we could obtain good reconstructions with this Radon implementation, scikit’s operator is limited to 2D parallel beam projections: there is no support for alternative scanning geometries such as fan-beam. Moreover 3D transforms are unavailable.</p>
<p>This notebook is focused around Pyxu’s <code class="docutils literal notranslate"><span class="pre">XRayTransform()</span></code><a class="reference external" href="../api/experimental/xray.html#pyxu.experimental.xray.XRayTransform">🔗</a> class, a flexible frontend to 2 high-performance Radon/XRay implementations for 2D/3D setups. The goal is to show how to create different scanning geometries and their effect on image quality <strong>if we do not perform regularization</strong>.</p>
<p>Let’s get started!</p>
<section id="Preliminaries">
<h2>Preliminaries<a class="headerlink" href="#Preliminaries" title="Link to this heading">#</a></h2>
<p>The X-Ray Transform (XRT) of a function <span class="math notranslate nohighlight">\(f: \mathbb{R}^{D} \to \mathbb{R}\)</span> is defined as</p>
<div class="math notranslate nohighlight">
\[\mathcal{P}[f](\mathbf{n}, \mathbf{t})
=
\int_{\mathbb{R}} f(\mathbf{t} + \mathbf{n} \alpha) d\alpha,\]</div>
<p>where <span class="math notranslate nohighlight">\(\mathbf{n}\in \mathbb{S}^{D-1}\)</span> and <span class="math notranslate nohighlight">\(\mathbf{t} \in \mathbf{n}^{\perp}\)</span>. <span class="math notranslate nohighlight">\(\mathcal{P}[f]\)</span> hence denotes the set of <em>line integrals</em> of <span class="math notranslate nohighlight">\(f\)</span>.</p>
<p>Two class of algorithms exist to evaluate the XRT:</p>
<ul class="simple">
<li><p><strong>Fourier methods</strong> leverage the <a class="reference external" href="https://en.wikipedia.org/wiki/Projection-slice_theorem">Fourier Slice Theorem (FST)</a> to efficiently evaluate the XRT <em>when multiple values of</em> <span class="math notranslate nohighlight">\(\mathbf{t}\)</span> <em>are desired for each</em> <span class="math notranslate nohighlight">\(\mathbf{n}\)</span>.</p></li>
<li><p><strong>Ray methods</strong> compute estimates of the XRT via quadrature rules by assuming <span class="math notranslate nohighlight">\(f\)</span> is piecewise constant on short intervals.</p></li>
</ul>
<p>Pyxu’s <code class="docutils literal notranslate"><span class="pre">XRayTransform()</span></code><a class="reference external" href="../api/experimental.xray.html#pyxu.experimental.xray.XRayTransform">🔗</a> efficiently evaluates samples of the XRT assuming <span class="math notranslate nohighlight">\(f\)</span> is a pixelized image/volume where:</p>
<ul class="simple">
<li><p>the lower-left element of <span class="math notranslate nohighlight">\(f\)</span> is located at <span class="math notranslate nohighlight">\(\mathbf{o} \in \mathbb{R}^{D}\)</span>,</p></li>
<li><p>pixel dimensions are <span class="math notranslate nohighlight">\(\mathbf{\Delta} \in \mathbb{R}_{+}^{D}\)</span>, i.e.</p></li>
</ul>
<div class="math notranslate nohighlight">
\[f(\mathbf{r}) = \sum_{\{\mathbf{q}\} \subset \mathbb{N}^{D}}
                \alpha_{\mathbf{q}}
                1_{[\mathbf{0}, \mathbf{\Delta}]}(\mathbf{r} - \mathbf{q} \odot \mathbf{\Delta} - \mathbf{o}),
\quad
\alpha_{\mathbf{q}} \in \mathbb{R}.\]</div>
<p>In the 2D case, the parametrization is best explained by the figure below:</p>
<center><p><img alt="2D XRay Geometry" class="no-scaled-link" src="../_images/xray_parametrization.svg" width="35%"/></p>
</center></section>
<section id="2D-Imaging">
<h2>2D Imaging<a class="headerlink" href="#2D-Imaging" title="Link to this heading">#</a></h2>
<p>Let’s try to reconstruct a phantom using different scanning geometries, each having the same number of total rays cast into the medium:</p>
<ul class="simple">
<li><p>2D parallel beam with equi-spaced offsets.</p></li>
<li><p>2D parallel beam with non-uniform offsets.</p></li>
<li><p>2D fan beam.</p></li>
</ul>
<p>We will use the phantom below for all experiments.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_2D_phantom</span><span class="p">(</span><span class="n">shape</span><span class="p">:</span> <a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/stdtypes.html#tuple" title="tuple"><span class="nb">tuple</span></a><span class="p">[</span><a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/functions.html#int" title="int"><span class="nb">int</span></a><span class="p">],</span> <span class="n">seed</span><span class="p">:</span> <a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/functions.html#int" title="int"><span class="nb">int</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="c1"># in: (N_h, N_w) phantom dimensions [px]</span>
    <span class="c1"># out: (N_h, N_w) phantom</span>
    <span class="kn">import</span> <span class="nn">xdesign</span> <span class="k">as</span> <span class="nn">xd</span>

    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">substrate</span> <span class="o">=</span> <span class="n">xd</span><span class="o">.</span><span class="n">Foam</span><span class="p">(</span><span class="n">size_range</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">],</span> <span class="n">gap</span><span class="o">=</span><span class="mf">0.025</span><span class="p">,</span> <span class="n">porosity</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">I</span> <span class="o">=</span> <span class="n">xd</span><span class="o">.</span><span class="n">discrete_phantom</span><span class="p">(</span><span class="n">substrate</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/functions.html#int" title="int"><span class="nb">int</span></a><span class="p">))</span>  <span class="c1"># produce image at average resolution</span>
    <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/functions.html#int" title="int"><span class="nb">int</span></a><span class="p">(</span><span class="mf">0.05</span> <span class="o">*</span> <span class="n">I</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>  <span class="c1"># 5% axial pad</span>

    <span class="n">I</span> <span class="o">=</span> <span class="n">ski</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">rescale</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">/</span> <span class="n">I</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># rescale to user dimensions</span>
    <span class="n">I</span> <span class="o">=</span> <span class="p">(</span><span class="n">I</span> <span class="o">-</span> <span class="n">I</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="n">I</span><span class="o">.</span><span class="n">ptp</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">I</span>

<span class="n">N_side</span> <span class="o">=</span> <span class="mi">512</span>  <span class="c1"># N_px = N_side**2</span>
<span class="n">pitch</span> <span class="o">=</span> <span class="mf">1e-4</span>  <span class="c1"># m/px [can differ per axis]</span>
<span class="n">phantom</span> <span class="o">=</span> <span class="n">create_2D_phantom</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">N_side</span><span class="p">,</span> <span class="n">N_side</span><span class="p">),</span> <span class="n">seed</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">im_kwargs</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/stdtypes.html#dict" title="dict"><span class="nb">dict</span></a><span class="p">(</span>
    <span class="n">origin</span><span class="o">=</span><span class="s2">"lower"</span><span class="p">,</span>
    <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">N_side</span> <span class="o">*</span> <span class="n">pitch</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">N_side</span> <span class="o">*</span> <span class="n">pitch</span><span class="p">],</span>
<span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">phantom</span><span class="p">,</span> <span class="o">**</span><span class="n">im_kwargs</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"x [m]"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"y [m]"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Phantom"</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 1.0, 'Phantom')
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_xray_5_1.png" src="../_images/examples_xray_5_1.png"/>
</div>
</div>
<section id="Parallel-Beam:-Uniform-Offsets">
<h3>Parallel Beam: Uniform Offsets<a class="headerlink" href="#Parallel-Beam:-Uniform-Offsets" title="Link to this heading">#</a></h3>
<p>Let’s first look at a baseline setup similar to what <code class="docutils literal notranslate"><span class="pre">scikit-image</span></code>’s <code class="docutils literal notranslate"><span class="pre">radon()</span></code><a class="reference external" href="https://scikit-image.org/docs/stable/api/skimage.transform.html#skimage.transform.radon">🔗</a> and <code class="docutils literal notranslate"><span class="pre">iradon()</span></code><a class="reference external" href="https://scikit-image.org/docs/stable/api/skimage.transform.html#skimage.transform.iradon">🔗</a> functions would produce: a parallel-beam scan with equi-spaced lines and uniformly-distributed scan directions.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N_angle</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">N_offset</span> <span class="o">=</span> <span class="mi">200</span>

<span class="c1"># Let's build the necessary components to instantiate the operator. ========================</span>
<span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">N_angle</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">n</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>  <span class="c1"># &lt;n, t&gt; = 0</span>
<span class="n">t_max</span> <span class="o">=</span> <span class="n">pitch</span> <span class="o">*</span> <span class="n">N_side</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="mf">1.1</span>  <span class="c1"># 10% over ball radius</span>
<span class="n">t_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">t_max</span><span class="p">,</span> <span class="n">t_max</span><span class="p">,</span> <span class="n">N_offset</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">n_spec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">N_angle</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="n">N_angle</span><span class="p">,</span> <span class="n">N_offset</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>  <span class="c1"># (N_angle, N_offset, 2)</span>
<span class="n">t_spec</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">N_angle</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">t_offset</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">N_offset</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># (N_angle, N_offset, 2)</span>
<span class="n">t_spec</span> <span class="o">+=</span> <span class="n">pitch</span> <span class="o">*</span> <span class="n">N_side</span> <span class="o">/</span> <span class="mi">2</span>  <span class="c1"># Move anchor point to the center of volume.</span>
<span class="c1"># ==========================================================================================</span>

<span class="n">op_para_u</span> <span class="o">=</span> <span class="n">pxr</span><span class="o">.</span><span class="n">XRayTransform</span><span class="o">.</span><span class="n">init</span><span class="p">(</span>
    <span class="n">arg_shape</span><span class="o">=</span><span class="p">(</span><span class="n">N_side</span><span class="p">,</span> <span class="n">N_side</span><span class="p">),</span>
    <span class="n">origin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>  <span class="c1"># bottom-left corner of volume located at (0, 0)</span>
    <span class="n">pitch</span><span class="o">=</span><span class="n">pitch</span><span class="p">,</span>  <span class="c1"># pixel dimensions. (Can vary per axis.)</span>
    <span class="n">method</span><span class="o">=</span><span class="s2">"ray-trace"</span><span class="p">,</span>
    <span class="n">n_spec</span><span class="o">=</span><span class="n">n_spec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>  <span class="c1"># (N_ray, 2) directions</span>
    <span class="n">t_spec</span><span class="o">=</span><span class="n">t_spec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>  <span class="c1"># (N_ray, 2)</span>
<span class="p">)</span>
<br/></pre></div>
</div>
</div>
<p>It can be tricky to correctly parametrize the rays. The <code class="docutils literal notranslate"><span class="pre">diagnostic_plot()</span></code> method can be used to verify everything is correct. By default <code class="docutils literal notranslate"><span class="pre">diagnostic_plot()</span></code> shows all rays going through the volume. For visualization purposes, let’s only plot every <span class="math notranslate nohighlight">\(N\)</span>-th angle and <span class="math notranslate nohighlight">\(K\)</span>-th offset.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span><span class="p">,</span> <span class="n">K</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span>
<span class="n">ray_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N_angle</span> <span class="o">*</span> <span class="n">N_offset</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">N_angle</span><span class="p">,</span> <span class="n">N_offset</span><span class="p">)[::</span><span class="n">N</span><span class="p">,::</span><span class="n">K</span><span class="p">]</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">op_para_u</span><span class="o">.</span><span class="n">diagnostic_plot</span><span class="p">(</span><span class="n">ray_idx</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_xray_9_0.png" src="../_images/examples_xray_9_0.png"/>
</div>
</div>
<p>The construction seems ok for a parallel-beam scan: angles/offsets are distributed uniformily, and we can already see that the lines <em>concentrate</em> in the center of the volume. (More on this later.)</p>
<p>Now that we created the XRay operator, let’s compute the sinogram and visualize it.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute sinogram</span>
<span class="n">sinogram</span> <span class="o">=</span> <span class="n">op_para_u</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">phantom</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">N_angle</span><span class="p">,</span> <span class="n">N_offset</span><span class="p">)</span>  <span class="c1"># (N_angle, N_offset)</span>


<span class="c1"># And plot it</span>
<span class="n">N_level</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ANGLE</span><span class="p">,</span> <span class="n">OFFSET</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">t_offset</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s2">"ij"</span><span class="p">)</span>
<span class="n">contour</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span>
    <span class="n">ANGLE</span><span class="p">,</span>
    <span class="n">OFFSET</span><span class="p">,</span>
    <span class="n">sinogram</span><span class="p">,</span>
    <span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sinogram</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">N_level</span><span class="p">),</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">'grey'</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">contour</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">"$\angle \mathbf</span><span class="si">{n}</span><span class="s2">$"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span>
    <span class="n">ticks</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">],</span>
    <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s2">"0"</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"$\frac{\pi}</span><span class="si">{2}</span><span class="s2">$"</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"$\pi$"</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">"lateral offset [m]"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span>
    <span class="n">ticks</span><span class="o">=</span><span class="p">[</span><span class="n">t_offset</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">t_offset</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span>
    <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">);</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_xray_11_0.png" src="../_images/examples_xray_11_0.png"/>
</div>
</div>
<p>Now that we have the sinogram, let’s invert the imaging process to (try to) reconstruct an image which produced it. We will try 2 methods:</p>
<ul class="simple">
<li><p>Plain back-projection of the sinogram data into the image domain.</p></li>
<li><p>Forming the least-squares image. The conventional Filtered-BackProjection algorithm (FBP) should produce similar images, but let’s stick to an undampened CG method to compute the pseudo-inverse for simplicity.</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute backprojected image and LSQ image. =======================</span>
<span class="n">I_BP</span> <span class="o">=</span> <span class="n">op_para_u</span><span class="o">.</span><span class="n">adjoint</span><span class="p">(</span><span class="n">sinogram</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">phantom</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">I_LSQ</span> <span class="o">=</span> <span class="n">op_para_u</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">sinogram</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">damp</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">phantom</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Plot the images ==================================================</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">phantom</span><span class="p">,</span> <span class="o">**</span><span class="n">im_kwargs</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">I_BP</span><span class="p">),</span> <span class="o">**</span><span class="n">im_kwargs</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">I_LSQ</span><span class="p">,</span> <span class="o">**</span><span class="n">im_kwargs</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Ground-Truth"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"log-BackProj"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"LS"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">_ax</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">:</span>
    <span class="n">_ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">"off"</span><span class="p">)</span>

<span class="c1"># aliases to compare against fan-beam later on.</span>
<span class="n">I_BP_u</span> <span class="o">=</span> <span class="n">I_BP</span>
<span class="n">I_LSQ_u</span> <span class="o">=</span> <span class="n">I_LSQ</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
INFO:/tmp/pyxu_nqhe46r2:[2023-11-02 15:05:21.625205] Iteration 0
        iteration: 0
        AbsError[residual]: 0.05687622737895547
        N_iter: 1.0
INFO:/tmp/pyxu_nqhe46r2:[2023-11-02 15:05:22.035556] Iteration 1
        iteration: 1
        AbsError[residual]: 0.06557017379381164
        N_iter: 2.0
INFO:/tmp/pyxu_nqhe46r2:[2023-11-02 15:05:22.436203] Iteration 2
        iteration: 2
        AbsError[residual]: 0.005995962885020177
        N_iter: 3.0
INFO:/tmp/pyxu_nqhe46r2:[2023-11-02 15:05:22.821280] Iteration 3
        iteration: 3
        AbsError[residual]: 0.00200349375989515
        N_iter: 4.0
INFO:/tmp/pyxu_nqhe46r2:[2023-11-02 15:05:23.230381] Iteration 4
        iteration: 4
        AbsError[residual]: 0.008496910984158959
        N_iter: 5.0
INFO:/tmp/pyxu_nqhe46r2:[2023-11-02 15:05:23.617034] Iteration 5
        iteration: 5
        AbsError[residual]: 0.0009511932090629814
        N_iter: 6.0
INFO:/tmp/pyxu_nqhe46r2:[2023-11-02 15:05:24.036326] Iteration 6
        iteration: 6
        AbsError[residual]: 0.0005980549190576326
        N_iter: 7.0
INFO:/tmp/pyxu_nqhe46r2:[2023-11-02 15:05:24.479982] Iteration 7
        iteration: 7
        AbsError[residual]: 0.0005385074691672622
        N_iter: 8.0
INFO:/tmp/pyxu_nqhe46r2:[2023-11-02 15:05:24.922761] Iteration 8
        iteration: 8
        AbsError[residual]: 0.0013588506056697075
        N_iter: 9.0
INFO:/tmp/pyxu_nqhe46r2:[2023-11-02 15:05:25.344982] Iteration 9
        iteration: 9
        AbsError[residual]: 0.00031133777340682607
        N_iter: 10.0
INFO:/tmp/pyxu_nqhe46r2:[2023-11-02 15:05:25.724944] Iteration 10
        iteration: 10
        AbsError[residual]: 0.0002170788817839002
        N_iter: 11.0
INFO:/tmp/pyxu_nqhe46r2:[2023-11-02 15:05:26.103988] Iteration 11
        iteration: 11
        AbsError[residual]: 0.00036685570387762087
        N_iter: 12.0
INFO:/tmp/pyxu_nqhe46r2:[2023-11-02 15:05:26.482316] Iteration 12
        iteration: 12
        AbsError[residual]: 0.0002774264159603471
        N_iter: 13.0
INFO:/tmp/pyxu_nqhe46r2:[2023-11-02 15:05:26.858245] Iteration 13
        iteration: 13
        AbsError[residual]: 0.00016839394398493801
        N_iter: 14.0
INFO:/tmp/pyxu_nqhe46r2:[2023-11-02 15:05:27.237286] Iteration 14
        iteration: 14
        AbsError[residual]: 9.819763790838799e-05
        N_iter: 15.0
INFO:/tmp/pyxu_nqhe46r2:[2023-11-02 15:05:27.237929] Stopping Criterion satisfied -&gt; END
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_xray_13_1.png" src="../_images/examples_xray_13_1.png"/>
</div>
</div>
<p>Some high-level remarks just by looking at these images:</p>
<ul class="simple">
<li><p>The backprojected image has very low contrast: we barely can make out the porous structures in the background, even in log-scale.</p></li>
<li><p>The least-squares image allows us to identify the porous structure more easily. However the peripheral region is significantly more “blurry” than the central region. This is because the ray density is higher in the central region than in the periphery.</p></li>
</ul>
</section>
<section id="Parallel-Beam:-Non-Uniform-Offsets">
<h3>Parallel Beam: Non-Uniform Offsets<a class="headerlink" href="#Parallel-Beam:-Non-Uniform-Offsets" title="Link to this heading">#</a></h3>
<p>One option to homogenize radial resolution is to move away from uniformly sampling <span class="math notranslate nohighlight">\(t \in [-t_{\mathrm{offset}}^{\max}, t_{\mathrm{offset}}^{\max}]\)</span>, and instead sample it more densely at the peripheral regions. Let’s define a radius <span class="math notranslate nohighlight">\(r \in ]0, t_{\mathrm{offset}}^{\max}[\)</span> such that the number of offsets inside/outside the boundary are equal. We’ll image the phantom at different <span class="math notranslate nohighlight">\(r\)</span> values and see how the radial resolution changes.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We only need to change `t_spec` to create our non-uniformly sampled XRT.</span>
<span class="n">radial_threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.55</span><span class="p">]</span>

<span class="n">op_para_nu</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">rt</span> <span class="ow">in</span> <span class="n">radial_threshold</span><span class="p">:</span>
    <span class="c1"># Let's build the necessary components to instantiate the operator. ========================</span>
    <span class="n">t_max</span> <span class="o">=</span> <span class="n">pitch</span> <span class="o">*</span> <span class="n">N_side</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># we go until the diagonal max size now.</span>
    <span class="n">t_offset_inside</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">t_max</span> <span class="o">*</span> <span class="n">rt</span><span class="p">,</span> <span class="n">t_max</span> <span class="o">*</span> <span class="n">rt</span><span class="p">,</span> <span class="n">N_offset</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">t_offset_outside</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">t_max</span> <span class="o">*</span> <span class="n">rt</span><span class="p">,</span> <span class="n">t_max</span><span class="p">,</span> <span class="n">N_offset</span><span class="o">//</span><span class="mi">4</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">t_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="o">-</span><span class="n">t_offset_outside</span><span class="p">,</span> <span class="n">t_offset_inside</span><span class="p">,</span> <span class="n">t_offset_outside</span><span class="p">]</span>


    <span class="n">t_spec</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">N_angle</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">t_offset</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">N_offset</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># (N_angle, N_offset, 2)</span>
    <span class="n">t_spec</span> <span class="o">+=</span> <span class="n">pitch</span> <span class="o">*</span> <span class="n">N_side</span> <span class="o">/</span> <span class="mi">2</span>  <span class="c1"># Move anchor point to the center of volume.</span>
    <span class="c1"># ==========================================================================================</span>

    <span class="n">op</span> <span class="o">=</span> <span class="n">pxr</span><span class="o">.</span><span class="n">XRayTransform</span><span class="o">.</span><span class="n">init</span><span class="p">(</span>
        <span class="n">arg_shape</span><span class="o">=</span><span class="p">(</span><span class="n">N_side</span><span class="p">,</span> <span class="n">N_side</span><span class="p">),</span>
        <span class="n">origin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>  <span class="c1"># bottom-left corner of volume located at (0, 0)</span>
        <span class="n">pitch</span><span class="o">=</span><span class="n">pitch</span><span class="p">,</span>  <span class="c1"># pixel dimensions. (Can vary per axis.)</span>
        <span class="n">method</span><span class="o">=</span><span class="s2">"ray-trace"</span><span class="p">,</span>
        <span class="n">n_spec</span><span class="o">=</span><span class="n">n_spec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>  <span class="c1"># (N_ray, 2) directions</span>
        <span class="n">t_spec</span><span class="o">=</span><span class="n">t_spec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>  <span class="c1"># (N_ray, 2)</span>
    <span class="p">)</span>
    <span class="n">op_para_nu</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">rt</span><span class="p">,</span> <span class="n">op</span><span class="p">))</span>
<br/></pre></div>
</div>
</div>
<p>Let’s look again at <code class="docutils literal notranslate"><span class="pre">diagnostic_plot()</span></code> to make sure the offsets are effectively non-uniform. (We’ll plot one angle only for visualization purposes.)</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ray_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N_angle</span> <span class="o">*</span> <span class="n">N_offset</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">N_angle</span><span class="p">,</span> <span class="n">N_offset</span><span class="p">)[</span><span class="mi">10</span><span class="p">,:]</span>

<span class="k">for</span> <span class="n">rt</span><span class="p">,</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">op_para_nu</span><span class="p">:</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">diagnostic_plot</span><span class="p">(</span><span class="n">ray_idx</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">"$r = </span><span class="si">{</span><span class="n">rt</span><span class="si">}</span><span class="s2">$"</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_xray_18_0.png" src="../_images/examples_xray_18_0.png"/>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_xray_18_1.png" src="../_images/examples_xray_18_1.png"/>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_xray_18_2.png" src="../_images/examples_xray_18_2.png"/>
</div>
</div>
<p>The lines seem about right, so let’s see what the resolution looks like:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N_op</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/functions.html#len" title="len"><span class="nb">len</span></a><span class="p">(</span><span class="n">op_para_nu</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="n">N_op</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Ground-Truth"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">phantom</span><span class="p">,</span> <span class="o">**</span><span class="n">im_kwargs</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">"off"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"uniform-offset"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">I_LSQ</span><span class="p">,</span> <span class="o">**</span><span class="n">im_kwargs</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">"off"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span> <span class="ow">in</span> <a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/functions.html#enumerate" title="enumerate"><span class="nb">enumerate</span></a><span class="p">(</span><span class="n">op_para_nu</span><span class="p">):</span>
    <span class="c1"># Compute LSQ image. ===============================================</span>
    <span class="n">sinogram</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">phantom</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">N_angle</span><span class="p">,</span> <span class="n">N_offset</span><span class="p">)</span>
    <span class="n">I_LSQ</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">sinogram</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">damp</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">phantom</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="c1"># Plot it ==========================================================</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">I_LSQ</span><span class="p">,</span> <span class="o">**</span><span class="n">im_kwargs</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"$r=</span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s2">$"</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">"off"</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
INFO:/tmp/pyxu__a3j8z1b:[2023-11-02 15:57:02.085322] Iteration 0
        iteration: 0
        AbsError[residual]: 0.06083631599882158
        N_iter: 1.0
INFO:/tmp/pyxu__a3j8z1b:[2023-11-02 15:57:02.448879] Iteration 1
        iteration: 1
        AbsError[residual]: 0.06578516446141662
        N_iter: 2.0
INFO:/tmp/pyxu__a3j8z1b:[2023-11-02 15:57:02.795919] Iteration 2
        iteration: 2
        AbsError[residual]: 0.00798533484005245
        N_iter: 3.0
INFO:/tmp/pyxu__a3j8z1b:[2023-11-02 15:57:03.165755] Iteration 3
        iteration: 3
        AbsError[residual]: 0.003094276181013245
        N_iter: 4.0
INFO:/tmp/pyxu__a3j8z1b:[2023-11-02 15:57:03.519540] Iteration 4
        iteration: 4
        AbsError[residual]: 0.003677420194809119
        N_iter: 5.0
INFO:/tmp/pyxu__a3j8z1b:[2023-11-02 15:57:03.873239] Iteration 5
        iteration: 5
        AbsError[residual]: 0.00154224789194649
        N_iter: 6.0
INFO:/tmp/pyxu__a3j8z1b:[2023-11-02 15:57:04.256761] Iteration 6
        iteration: 6
        AbsError[residual]: 0.0011077690459421158
        N_iter: 7.0
INFO:/tmp/pyxu__a3j8z1b:[2023-11-02 15:57:04.599026] Iteration 7
        iteration: 7
        AbsError[residual]: 0.0011478545727175993
        N_iter: 8.0
INFO:/tmp/pyxu__a3j8z1b:[2023-11-02 15:57:04.954629] Iteration 8
        iteration: 8
        AbsError[residual]: 0.0005351391116486889
        N_iter: 9.0
INFO:/tmp/pyxu__a3j8z1b:[2023-11-02 15:57:05.320116] Iteration 9
        iteration: 9
        AbsError[residual]: 0.0018568674052228317
        N_iter: 10.0
INFO:/tmp/pyxu__a3j8z1b:[2023-11-02 15:57:05.699617] Iteration 10
        iteration: 10
        AbsError[residual]: 0.0003912409363852758
        N_iter: 11.0
INFO:/tmp/pyxu__a3j8z1b:[2023-11-02 15:57:06.052301] Iteration 11
        iteration: 11
        AbsError[residual]: 0.00023032652888550442
        N_iter: 12.0
INFO:/tmp/pyxu__a3j8z1b:[2023-11-02 15:57:06.405469] Iteration 12
        iteration: 12
        AbsError[residual]: 0.0004925694078794666
        N_iter: 13.0
INFO:/tmp/pyxu__a3j8z1b:[2023-11-02 15:57:06.779761] Iteration 13
        iteration: 13
        AbsError[residual]: 0.00022321689259305474
        N_iter: 14.0
INFO:/tmp/pyxu__a3j8z1b:[2023-11-02 15:57:07.151672] Iteration 14
        iteration: 14
        AbsError[residual]: 0.00013802876443840057
        N_iter: 15.0
INFO:/tmp/pyxu__a3j8z1b:[2023-11-02 15:57:07.520319] Iteration 15
        iteration: 15
        AbsError[residual]: 0.00018681278195342298
        N_iter: 16.0
INFO:/tmp/pyxu__a3j8z1b:[2023-11-02 15:57:07.888776] Iteration 16
        iteration: 16
        AbsError[residual]: 8.945616788750326e-05
        N_iter: 17.0
INFO:/tmp/pyxu__a3j8z1b:[2023-11-02 15:57:07.889269] Stopping Criterion satisfied -&gt; END
INFO:/tmp/pyxu_vzby51qs:[2023-11-02 15:57:08.463660] Iteration 0
        iteration: 0
        AbsError[residual]: 0.05587978235963257
        N_iter: 1.0
INFO:/tmp/pyxu_vzby51qs:[2023-11-02 15:57:08.878741] Iteration 1
        iteration: 1
        AbsError[residual]: 0.06411632865120671
        N_iter: 2.0
INFO:/tmp/pyxu_vzby51qs:[2023-11-02 15:57:09.231433] Iteration 2
        iteration: 2
        AbsError[residual]: 0.006470451070089179
        N_iter: 3.0
INFO:/tmp/pyxu_vzby51qs:[2023-11-02 15:57:09.591149] Iteration 3
        iteration: 3
        AbsError[residual]: 0.002110160298811039
        N_iter: 4.0
INFO:/tmp/pyxu_vzby51qs:[2023-11-02 15:57:09.943987] Iteration 4
        iteration: 4
        AbsError[residual]: 0.007383376206422935
        N_iter: 5.0
INFO:/tmp/pyxu_vzby51qs:[2023-11-02 15:57:10.315364] Iteration 5
        iteration: 5
        AbsError[residual]: 0.0011452535995901175
        N_iter: 6.0
INFO:/tmp/pyxu_vzby51qs:[2023-11-02 15:57:10.671398] Iteration 6
        iteration: 6
        AbsError[residual]: 0.0008150197713191819
        N_iter: 7.0
INFO:/tmp/pyxu_vzby51qs:[2023-11-02 15:57:11.027916] Iteration 7
        iteration: 7
        AbsError[residual]: 0.0006293635897970357
        N_iter: 8.0
INFO:/tmp/pyxu_vzby51qs:[2023-11-02 15:57:11.391504] Iteration 8
        iteration: 8
        AbsError[residual]: 0.0011972310173951667
        N_iter: 9.0
INFO:/tmp/pyxu_vzby51qs:[2023-11-02 15:57:11.758753] Iteration 9
        iteration: 9
        AbsError[residual]: 0.00036930096120571835
        N_iter: 10.0
INFO:/tmp/pyxu_vzby51qs:[2023-11-02 15:57:12.130178] Iteration 10
        iteration: 10
        AbsError[residual]: 0.00019861182883296077
        N_iter: 11.0
INFO:/tmp/pyxu_vzby51qs:[2023-11-02 15:57:12.507776] Iteration 11
        iteration: 11
        AbsError[residual]: 0.0002665008466789277
        N_iter: 12.0
INFO:/tmp/pyxu_vzby51qs:[2023-11-02 15:57:12.862428] Iteration 12
        iteration: 12
        AbsError[residual]: 0.0003984004605641113
        N_iter: 13.0
INFO:/tmp/pyxu_vzby51qs:[2023-11-02 15:57:13.231427] Iteration 13
        iteration: 13
        AbsError[residual]: 0.00016190790722508518
        N_iter: 14.0
INFO:/tmp/pyxu_vzby51qs:[2023-11-02 15:57:13.642948] Iteration 14
        iteration: 14
        AbsError[residual]: 8.831692053839597e-05
        N_iter: 15.0
INFO:/tmp/pyxu_vzby51qs:[2023-11-02 15:57:13.643521] Stopping Criterion satisfied -&gt; END
INFO:/tmp/pyxu_i3jnsx5v:[2023-11-02 15:57:14.206342] Iteration 0
        iteration: 0
        AbsError[residual]: 0.04912049936843101
        N_iter: 1.0
INFO:/tmp/pyxu_i3jnsx5v:[2023-11-02 15:57:14.550954] Iteration 1
        iteration: 1
        AbsError[residual]: 0.059035901920879576
        N_iter: 2.0
INFO:/tmp/pyxu_i3jnsx5v:[2023-11-02 15:57:14.958738] Iteration 2
        iteration: 2
        AbsError[residual]: 0.004886593680700907
        N_iter: 3.0
INFO:/tmp/pyxu_i3jnsx5v:[2023-11-02 15:57:15.325365] Iteration 3
        iteration: 3
        AbsError[residual]: 0.0019312505080778335
        N_iter: 4.0
INFO:/tmp/pyxu_i3jnsx5v:[2023-11-02 15:57:15.701409] Iteration 4
        iteration: 4
        AbsError[residual]: 0.008737888705976127
        N_iter: 5.0
INFO:/tmp/pyxu_i3jnsx5v:[2023-11-02 15:57:16.042200] Iteration 5
        iteration: 5
        AbsError[residual]: 0.0008519185620550029
        N_iter: 6.0
INFO:/tmp/pyxu_i3jnsx5v:[2023-11-02 15:57:16.397270] Iteration 6
        iteration: 6
        AbsError[residual]: 0.0005424006108261304
        N_iter: 7.0
INFO:/tmp/pyxu_i3jnsx5v:[2023-11-02 15:57:16.755044] Iteration 7
        iteration: 7
        AbsError[residual]: 0.00041813351788701805
        N_iter: 8.0
INFO:/tmp/pyxu_i3jnsx5v:[2023-11-02 15:57:17.118268] Iteration 8
        iteration: 8
        AbsError[residual]: 0.0008582720432987022
        N_iter: 9.0
INFO:/tmp/pyxu_i3jnsx5v:[2023-11-02 15:57:17.478996] Iteration 9
        iteration: 9
        AbsError[residual]: 0.00029155498997959523
        N_iter: 10.0
INFO:/tmp/pyxu_i3jnsx5v:[2023-11-02 15:57:17.829410] Iteration 10
        iteration: 10
        AbsError[residual]: 0.0002089021304178365
        N_iter: 11.0
INFO:/tmp/pyxu_i3jnsx5v:[2023-11-02 15:57:18.185754] Iteration 11
        iteration: 11
        AbsError[residual]: 0.0003716617961722087
        N_iter: 12.0
INFO:/tmp/pyxu_i3jnsx5v:[2023-11-02 15:57:18.546313] Iteration 12
        iteration: 12
        AbsError[residual]: 0.0002429203135320249
        N_iter: 13.0
INFO:/tmp/pyxu_i3jnsx5v:[2023-11-02 15:57:18.880553] Iteration 13
        iteration: 13
        AbsError[residual]: 0.00014315533097738364
        N_iter: 14.0
INFO:/tmp/pyxu_i3jnsx5v:[2023-11-02 15:57:19.227251] Iteration 14
        iteration: 14
        AbsError[residual]: 8.397651073145921e-05
        N_iter: 15.0
INFO:/tmp/pyxu_i3jnsx5v:[2023-11-02 15:57:19.227785] Stopping Criterion satisfied -&gt; END
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_xray_20_1.png" src="../_images/examples_xray_20_1.png"/>
</div>
</div>
<p>A few takebacks from this experiment:</p>
<ul class="simple">
<li><p>If <span class="math notranslate nohighlight">\(r\)</span> is small, then the sharp region is limited to a small radius around the image center.</p></li>
<li><p>As <span class="math notranslate nohighlight">\(r\)</span> increases, we lose sharpness at the center in favor of peripheral regions.</p></li>
</ul>
</section>
<section id="Fan-Beam">
<h3>Fan Beam<a class="headerlink" href="#Fan-Beam" title="Link to this heading">#</a></h3>
<p>Another potential solution to improve radial resolution is to employ a fan beam geometry. The advantage of fan beam is potentially more “orientations” being available for the same value of <span class="math notranslate nohighlight">\(N_{\mathrm{angle}}\)</span>.</p>
<p>We will take the same <span class="math notranslate nohighlight">\(N_{\mathrm{angle}}\)</span> and <span class="math notranslate nohighlight">\(N_{\mathrm{offset}}\)</span> settings as in parallel beam, but where <span class="math notranslate nohighlight">\(N_{\mathrm{angle}}\)</span> refers to the number of “emitter” locations, and <span class="math notranslate nohighlight">\(N_{\mathrm{offset}}\)</span> now corresponds to the number of detectors spread along the edge of the image.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># In the parallel-beam setups above, we had fixed `origin=0` and shifted `t_spec` to be centered at the volume</span>
<span class="c1"># mid-point, i.e. (N_side * pitch / 2). For fan-beam, it is easier to center the volume at the origin of the reference</span>
<span class="c1"># system, i.e. `origin = -(N_side * pitch / 2)`, and define `n/t_spec` for one source position. Subsequent src/detector</span>
<span class="c1"># positions are then obtained by applying a rotation matrix.</span>

<span class="c1"># Let's build the necessary components to instantiate the operator. ========================</span>
<span class="n">radius</span> <span class="o">=</span> <span class="p">(</span><span class="n">N_side</span> <span class="o">*</span> <span class="n">pitch</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>  <span class="c1"># be at diagonal distance</span>
<span class="n">tx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">radius</span>  <span class="c1"># (2,)</span>
<span class="n">t_max</span> <span class="o">=</span> <span class="n">N_side</span> <span class="o">*</span> <span class="n">pitch</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">t_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">t_max</span><span class="p">,</span> <span class="n">t_max</span><span class="p">,</span> <span class="n">N_offset</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">rx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N_offset</span><span class="p">),</span> <span class="n">t_offset</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (N_offset, 2)</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="p">(</span><span class="n">N_offset</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">n</span> <span class="o">=</span> <span class="n">rx</span> <span class="o">-</span> <span class="n">tx</span>  <span class="c1"># vectors pointing from unique TX to all RX.</span>

<span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">N_angle</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N_angle</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">R</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">R</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
<span class="n">R</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
<span class="n">R</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>

<span class="n">n_spec</span> <span class="o">=</span> <span class="p">(</span><span class="n">R</span> <span class="o">@</span> <span class="n">n</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># (N_angle, N_offset, 2)</span>
<span class="n">t_spec</span> <span class="o">=</span> <span class="p">(</span><span class="n">R</span> <span class="o">@</span> <span class="n">t</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># (N_angle, N_offset, 2)</span>
<span class="c1"># ==========================================================================================</span>


<span class="n">op_fan</span> <span class="o">=</span> <span class="n">pxr</span><span class="o">.</span><span class="n">XRayTransform</span><span class="o">.</span><span class="n">init</span><span class="p">(</span>
    <span class="n">arg_shape</span><span class="o">=</span><span class="p">(</span><span class="n">N_side</span><span class="p">,</span> <span class="n">N_side</span><span class="p">),</span>
    <span class="n">origin</span><span class="o">=-</span><span class="n">N_side</span> <span class="o">*</span> <span class="n">pitch</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># center of volume located at (0, 0)</span>
    <span class="n">pitch</span><span class="o">=</span><span class="n">pitch</span><span class="p">,</span>  <span class="c1"># pixel dimensions. (Can vary per axis.)</span>
    <span class="n">method</span><span class="o">=</span><span class="s2">"ray-trace"</span><span class="p">,</span>
    <span class="n">n_spec</span><span class="o">=</span><span class="n">n_spec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>  <span class="c1"># (N_ray, 2) directions</span>
    <span class="n">t_spec</span><span class="o">=</span><span class="n">t_spec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>  <span class="c1"># (N_ray, 2)</span>
<span class="p">)</span>
<br/></pre></div>
</div>
</div>
<p>Let’s again verify that the rays are instantiated correctly. We’ll limit the visualization to 2 “emitters”, and sub-sample the outgoing beam-count for visualization purposes:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ray_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N_angle</span> <span class="o">*</span> <span class="n">N_offset</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">N_angle</span><span class="p">,</span> <span class="n">N_offset</span><span class="p">)[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="p">::</span><span class="mi">10</span><span class="p">]</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">op_fan</span><span class="o">.</span><span class="n">diagnostic_plot</span><span class="p">(</span><span class="n">ray_idx</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_xray_25_0.png" src="../_images/examples_xray_25_0.png"/>
</div>
</div>
<p>We can already see an interesting difference with respect to parallel-beam setups: the ray density is higher in the periphery than in the center region.</p>
<p>Plotting the sinogram is more complex than in the parallel-beam case, so let’s skip that step and instead see what the back-projected and least-squares images look like.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute backprojected image and LSQ image. =======================</span>
<span class="n">sinogram</span> <span class="o">=</span> <span class="n">op_fan</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">phantom</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">N_angle</span><span class="p">,</span> <span class="n">N_offset</span><span class="p">)</span>
<span class="n">I_BP</span> <span class="o">=</span> <span class="n">op_fan</span><span class="o">.</span><span class="n">adjoint</span><span class="p">(</span><span class="n">sinogram</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">phantom</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">I_LSQ</span> <span class="o">=</span> <span class="n">op_fan</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">sinogram</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">damp</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">phantom</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Plot the images ==================================================</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">phantom</span><span class="p">,</span> <span class="o">**</span><span class="n">im_kwargs</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">I_BP</span><span class="p">,</span> <span class="o">**</span><span class="n">im_kwargs</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">I_LSQ</span><span class="p">,</span> <span class="o">**</span><span class="n">im_kwargs</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">I_BP_u</span><span class="p">),</span> <span class="o">**</span><span class="n">im_kwargs</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">I_LSQ_u</span><span class="p">,</span> <span class="o">**</span><span class="n">im_kwargs</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Ground-Truth"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"BP (Fan)"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"LSQ (Fan)"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"log-BP (Par)"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"LSQ (Par)"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">_ax</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">:</span>
    <span class="n">_ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">"off"</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
INFO:/tmp/pyxu_yxbaj8t3:[2023-11-02 16:02:06.189267] Iteration 0
        iteration: 0
        AbsError[residual]: 0.05324661981317398
        N_iter: 1.0
INFO:/tmp/pyxu_yxbaj8t3:[2023-11-02 16:02:06.781108] Iteration 1
        iteration: 1
        AbsError[residual]: 0.0030504175391676256
        N_iter: 2.0
INFO:/tmp/pyxu_yxbaj8t3:[2023-11-02 16:02:07.174329] Iteration 2
        iteration: 2
        AbsError[residual]: 0.002050073063966784
        N_iter: 3.0
INFO:/tmp/pyxu_yxbaj8t3:[2023-11-02 16:02:07.579660] Iteration 3
        iteration: 3
        AbsError[residual]: 0.0008204494986229778
        N_iter: 4.0
INFO:/tmp/pyxu_yxbaj8t3:[2023-11-02 16:02:07.999506] Iteration 4
        iteration: 4
        AbsError[residual]: 0.00043823673093985297
        N_iter: 5.0
INFO:/tmp/pyxu_yxbaj8t3:[2023-11-02 16:02:08.425266] Iteration 5
        iteration: 5
        AbsError[residual]: 0.0002602658043562458
        N_iter: 6.0
INFO:/tmp/pyxu_yxbaj8t3:[2023-11-02 16:02:08.884062] Iteration 6
        iteration: 6
        AbsError[residual]: 0.0001519355648745462
        N_iter: 7.0
INFO:/tmp/pyxu_yxbaj8t3:[2023-11-02 16:02:09.339093] Iteration 7
        iteration: 7
        AbsError[residual]: 0.00010628508829214899
        N_iter: 8.0
INFO:/tmp/pyxu_yxbaj8t3:[2023-11-02 16:02:09.805582] Iteration 8
        iteration: 8
        AbsError[residual]: 6.868850929434216e-05
        N_iter: 9.0
INFO:/tmp/pyxu_yxbaj8t3:[2023-11-02 16:02:09.806236] Stopping Criterion satisfied -&gt; END
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_xray_27_1.png" src="../_images/examples_xray_27_1.png"/>
</div>
</div>
<p>Based on the plots, we can already see some interesting behaviour:</p>
<ul class="simple">
<li><p>At equivalent rays cast into the medium, the back-projected fan-image has much higher contrast than the parallel-beam equivalent. (Linear vs. log-scale plot.)</p></li>
<li><p>The least-squares fan-beam image appears sharper &amp; higher-contrast than the parallel beam version, but it warps at the borders due to the projection geometry.</p></li>
</ul>
<p>A finer analysis is of course possible, but we hope to have shown how the scanning geometry impacts image reconstruction. The versatile <code class="docutils literal notranslate"><span class="pre">XRayTransform()</span></code><a class="reference external" href="../api/experimental/xray.html#pyxu.experimental.xray.XRayTransform">🔗</a> class is therefore a handy tool in the computational scientist’s toolbox!</p>
</section>
</section>
</section>
</article>
<footer class="bd-footer-article">
<div class="footer-article-items footer-article__inner">
<div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
</div></div>
</div>
</footer>
</div>
<div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">
<div class="sidebar-secondary-item">
<div class="page-toc tocsection onthispage">
<i class="fa-solid fa-list"></i> On this page
  </div>
<nav class="bd-toc-nav page-toc">
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Preliminaries">Preliminaries</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#2D-Imaging">2D Imaging</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Parallel-Beam:-Uniform-Offsets">Parallel Beam: Uniform Offsets</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Parallel-Beam:-Non-Uniform-Offsets">Parallel Beam: Non-Uniform Offsets</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Fan-Beam">Fan Beam</a></li>
</ul>
</li>
</ul>
</nav></div>
<div class="sidebar-secondary-item">
<div id="searchbox"></div></div>
<div class="sidebar-secondary-item">
<div class="tocsection editthispage">
<a href="https://github.com/matthieumeo/pyxu/edit/main/doc/examples/xray.ipynb">
<i class="fa-solid fa-pencil"></i>
      
      
        
          Edit on GitHub
        
      
    </a>
</div>
</div>
<div class="sidebar-secondary-item">
<div class="tocsection sourcelink">
<a href="../_sources/examples/xray.ipynb">
<i class="fa-solid fa-file-lines"></i> Show Source
    </a>
</div>
</div>
</div></div>
</div>
<footer class="bd-footer-content">
</footer>
</main>
</div>
</div>
<!-- Scripts loaded after <body> so the DOM is not blocked -->
<script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>
<footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
<div class="footer-items__start">
<div class="footer-item">
<p class="copyright">
    
      © Copyright 2023, M. Simeoni, S. Kashani, J. Rué-Queralt, Pyxu Developers.
      <br/>
</p>
</div>
<div class="footer-item">
<p class="sphinx-version">
     Created with <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6, with some help from <a href="https://chat.openai.com/"> ChatGPT</a> (GPT 4).
    <br/>
</p>
</div>
</div>
<div class="footer-items__end">
<div class="footer-item"><p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.13.3.
</p></div>
</div>
</div>
</footer>
</body>
</html>